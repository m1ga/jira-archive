---
title: "[AC-2190] Android: Facebook login occasionally hangs"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>n/a</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Cannot Reproduce</td></tr>
<tr><th>Resolution Date</th><td>2013-09-09T20:50:22.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Appcelerator Modules, Titanium SDK & CLI</td></tr>
<tr><th>Labels</th><td>facebook, module</td></tr>
<tr><th>Reporter</th><td>Mark Mokryn</td></tr>
<tr><th>Assignee</th><td>Mauro Parra-Miranda</td></tr>
<tr><th>Created</th><td>2013-06-18T11:41:02.000+0000</td></tr>
<tr><th>Updated</th><td>2016-03-08T07:41:10.000+0000</td></tr>
</table>

<h3>Description</h3>

*Steps to reproduce*
1. Build for Android device 
2. Click login button, wait for login event
3. Click logout button
4. Click back button to close app
5. Repeat above steps a few times. After a few iterations (usually just 2 or 3), clicking the login button seems to have no effect.
6. At this point, check the Android logs. I see the following message: com.facebook.Session Should not pass a read permission (email) to a request for publish or manage authorization . Something is clearly wrong, as my app never asked for anything besides email permission.
7. At this point, only closing the app enables recovery. This causes a major usability problem on Android.

*index.js*
<code><pre>
var loggedIn = undefined;
var fb = require('facebook');
fb.appid = 'YOUR_APP_ID';
fb.permissions = ['email'];
fb.forceDialogAuth = false;

function doLogin(e) {
	fb.authorize();
}

function doLogout(e){
	fb.logout();
}  

function loggedInState() {
	$.initLabel.visible = false;
	$.logoutBtn.visible = true;
	$.loginBtn.visible = false;	
	Ti.API.info('Access token in case we need to debug: ' + fb.accessToken);	
}

function loggedOutState() {
	$.initLabel.visible = false;
	$.logoutBtn.visible = false;
	$.loginBtn.visible = true;	
}

fb.addEventListener('logout', function() {
	loggedOutState();
});

fb.addEventListener('login', function(e) {
	Ti.API.info('Facebook login event, data:' + JSON.stringify(e.data) + ' cancelled: ' + e.cancelled + 
		' error: ' + e.error + ' type: ' + e.type + ' uid: ' + e.uid + ' success: ' + e.success);
	if (e.success) {
		loggedInState();
		alert('Login success, see console logs for user data');
	} else if (e.error) {
		alert ('Login error: ' + e.error);
		loggedOutState();
	} else if (e.cancelled) { // do nothing
		alert('Login cancelled');
		loggedOutState();
	} else {
		alert('no success, no error, and not cancelled... assume loggedOutState');
		loggedOutState();
	}
});

loggedIn = fb.getLoggedIn();
Ti.API.info('logged in: ' + loggedIn); 
if (loggedIn) {
	loggedInState();
}

if (loggedIn === false) {
	loggedOutState();
}

$.index.open();
</pre></code> 

*index.xml*
<code><pre> 
&lt;Alloy&gt;
	&lt;Window class="container"&gt;
		&lt;Label id="initLabel"&gt;This appears only when login state is undefined&lt;/Label&gt;
		&lt;Button id="loginBtn" onClick="doLogin"&gt;Facebook Login&lt;/Button&gt;
		&lt;Button id="logoutBtn" onClick="doLogout"&gt;Facebook Logout&lt;/Button&gt;
	&lt;/Window&gt;
&lt;/Alloy&gt;
</pre></code> 

*index.tss*
<code><pre>
".container": {
	backgroundColor:"white"
},
"#initLabel": {
	width: Ti.UI.SIZE,
	height: Ti.UI.SIZE,
	color: "#000",
	visible: true
} ,
"#loginBtn": {
	visible: false
},
"#logoutBtn": {
visible: false
}
</pre></code>

*tiapp.xml extract*
<code><pre>
&lt;id&gt;com.test.ti&lt;/id&gt; &lt;!-- make sure this matches your Facebook app config --&gt;
&lt;property name="ti.facebook.appid"&gt;YOUR_APP_ID&lt;/property&gt;
...
    &lt;modules&gt;
    	&lt;!-- Add the appropriate line(s) to your modules section --&gt;
    	&lt;module platform="android"&gt;facebook&lt;/module&gt;
    	&lt;module platform="iphone"&gt;facebook&lt;/module&gt;
    &lt;/modules&gt;
</pre></code>

<h3>Comments</h3>

<ol>
<li>Mauro Parra-Miranda 2013-09-09

   Tested this, looks working just fine. </li>
<li>Jan Helleman 2014-01-07

   I have the same issue on 3.2.0 with fb module 3.0.2. When clicking the button the log says "W/com.facebook.Session: Should not pass a read permission (email) to a request for publish or manage authorization" and no auth popup appears. The code:
   
   Alloy.Globals.Facebook = require('facebook');
   Alloy.Globals.Facebook.appid = 'xxx';
   Alloy.Globals.Facebook.permissions = ['email'];
   Alloy.Globals.Facebook.forceDialogAuth = false;</li>
</ol>


<p><a href="/AC/AC-2190.json">JSON Source</a></p>