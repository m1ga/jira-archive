---
title: "[AC-5622] ios simulator crashes when playing a sound from local filesystem"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>n/a</td></tr>
<tr><th>Status</th><td>Resolved</td></tr>
<tr><th>Resolution</th><td>Done</td></tr>
<tr><th>Resolution Date</th><td>2018-03-06T21:30:59.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Appcelerator Studio 4.5.0</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Titanium SDK & CLI</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>mvschilt</td></tr>
<tr><th>Assignee</th><td>Shak Hossain</td></tr>
<tr><th>Created</th><td>2018-02-25T21:23:31.000+0000</td></tr>
<tr><th>Updated</th><td>2018-03-06T21:30:59.000+0000</td></tr>
</table>

<h3>Description</h3>

I'm creating an app to record sound from the microphone. This code was working before but suddenly the simulator crashes. I thought it was my app, so I tried to isolate it in a separate app to test it. But if I use the code from <a href="http://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Media.AudioRecorder and adjust it a little bit to my code the simulator also the simulator crashes without giving any pointer to the problem.

My code:
added permission: <code>NSMicrophoneUsageDescription</code>
app.js
<code><pre>
var window = Ti.UI.createWindow({
  backgroundColor: '#fff'
});

var recordStart = Ti.UI.createButton({
  title: 'Start',
  top: 10
});

var recordPause = Ti.UI.createButton({
  title: 'Pause',
  top: 60
});

var recordStop = Ti.UI.createButton({
  title: 'Stop',
  top: 110
});

var recordPlay = Ti.UI.createButton({
  title: 'Play',
  top: 160
});

var audioRecorder = Ti.Media.createAudioRecorder();
var record;
var audioPlayer;
var voiceFile;
var recDir = Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,'Recordings');
     if(!recDir.exists()){
       recDir.createDirectory();
     };

window.addEventListener('open', function(e) {
  if (!Ti.Media.hasAudioRecorderPermissions()) {
    Ti.Media.requestAudioRecorderPermissions(function(e) {
      if (e.success) {
        window.add(recordStart);
      }
    });
  } else {
    window.add(recordStart);
  }
});

recordStart.addEventListener('click', function(e) {
  audioRecorder.start();
});

recordPause.addEventListener('click', function(e) {
  if (audioRecorder.getPaused()) {
    recordPause.setTitle('Pause');
    audioRecorder.resume();
  } else {
    recordPause.setTitle('Resume');
    audioRecorder.pause();
  }
});

recordStop.addEventListener('click', function(e) {

	record = audioRecorder.stop();
	var date = new Date();
	var millisec = date.getMilliseconds();
	voiceFile =     Ti.Filesystem.getFile(recDir.nativePath, "Test_"+ millisec +".mp4");
        voiceFile.write(record);
        Ti.API.info("voiceFile native " +  voiceFile.nativePath);
});

recordPlay.addEventListener('click', function(e) {
  Ti.API.info("start playing sound");
  Ti.API.info("voiceFile native " +  voiceFile.nativePath);
  audioPlayer = Ti.Media.createAudioPlayer({
    url: voiceFile.nativePath
  });
  audioPlayer.start();
});

window.add(recordPause);
window.add(recordStop);
window.add(recordPlay);

window.open();
</pre></code>

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/AC/AC-5622_64900/console trace log.txt">console trace log.txt</td></td><td>2018-02-25T21:22:40.000+0000</td><td>32960</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Mostafizur Rahman 2018-02-26

   Hello [~mvschilt], Thanks for sharing with us. Can you please share us the exact test case to reproduce this on our end and the error logs during the app crash.</li>
<li>mvschilt 2018-02-26

   Hi @mrahman, 
   
   Thanks for your response.
   I've got the main part of the code from the example given on page <a href="http://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Media.AudioRecorder. I added the lines to the code so the file is saved in a specific folder within the Titanium.Filesystem.applicationDataDirectory.
   
   The testcase to reproduce:
   push start button (Start recording)
   push stop button (Stop recording)
   push play button (Play sound)
   
   The expectation is that when pushing the play button the sound will be played. Instead the simulator ends abnormally and no error is logged. </li>
<li>Hans Knöchel 2018-02-26

   Hey there! When exactly did that work before? Which SDK version? Or do you mean it worked inside the app and then crashes?</li>
<li>mvschilt 2018-02-26

   Hi Hans Knöchel,
   
   I made a successful build on the 6th of February with SDK 7.0.0.GA.
   When I build the app with the SDK to 7.0.0.GA, then also this problem occurs. 
   Before this functionality worked in the app. The sound was playing. But now the simulator crashes. 
   
   Can you reproduce it?
   
   Best regards,
   
   Michiel</li>
<li>Hans Knöchel 2018-02-26

   Hey @[~mvschilt], so first of all, you need to set a proper [audio session category](<a href="http://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Media-property-audioSessionCategory) before:
   <code><pre>
   Ti.Media.audioSessionCategory = Ti.Media.AUDIO_SESSION_CATEGORY_PLAY_AND_RECORD;
   </pre></code>
   But after that, the app still seems to crash when playing the audio again, although I am not sure if that may be related to the mp4 format which is rather a video than audio format. I will dig some more into this, but this does not seem to be an SDK issue.
   
   *EDIT*: See [this example](<a href="https://github.com/appcelerator/KitchenSink/blob/stable/Resources/ui/handheld/ios/phone/sound_record.js)" rel="nofollow" target="_blank">https://github.com/appcelerator/KitchenSink/blob/stable/Resources/ui/handheld/ios/phone/sound_record.js)</a> for more details.
   
   *EDIT 2*: The following works:
   <code><pre>
   var window = Ti.UI.createWindow({
     backgroundColor: '#fff'
   });
   
   Ti.Media.audioSessionCategory = Ti.Media.AUDIO_SESSION_CATEGORY_PLAY_AND_RECORD;
    
   var recordStart = Ti.UI.createButton({
     title: 'Start',
     top: 200
   });
    
   var recordPause = Ti.UI.createButton({
     title: 'Pause',
     top: 60
   });
    
   var recordStop = Ti.UI.createButton({
     title: 'Stop',
     top: 110
   });
    
   var recordPlay = Ti.UI.createButton({
     title: 'Play',
     top: 160
   });
    
   var audioRecorder = Ti.Media.createAudioRecorder({
     compression: Ti.Media.AUDIO_FORMAT_AAC,
     format: Ti.Media.AUDIO_FILEFORMAT_MP4
   });
   var record;
   var audioPlayer;
   var voiceFile;
   var recDir = Titanium.Filesystem.getFile(Titanium.Filesystem.applicationDataDirectory,'Recordings');
        if(!recDir.exists()){
          recDir.createDirectory();
        };
    
   window.addEventListener('open', function(e) {
     if (!Ti.Media.hasAudioRecorderPermissions()) {
       Ti.Media.requestAudioRecorderPermissions(function(e) {
         if (e.success) {
           window.add(recordStart);
         }
       });
     } else {
       window.add(recordStart);
     }
   });
    
   recordStart.addEventListener('click', function(e) {
     audioRecorder.start();
   });
    
   recordPause.addEventListener('click', function(e) {
     if (audioRecorder.getPaused()) {
       recordPause.setTitle('Pause');
       audioRecorder.resume();
     } else {
       recordPause.setTitle('Resume');
       audioRecorder.pause();
     }
   });
    
   recordStop.addEventListener('click', function(e) {
    
   	record = audioRecorder.stop();
   	var date = new Date();
   	var millisec = date.getMilliseconds();
   	voiceFile =     Ti.Filesystem.getFile(recDir.nativePath, "Test_"+ millisec +".mp4");
           voiceFile.write(record);
           Ti.API.info("voiceFile native " +  voiceFile.nativePath);
   });
    
   recordPlay.addEventListener('click', function(e) {
     Ti.API.info("start playing sound");
     Ti.API.info("voiceFile native " +  voiceFile.nativePath);
     audioPlayer = Ti.Media.createAudioPlayer({
       url: voiceFile.nativePath
     });
     audioPlayer.start();
   });
    
   window.add(recordPause);
   window.add(recordStop);
   window.add(recordPlay);
    
   window.open();
   </pre></code>
   We should update the docs to reflect this configuration. Let us know if it works for you as well! The AudioRecorder API is pretty powerful, but also requires some configuration.</li>
<li>mvschilt 2018-02-26

   Hi Hans,
   
   Thank you very much for your digging. It works fine at my side, I added some code to clear the record variable. so when you record again this variable will be empty.
   
   <code><pre>
   recordStart.addEventListener('click', function(e) {
   	record = '';
     audioRecorder.start();
   });
   </pre></code>
   
   But I'm still wondering if there was someting changed in the SDK, because I believe the code is handled more strict. Before I had this code:
   $.Login.fbProxy = fb.createActivityWorker({lifecycleContainer: $.Login});
   Running it on ios didn't cause any problem. 
   
   But as the issue logged in this ticket the app also crashed, so I made it specifically for android platform and there was no problem anymore. 
   
   Thanks for your help. </li>
<li>Hans Knöchel 2018-02-26

   <code>createActivityWorker</code> is Android only, so if it didn't cause issues on iOS before, that was the actual issue. 7.0.0 uses the native JSCore by default, which reduces the app size and brings other advantages like the safari debugger. But you can still try to disable it by using <code>&lt;use-jscore-framework&gt;false&lt;/use-jscore-framework&gt;</code>. Can we resolve this issue? Let me know!</li>
<li>mvschilt 2018-02-26

   Hi Hans,
   
   Ah that is good to know, thanks for letting me know. 
   
   yes the issue can be put to resolved. Many thanks for your help.
   
   Best regards,
   
   Michiel
   </li>
</ol>


<p><a href="/AC/AC-5622.json">JSON Source</a></p>