---
title: "[AC-6485] Reducing APK size"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>n/a</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Not Our Bug</td></tr>
<tr><th>Resolution Date</th><td>2020-03-03T16:01:48.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>n/a</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Rainer Schleevoigt</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2020-02-07T18:37:23.000+0000</td></tr>
<tr><th>Updated</th><td>2020-03-03T16:01:48.000+0000</td></tr>
</table>

<h3>Description</h3>

I have added ffmpeg to an app by using a new module. This module uses a multi architect binary. It is very large (ca. 20MB). After building of app (apk) I see with a debug tool: the binaries are twice in the apk: first under /assets and second under /assets/Resources/ I guess the system uses only one place. Which binary  I can remove and why the asset has this two places?

<h3>Comments</h3>

<ol>
<li>Joshua Quick 2020-02-08

   I'm not really sure what you're doing. If the module is open source, then perhaps you can point us to what it looks like?
   
   The only thing that gets duplicated by a module are files you put under its "assets" folder. These files are added to APK "assets" and as JAR resources. Unfortunately, devs are using it for both purposes and we don't want to break it. In Titanium 9.0.0, we'll be offering a new "Resources" folder which will only add files to APK "assets/Resources".
   <code><pre>
   <module>/android/assets
   </pre></code>
   
   If your module includes prebuilt C/C++ <code>\*.so</code> libraries, then they need to go under the following architecture folders. I imagine this is what you want. When you do an app build, it'll copy the <code>\*.so</code> libraries to similar folders within the APK, which is where they're supposed to go.
   <code><pre>
   <module>/android/libs/arm64-v8a
   <module>/android/libs/armeabi-v7a
   <module>/android/libs/x86
   </pre></code>
   </li>
<li>Rainer Schleevoigt 2020-02-10

   In case of ffmpeg the module uses binaries (not *.so). During first run the right binary will copied (and unzipped) and make executable in data folder. In the compiled apk I see the ffmpeg (zipped) binaries in folder /assets *and* in folder /assets/Resources. 
   <a href="https://github.com/AppWerft/Ti.FFmpeg/" rel="nofollow" target="_blank">https://github.com/AppWerft/Ti.FFmpeg/</a>
   I guess I can rewmove the version under /assets/Resources. Right?
   </li>
<li>Joshua Quick 2020-02-11

   If I understand correctly, your module project has binaries under the following directory. If this is the case, then yes, it will duplicate the files.
   <code><pre>
   <module>/android/assets
   </pre></code>
   
   What you can do instead is move your binaries to the below folder. This folder copies files to APK "assets" as well and it won't duplicate the files. This is supported by all Titanium SDK versions. I don't think this folder is documented, but it's what our "appcelerator.encrypteddatabase" module uses and we need to maintain backward compatibility. Also note that this copies files to the root "assets" folder in the APK. If you want the files to be accessible to Titanium's JavaScript code, you'll need to put your binaries under a "Resources" subdirectory (which I think you already know).
   <code><pre>
   <module>/android/platform/android/bin/assets
   </pre></code>
   
   Does this help?</li>
<li>Rainer Schleevoigt 2020-02-11

   Maybe it helps. With the module Kroll method loadBinaries() binaries will copied from folder addressed by <code>getFilesDirectory()</code>, this is the assets folder directly underneath the module folder. How can I address  <code>/android/platform/android/bin/assets</code>?
   Here the copy process:
   <a href="https://github.com/AppWerft/Ti.FFmpeg/blob/master/android/src/com/github/hiteshsondhi88/libffmpeg/FileUtils.java#L54-L87" rel="nofollow" target="_blank">https://github.com/AppWerft/Ti.FFmpeg/blob/master/android/src/com/github/hiteshsondhi88/libffmpeg/FileUtils.java#L54-L87</a>
   Although the apk is zipped the zipping of ffmpeg with <code>zip -9</code> saves 10MB. I guess it is due the other zip metric of zipalign?</li>
<li>Rainer Schleevoigt 2020-02-11

   Ah I understand: I have only to move the architecture folder structure to <code>/android/platform/android/bin/assets</code>. In the end the binaries are in the same folder, I don't have to modify the copy code. </li>
<li>Rainer Schleevoigt 2020-02-11

   It works! old apk size 97MB, new 57MB. Maybe I can remove the x86 variant. It is not possible to deliver apks depending on architecture. I can deploy 64bit one, but the 32bit only will rejected. </li>
<li>Joshua Quick 2020-02-11

   I recommend that you support all architectures in the module and let the app decide which architectures to support.
   
   In the "tiapp.xml", you can configure which architectures you want as follows. In you
   <code><pre>
   <ti:app xmlns:ti="<a href="http://ti.appcelerator.org" rel="nofollow" target="_blank">http://ti.appcelerator.org</a>">
   	<android>
   		<!-- All architectures supported by Titanium 7.0.0 to 8.x.x. -->
   		<!-- <abi>armeabi-v7a,arm64-v8a,x86</abi> -->
   
   		<!-- All architectures supported by Titanium 9.0.0 and higher. -->
   		<!-- <abi>armeabi-v7a,arm64-v8a,x86,x86_64</abi> -->
   
   		<!-- This is what you want. -->
   		<abi>armeabi-v7a,arm64-v8a</abi>
   	</android>
   </ti:app>
   </pre></code>
   
   Also note that "production" builds exclude <code>x86</code> by default since it's really only relevant to the emulator. Titanium only adds <code>x86</code> to APKs when doing test/development builds by default, unless you configure it via your "tiapp.xml" as shown above.</li>
</ol>


<p><a href="/AC/AC-6485.json">JSON Source</a></p>