---
title: "[AC-6582] Android: Image orientation handling"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>n/a</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Duplicate</td></tr>
<tr><th>Resolution Date</th><td>2020-09-08T23:42:21.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>n/a</td></tr>
<tr><th>Labels</th><td>android, exif</td></tr>
<tr><th>Reporter</th><td>Michael Gangolf</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2020-08-09T11:16:47.000+0000</td></tr>
<tr><th>Updated</th><td>2020-09-08T23:42:21.000+0000</td></tr>
</table>

<h3>Description</h3>

In Ti 9.1.0 there was a change to the orientation handling of rotated images:

<a href="https://github.com/appcelerator/titanium_mobile/pull/11679" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11679</a>

<a href="https://github.com/appcelerator/titanium_mobile/blob/7ce3ae11f2c886864ed7713b1e88324b60fdf8f6/android/titanium/src/java/org/appcelerator/titanium/TiBlob.java#L756-L758" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/7ce3ae11f2c886864ed7713b1e88324b60fdf8f6/android/titanium/src/java/org/appcelerator/titanium/TiBlob.java#L756-L758</a>

while this fixes the rotation of the images in the example it brings some problems using av.imageview:
<a href="https://github.com/AndreaVitale/av.imageview/issues/92" rel="nofollow" target="_blank">https://github.com/AndreaVitale/av.imageview/issues/92</a>

One thing I see is that on my Android 10, Pixel 4 I always get the wrong orientation in e.media.width/height for portrait images when looking at images from camera or gallery but I don't know the orientation (e.g. a portrait image is exif orientation 6 (top, right) but the returned width value is higher).

In my opinion the images that are returned to my app should always be in the correct orientation AND the width/height value should represent that too.

<code><pre>
var window = Ti.UI.createWindow({
	title: "Image Test"
});

var AvImageview = require("av.imageview");
var img1 =AvImageview.createImageView({
	width: Ti.UI.FILL,
	height: 200,
	top: 0,
	contentMode: AvImageview.CONTENT_MODE_ASPECT_FILL,
});

var img2 =AvImageview.createImageView({
	width: Ti.UI.FILL,
	height: 200,
	top: 200,
	contentMode: AvImageview.CONTENT_MODE_ASPECT_FILL,
});
var img3 =Ti.UI.createImageView({
	width: Ti.UI.SIZE,
	height: 200,
	top: 400,
	autoRotate: true
});
var img4 =Ti.UI.createImageView({
	width: Ti.UI.SIZE,
	height: 200,
	top: 600,
	autoRotate: true
});
window.add(img1);
window.add(img2);
window.add(img3);
window.add(img4);
var dl = Ti.UI.createButton({
	title: "gal",
	bottom: 60,
});
dl.addEventListener("click", function(e) {
	Ti.Media.openPhotoGallery({
		success: function(e) {
			var w = e.media.width;
			var h = e.media.height;

			var r = h / w;
			w = 1024;
			h = r * w;

			var imageBlob = e.media.imageAsResized(w, h);
			img1.image = e.media;
			img2.image = imageBlob;
			img3.image = e.media;
			img4.image = imageBlob;
		}
	});
});

window.add(dl);
window.open();
</pre></code>

Needs av.imageview (<a href="https://github.com/AndreaVitale/av.imageview/releases/tag/Android-5.0.1)" rel="nofollow" target="_blank">https://github.com/AndreaVitale/av.imageview/releases/tag/Android-5.0.1)</a>

9.0.3.GA
 !ti903ga.jpg|thumbnail! 

9.1.0.RC
 !ti910rc.jpg|thumbnail! 

1st and 3rd image are straight from the Gallery
2nd and 4th image are resized images.

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/AC/AC-6582_67491/ti903ga.jpg">ti903ga.jpg</td></td><td>2020-08-15T13:23:12.000+0000</td><td>368794</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/AC/AC-6582_67490/ti910rc.jpg">ti910rc.jpg</td></td><td>2020-08-15T13:19:49.000+0000</td><td>447507</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Joshua Quick 2020-08-17

   [~michael], the real issue is that Google's image loading APIs ignore the JPEG's EXIF orientation when decoding it to a bitmap and simply load it as-is. Apple and Microsoft will pre-rotate it, but Google does not.
   
   The Titanium blob's "width" and "height" properties represent the actual width and height of the bitmap it wraps. In this case, it's for the unrotated image and it's technically correct. Titanium's <code>ImageView.image</code> property is the only image displaying API that will correctly rotate a JPEG. So, swapping the blob's width/height values would end up causing sizing issues in all of our other image displaying APIs such as "backgroundImage".
   
   I think a good *+interim+* solution would be to add a new "rotation" property to <code>Ti.Blob</code> which would provide the EXIF rotation. This is needed for people who are doing the math themselves, such as you. In your case, you know you need to swap width/height values when the rotation is 90 or 180 degrees.
   (On iOS, this new "rotation" property will always be zero since Apple pre-rotates it.)
   
   The BEST solution would be for us to load JPEGs ourselves via the "libjpeg" library and rotate it during the decoding process, but this would involve a major refactoring of our code (although I think it needs it). If we were to do this, then the blob's "rotation" property will always be zero, the blob's width/height properties would be what you expect, and then we can finally be done with this nonsense.</li>
<li>Michael Gangolf 2020-08-17

   Thank you for the great explanation! I've tested it with a js exif library, have to give it another go.
   
   it is just that the change in 9.1.0 (swapping the values for rotated images) <a href="https://github.com/appcelerator/titanium_mobile/blob/7ce3ae11f2c886864ed7713b1e88324b60fdf8f6/android/titanium/src/java/org/appcelerator/titanium/TiBlob.java#L756-L758" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/7ce3ae11f2c886864ed7713b1e88324b60fdf8f6/android/titanium/src/java/org/appcelerator/titanium/TiBlob.java#L756-L758</a> broke it for me and 9.0.3.GA is working. 
   Perhaps it is a combination of that PR (since it fixes other parts) and an exif check? Here is a test image: <a href="http://migaweb.de/IMG_20200802_151801.jpg" rel="nofollow" target="_blank">http://migaweb.de/IMG_20200802_151801.jpg</a>
   
   I hate handling images on Android :-D Especially on Samsung phones. </li>
<li>Joshua Quick 2020-08-17

   </li>
<li>Joshua Quick 2020-08-20

   [~michael], I'm thinking about adding new properties "uprightWidth" and "uprightHeight" to <code>Ti.Blob</code> which will tell you the width/height of the JPEG after it's been rotated. This should make it more convenient to use. For iOS, theses properties will always match <code>width</code> and <code>height</code> since iOS always decodes JPEGs pre-rotated.</li>
<li>Michael Gangolf 2020-08-20

   I was trying to find a spot to do that already but wasn't successful :) And I had some problems with cleanbuild failing on 9.2.0 at the end (had to manually install it, not sure yet why) but I'll give it another go at the weekend. </li>
<li>Joshua Quick 2020-08-20

   [~michael], I have something working now. I just don't "love" the idea of adding these 2 new properties to <code>Ti.Blob</code>. Ideally you shouldn't have to worry about this in Titanium... but natively you do.
   
   Maybe a better solution might be to add a method to our "ti.imagefactory" module. Like an <code>imageGetUprightSize()</code> method? I'm a bit torn on this.</li>
<li>Joshua Quick 2020-09-08

   Resolved by [TIMOB-28093]</li>
</ol>


<p><a href="/AC/AC-6582.json">JSON Source</a></p>