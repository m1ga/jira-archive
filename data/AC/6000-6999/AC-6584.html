---
title: "[AC-6584] iOS: ti.identity rare crash when when reading/updating KeychainItem value"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>n/a</td></tr>
<tr><th>Status</th><td>Open</td></tr>
<tr><th>Resolution</th><td>Unresolved</td></tr>

<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Titanium SDK & CLI</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Teun Klijn</td></tr>
<tr><th>Assignee</th><td>Abir Mukherjee</td></tr>
<tr><th>Created</th><td>2020-08-11T13:47:41.000+0000</td></tr>
<tr><th>Updated</th><td>2020-08-11T13:47:41.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary*

We're using ti.identity to store a user token in the iOS keychain, this goes well most of the time, but sometimes (about 7% of the time according to Firebase) an exception will occur:

<code><pre>
Crashed: com.apple.root.default-qos
EXC_BAD_ACCESS KERN_INVALID_ADDRESS 0x0000000000000020
__26-[APSKeychainWrapper read]_block_invoke

0  libobjc.A.dylib                0x1aec3bbf0 objc_retain + 16
1  MyApp                          0x10092b284 __26-[APSKeychainWrapper read]_block_invoke + 111 (APSKeychainWrapper.m:111)
2  libdispatch.dylib              0x1af488a38 _dispatch_call_block_and_release + 24
3  libdispatch.dylib              0x1af4897d4 _dispatch_client_callout + 16
4  libdispatch.dylib              0x1af42dc80 _dispatch_queue_override_invoke + 684
5  libdispatch.dylib              0x1af43a030 _dispatch_root_queue_drain + 372
6  libdispatch.dylib              0x1af43a8d4 _dispatch_worker_thread2 + 128
7  libsystem_pthread.dylib        0x1af66a1b4 _pthread_wqthread + 464
8  libsystem_pthread.dylib        0x1af66ccd4 start_wqthread + 4
</pre></code>

*Step to reproduce*

<h4>Add the example code to a Titanium classic project</h4>
<h4>Add the ti.identity module</h4>
<h4>Run the app on iOS and wait until the app crashes (usually within a couple of minutes)</h4>

NOTE: the actual app doesn't loop to update the KeychainItem, this is just an example.

<code><pre>
var TiIdentity = require('ti.identity');

var win = Ti.UI.createWindow({
  backgroundColor: '#fff',
});

var countLabel = Ti.UI.createLabel({
  width: Ti.UI.FILL,
  textAlign: Ti.UI.TEXT_ALIGNMENT_CENTER,
});
win.add(countLabel);

function updateKeychainItem(value, onResult) {
  var keychainItem = TiIdentity.createKeychainItem({
    identifier: 'password',
  });

  keychainItem.fetchExistence(function (eExistence) {
    if (eExistence.exists) {
      keychainItem.addEventListener('read', function (eRead) {
        if (!eRead.success) {
          onResult(eRead);
          return;
        }

        if (eRead.value != value) {
          keychainItem.addEventListener('update', onResult);
          keychainItem.update(value);
        } else {
          onResult({ success: true });
        }
      });
      keychainItem.read();
    } else {
      keychainItem.addEventListener('save', onResult);
      keychainItem.save(value);
    }
  });
}

win.addEventListener('open', function () {
  (function updateLoop(i) {
    updateKeychainItem('pass ' + i, function (e) {
      if (--i) updateLoop(i);
      countLabel.text = i;
    });
  })(100000);
});

win.open();
</pre></code>

*Expected result*

The app updates the KeychainItem a 100000 times.

*Actual result*

The app crashes before finishing the loop.

<h3>Comments</h3>

<p>No comments</p>

<p><a href="/AC/AC-6584.json">JSON Source</a></p>