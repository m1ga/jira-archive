---
title: "[ALOY-453] Fully support up and down migrations in sql adapter"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Resolved</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2013-01-17T20:04:56.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Alloy 0.3.5, 2013 Sprint 02</td></tr>
<tr><th>Components</th><td>Runtime</td></tr>
<tr><th>Labels</th><td>GA-candidate, notable</td></tr>
<tr><th>Reporter</th><td>Tony Lukasavage</td></tr>
<tr><th>Assignee</th><td>Unknown</td></tr>
<tr><th>Created</th><td>2013-01-09T15:37:09.000+0000</td></tr>
<tr><th>Updated</th><td>2018-03-07T22:26:00.000+0000</td></tr>
</table>

<h3>Description</h3>

When constructing a sql database from a series of migrations with no special parameters, we should assume that the latest migration is our target. With the latest migration as the target, we should call the up() function on all migrations before it (including the latest), starting with the last migration that has been executed in the app. down() functions should not be called unless a developer is rolling back a migration to an earlier one, for which we don't really have a method to do so yet anyway. This is not how it working right now in the sql adapter. 

The basic flow of applying migrations should be as follows:

<h4>Standard application flow, no explicit migration version specified</h4>
<h4>Get the "last migration" executed, which should be saved. Now it is being saved in the sqlite database, but if it doesn't exist it should be assumed that the first migration is the starting point.</h4>
<h4>Execute, in order, the up() function of all migrations from the starting migration to the latest migration.</h4>
<h4>Update the "last migration" in the sqlite database.</h4>

We should also add a way for developers to specify a specific migration to which they want their app to conform. We should add a parameter to the model config that allows them to pick that version:

<code><pre>
exports.definition = {
	config: {
		"columns": {
			"name":"text",
			"nickname":"text"
		},
		"adapter": {
			"type": "sql",
			"collection_name": "fighters",

               // this field determines whether the database is up to date,
               // or if it requires an upgrade or rollback
               "migration": "201209301904312"
		}
	}
}
</pre></code>

Notice the new migration field in "adapter". This tells the app which migration to conform to. The following shows the flow for upgrading and downgrading based on this version number.

<h4>config version same as "last" version</h4>
* Do nothing

<h4>config version is greater than "last" version</h4>
* Execute all up() functions, in order, on migrations greater than the "last" version and less than or equal to the config version

<h4>config version is less than "last" version</h4>
* Execute all down() functions, in reverse order, on migrations greater than config version and less than or equal to the "last" version 

<h3>Comments</h3>

<ol>
<li>Tony Lukasavage 2013-01-17

   Migrations testable up and down in: 
   
   * <a href="https://github.com/appcelerator/alloy/tree/master/test/apps/models/sql_keywords" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/tree/master/test/apps/models/sql_keywords</a>
   * <a href="https://github.com/appcelerator/alloy/tree/master/test/apps/models/sql_preload" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/tree/master/test/apps/models/sql_preload</a>
   * <a href="https://github.com/appcelerator/alloy/tree/master/test/apps/models/sql_queries" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/tree/master/test/apps/models/sql_queries</a></li>
</ol>


<p><a href="/ALOY/ALOY-453.json">JSON Source</a></p>