---
title: "[ALOY-728] Add a CLI command to extract i18n strings from alloy code and update the strings.xml files"
---
<table>
<tr><th>Type</th><td>New Feature</td></tr>
<tr><th>Priority</th><td>Low</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2013-07-22T21:45:29.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Alloy 1.2.0, 2013 Sprint 15</td></tr>
<tr><th>Components</th><td>Tooling</td></tr>
<tr><th>Labels</th><td>notable, qe-testadded</td></tr>
<tr><th>Reporter</th><td>Daniel Sefton</td></tr>
<tr><th>Assignee</th><td>Tony Lukasavage</td></tr>
<tr><th>Created</th><td>2013-06-26T20:28:15.000+0000</td></tr>
<tr><th>Updated</th><td>2013-07-30T00:00:35.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>update</h4>

The <code>alloy extract-i18n</code> command will inspect your TSS and JS files for instances of Titanium's localization functions:

* Titanium.Locale.getString()
* Ti.Locale.getString()
* L()

and when it finds them, it will take the i18n key from the first parameter (if it is a string) and add it as an entry to your target language's i18n strings.xml file. 

The syntax for calling <code>alloy extract-i18n</code> is as follows:

<code><pre>
// Shows a before and after of your i18n file, does NOT write the changes
$ alloy extract-i18n  

// Writes the changes to "i18n/en/strings.xml"
$ alloy extract-i18n --apply   

// Specify a different language with another parameter ("en" is the default)
$ alloy extract-i18n es

// Specify "es" as the language and write the changes to "i18n/es/strings.xml"
$ alloy extract-i18n es --apply
</pre></code>

This command, when applied with --apply, will only add new i18n entries. It will leave any existing entries untouched. So in general, <code>alloy extract-i18n --apply</code> is always safe, but just in case, we provide the preview functionality when not using --apply.


<h4>original</h4>

The alloy CLI tool is really useful and streamlines the development process. It should propose more tools to the Alloy developer.

One tool that i would have loved to have on one of our last projects is a tool to extract internationalized strings from the alloy code (either tss or js files).

The user could type:

<code><pre>
$ alloy extract-i18n <language>
</pre></code>

and this would introspect all the tss and js files, searching for i18n strings (those in the <code>L()</code> method) and adding the new strings to the i18n file for the requested language. If no <code>language</code> parameter is passed, the default language is used.

In order to act safely with precious i18n files, the behavior could only display the i18n strings found in the project, and only modify the i18n files if the <code>--force</code> option is passed.

This command:
<code><pre>
$ alloy extract-i18n fr
</pre></code>

Would display:
<code><pre>
[DEBUG] app/styles/account/create.tss: 5 strings found.
[DEBUG] app/styles/account/edit.tss: 13 strings found.

[DEBUG] ...

[INFO] Found 52 unique i18n strings in the code.
[INFO] Did not write the i18n file - please pass the "--force" option.
[INFO] Completed i18n extraction. Found 12 new strings.
</pre></code>

this means: "the tool has found 52 i18n strings in the app, 12 of them didn't exist in the <code>i18n/fr/strings.xml</code> file.


This command:
<code><pre>
$ alloy extract-i18n fr --force
</pre></code>

Would display:
<code><pre>
[DEBUG] app/styles/account/create.tss: 5 strings found.
[DEBUG] app/styles/account/edit.tss: 13 strings found.

[DEBUG] ...

[INFO] Found 52 unique i18n strings in the code.
[INFO] Did not write the i18n file - please pass the "--force" option.
[INFO] Completed i18n extraction. Found 12 new strings.
</pre></code>

Which means the same like the command before, except that, in that case, the strings are appended to <code>i18n/fr/strings.xml</code>.


note that:
* the tool must be clever enough to remove duplicates (if a string is used several times, it must appear only once in the i18n file)
* there could be another option to prune the messages that are not used in the app anymore, for instance <code>--prune</code>


This command proposal is inspired by [Symfony](<a href="http://symfony.com)" rel="nofollow" target="_blank">http://symfony.com)</a>'s <code>translation:update</code> command ([see its code](<a href="https://github.com/symfony/symfony/blob/master/src/Symfony/Bundle/FrameworkBundle/Command/TranslationUpdateCommand.php))" rel="nofollow" target="_blank">https://github.com/symfony/symfony/blob/master/src/Symfony/Bundle/FrameworkBundle/Command/TranslationUpdateCommand.php))</a>, which allows to perform the same type of operation within this PHP framework.

<h3>Comments</h3>

<ol>
<li>Tony Lukasavage 2013-07-22

   PR: <a href="https://github.com/appcelerator/alloy/pull/194" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/194</a>
   test app: <a href="https://github.com/appcelerator/alloy/tree/master/test/apps/testing/ALOY-728" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/tree/master/test/apps/testing/ALOY-728</a>
   
   Significant refactoring and changes were made to the original PR. The code was made much safer, cleaner, and more powerful. You can peruse the PR for full details, but the highlights are:
   
   <h4>Now supports searching for <code>Ti.Locale.getString()</code> and <code>Titanium.Locale.getString()</code>, not just <code>L()</code></h4>
   <h4>The regex for matching more closely follows the guidelines set forth for i18n keys in the wiki</h4>
   <h4>Handles the situation where there's no i18n folder, or no strings.xml file</h4>
   <h4>Fixed a few argument handling bugs</h4>
   <h4>merge() code now merges successfully instead of overwriting the existing strings.xml file with only the new keys</h4>
   <h4>I created a new option "-A, --apply" for writing the i18n files, instead of "-f, --force}}. --force feels like you're doing something wrong, --apply feels cleaner.</h4>
   <h4>Calling <code>alloy extract-i18n</code> without --apply will show you a before and after of the target strings.xml file. </h4>
   <h4>Calling <code>alloy extract-i18n --apply</code> will not totally overwrite the existing strings.xml file, but will instead append nodes to the end of the list. This helps preserve the file formatting previous to using <code>alloy extract-i18n</code>.</h4>
   <h4>Underscore.js functions were used in a number of places to make the code a bit tighter.</h4>
   <h4>File writes use <code>os.EOL</code> instead of <code>\n</code> so that the files print correctly on all host OSes.</h4>
   <h4>Added a test app for ensuring it works as expected</h4>
   
   That should cover it. :)
   
   Functional testing should execute the following steps:
   
   <h4>Run the test app (ALOY-728)</h4>
   <h4>You should see a label on the screen that says "nothing assigned yet"</h4>
   <h4>After the app starts, delete the existing *i18n* folder</h4>
   <h4>Run <code>alloy extract-i18n</code>. You should see a before and after that looks like this:</h4>
   <code><pre>
   [INFO] ######## BEFORE ########
   <?xml version="1.0" encoding="UTF-8"?><resources>
   </resources>
   [INFO] ######## AFTER  ########
   <?xml version="1.0" encoding="UTF-8"?><resources>
   <?xml version="1.0" encoding="UTF-8"?><resources>
     <string name="foo">foo</string>
     <string name="foo1good">foo1good</string>
     <string name="found_me">found_me</string>
     <string name="thekey1">thekey1</string>
     <string name="thekey2">thekey2</string>
     <string name="thekey3">thekey3</string>
     <string name="tester">tester</string>
   </resources>
   </resources>
   </pre></code>
   <h4>Next run <code>alloy extract-i18n --apply</code></h4>
   <h4>Ensure that after running the above command that the *i18n/en/strings.xml* file contains the contents that you saw in the previous "after" data.</h4>
   <h4>Run <code>alloy extract-i18n --apply</code> again. You should get a warning message telling you that there's nothing to do since the file is already up to date.</h4>
   <h4>Run <code>alloy extract-i18n --apply es</code>.</h4>
   <h4>Ensure that after running the above command that the *i18n/es/strings.xml* file contains the contents that you saw in the previous "after" data.</h4>
   <h4>Go into the *i18n/en/strings.xml* and change the value for the "tester" key to "I work!"</h4>
   <h4>Make sure that your testing emulator/simulator/device is set for english language</h4>
   <h4>Restart the app</h4>
   <h4>You should see a label that says "I work!" now </h4></li>
<li>Federico Casali 2013-07-30

   Verified as working as expected.
   
   Titanium SDK 3.1.2.v20130726192706
   Alloy 1.2.0-alpha
   Appcelerator Studio 3.1.3.201307252418
   CLI 3.1.2
   Node 0.8.22
   
   Android 4.1.2 device and iOS 5 (6.1.4)
   
   Closing.</li>
</ol>


<p><a href="/ALOY/ALOY-728.json">JSON Source</a></p>