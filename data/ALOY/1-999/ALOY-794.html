---
title: "[ALOY-794] Alloy Conditional code not functional"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2014-01-21T22:28:19.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Alloy 1.1.2</td></tr>
<tr><th>Fix Version/s</th><td>Alloy 1.4.0</td></tr>
<tr><th>Components</th><td>Runtime</td></tr>
<tr><th>Labels</th><td>alloy, qe, qe-closed-3.3.0, qe-manualtest</td></tr>
<tr><th>Reporter</th><td>Mason Zhang</td></tr>
<tr><th>Assignee</th><td>Tony Lukasavage</td></tr>
<tr><th>Created</th><td>2013-08-17T12:43:42.000+0000</td></tr>
<tr><th>Updated</th><td>2014-11-20T18:20:27.000+0000</td></tr>
</table>

<h3>Description</h3>

Q&A: <a href="http://developer.appcelerator.com/question/156082/alloy-compiler-conditional-code-not-work" rel="nofollow" target="_blank">http://developer.appcelerator.com/question/156082/alloy-compiler-conditional-code-not-work</a>

Add code below in a controller code:

<code><pre>
if(OS_ANDROID) {
	function aaa() {
		Ti.API.info('android aaa');
	}
}
else {
	function bbb() {
		Ti.API.info('not android bbb');
	}
}

if(OS_IOS) {
	function aaa() {
		Ti.API.info('ios aaa');
	}
}
else {
	function bbb() {
		Ti.API.info('not ios bbb');
	}
}

setTimeout(aaa, 0);
setTimeout(bbb, 0);
</pre></code>

The compiled code is:
<code><pre>
    function aaa() {
        Ti.API.info("android aaa");
    }
    function bbb() {
        Ti.API.info("not android bbb");
    }
    function aaa() {
        Ti.API.info("ios aaa");
    }
    function bbb() {
        Ti.API.info("not ios bbb");
    }
    setTimeout(aaa, 0);
    setTimeout(bbb, 0);
</pre></code>

<h3>Comments</h3>

<ol>
<li>Tony Lukasavage 2013-08-17

   As noted in the Q&A, this is an issue with putting function declarations inside a block, which is a bad practice in Javascript as function declarations have top-level scope. The fix for the issue is to properly structure the blocks using function expressions instead, like this:
   
   <code><pre>
   var aaa, bbb;
    
   if(OS_ANDROID) {
       aaa = function() {
           Ti.API.info('android aaa');
       }
   }
   else {
       bbb = function() {
           Ti.API.info('not android bbb');
       }
   }
    
   if(OS_IOS) {
       aaa = function() {
           Ti.API.info('ios aaa');
       }
   }
   else {
       bbb = function() {
           Ti.API.info('not ios bbb');
       }
   }
    
   $.index.open();
    
   aaa();
   bbb();
   </pre></code>
   
   Seeing as how these are supposed to be "compiler" conditionals, though, I will look into the possibility of having this work. I'm hesitant, though, and unlikely to change it as it could inadvertantly promote a bad Javascript practice.</li>
<li>Mason Zhang 2013-08-17

   The discussion on forum: <a href="http://developer.appcelerator.com/question/156082/alloy-compiler-conditional-code-not-work" rel="nofollow" target="_blank">http://developer.appcelerator.com/question/156082/alloy-compiler-conditional-code-not-work</a></li>
<li>Mason Zhang 2013-08-18

   More to add:
   
   I took some time to change all the function definition to function expression. But got other issues. Here are sample code:
   
   still on Mac OS X 10.7, iOS simulator, TI 3.1.2.GA, Alloy 1.2.0
   
   view.xml
   
   <View id="buttonGroup" platform="ios">
     <Button id="startButton" onClick="start"/>
     <Button id="interruptButton" onClick="interrupt"/>
   </View>
   
   controller.js
   
   var interrupt = function() {
       debugger;
   }
   
   This function will be executed twice when click the button.
   but if I change the code back to this way:
   
   function interrupt() {
       debugger;
   }
   
   This works fine.
   
   Finally it should be still the conditional code issue:
   
   my view.xml
   ~~~
           <View id="timerView">
               <View id="buttonGroup" platform="android">
                   <ImageView id="startButton" onClick="start"/>
                   <ImageView id="interruptButton" onClick="interrupt"/>
               </View>
               <View id="buttonGroup" platform="ios">
                   <Button id="startButton" onClick="start"/>
                   <Button id="interruptButton" onClick="interrupt"/>
               </View>
           </View>
   ~~~
   
   the generated code:
   ~~~
       __defers["$.__views.startButton!click!start"] && $.__views.startButton.addEventListener("click", start);
       __defers["$.__views.interruptButton!click!interrupt"] && $.__views.interruptButton.addEventListener("click", interrupt);
       __defers["$.__views.startButton!click!start"] && $.__views.startButton.addEventListener("click", start);
       __defers["$.__views.interruptButton!click!interrupt"] && $.__views.interruptButton.addEventListener("click", interrupt);
   ~~~
   
   The defers are duplicated. So if I use function definition, then everything works because defer will not be used. But if I use function expression, then there will be trouble.
   
   I still think this kind of issue is too bad for developers, the code just silently wrong.
   </li>
<li>Mason Zhang 2013-08-18

   You'd better increase the priority of this defect. The code will be silently wrong. This really hurt!</li>
<li>Tony Lukasavage 2013-08-18

   [~aladdina] please try to use the appopriate code formatting tags. Your responses are very hard to read. I bumped up the priority a bit, but as this issue is pretty easy to workaround just by slight restructuring of your code, it will likely wait til the next minor release of alloy.</li>
<li>Tony Lukasavage 2014-01-21

   The original issue of nesting function declarations inside conditionals in Javascript is not going to be addressed for the reasons already mentioned. Even further, under the condition of "use strict" in Javascript, this code is not even valid.
   
   Concerning the multiple instances of event handlers showing up in code when you refactored to avoid the aforementioned issue, I have addressed it. It was resolved as a result of ALOY-851.</li>
<li>Deepti Pandey 2014-05-14

   Verified as FIXED using :
   Mac :10.9.2
   Appcelerator Studio, build: 3.3.0.201405121247
   SDK - 3.3.0.v20140513191712
   acs-1.0.14
   alloy-1.4.0-dev
   npm-1.3.2
   titanium-3.3.0-dev
   titanium-code-processor-1.1.1
   Xcode :5.1.1
   
   Alloy conditional code are functional and working as expected.
   Hence closing as FIXED.</li>
</ol>


<p><a href="/ALOY/ALOY-794.json">JSON Source</a></p>