---
title: "[ALOY-817] Wrong method used to add an event listener when using custom namespace in markup"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2013-09-04T20:57:13.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Alloy 1.2.1, Alloy 1.2.0</td></tr>
<tr><th>Fix Version/s</th><td>Alloy 1.3.0, Alloy 1.2.2, 2013 Sprint 18</td></tr>
<tr><th>Components</th><td>XML</td></tr>
<tr><th>Labels</th><td>qe-testadded</td></tr>
<tr><th>Reporter</th><td>Davide Cassenti</td></tr>
<tr><th>Assignee</th><td>Tony Lukasavage</td></tr>
<tr><th>Created</th><td>2013-09-04T15:53:30.000+0000</td></tr>
<tr><th>Updated</th><td>2013-09-05T19:30:25.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Problem description</h4>
When adding an onClick event to a Map view (using the Android Map module), instead of using addEventListener, alloy is using on().

<h4>Steps to reproduce</h4>
1) Create a new Alloy app
2) Use the following code in index.xml:

<code><pre>
&lt;Alloy&gt;
  &lt;Window&gt;
    &lt;View id="map2" ns="Alloy.Globals.Map" onClick="report"/&gt;
  &lt;/Window&gt;
&lt;/Alloy&gt;
</pre></code>

Add a report function in index.js:

<code><pre>
function report(event) {
  alert('Hello');
}

$.index.open();
</pre></code>

Assign the value to Alloy.Globals.Map in alloy.js:

<code><pre>
Alloy.Globals.Map = Ti.Platform.osname === 'android' ? require('ti.map') : Ti.Map;
</pre></code>

<h4>Results</h4>
When running the app, the result of the onClick is:

<code><pre>
.__views.map2 = Alloy.Globals.Map.createView({
    id: "map2",
    ns: "Alloy.Globals.Map"
});
$.__views.index.add($.__views.map2);
report ? $.__views.map2.on("click", report) : __defers["$.__views.map2!click!report"] = true;
</pre></code>

Using the normal Ti.Map, the listener is added using addEventListener.

<h4>workaround</h4>

Don't specify the event listener in the markup, just do it in the controller

<code><pre>
$.map2.addEventListener('click', function(e) {});
</pre></code>

<h3>Comments</h3>

<ol>
<li>Tony Lukasavage 2013-09-04

   PR (master): <a href="https://github.com/appcelerator/alloy/pull/239" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/239</a>
   commit (1_2_X): <a href="https://github.com/appcelerator/alloy/commit/05ad3e792d3e5f45a7df592dcbdc82cbd6e07999" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/commit/05ad3e792d3e5f45a7df592dcbdc82cbd6e07999</a>
   test app: <a href="https://github.com/appcelerator/alloy/tree/master/test/apps/testing/ALOY-817" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/tree/master/test/apps/testing/ALOY-817</a>
   
   This fixed attaching event listeners to developer-defined namespace objects. From now on, only the following markup element types will use <code>on()</code> for event handling. All other will use <code>addEventListener()</code>:
   
   * <Collection>
   * <Model>
   * <Require>
   * <Widget>
   
   functional test:
   
   <h4>Run test app </h4>
   <h4>Ensure that the app loads without compile or runtime error</h4>
   <h4>Check the console output. Ensure that you see all 7 event handlers fire their log messages. The list should contain the following:</h4>
   <code><pre>
   [INFO]  collection change
   [INFO]  model change
   [INFO]  another model change
   [INFO]  button clicked
   [INFO]  map clicked
   [INFO]  window clicked
   [INFO]  empty controller init
   </pre></code>
   <h4>If all 7 event handlers fired, it's not completely necessary, but you can inspect the generated code for the "index" and "empty" controllers, making sure that <code>on</code> is used for all models, collection, and controllers while <code>addEventListener</code> is used for everything else, including the map.</h4></li>
<li>Federico Casali 2013-09-05

   Verified as fixed with the provided sample code.
   
   Also verified checking 'index' and 'empty' controllers, 'on' is used for models, collections and controllers, while addEventListener is used for everything else (window, map , button... )
   
   Titanium SDK  .1.3.v20130904134612
   Alloy 1.2.2
   CLI 3.1.2.GA
   Node 0.10.13
   
   Closing.</li>
</ol>


<p><a href="/ALOY/ALOY-817.json">JSON Source</a></p>