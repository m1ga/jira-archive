---
title: "[ALOY-897] Adding a Widget that uses arguments to a controller's XML causes a Proxy leak"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2014-01-06T17:39:18.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Alloy 1.2.2</td></tr>
<tr><th>Fix Version/s</th><td>Alloy 1.4.0</td></tr>
<tr><th>Components</th><td>Widgets</td></tr>
<tr><th>Labels</th><td>qe-closed-3.3.0, qe-testadded</td></tr>
<tr><th>Reporter</th><td>Alan Leard</td></tr>
<tr><th>Assignee</th><td>Tony Lukasavage</td></tr>
<tr><th>Created</th><td>2013-12-06T01:09:05.000+0000</td></tr>
<tr><th>Updated</th><td>2014-05-14T09:52:13.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Description</h4>
Proxies do not get released from a window that has a widget added to in in the XML (widget has to be using arguments).

<h4>Repro Steps</h4>
-Build attached app.
-Open Xcode Instruments.
-Open the new window, then close it.
-Repeat several times and you will find that Proxies are retained while UIViews are released.
-Comment out line 4 of LandingPage.xml to remove the widget, then repeat steps.  The leak goes away.

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/ALOY/ALOY-897_44430/SprintProxyTest.zip">SprintProxyTest.zip</td></td><td>2013-12-06T01:09:05.000+0000</td><td>5071174</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Tony Lukasavage 2013-12-06

   Found the root of the issue, and Alan's hint that it required arguments being passed to the widget is what helped me find it. At the beginning of the loading widget's controller, all arguments are attached to the loading UI proxy, like this:
   
   <code><pre>
   var args = arguments[0] || {};
   
   for (var k in args) {
   	$.loading[k] = args[k];
   }
   </pre></code>
   
   This is meant to attach any arguments passed through <Widget> to the actual loading UI proxy. What the developer of the widget doesn't see is that Alloy also attached hidden properties to the widget's argument list as well that help it understand things like where it is in the view hierarchy, or if it is part of data binding. In this particular case, the <code>__parentSymbol</code> property, which holds a reference to the parent of this widget, is being attached to the loading UI proxy. When the widget is removed, it retains this <code>__parentSymbol</code> reference unbeknownst to the developer, and in turn stays in memory since this reference is never nulled out, and hence the seemingly unavoidable memory leak.
   
   So technically this memory leak is not inherent in Alloy, but is a result of the widget attempting to iterate through all given arguments and attach them to the proxy without validation. It is actually really easy for the widget to be updated to avoid this. That said, the hidden properties Alloy attaches should not be enumerable, and this type of problem should not even be possible.
   
   Here's what will be done:
   
   <h4>Make a small modification to the loading widget to more deliberately handle the incoming arguments, which would prevent the memory leak in this widget and address the immediate problem.</h4>
   <h4>Use the <code>Object.defineProperty()</code> function to make Alloy's hidden variables non-enumerable, which would prevent any other widgets from falling victim to this trap.</h4></li>
<li>Tony Lukasavage 2013-12-06

   The loading widget, the only builtin Alloy widget affected by this, has been fixed in ALOY-898. The underlying issue yet to be addressed here can be worked around on of 2 ways in the meantime:
   
   <h4>Don't blindly iterate over the properties in the "args" object as they will contain Alloy hidden properties</h4>
   <h4>Use the following code snippet to safely ignore Alloy hidden properties when iterating over "args":</h4>
   <code><pre>
   var args = arguments[0] || {};
   
   for (var k in args) {
           // Ignore Alloy hidden properties to work around ALOY-897
           if (k === 'id' || /^(?:__|#|$)/.test(k)) { continue; }
   
           $.loading[k] = args[k];
   }
   </pre></code></li>
<li>Tony Lukasavage 2014-01-06

   PR: <a href="https://github.com/appcelerator/alloy/pull/294" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/294</a>
   
   Functional test can be run against the app given in the description to ensure that no memory leaks occur.</li>
<li>Priya Agarwal 2014-05-14

   Verified the FIXED with:
   Appc-Studio:3.3.0.201405121247
   sdk:3.3.0.v20140513191712
   acs:1.0.14
   alloy:1.4.0-dev
   npm:1.3.2
   titanium:3.3.0-dev
   titanium-code-processor:1.1.1
   xcode:5.1.1
   Device:Iphone Simulator(v7.1)
   
   Ran the app found no memory leaks.
   Working as expected. Hence closing the issue.</li>
</ol>


<p><a href="/ALOY/ALOY-897.json">JSON Source</a></p>