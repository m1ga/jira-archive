---
title: "[ALOY-900] Create a new table with Alloy and pre-built db"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2014-04-16T14:49:38.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Alloy 1.4.0, 2014 Sprint 08</td></tr>
<tr><th>Components</th><td>Models</td></tr>
<tr><th>Labels</th><td>alloy, notable, qe-testadded</td></tr>
<tr><th>Reporter</th><td>David Benko</td></tr>
<tr><th>Assignee</th><td>Tim Poulsen</td></tr>
<tr><th>Created</th><td>2013-12-12T18:25:45.000+0000</td></tr>
<tr><th>Updated</th><td>2014-05-15T21:04:50.000+0000</td></tr>
</table>

<h3>Description</h3>

Creating a new table with a pre-build db fails because Alloy executes "pragma table_info" to get columns information:

<code><pre> 
12-11 19:04:30.728: E/TiExceptionHandler(13828): (main) [366,366] ----- Titanium Javascript Runtime Error -----
12-11 19:04:30.728: E/TiExceptionHandler(13828): (main) [0,366] - In alloy/sync/sql.js:11,69
12-11 19:04:30.733: E/TiExceptionHandler(13828): (main) [1,367] - Message: Uncaught TypeError: Cannot call method 'isValidRow' of null
12-11 19:04:30.733: E/TiExceptionHandler(13828): (main) [0,367] - Source: base.install(b,d),d=b.execute('pragma table_info("'+e+'");'),f={};d.isValidRow
12-11 19:04:30.733: E/V8Exception(13828): Exception occurred at alloy/sync/sql.js:11: Uncaught TypeError: Cannot call method 'isValidRow' of null
</pre></code> 

Detailed problem:

<a href="http://developer.appcelerator.com/question/160374/alloy--migrations---create-new-table-with-migrations" rel="nofollow" target="_blank">http://developer.appcelerator.com/question/160374/alloy--migrations---create-new-table-with-migrations</a>

<h3>Comments</h3>

<ol>
<li>Ritu Agrawal 2013-12-15

   Moving this issue to Alloy project based on Tony's recommendation on the Q&A thread.</li>
<li>Ritu Agrawal 2013-12-15

   FYI - JIRA changed the reporter to "me" when I moved this ticket from TC to ALLOY and I don't have permission to change it back. This issue was originally reported by [~davidbenko].</li>
<li>Nils Sdun 2014-02-22

   Possible Solution:
   Place following code in sql.js in line 271.
   It will create a Table from a Model if it doesnÂ´t exist. If no columns given in the model, the ALLOY_ID_DEFAULT will be taken.
   
   <code><pre>
   if(rs == null) {
       var idAttribute = ALLOY_ID_DEFAULT;
       if(config.adapter.idAttribute) {
           idAttribute = config.adapter.idAttribute; 
       }
       var columns = [];
       var found = false;
       for (var k in config.columns) { 
           k === idAttribute && (found = true); 
           columns.push(k + " " + config.columns[k]); 
       }
       found || columns.push(idAttribute + " TEXT UNIQUE");
       db.execute( 'CREATE TABLE ' + table + ' (' + columns.join(", ") + ');' );
       var rs = db.execute('pragma table_info("' + table + '");'); 
   }
   </pre></code></li>
<li>Tim Poulsen 2014-03-14

   PR <a href="https://github.com/appcelerator/alloy/pull/347" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/347</a>
   
   Test app included: test/apps/testing/ALOY-900
   
   This change adds support for a few scenarios: 
   
   * Existing model, which points to an external database, with a migration file used to define a new table in that database
   * Existing external database, add a new table by simply defining a new model file and instantiating it in a controller, no migration needed
   * Alloy-created database, add a new table by simply defining a new model file and instantiating it in a controller, no migration needed
   
   Functional test:
   
   1. Run the test app in the iOS simulator
   2. Open ~/Library/Application Support/iPhone Simulator/VERSION/GUID/Library/Private Documents folder to find the generated sqlite database file
   3. Use a SQLite tool, such as the SQLite Manager plugin for Firefox to open that file. It will contain a table named weather with three columns, city, id, and bogusField as defined in the migration
   4. Delete the app from the simulator
   5. Rename the migrations folder or delete it so that it's not used
   6. Repeat steps 1-3, this time the database's table structure will match the table definition in the models/weather.js file
   7. Delete the app from the simulator
   8. Edit the models/weather.js file to remove the db_file property from the adapter config.
   9. Repeat steps 1-3 to create the standard _alloy_.sql file. It will contain the tables as defined in the model</li>
<li>Tim Poulsen 2014-03-14

   Sorry, not supposed to Resolve till the PR is merged.</li>
<li>Tim Poulsen 2014-04-16

   PR merged</li>
<li>Lokesh Choudhary 2014-05-15

   Ran through the functional test steps mentioned by [~skypanther]. All steps worked as expected.
   
   Closing.
   
   Environment:
   Appc Studio : 3.3.0.201405121247
   Ti SDK : 3.3.0.v20140514163013
   Mac OSX : 10.8.5
   Alloy : 1.4.0-alpha
   CLI - 3.3.0-dev
   iPhone simulator : 7.1 64-bit</li>
</ol>


<p><a href="/ALOY/ALOY-900.json">JSON Source</a></p>