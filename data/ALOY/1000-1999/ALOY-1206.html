---
title: "[ALOY-1206] Alloy compiler doesn't regenerate controllers if only change is made to the distribution target"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Resolved</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2015-01-13T08:09:27.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Alloy 1.5.1</td></tr>
<tr><th>Fix Version/s</th><td>Alloy 1.7.0</td></tr>
<tr><th>Components</th><td>Tooling</td></tr>
<tr><th>Labels</th><td>compiler, optimalization</td></tr>
<tr><th>Reporter</th><td>Fokke Zandbergen</td></tr>
<tr><th>Assignee</th><td>Tim Poulsen</td></tr>
<tr><th>Created</th><td>2014-12-12T22:04:41.000+0000</td></tr>
<tr><th>Updated</th><td>2015-01-13T08:09:27.000+0000</td></tr>
</table>

<h3>Description</h3>

When building for a different target environment (development, test or production) conditional code in <code>app/alloy.js</code> is not updated in <code>Resources/\[platform\]/app.js</code>. This can cause serious errors when relying on the conditions for particular behaviour in ad-hoc and app store builds.

<h4>Test case</h4>

1. Create a project: <code>ti create -t app -p ios -n conditions --id test.conditions -d .</code>
2. Make it Alloy: <code>cd conditions && alloy new</code>
3. Insert the following snippet in both <code>app/alloy.js</code> and <code>app/controllers/index.js</code>:

<code><pre>
if (ENV_PRODUCTION) console.debug('if (ENV_PRODUCTION)');
if (ENV_TEST) console.debug('if (ENV_TEST)');
if (ENV_DEV) console.debug('if (ENV_DEVELOPMENT)');
</pre></code>

4. Build the production for Simulator: <code>ti build -p ios -b</code>
5. Confirm that both <code>Resources/iphone/app.js</code> and <code>Resources/iphone/alloy/controllers/index.js</code> only have <code>console.debug("if (ENV_DEVELOPMENT)");</code> which is correct
6. Build for ad-hoc or to device: <code>ti build -p ios --target dist-adhoc</code>
7. Confirm that <code>Resources/iphone/app.js</code> still has <code>console.debug("if (ENV_DEVELOPMENT)");</code> while <code>Resources/iphone/alloy/controllers/index.js</code> is correctly updated to have <code>console.debug("if (ENV_PRODUCTION)");</code>

<h3>Comments</h3>

<ol>
<li>Tim Poulsen 2014-12-17

   Alloy's compilation process attempts to speed the operation by skipping some portions of the process if files are reasonably expected to be unchanged. The algorithm does not currently consider build target changes, though it appears it should.
   
   As a workaround, update one or more JS files in your app so that the app's controllers are regenerated with the updated values.</li>
<li>Fokke Zandbergen 2014-12-18

   That workaround doesn't work... it's about the <code>alloy.js</code>.
   
   The related code is at:
   <a href="https://github.com/appcelerator/alloy/blob/master/Alloy/commands/compile/index.js#L349-L352" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/blob/master/Alloy/commands/compile/index.js#L349-L352</a></li>
<li>Tim Poulsen 2014-12-29

   PR <a href="https://github.com/appcelerator/alloy/pull/646" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/646</a> 
   
   What I've done is update the Orphanage / controller-reuse logic to always regenerate app.js & controllers/index.js when building for something other than a development target (test, dist-adhoc, dist-appstore, etc.). 
   
   Functional test using Fokke's steps above. Additionally, you can/should check that controllers are regenerated with <code>ti build -p ios -T device</code></li>
<li>Feon Sua Xin Miao 2015-01-13

   PR merged.</li>
</ol>


<p><a href="/ALOY/ALOY-1206.json">JSON Source</a></p>