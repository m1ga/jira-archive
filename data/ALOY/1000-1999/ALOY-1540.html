---
title: "[ALOY-1540] npm node_modules are erroring when compiling"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Reopened</td></tr>
<tr><th>Resolution</th><td>Unresolved</td></tr>

<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>alloy 1.9.11</td></tr>
<tr><th>Components</th><td>Tooling</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Creative</td></tr>
<tr><th>Assignee</th><td>Feon Sua Xin Miao</td></tr>
<tr><th>Created</th><td>2017-01-31T14:07:53.000+0000</td></tr>
<tr><th>Updated</th><td>2019-09-05T15:59:17.000+0000</td></tr>
</table>

<h3>Description</h3>

I believe it was said that Ti SDK 6.0.0+ came with full node support. This should include installation of npm modules as well. Sadly, a lot of modules are not passing the compilation process of titanium, because they do not follow a certain convention.

One of those error messages would be:

<code><pre>
[ERROR] Error generating AST for "/Users/john/Documents/Appcelerator_Studio_Workspace/myapp/Resources/iphone/node_modules/glob/test/00-setup.js"
[ERROR] 'return' outside of function
[ERROR] line 82, position 1779
[ERROR] Alloy compiler failed
</pre></code>

Testcase:

Create a package.json (regular npm setup) inside app/lib so the packages come available during runtime. Install for instance <code>mocha</code> (<a href="https://www.npmjs.com/package/mocha)." rel="nofollow" target="_blank">https://www.npmjs.com/package/mocha).</a> There are many more packages that will fail the compilation process once installed into /app.

<code>app/lib/package.json</code>

<code><pre>
{
  "name": "myapp",
  "description": "myapp",
  "private": true,
  "dependencies": {
  },
  "devDependencies": {
    "mocha": "2.5.3",
    "should": "7.1.1",
    "ti-mocha": "0.2.0"
  }
}

</pre></code>

run <code>npm install</code> in this directory to install the module.

I recommend installing a lot of packages, and determine if they pass the Alloy compiler. Every compilation should pass.


<h3>Comments</h3>

<ol>
<li>Feon Sua Xin Miao 2017-02-01

   [~hansknoechel],  Alloy compile uses Uglifyjs to create ast of js files. For the reported error, <code>'return' outside of function</code>, it looks like an issue with Uglifyjs, which tries to be spec-compliant and does not like global scope returns. There could be other issues with uglify a commonJS module. I'm looking into this.
   
   [~cwilliams], it'll also be an issue with SDK uglifying npm modules files under <code>/Resources</code> dir TIMOB-24373.
   
   </li>
<li>Feon Sua Xin Miao 2017-02-01

   PR: <a href="https://github.com/appcelerator/alloy/pull/814" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/814</a></li>
<li>Chris Barber 2017-04-04

   The version of uglify-js that Alloy uses is a bit out-of-date. I'd be surprised if the new version tolerated <code>return</code> outside of functions. We had talks of changing the build process so that any Uglify exceptions would just be warnings and not stop the build, however in Alloy's case, I'm pretty sure it needs a valid AST to generate the app.</li>
<li>Creative 2017-04-05

   </li>
<li>Feon Sua Xin Miao 2017-04-05

   Alloy compile needs valid AST of controller to generate the app, it doesn't need to parse AST of the files in <code>app/lib</code>, they are copied to <code>Resources</code>. The question is does Alloy need to optimize all files under <code>app/lib</code> or <code>app/lib/node_modules</code>? Alloy can skip those files then we need to take care of TIMOB-24373.</li>
<li>Chris Barber 2017-04-05

   [~uzbbert] That's a great find, however we use UglifyJS, not UglifyJS2, and UglifyJS doesn't appear to have this option. :(</li>
<li>Chris Barber 2017-04-05

   [~fmiao] Alloy should never optimize anything in a node_modules directory.</li>
<li>Feon Sua Xin Miao 2017-04-07

   PR merged.</li>
<li>Jason Kneen 2019-09-05

   This is still an issue. Ti 8.1.1.GA, Alloy 1.14.0
   
   1. create new project
   2. create package.json in app/lib
   3. in *app/lib* do *npm install cryptlib* (for example)
   4. build the project
   
   Fails with 
   
   <code>[ERROR] Alloy compiler failed</code>
   
   Doing a trace log shows:
   
   {{[DEBUG] if (!process.env.SAUCE_KEY || !process.env.SAUCE_USER)
   [DEBUG]   return console.log('SAUCE_KEY and/or SAUCE_USER not set, not running sauce tests')
   [DEBUG] if (!/v0\.10/.test(process.version))
   [DEBUG]   return console.log('Not Node v0.10.x, not running sauce tests')
   [DEBUG] require('./sauce.js')
   [DEBUG]  
   [DEBUG] /Users/jkneen/.nvm/versions/node/v9.9.0/lib/node_modules/alloy/Alloy/commands/compile/sourceMapper.js:212
   [DEBUG]                 throw e;
   [DEBUG]                 ^
   [DEBUG] SyntaxError: 'return' outside of function (4:2)}}</li>
<li>Brenton House 2019-09-05

    I've created a PR that fixes this issue.   If this is accepted as a feature for Alloy, I will create PR against Alloy master.  
    <a href="https://github.com/brentonhouse/titanium-turbo/pull/52" rel="nofollow" target="_blank">https://github.com/brentonhouse/titanium-turbo/pull/52</a>
    </li>
<li>Chris Barber 2019-09-05

    [~bhouse] I'm fine with always enabling <code>allowReturnOutsideFunction: true</code>. I get why it's a flag, but many, many projects explicitly enable this feature including Titanium: <a href="https://github.com/appcelerator/node-titanium-sdk/blob/master/lib/jsanalyze.js#L77-L83." rel="nofollow" target="_blank">https://github.com/appcelerator/node-titanium-sdk/blob/master/lib/jsanalyze.js#L77-L83.</a></li>
<li>Chris Barber 2019-09-05

    I personally don't see a reason for a try/catch and I'd vote to have it removed from Titanium.</li>
</ol>


<p><a href="/ALOY/ALOY-1540.json">JSON Source</a></p>