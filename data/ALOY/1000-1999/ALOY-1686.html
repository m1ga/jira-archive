---
title: "[ALOY-1686] Alloy: App crashes due to context used when accessing Ti.Database API"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>None</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2019-05-16T13:38:31.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Alloy 1.13.9</td></tr>
<tr><th>Fix Version/s</th><td>CLI Release 7.0.12, Alloy 1.13.10</td></tr>
<tr><th>Components</th><td>Models</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Hans Knöchel</td></tr>
<tr><th>Assignee</th><td>Christopher Williams</td></tr>
<tr><th>Created</th><td>2019-05-02T09:27:34.000+0000</td></tr>
<tr><th>Updated</th><td>2019-05-17T14:05:35.000+0000</td></tr>
</table>

<h3>Description</h3>

The current master is broken due to changes in the Obj-C JSCore interface (TIMOB-26038):
<code><pre>
[ERROR] Script Error {
[ERROR]     column = 38;
[ERROR]     line = 214;
[ERROR]     message = "self type check failed for Objective-C instance method";
[ERROR]     sourceURL = "file:///Users/hans/Library/Developer/CoreSimulator/Devices/884D0F2B-46F2-41D5-AA78-C26BC42BF348/data/Containers/Bundle/Application/B1994734-79D4-40DD-9003-C940456A903D/Lambus.app/alloy/sync/sql.js";
[ERROR]     stack = "    at [native code]\n    at Sync(/alloy/sync/sql.js:214:38)\n    at sync(/alloy.js:92:22)\n    at fetch(/alloy/backbone.js:344:47)\n    at (/app.js:45:24)\n    at global code(/app.js:225:70)\n    at require@[native code]\n    at (/ti.main.js:8997:10)\n    at doLoad(/ti.main.js:8955:15)\n    at loadBootstrapScripts(/ti.main.js:8967:11)\n    at loadAsync(/ti.main.js:8972:23)\n    at global code(/ti.main.js:8994:10)";
[ERROR]     toJSON = "&lt;KrollCallback: 0x600000bfba40&gt;";
[ERROR] }
</pre></code>
Specifically, changes in <code>Ti.Database</code> seem to have caused this issues. It was triggered by Alloy models which use Backbone in the background which uses Ti.Database in the background.

To reproduce, simply create a new Alloy app and create a model as documented in the docs. For the core-team: This is also reproducible in the app you guys have access to.

*EDIT*: After investigating this, it seems like [this selector](<a href="https://github.com/appcelerator/titanium_mobile/pull/10381/files#diff-d0e600e43c92d0fe06ffee452771f44cR125)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10381/files#diff-d0e600e43c92d0fe06ffee452771f44cR125)</a> is causing the issues as it's referenced in the sql.js to get the field from the result-set at the specified index.

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2019-05-02

   cc [~cwilliams] [~jvennemann]</li>
<li>Hans Knöchel 2019-05-06

   Any update here? We're trying to stay on latest master to report back all issues, but this one is currently breaking us.</li>
<li>Hans Knöchel 2019-05-13

   Another attempt to ping this…Does this really need to slip into a GA again to get people's attention on this? Every app that uses Ti.Database will be broken and I have no idea how the unit tests could have allowed this to be merged.</li>
<li>Christopher Williams 2019-05-15

   So at first glance this looks to me like a latent bug in Alloy that happened not to trigger before (oddly). It plays around with the result set's field method a little:
   <code><pre>
   var getField = OS_ANDROID || OS_WINDOWS ? rs.field.bind(rs) : rs.field;
   </pre></code>
   
   Notice that on Windows or Android it uses bind to explicitly tie <code>this</code> to the ResultSet instance. On iOS it does not.
   
   As a result, <code>this</code> is implicitly the global object: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Function/bind" rel="nofollow" target="_blank">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Function/bind</a>
   
   Changing that line to always use bind on all platforms fixes the issue. Or simply calling <code>rs.field(i);</code> which is much more common usage - I'm not sure why this redirection was used in the first place.
   
   Note that we ran into this exact same bug before on Windows (using JSCore) in TIMOB-20577.</li>
<li>Christopher Williams 2019-05-15

   <a href="https://github.com/appcelerator/alloy/pull/930" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/930</a></li>
<li>Hans Knöchel 2019-05-15

   [~cwilliams] Issue fixed, thank you so much!!</li>
<li>Ewan Harris 2019-05-16

   1_13_X backport: <a href="https://github.com/appcelerator/alloy/pull/931" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/931</a></li>
<li>Samir Mohammed 2019-05-17

   </li>
<li>Samir Mohammed 2019-05-17

   Closing ticket also verified using CLI <code>7.1.0-master.16</code> with the above steps. </li>
</ol>


<p><a href="/ALOY/ALOY-1686.json">JSON Source</a></p>