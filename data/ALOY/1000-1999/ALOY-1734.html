---
title: "[ALOY-1734] JS files imported in "alloy.js" don't have access to Alloy globals as of Titanium 9.0.0"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2020-08-11T20:24:48.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>CLI Release 8.1.0</td></tr>
<tr><th>Components</th><td>n/a</td></tr>
<tr><th>Labels</th><td>alloy, globals, regression</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Ewan Harris</td></tr>
<tr><th>Created</th><td>2020-07-30T20:48:49.000+0000</td></tr>
<tr><th>Updated</th><td>2020-08-11T20:24:48.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
As of Titanium 9.0.0, a JS files loaded via <code>import</code> in the "alloy.js" won't have access to globals <code>Alloy</code>, <code>Backbone</code>, or <code>_</code> (aka: lodash).

This is not an issue if JS files are loaded via the <code>require()</code> function.

*Steps to reproduce:*
<h4>Download [kitchensink-v2](<a href="https://github.com/appcelerator/kitchensink-v2)." rel="nofollow" target="_blank">https://github.com/appcelerator/kitchensink-v2).</a></h4>
<h4>Open project file: <code>./app/lib/actionbar.js</code></h4>
<h4>Add the following line to the end of the JS file:</h4>
<code><pre>
console.log("@@@ Alloy = " + (typeof Alloy));
</pre></code>
<h4>Build and run on Android or iOS.</h4>
<h4>Notice the following gets logged as undefined.</h4>
<code><pre>
[INFO]  @@@ Alloy = undefined
</pre></code>

*Cause:*
Look at the "app.js" that gets generated. The babel transpile is turning the JavaScript <code>import</code> statement into a <code>require()</code> function call at the top of the "app.js", above where we assign <code>Alloy</code> globals. Also note that "var" variables in "app.js" and "alloy.js" no longer have global scope as of Titanium 9.0.0, which is why it wasn't an issue before.

The top of the generated "app.js" looks like this.
<code><pre>
var _actionbar=_interopRequireDefault(require("actionbar"));
function _interopRequireDefault(obj){
	return obj&&obj.__esModule?obj:{default:obj}
}
"use strict";
var Alloy=require("/alloy"),
	_=Alloy._,
	Backbone=Alloy.Backbone;
global.Alloy=Alloy,
global._=_,
global.Backbone=Backbone,
</pre></code>

*Note:*
JavaScript <code>import</code> statements are "hoisted". This is in the ES6 specification, which means this is not a babel transpile issue. So, <code>import</code> statements will always be executed first within the same JS file.

*Possible Fix:*
Add an "alloy.bootstrap.js" to the project and assign the Alloy globals there. Bootstrap scripts are loaded before the "app.js", which works-around the problem. This also means we can remove the global Alloy assignment from the generated "app.js".

*Work-Around:*
Don't <code>import</code> JS files in the "alloy.js". Use <code>require()</code> function instead.


<h3>Comments</h3>

<ol>
<li>Ewan Harris 2020-07-30

   Adding the bootstrap file will be the only solution here, bable is adhering to the modules spec by hoisting the import statements like they would if they were actually ran in a JS environment (as opposed to being transpiled) <a href="https://exploringjs.com/es6/ch_modules.html#_imports-are-hoisted" rel="nofollow" target="_blank">https://exploringjs.com/es6/ch_modules.html#_imports-are-hoisted</a></li>
<li>Joshua Quick 2020-07-31

   I can think of another solution.
   
   Instead of inserting the "alloy.js" code into the "app.js" template's <code>__MAPMARKER_ALLOY_JS__</code>, we could keep the "alloy.js" file and require it in instead.
   <a href="https://github.com/appcelerator/alloy/blob/master/Alloy/template/app.js" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/blob/master/Alloy/template/app.js</a>
   
   So Alloy's "app.js" code becomes the below.
   
   <code><pre>
   //app.js
   var Alloy = require('/alloy'),
   	_ = Alloy._,
   	Backbone = Alloy.Backbone;
   global.Alloy = Alloy;
   global._ = _;
   global.Backbone = Backbone;
   
   // Don't do this anymore.
   //__MAPMARKER_ALLOY_JS__
   
   // Require the "alloy.js" file instead.
   require('alloy');
   </pre></code>
   
   This means we're no longer generating an "app.js" and we would just copy this file and the developer's "alloy.js" as-is.</li>
<li>Hans Kn√∂chel 2020-08-01

   Could we also (as a workaround) move not only the Alloy.Globals but the whole alloy.js contents to the bootstrap? Does this affect boot time?</li>
<li>Joshua Quick 2020-08-03

   bq. Could we also (as a workaround) move not only the Alloy.Globals but the whole alloy.js contents to the bootstrap? Does this affect boot time?
   
   Yes, that's exactly what I'm suggesting. And it wouldn't effect the boot time. We would simply be loading the "alloy.js" sooner than before (ie: before the "app.js"). A bootstrap script can only add a delay when using its optional async execute function, which we're not going to do in this case.
   
   Also, it looks like JS imports being "hoisted" above JS statements is part of the ES6 specification. So, this isn't a babel issue. The babel transpile is doing the correct thing.</li>
<li>Ewan Harris 2020-08-05

   PR: <a href="https://github.com/appcelerator/alloy/pull/964" rel="nofollow" target="_blank">https://github.com/appcelerator/alloy/pull/964</a>
   
   I did some small tests to see how this impacted the startup time of KS-v2 on Android and there's averaged out I'm seeing similar numbers, I'll continue to try collect data and also get some results for iOS </li>
<li>Ewan Harris 2020-08-06

   Available in alloy 1.15.0 and appc CLI 8.1.0-master.9. Appc cli currently only preprod, so internal only</li>
<li>Satyam Sekhri 2020-08-11

   Verified on:
   Mac OS: 10.15.4
   SDK: 9.1.0.v20200810095016
   Appc CLI: 8.1.0-master.9
   JDK: 11.0.4
   Node: 10.17.0</li>
</ol>


<p><a href="/ALOY/ALOY-1734.json">JSON Source</a></p>