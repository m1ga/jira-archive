---
title: "[DAEMON-201] appcd-client: Accept-Language should not be set if locale is null"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>None</td></tr>
<tr><th>Status</th><td>Resolved</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-12-05T16:18:18.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Appc Daemon 1.0.0</td></tr>
<tr><th>Fix Version/s</th><td>Appc Daemon 1.1.0, Appc Daemon 1.0.1</td></tr>
<tr><th>Components</th><td>appcd-client</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Ewan Harris</td></tr>
<tr><th>Assignee</th><td>Ewan Harris</td></tr>
<tr><th>Created</th><td>2017-12-04T14:53:43.000+0000</td></tr>
<tr><th>Updated</th><td>2017-12-12T21:25:24.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Description</h4>

I was reviewing the test failures and noticed some Jenkins machines fail on the below test, as I understand it it's possible for the locale function in appcd-response to return null, so I believe it would make sense for appcd-client to have a default for the Accepts-Language header, which would probably be <code>en</code> or <code>*</code>.

Alternatively just fix the regex check to accept null.

<code><pre>
 1) Client request() should make a request to the mock server:
     AssertionError: expected 'null' to match /^([a-z]{2})(?:[-_](?:\w+[-_])?([A-Z]{2}))?$/i
      at WebSocket.conn.on.msg (test/test-client.js:159:49)
      at Receiver._receiver.onmessage (/Users/build/jenkins/workspace/cli_appc-daemon_master-XS2WQ2LFI3NLAO73KGNRAF6P26KUCWWAZBYDRU2BBMG2YHPP363A/node_modules/ws/lib/WebSocket.js:143:47)
      at Receiver.dataMessage (/Users/build/jenkins/workspace/cli_appc-daemon_master-XS2WQ2LFI3NLAO73KGNRAF6P26KUCWWAZBYDRU2BBMG2YHPP363A/node_modules/ws/lib/Receiver.js:389:14)
      at Receiver.getData (/Users/build/jenkins/workspace/cli_appc-daemon_master-XS2WQ2LFI3NLAO73KGNRAF6P26KUCWWAZBYDRU2BBMG2YHPP363A/node_modules/ws/lib/Receiver.js:330:12)
      at Receiver.startLoop (/Users/build/jenkins/workspace/cli_appc-daemon_master-XS2WQ2LFI3NLAO73KGNRAF6P26KUCWWAZBYDRU2BBMG2YHPP363A/node_modules/ws/lib/Receiver.js:165:16)
      at Receiver.add (/Users/build/jenkins/workspace/cli_appc-daemon_master-XS2WQ2LFI3NLAO73KGNRAF6P26KUCWWAZBYDRU2BBMG2YHPP363A/node_modules/ws/lib/Receiver.js:139:10)
      at Socket._ultron.on (/Users/build/jenkins/workspace/cli_appc-daemon_master-XS2WQ2LFI3NLAO73KGNRAF6P26KUCWWAZBYDRU2BBMG2YHPP363A/node_modules/ws/lib/WebSocket.js:139:22)
      at addChunk (_stream_readable.js:263:12)
      at readableAddChunk (_stream_readable.js:250:11)
      at Socket.Readable.push (_stream_readable.js:208:10)
      at TCP.onread (net.js:594:20)
</pre></code>

<h3>Comments</h3>

<ol>
<li>Chris Barber 2017-12-04

   <code>locale()</code> returning <code>null</code> is valid. <code>appcd-client</code> should probably only set the <code>Accept-Language</code> if the locale is not <code>null</code>.
   
   Internally, the <code>WebSocketSession</code> will pass the <code>Accept-Language</code> value to the <code>appcd-response</code> <code>Message.toString()</code> which in turn tolerates <code>null</code> locales.
   
   So this ticket comes down to not setting the locale if it's <code>null</code> and fixing the unit test in the event locale is <code>null</code>.</li>
<li>Ewan Harris 2017-12-05

   <a href="https://github.com/appcelerator/appc-daemon/pull/220" rel="nofollow" target="_blank">https://github.com/appcelerator/appc-daemon/pull/220</a></li>
<li>Chris Barber 2017-12-12

   1_0_X backport: <a href="https://github.com/appcelerator/appc-daemon/pull/247" rel="nofollow" target="_blank">https://github.com/appcelerator/appc-daemon/pull/247</a></li>
</ol>


<p><a href="/DAEMON/DAEMON-201.json">JSON Source</a></p>