---
title: "[DAEMON-285] Unsubscribe in external plugin service dispatcher not called when forcefully closing connection"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>None</td></tr>
<tr><th>Status</th><td>Resolved</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2019-09-24T15:04:24.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Appc Daemon 3.0.0</td></tr>
<tr><th>Fix Version/s</th><td>Appc Daemon 3.1.0</td></tr>
<tr><th>Components</th><td>appcd-plugin</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Jan Vennemann</td></tr>
<tr><th>Assignee</th><td>Jan Vennemann</td></tr>
<tr><th>Created</th><td>2019-09-24T10:18:38.000+0000</td></tr>
<tr><th>Updated</th><td>2019-09-24T15:04:32.000+0000</td></tr>
</table>

<h3>Description</h3>

Canceling a subscription to a service dispatcher in external plugins won't properly trigger the cleanup logic since the plugin isn't notified about the end of response stream like it is happening in internal plugins.

*Steps to reproduce the behavior*
<h4>Open a subscription to any internal plugin, e.g. <code>appcd exec /appcd/status/system/memory --subscribe</code>, and then cancel the subscription by CTRL+C</h4>
<h4>Notice that the subscription will be properly cleaned up as indicated by the following logs:</h4>
<code><pre>
2019-09-24T10:15:47.154Z appcd:http:webserver 127.0.0.1:59795 disconnected
2019-09-24T10:15:47.155Z appcd:http:webserver 127.0.0.1:59795 closed WebSocket
2019-09-24T10:15:47.155Z appcd:service-dispatcher cleanup
2019-09-24T10:15:47.155Z appcd:service-dispatcher Stream ended, cleaning up
2019-09-24T10:15:47.155Z appcd:service-dispatcher [782e2d4a-b194-4f9a-806f-9b3cfc47b2f3] Unsubscribing: system.memory
2019-09-24T10:15:47.155Z appcd:service-dispatcher [782e2d4a-b194-4f9a-806f-9b3cfc47b2f3] No more listeners, removing descriptor: system.memory
2019-09-24T10:15:47.156Z appcd:service-dispatcher [782e2d4a-b194-4f9a-806f-9b3cfc47b2f3] Calling service's destroySubscription(): system.memory
2019-09-24T10:15:47.156Z appcd:data-service-dispatcher Removing gawk watch
2019-09-24T10:15:47.156Z appcd:core:websocket-session stream ended
2019-09-24T10:15:47.157Z appcd:core:websocket-session [0] 127.0.0.1:59795 [finish] /appcd/status/system/memory 200 2874ms
</pre></code>
<h4>Now, do the same for an external plugin, e.g. run <code>appcd exec /titanium/latest/sdk --subscribe</code> and then cancel the subscription by CTRL+C</h4>
<h4>No subscription cleanup is done as you can see in the following logs</h4>
<code><pre>
2019-09-24T10:10:04.797Z appcd:http:webserver 127.0.0.1:59613 disconnected
2019-09-24T10:10:04.797Z appcd:http:webserver 127.0.0.1:59613 closed WebSocket
2019-09-24T10:10:04.798Z appcd:core:websocket-session stream ended
2019-09-24T10:10:04.798Z appcd:core:websocket-session [0] 127.0.0.1:59613 [finish] /titanium/latest/sdk 200 7006ms
</pre></code>

*Actual behavior*
Subscriptions in external plugins are not properly cleaned up and a service dispatchers <code>onUnsubscribe</code> and <code>destroySubscription</code> are not being called.

*Expected behavior*
A subscriptions cleanup logic is properly being executed for external plugins.

<h3>Comments</h3>

<ol>
<li>Jan Vennemann 2019-09-24

   PR: <a href="https://github.com/appcelerator/appc-daemon/pull/431" rel="nofollow" target="_blank">https://github.com/appcelerator/appc-daemon/pull/431</a></li>
</ol>


<p><a href="/DAEMON/DAEMON-285.json">JSON Source</a></p>