---
title: "[DAEMON-81] winreglib: Implement native addon to watch Windows Registry keys"
---
<table>
<tr><th>Type</th><td>New Feature</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Resolved</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2019-05-24T20:00:11.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Appc Daemon 2.3.0</td></tr>
<tr><th>Components</th><td>winreglib</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Chris Barber</td></tr>
<tr><th>Assignee</th><td>Chris Barber</td></tr>
<tr><th>Created</th><td>2017-05-09T15:02:50.000+0000</td></tr>
<tr><th>Updated</th><td>2019-06-04T16:07:33.000+0000</td></tr>
</table>

<h3>Description</h3>

On Windows, the daemon needs to watch the Windows Registry for Android SDK, JDK, and Visual Studio related keys so that the system info can monitor it.

In the daemon prototype, the detect engine would use <a href="https://www.npmjs.com/package/winreg" rel="nofollow" target="_blank">https://www.npmjs.com/package/winreg</a> (which calls <code>reg.exe</code>) and polls the Windows Registry every 15 seconds. This is inefficient and slow.

It would be better if we had a native C++ addon for Node that we could use.

It looks like it would need to call <code>RegNotifyChangeKeyValue()</code> (<a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724892(v=vs.85).aspx)." rel="nofollow" target="_blank">https://msdn.microsoft.com/en-us/library/windows/desktop/ms724892(v=vs.85).aspx).</a>

The C++ code would expose a simple API where you can start and stop watching a specific key.

Then we need a high-level <code>.js</code> API that exports a nicer, efficient ES6 compliant API. I imagine the <code>RegistryWatcher</code> would extend an <code>EventEmitter</code>. This file would also make use of <a href="https://www.npmjs.com/package/node-pre-gyp-init" rel="nofollow" target="_blank">https://www.npmjs.com/package/node-pre-gyp-init</a> to try and downloading the pre-built binary.

<h4>API</h4>

The public API will expose 3 methods: <code>get</code>, <code>list</code>, and <code>watch</code>.

<code>get()</code> will retrieve the value for a given key.

<code>list()</code> will retrieve all subkeys and values for a given key.

<code>watch()</code> will start watching a registry key for changes. It will return a watch handle that emits change events and also contains the <code>stop()</code> method to unwatch.

<code><pre>
import { get, list, watch } from 'winreglib';

const value = get('HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run');
console.log(<code>value = ${value}</code>);

const { resolvedRoot, key, subkeys, values } = list('HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run');
console.log(<code>resolvedRoot = ${resolvedRoot}</code>);
console.log(<code>key = ${key}</code>);
console.log('subkeys:', subkeys);
console.log('values:', values);

const handle = watch('HKCU'\\Software\\Microsoft\\Windows\\CurrentVersion\\Run');
handle.on('change', evt =&gt; {
    console.log('change!', evt);

    handle.stop();
});
</pre></code>

<h3>Comments</h3>

<ol>
<li>Chris Barber 2019-05-24

   Published v1.0.0: <a href="https://www.npmjs.com/package/winreglib." rel="nofollow" target="_blank">https://www.npmjs.com/package/winreglib.</a>
   
   Opted to use [prebuildify](<a href="https://www.npmjs.com/package/prebuildify)" rel="nofollow" target="_blank">https://www.npmjs.com/package/prebuildify)</a> and [node-gyp-build](<a href="https://www.npmjs.com/package/node-gyp-build)" rel="nofollow" target="_blank">https://www.npmjs.com/package/node-gyp-build)</a> instead of [node-pre-gyp](<a href="https://www.npmjs.com/package/node-pre-gyp)" rel="nofollow" target="_blank">https://www.npmjs.com/package/node-pre-gyp)</a> and [node-pre-gyp-init](<a href="https://www.npmjs.com/package/node-pre-gyp-init)." rel="nofollow" target="_blank">https://www.npmjs.com/package/node-pre-gyp-init).</a> The builds are pre-compiled before publish and included in the package. There is no need for S3 or Github to store the prebuilt binaries. Because winreglib uses N-API, version 3, there shouldn't be any issues with future Node.js release and thus no need for runtime downloading of the prebuild or compiling the module.
   
   The package contains prebuilds for 64-bit and 32-bit.
   </li>
</ol>


<p><a href="/DAEMON/DAEMON-81.json">JSON Source</a></p>