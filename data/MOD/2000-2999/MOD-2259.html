---
title: "[MOD-2259] iOS: Encrypted Database Adapter error on module upgrade"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2016-07-05T06:08:49.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>encryptedDatabase 1.3.1</td></tr>
<tr><th>Components</th><td>Encrypted SQLite DB</td></tr>
<tr><th>Labels</th><td>database</td></tr>
<tr><th>Reporter</th><td>Mostafizur Rahman</td></tr>
<tr><th>Assignee</th><td>Unknown</td></tr>
<tr><th>Created</th><td>2016-01-21T19:18:26.000+0000</td></tr>
<tr><th>Updated</th><td>2018-08-06T17:49:26.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Issue Description</h4>
App uses Encrypted database module v1.0.0. When the app uses module v1.3.0, it results in white screen and doesn't support the update. Console error below. 

<h4>Steps to reproduce </h4>
From Studio:
1) Get sample app attached and install it (contains both module versions already)
<a href="https://www.dropbox.com/s/kppn75te6xaarft/Test_EncryptedDB.zip?dl=0" rel="nofollow" target="_blank">https://www.dropbox.com/s/kppn75te6xaarft/Test_EncryptedDB.zip?dl=0</a>
2) Run Encrypted DB module 1.0.0 on sim/device
3) DB operations work as expected
4) Clean Build and upgrade module version to 1.3.0
5) Run app and monitor console logs. Stack trace below is shown. 

<h4>Stack Trace</h4>
<code><pre>
Jan 21 11:06:55 iPad SpringBoard[48] <Error>: SecTrustEvaluate [leaf IssuerCommonName SubjectCommonName] 
Jan 21 11:06:55 iPad SpringBoard[48] <Notice>: MIS: Using empty blacklist. 
Jan 21 11:06:55 iPad SpringBoard[48] <Error>: SecTrustEvaluate [leaf IssuerCommonName SubjectCommonName] 
Jan 21 11:06:55 iPad SpringBoard[48] <Notice>: MIS: Using empty blacklist. 
Jan 21 11:06:55 iPad securityd[81] <Error>: secTaskDiagnoseEntitlements MISSING keychain entitlements: no stored taskRef found 
Jan 21 11:06:55 iPad securityd[81] <Error>: secTaskDiagnoseEntitlements MISSING keychain entitlements: no stored taskRef found 
Jan 21 11:06:55 iPad amfid[655] <Error>: SecTrustEvaluate [leaf IssuerCommonName SubjectCommonName] 
Jan 21 11:06:55 iPad amfid[655] <Notice>: MIS: Using empty blacklist. 
Jan 21 11:06:55 iPad securityd[81] <Error>: SecOCSPSingleResponseCalculateValidity OCSPSingleResponse: nextUpdate 0.82 days ago 
Jan 21 11:06:55 iPad securityd[81] <Error>: SecOCSPResponseCreateWithID OCSPResponse: decode failure at top level 3C68746D6C3E0A3C686561643E0A3C6D65746120687474702D65717569763D27726566726573682720636F6E74656E743D27313B2075726C3D687474703A2F2F6F6373702E6170706C652E636F6D2F6367692D62696E2F6C6F67696E3F636D643D72656469726563742661727562616C703D62636436636161622D343339302D343635322D386236322D35653363373763393035272F3E0A3C2F686561643E0A3C2F68746D6C3E0A
Jan 21 11:06:55 iPad securityd[81] <Error>: SecOCSPResponseCreateWithID OCSPResponse: no responseStatus 3C68746D6C3E0A3C686561643E0A3C6D65746120687474702D65717569763D27726566726573682720636F6E74656E743D27313B2075726C3D687474703A2F2F6F6373702E6170706C652E636F6D2F6367692D62696E2F6C6F67696E3F636D643D72656469726563742661727562616C703D62636436636161622D343339302D343635322D386236322D35653363373763393035272F3E0A3C2F686561643E0A3C2F68746D6C3E0A
Jan 21 11:06:56 iPad kernel[0] <Notice>: xpcproxy[932] Container: /private/var/mobile/Containers/Data/Application/EEC10B5D-9ADE-44DC-AB96-83C10AF75F4B (sandbox) 
Jan 21 11:06:56 iPad Test EncryptedDB[932] <Warning>: [ERROR] A SQLite database error occurred on database '/var/mobile/Containers/Data/Application/EEC10B5D-9ADE-44DC-AB96-83C10AF75F4B/Library/Private Documents/todo.enc.db.sql': Error Domain=com.plausiblelabs.EncPLDatabase Code=3 "An error occured parsing the provided SQL statement." UserInfo={com.plausiblelabs.EncPLDatabase.error.vendor.code=26, com.plausiblelabs.EncPLDatabase.error.vendor.string=file is encrypted or is not a database, NSLocalizedDescription=An error occured parsing the provided SQL statement., com.plausiblelabs.EncPLDatabase.error.query.string=CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);} (SQLite #26: file is encrypted or is not a database) (query: 'CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);') 
Jan 21 11:06:56 iPad Test EncryptedDB[932] <Warning>: [ERROR] Application received error: invalid SQL statement at enc.db.js (line 1) 
Jan 21 11:06:56 iPad Test EncryptedDB[932] <Warning>: [ERROR] Application received error: Module "alloy/models/Todo" failed to leave a valid exports object
</pre></code>

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/MOD/MOD-2259_58402/appc_info.txt">appc_info.txt</td></td><td>2016-03-03T08:51:52.000+0000</td><td>602948</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/MOD/MOD-2259_59193/enc.db.js">enc.db.js</td></td><td>2016-05-12T05:43:02.000+0000</td><td>18796</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/MOD/MOD-2259_58401/errorlog">errorlog</td></td><td>2016-03-03T08:52:01.000+0000</td><td>2791861</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/MOD/MOD-2259_58404/IMG_0329.jpg">IMG_0329.jpg</td></td><td>2016-03-03T08:53:12.000+0000</td><td>42274</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Eduardo Gomez 2016-02-01

   The migrations cannot be done due this file (migrations table):
   
   * app/assets/alloy/sync/enc.db.js
   
   <code><pre>
   // Gets the current saved migration
   function GetMigrationFor(dbname, table) {
       var mid = null;
       var db = _database.open(dbname);
       db.execute('DROP TABLE IF EXISTS migrations'); 
       db.execute('CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);');
       var rs = db.execute('SELECT latest FROM migrations where model = ?;', table);
       if (rs.isValidRow()) {
           mid = rs.field(0) + '';
       }
       rs.close();
       db.close();
       return mid;
   }
   </pre></code></li>
<li>Chee Kiat Ng 2016-05-12

   Basically, the difference between appcelerator.encrypteddatabase 1.0.0 and 1.3.0 is that they contain different default settings, and thus existing databases need to be migrated or upgraded from older settings to a new version. 
   
   I'm still working on a way to do a in-place conversion of a existing database to a new one (which will take time), but at the mean time, a simple way to enable the usage of 1.3.0 module is, in your titanium app, in every <code><pre>var db = database.open</pre></code> being called, you just need to add this in the following line: <code><pre>db.execute('PRAGMA kdf_iter = 4000;'); </pre></code>
   So in the attached sample app, you are adding this line in <code>/app/assets/alloy/sync/enc.db.js</code> after <code><pre>_database.open(..);</pre></code>
   
   This basically tells the new module to read the table with the old setting. (the new one is kdf_iter = 64000)This really doesn't have any impact on the overall usage of the database. And it's a good solution for now if you really need this out asap.
   
   Eventually we will need a solution like this (pseudocode):
   <code><pre>
   if (olderDatabaseExists && !hasMigrated) {
       db.open();
       db.migrate();
       hasMigrated = true;
   }
   </pre></code>
   The eventual solution *will still work* in a later release if you choose to the above fix first in an interim version.
   
   [~shossain] ^</li>
<li>Chee Kiat Ng 2016-05-12

   <h4>Steps to test if above fix works</h4>
   1. Starting from scratch (no pre-existing app on the simulator)
   2. Get sample app attached and install it (contains both module versions already)
   <a href="https://www.dropbox.com/s/kppn75te6xaarft/Test_EncryptedDB.zip?dl=0" rel="nofollow" target="_blank">https://www.dropbox.com/s/kppn75te6xaarft/Test_EncryptedDB.zip?dl=0</a>
   3) Run Encrypted DB module 1.0.0 on sim/device: *appc run -p ios -C <UDID of ipad2 simulator>* only ipad2 works now because the module 1.0.0 is 32bit.
   4) DB operations work as expected
   5) Clean Build and upgrade module version to 1.3.0
   6) replace  <code>/app/assets/alloy/sync/enc.db.js</code> with the one attached in ticket
   7) Run app again and it will still work</li>
<li>Ingo Muschenetz 2016-05-20

   To clarify, what Kiat has proposed is a workaround for now. The 32-bit to 64-bit SDK change forced a change in the connection parameters. However, it currently fails during the migration. Thus, what Kiat is suggesting is to read the tables with the old default:
    
   <a href="https://www.zetetic.net/sqlcipher/sqlcipher-api/#kdf_iter" rel="nofollow" target="_blank">https://www.zetetic.net/sqlcipher/sqlcipher-api/#kdf_iter</a>
   <a href="https://www.zetetic.net/blog/2013/9/3/sqlcipher-300-beta-release.html" rel="nofollow" target="_blank">https://www.zetetic.net/blog/2013/9/3/sqlcipher-300-beta-release.html</a>
   
   (it went from 4000 in 1.0.0 to 64000 in 1.3.0, thus the pragma definition he adds of setting it back to 4000). This change is not something we can control if we wish to take advantage of 64-bit support.</li>
<li>Ingo Muschenetz 2016-05-20

   Note also the description of "cypher_migrate" in <a href="https://www.zetetic.net/blog/2013/9/3/sqlcipher-300-beta-release.html" rel="nofollow" target="_blank">https://www.zetetic.net/blog/2013/9/3/sqlcipher-300-beta-release.html</a>, so perhaps ACE could explore that pragma as a workaround.</li>
<li>Chee Kiat Ng 2016-05-25

   PR here: <a href="https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/pull/12" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/pull/12</a>
   </li>
<li>Chee Kiat Ng 2016-05-26

   PR updated. release updated. Tested on new project as well as attached project. 
   <h4>Steps to test</h4>
   1. Starting from scratch (no pre-existing app on the simulator)
   2. Get sample app attached and install it (contains both module versions already)
   <a href="https://www.dropbox.com/s/kppn75te6xaarft/Test_EncryptedDB.zip?dl=0" rel="nofollow" target="_blank">https://www.dropbox.com/s/kppn75te6xaarft/Test_EncryptedDB.zip?dl=0</a>
   3) Run Encrypted DB module 1.0.0 on sim/device: *appc run -p ios -C <UDID of ipad2 simulator>* only ipad2 works now because the module 1.0.0 is 32bit.
   4) DB operations work as expected
   5) Clean Build and upgrade module version to 1.3.1
   7) Run app again and it will still work</li>
<li>Hans Knöchel 2016-05-26

   CR approved. Waiting for the customer to confirm the supplied solution before merging.</li>
<li>Ingo Muschenetz 2016-06-10

   [~arohini] did you have an updated test case?</li>
<li>Ajith Rohini 2016-06-22

    [~cng], Can we please give this a high priority? I had an email from Richard who is the Dir.Technical Architecture and IT Strategy @ ACE mentioning that they are getting pretty upset since this has been going on since Jan.
    
    Any help would be much appreciated</li>
<li>Chee Kiat Ng 2016-06-22

    [~sliang] Use this version please. <a href="https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/releases/tag/1.3.1" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/releases/tag/1.3.1</a>
    and try it against your reproducible case. it's a new build.</li>
<li>Shuo Liang 2016-06-23

    [~cng] I think I did use this one, I downloaded and tested it yesterday. Did you build a new today?</li>
<li>Shuo Liang 2016-06-28

    [~cng], I tried your latest build for v1.3.1 servial time. And the problem still there.
    
    Here is the step:
    
    1. Delete the old app from simulator. (important)
    2. Go with the reproduce steps in my comment. (v1.0.0 to v1.3.1)
    
    This error will pop out.
    
    <code><pre>
    [INFO] :   Opening DB...
    [ERROR] :  Error occurred calling next on a EncPLSqliteResultSet. SQLite error: 'attempt to write a readonly database' for 'INSERT OR IGNORE INTO testtable(id) VALUES (3);'
    [ERROR] :  Script Error {
    [ERROR] :      column = 21;
    [ERROR] :      line = 19;
    [ERROR] :      message = "Error occurred calling next on a EncPLSqliteResultSet. SQLite error: 'attempt to write a readonly database' for 'INSERT OR IGNORE INTO testtable(id) VALUES (3);'";
    [ERROR] :      sourceURL = "file:///Users/shuoliang/Library/Developer/CoreSimulator/Devices/44C74F69-DC96-461F-9FE1-93256A9F224D/data/Containers/Bundle/Application/03127931-BB65-413C-8CEF-FDEFFCF82117/AlloyTest6.app/app.js";
    [ERROR] :      stack = "[native code]\ninsert@file:///Users/shuoliang/Library/Developer/CoreSimulator/Devices/44C74F69-DC96-461F-9FE1-93256A9F224D/data/Containers/Bundle/Application/03127931-BB65-413C-8CEF-FDEFFCF82117/AlloyTest6.app/app.js:19:21\nglobal code@file:///Users/shuoliang/Library/Developer/CoreSimulator/Devices/44C74F69-DC96-461F-9FE1-93256A9F224D/data/Containers/Bundle/Application/03127931-BB65-413C-8CEF-FDEFFCF82117/AlloyTest6.app/app.js:41:7";
    [ERROR] :  }
    </pre></code>
    
    Note: If I run the app again with v1.3.1 right after this error (not delete app, not clean the project), the error will gone. </li>
<li>Scott Davenport 2016-06-29

    [~cbowley] can you work with Ajith and make sure this one gets over the line?  Thanks...Ajith just FYI Chris works very closely with the ACE/Chubb team as they have paid for 1 year of a Solutions Architect 6 hours a week.  He knows the ins and outs of the account from an app perspective.</li>
<li>Chee Kiat Ng 2016-06-30

    [~sliang] I'll try your test case again and see what I can do. Meanwhile, instead of your test case, can the customer provide a 100% reproducible one? </li>
<li>Eric Merriman  2018-08-06

    Cleaning up older fixed issues. If this issue should not have been closed as fixed, please reopen.</li>
</ol>


<p><a href="/MOD/MOD-2259.json">JSON Source</a></p>