---
title: "[MOD-2280] Facebook: fb.permissions leading to crash inconsistently on iOS"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2016-08-16T06:45:21.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.0.0</td></tr>
<tr><th>Components</th><td>Facebook</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Shuo Liang</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2016-08-05T03:16:19.000+0000</td></tr>
<tr><th>Updated</th><td>2018-08-06T17:49:34.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Reproduce</h4>
1. Run the following code in a simple classic project.
<code><pre>
var win = Ti.UI.createWindow({
	backgroundColor: "white",
});

// facebook
var fb = require('facebook');
fb.initialize();
fb.addEventListener('login', function(e) {
    if (e.success) {
        Ti.API.info('login from uid: '+e.uid+', name: '+ JSON.parse(e.data).name);
        checkPermission();
    }
    else if (e.cancelled) {
        alert('cancelled');
    }
    else {
        alert(e.error);
    }
});

// button to tigger facebook authorise and check the permission
var button = Ti.UI.createButton({
	title:"Authorise and check the permission",
	top: 100
});
button.addEventListener('click',function(e){
	if (!fb.loggedIn) {
		console.log("not logged yet.");
		fb.authorize();
	} else {	
		checkPermission();
	}
});
win.add(button);

function checkPermission() {
	if(fb.permissions.indexOf('publish_actions') < 0) {
		Ti.API.info("No publish_action permission");
	} else {
		Ti.API.info("Do have publish_action permission");
	}
}

win.open();
</pre></code>
2. Click the button to login/authorise.
3. Then click it again to check permissions.

<h4>Problem.</h4>
App will cash if you click the button for several times.

<h4>Note</h4>
No any crash log in console.


<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2016-08-05

   Can you add <code>fb.initialize()</code> before using the module instance? Just some troubleshooting.</li>
<li>Hans Knöchel 2016-08-06

   I've put it into this sprint for further investigation. Is there a difference between main-thread enabled and disabled? The issue is  definitely threading-related and I guess the problem is that we wait for the permissions [here](<a href="https://github.com/appcelerator-modules/ti.facebook/blob/master/ios/Classes/FacebookModule.m#L178)" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.facebook/blob/master/ios/Classes/FacebookModule.m#L178)</a> which can produce problems when being used in properties that need to return something immediately. I'll update this ticket as soon as I've tested it.</li>
<li>Hans Knöchel 2016-08-08

   PR: <a href="https://github.com/appcelerator-modules/ti.facebook/pull/60" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.facebook/pull/60</a>
   
   Ok, so here it what the PR does:
   - The getter was forced to run on the main-thread and wait for the result. That caused major problems, since the return value has not been retained. 
   - I also found out that this was a known issue in the Facebook-SDK, so I updated it to the latest stable available
   - While I did that, I also found some memory-leaks across the share-dialogs which I fixed
   - I tested the change with both kroll- and main-thread and did a click-penetration with 20+ clicks and no crash (before: crash after 2-3 times visible)
   - Finally bumped the version of ti.facebook to 1.2.3</li>
<li>Hans Knöchel 2016-08-10

   Pre-release: <a href="https://github.com/appcelerator-modules/ti.facebook/releases/tag/ios-5.2.3" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.facebook/releases/tag/ios-5.2.3</a></li>
<li>Chee Kiat Ng 2016-08-16

   [~hansknoechel] PR merged. Proceed to have the packaged Facebook module PR into titanium_mobile please.</li>
<li>Hans Knöchel 2016-08-16

   PR (titanium_mobile/master): <a href="https://github.com/appcelerator/titanium_mobile/pull/8234" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8234</a>
   
   New ti.facebook iOS version 5.2.3 released.</li>
<li>Eric Merriman  2018-08-06

   Cleaning up older fixed issues. If this issue should not have been closed as fixed, please reopen.</li>
</ol>


<p><a href="/MOD/MOD-2280.json">JSON Source</a></p>