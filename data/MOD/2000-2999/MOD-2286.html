---
title: "[MOD-2286] Ti.Facebook iOS: Sending Ti.Blob's in requestWithGraphPath throws mutating-error"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2016-08-29T03:49:09.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 5.1.2, Release 5.3.0, Release 5.4.0, Release 5.2.1</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.0.0</td></tr>
<tr><th>Components</th><td>Facebook</td></tr>
<tr><th>Labels</th><td>facebook, graph, mutating</td></tr>
<tr><th>Reporter</th><td>Hans Knöchel</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2016-08-26T23:20:09.000+0000</td></tr>
<tr><th>Updated</th><td>2018-08-06T17:49:12.000+0000</td></tr>
</table>

<h3>Description</h3>

When using the method <code>requestWithGraphPath</code> to send images to the graph, we unpack the blobs to <code>NSData</code> types internally. So far so good, but while doing that, we fast-iterate through the dictionary of parameters and mutate the value if it is a blob. That needs to be fixed. 

More infos: <a href="http://stackoverflow.com/questions/39152131/appcelerator-facebook-module-error-posting-photo-on-ios" rel="nofollow" target="_blank">http://stackoverflow.com/questions/39152131/appcelerator-facebook-module-error-posting-photo-on-ios</a>

*Expected behavior*: The <code>requestWithGraphPath</code> method succeeds, a new photo is uploaded to Facebook
*Actual behavior*: The app fails with a <code>*** Collection <__NSDictionaryM: 0x14ee27430> was mutated while being enumerated.</code> error

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2016-08-26

   PR: <a href="https://github.com/appcelerator-modules/ti.facebook/pull/61" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.facebook/pull/61</a>
   
   Demo:
   <code><pre>
   var fb = require("facebook");
   fb.initialize();
   
   var win = Ti.UI.createWindow({
       backgroundColor: "#fff"
   });
   var btn = Ti.UI.createButton({
       title: (fb.loggedIn) ? "Request write permissions and submit" : "Login"
   });
    
   btn.addEventListener("click", function() {
       if (fb.loggedIn) {
           requestPublishPermissions();
       } else {
           fb.permissions = ['email'];
           fb.authorize();
       }
   });
    
   fb.addEventListener("login", function(_e) {
       if (!_e.success) {
           btn.setTitle("Login");
           Ti.API.error("Login cancelled/failed!");
           Ti.API.error(_e);
           return;
       } else {
           Ti.API.info("Login succeeded");
           btn.setTitle("Request write permissions and submit");
       }        
   });
   
   function requestPublishPermissions() {
       fb.requestNewPublishPermissions(['publish_actions'], fb.AUDIENCE_ONLY_ME, function(e) {
           if (!e.success) {
               alert("Publish permissions denied!");
               return;
           }
                   
           var blob = Ti.UI.createView({
               width: 500,
               height: 500,
               backgroundColor: "green"
           }).toImage();
           
           var args = {
               picture: blob,
               caption: "Great green view"
           };
           
           fb.requestWithGraphPath('me/photos', args, "POST", showRequestResult);
       });
   
   }
   
   function showRequestResult(e) {
       alert("Photo has been submitted, check your facebook photo album");
       Ti.API.info(e);
   }
    
   win.add(btn);
   win.open();
   </pre></code>
   
   A compiled version of the module is attached to the PR.
   
   [~cng] I would like to have this in 6.0.0, let me know if that's ok and I'll prepare the SDK-PR's.</li>
<li>Chee Kiat Ng 2016-08-29

   CR and FT passed. APPROVED. (Good fix btw). Please back port for 6.0.0. And also indicate *Expected Result* and any additional helpful information in your test so that QE can verify easily later.</li>
<li>Hans Knöchel 2016-08-29

   Information updated, new Ti.Facebook version released on Github, prepackaged module updated for master and 6_0_X.</li>
<li>Eric Merriman  2018-08-06

   Cleaning up older fixed issues. If this issue should not have been closed as fixed, please reopen.</li>
</ol>


<p><a href="/MOD/MOD-2286.json">JSON Source</a></p>