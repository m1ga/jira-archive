---
title: "[MOD-2378] Android: Memory leak - TiBlob: (main) getNativePath not supported for non-file blob types."
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2018-03-01T00:02:31.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 7.1.0</td></tr>
<tr><th>Components</th><td>Map</td></tr>
<tr><th>Labels</th><td>android, annotation, customView, image, ti.map</td></tr>
<tr><th>Reporter</th><td>Onur Yıldırım</td></tr>
<tr><th>Assignee</th><td>Gary Mathews</td></tr>
<tr><th>Created</th><td>2017-12-11T01:33:10.000+0000</td></tr>
<tr><th>Updated</th><td>2018-07-13T14:55:02.000+0000</td></tr>
</table>

<h3>Description</h3>

Adding annotation with customView to a map outputs this warning for every annotation. This blocks the performance when you have 70+ markers.

TiBlob: (main) [1106,1935] getNativePath not supported for non-file blob types.

To reproduce, just do this in your map complete event handler:
<code><pre>
function onMapComplete(event) {
	var annot = TI_MAP.createAnnotation({
		latitude: 41.071004,
		longitude: 29.015450,
		title: 'test #1',
		customView: Ti.UI.createImageView({
			image: '/images/marker.png',
			width: Ti.UI.SIZE,
			height: Ti.UI.SIZE
		})
	});
	$.mapView.addAnnotation(annot);
}
</pre></code>

Here is the [line in TiBlob.java](<a href="https://github.com/appcelerator/titanium_mobile/blob/30a9911c4f1d30ba0c3d971903f16ae8cc18b0a6/android/titanium/src/java/org/appcelerator/titanium/TiBlob.java#L526)." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/30a9911c4f1d30ba0c3d971903f16ae8cc18b0a6/android/titanium/src/java/org/appcelerator/titanium/TiBlob.java#L526).</a> <code>getNativePath()</code> should not be called in the first place bec. customView already provides the annotation view. Why would it try to get a path for it?

Why I use customView? Bec. otherwise if I use the image property, it leaks memory on Android; if you remove and re-add annotations multiple times... I'm tired of Titanium!

*UPDATE 1:* It still leaks memory both when <code>.image</code> or <code>.customView</code> used. Doesn't matter.
*UPDATE 2:* It also leaks memory when using default pins (not setting <code>.image</code> or <code>.customView</code>) but the app stands a bit more longer before it crashes.

<code><pre>
[WARN] :   art: Throwing OutOfMemoryError "Failed to allocate a 57612 byte allocation with 55816 free bytes and 54KB until OOM"
[WARN] :   JNIHelp: Discarding pending exception (java.lang.OutOfMemoryError: Failed to allocate a 57612 byte allocation with 55816 free bytes and 54KB until OOM) to throw java/lang/RuntimeException
[WARN] :   W/System.err: java.lang.RuntimeException: Could not allocate java pixel ref.
[WARN] :   W/System.err: 	at android.graphics.Bitmap.nativeCreateFromParcel(Native Method)
[WARN] :   W/System.err: 	at android.graphics.Bitmap.-wrap0(Bitmap.java)
[WARN] :   W/System.err: 	at android.graphics.Bitmap$1.createFromParcel(Bitmap.java:1564)
[WARN] :   W/System.err: 	at android.graphics.Bitmap$1.createFromParcel(Bitmap.java:1563)
[WARN] :   W/System.err: 	at bsb.a(:com.google.android.gms@11509470:2)
[WARN] :   W/System.err: 	at wpl.onTransact(:com.google.android.gms@11509470:8)
[WARN] :   W/System.err: 	at android.os.Binder.transact(Binder.java:499)
[WARN] :   W/System.err: 	at com.google.android.gms.internal.zzed.zza(Unknown Source)
[WARN] :   W/System.err: 	at com.google.android.gms.maps.model.internal.zzc.zzd(Unknown Source)
[WARN] :   W/System.err: 	at com.google.android.gms.maps.model.BitmapDescriptorFactory.fromBitmap(Unknown Source)
[WARN] :   W/System.err: 	at ti.map.AnnotationProxy.handleImage(AnnotationProxy.java:272)
[WARN] :   W/System.err: 	at ti.map.AnnotationProxy.processOptions(AnnotationProxy.java:232)
[WARN] :   W/System.err: 	at ti.map.TiUIMapView.addAnnotation(TiUIMapView.java:438)
[WARN] :   W/System.err: 	at ti.map.ViewProxy.handleAddAnnotation(ViewProxy.java:282)
[WARN] :   W/System.err: 	at ti.map.ViewProxy.handleAddAnnotations(ViewProxy.java:325)
[WARN] :   W/System.err: 	at ti.map.ViewProxy.addAnnotations(ViewProxy.java:313)
[WARN] :   W/System.err: 	at org.appcelerator.kroll.runtime.v8.V8Object.nativeFireEvent(Native Method)
[WARN] :   W/System.err: 	at org.appcelerator.kroll.runtime.v8.V8Object.fireEvent(V8Object.java:62)
[WARN] :   W/System.err: 	at org.appcelerator.kroll.KrollProxy.doFireEvent(KrollProxy.java:934)
[WARN] :   W/System.err: 	at org.appcelerator.kroll.KrollProxy.handleMessage(KrollProxy.java:1157)
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[WARN] :   W/System.err: 	at org.appcelerator.titanium.proxy.TiViewProxy.handleMessage(TiViewProxy.java:363)
[WARN] :   W/System.err: 	at android.os.Handler.dispatchMessage(Handler.java:98)
[WARN] :   W/System.err: 	at android.os.Looper.loop(Looper.java:154)
[WARN] :   W/System.err: 	at android.app.ActivityThread.main(ActivityThread.java:6119)
[WARN] :   W/System.err: 	at java.lang.reflect.Method.invoke(Native Method)
[WARN] :   W/System.err: 	at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:886)
[WARN] :   W/System.err: 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:776)
[ERROR] :  TiExceptionHandler: (main) [6051,31629] ----- Titanium Javascript Runtime Error -----
[ERROR] :  TiExceptionHandler: (main) [0,31629] - In /alloy/controllers/index.js:101,13
[ERROR] :  TiExceptionHandler: (main) [0,31629] - Message: Uncaught Could not allocate java pixel ref.
[ERROR] :  TiExceptionHandler: (main) [0,31629] - Source: 				$.vwMap.addAnnotations(annots);
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Clamp target GC heap from 111MB to 96MB
[INFO] :   art: WaitForGcToComplete blocked for 21.152ms for cause Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Clamp target GC heap from 111MB to 96MB
[INFO] :   art: WaitForGcToComplete blocked for 16.867ms for cause Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Clamp target GC heap from 111MB to 96MB
[INFO] :   art: WaitForGcToComplete blocked for 21.218ms for cause Alloc
[INFO] :   art: Starting a blocking GC Alloc
[ERROR] :  V8Exception: Exception occurred at /alloy/controllers/index.js:101: Uncaught Could not allocate java pixel ref.
[ERROR] :  V8Exception: Could not allocate java pixel ref.
[INFO] :   Choreographer: Skipped 83 frames!  The application may be doing too much work on its main thread.
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Clamp target GC heap from 111MB to 96MB
[INFO] :   art: WaitForGcToComplete blocked for 15.277ms for cause Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[ERROR] :  EGL_emulation: tid 29011: eglSurfaceAttrib(1174): error 0x3009 (EGL_BAD_MATCH)
[WARN] :   OpenGLRenderer: Failed to set EGL_SWAP_BEHAVIOR on surface 0xcb0fc420, error=EGL_BAD_MATCH
[INFO] :   art: Clamp target GC heap from 111MB to 96MB
[INFO] :   art: WaitForGcToComplete blocked for 35.539ms for cause Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: WaitForGcToComplete blocked for 24.297ms for cause Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Clamp target GC heap from 111MB to 96MB
[INFO] :   art: Alloc partial concurrent mark sweep GC freed 67(2456B) AllocSpace objects, 0(0B) LOS objects, 0% free, 95MB/96MB, paused 357us total 21.130ms
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Clamp target GC heap from 111MB to 96MB
[INFO] :   art: Alloc concurrent mark sweep GC freed 3(72B) AllocSpace objects, 0(0B) LOS objects, 0% free, 95MB/96MB, paused 261us total 21.652ms
[INFO] :   art: Forcing collection of SoftReferences for 64KB allocation
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Clamp target GC heap from 111MB to 96MB
[INFO] :   art: Alloc concurrent mark sweep GC freed 3(72B) AllocSpace objects, 0(0B) LOS objects, 0% free, 95MB/96MB, paused 235us total 21.648ms
[WARN] :   art: Throwing OutOfMemoryError "Failed to allocate a 65548 byte allocation with 32104 free bytes and 31KB until OOM"
[INFO] :   art: WaitForGcToComplete blocked for 68.092ms for cause Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: WaitForGcToComplete blocked for 67.564ms for cause Background
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: Waiting for a blocking GC Alloc
[INFO] :   art: Clamp target GC heap from 109MB to 96MB
[INFO] :   art: Alloc partial concurrent mark sweep GC freed 3632(322KB) AllocSpace objects, 29(1740KB) LOS objects, 2% free, 93MB/96MB, paused 199us total 19.395ms
[INFO] :   art: WaitForGcToComplete blocked for 21.957ms for cause Alloc
[INFO] :   art: Starting a blocking GC Alloc
[INFO] :   art: WaitForGcToComplete blocked for 18.575ms for cause Background
[INFO] :   APSAnalyticsService: Analytics Service Started
[INFO] :   APSAnalyticsService: Stopping Analytics Service
</pre></code>

*Environment:*
macOS High Sierra, node 8.9.3, Ti SDK 7.0.0, javac 1.8.0_112
Last Android device tested: Samsung Galaxy S7, Android 7.1.0 (API 25)


<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/MOD/MOD-2378_63770/map-annot-test.zip">map-annot-test.zip</td></td><td>2017-12-11T19:05:05.000+0000</td><td>10035760</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/MOD/MOD-2378_63958/marker.png">marker.png</td></td><td>2018-01-13T00:03:38.000+0000</td><td>4689</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/MOD/MOD-2378_63771/mleak-app-screen.png">mleak-app-screen.png</td></td><td>2017-12-11T19:05:38.000+0000</td><td>886429</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/MOD/MOD-2378_63772/mleak-full-logs.txt.zip">mleak-full-logs.txt.zip</td></td><td>2017-12-11T19:10:54.000+0000</td><td>29914</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Mostafizur Rahman 2017-12-11

   Hello [~onury],
   Thanks for sharing with us. Can you please share the the full sample code to reproduce the issue on our end? Also provide share your android device information and console logs.
   
   Best</li>
<li>Onur Yıldırım 2017-12-11

   @Mostafizur Rahman , I've attached a very explanatory sample app, full logs and more info (including environment, etc). I hope this helps you identify the problem quickly because our production app keeps crashing and we're loosing reputation over this. At least a workaround is crucial at this point.
   
   Pls let me know if you need anything else.
   Best,</li>
<li>Onur Yıldırım 2017-12-11

   Updated the sample app to show it also leaks memory with default pins. But cannot upload anymore files.</li>
<li>Onur Yıldırım 2017-12-13

   Any news on this? At least a confirmation pls.</li>
<li>Onur Yıldırım 2017-12-15

   </li>
<li>Onur Yıldırım 2017-12-16

   Please see the links below that discuss <code>OutOfMemoryException</code> when using maps in native Android. Might be helpful...
   
   * [StackOverflow: 75 markers on Map - memory leaks - OutOfMemoryException](<a href="https://stackoverflow.com/questions/14186072/75-markers-on-map-memory-leaks-outofmemoryexception)" rel="nofollow" target="_blank">https://stackoverflow.com/questions/14186072/75-markers-on-map-memory-leaks-outofmemoryexception)</a>
   * [StackOverflow: Android - Many OutOfMemoryError exceptions only on single Activity with MapView](<a href="https://stackoverflow.com/questions/14186072/75-markers-on-map-memory-leaks-outofmemoryexception)" rel="nofollow" target="_blank">https://stackoverflow.com/questions/14186072/75-markers-on-map-memory-leaks-outofmemoryexception)</a>
   * [Google Issue Tracker:  Memory leak in system when using MapView](<a href="https://issuetracker.google.com/issues/36907271)" rel="nofollow" target="_blank">https://issuetracker.google.com/issues/36907271)</a></li>
<li>Onur Yıldırım 2017-12-16

   Additional notes:
   
   - Adding <code>&lt;application  android:largeHeap="true"&gt;</code> does not help.  Still crashes. (not a guaranteed solution anyway).
   - Modifying <code>ti.map</code> module by using <code>.release()</code> for <code>bitmap</code> didn't help. (M. Gangolf)
   - Modifying <code>ti.map</code> module by manually calling <code>gc()</code> in <code>removeAllAnnotations()</code>  didn't help. (M. Gangolf)
   - As a workaround; considered updating annotations without removing and re-adding but <code>.image</code> can be only set at creation-time. (And it would still leak anyway without a fix.)
   </li>
<li>Sharif AbuDarda 2017-12-16

   Hello, We have verified the issue. Our engineers are working on it. The will schedule it for a fix. Thanks.</li>
<li>Onur Yıldırım 2017-12-16

   Great! Thanks Sharif.
   Looking forward to that.</li>
<li>Onur Yıldırım 2017-12-20

    @Sharif AbuDarda any kind of news on this?</li>
<li>Onur Yıldırım 2018-01-12

    Still no updates on this.</li>
<li>Eric Merriman  2018-01-12

    Hello [~onury], sorry to say the process failed us here. But this looks like a bad one so will ask our senior Android dev to look at this today. Expect some info by end of day.</li>
<li>Onur Yıldırım 2018-01-12

    Looking forward to it. Thanks.</li>
<li>Gary Mathews 2018-01-13

    titanium_mobile: <a href="https://github.com/appcelerator/titanium_mobile/pull/9725" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9725</a>
    ti.map: <a href="https://github.com/appcelerator-modules/ti.map/pull/219" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.map/pull/219</a>
    
    ti.map-4.1.1: <a href="https://github.com/appcelerator-modules/ti.map/releases/tag/android-4.1.1" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.map/releases/tag/android-4.1.1</a></li>
<li>Onur Yıldırım 2018-01-18

    Thanks Gary, hope these get merged soon.</li>
<li>Onur Yıldırım 2018-01-30

    Gary, a collaborator requested some changes on GitHub, 17 days ago.
    Can you please have a look at it? </li>
<li>Michael Gangolf 2018-02-18

    Just about the merge/fix: you could have used the custom SDK with the since Jan 13 since it is linked in the PR (by the build-bot) or even create your 7.0.2 version with the few lines of code or ask in ti-slack for someone to compile it for you. 
    
    Since it is scheduled for 7.1.0 it is not officially merged. </li>
<li>Onur Yıldırım 2018-02-18

    I could not use non-official releases for the app in production.</li>
<li>Gary Mathews 2018-02-28

    7_1_X: <a href="https://github.com/appcelerator/titanium_mobile/pull/9894" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9894</a></li>
<li>Lokesh Choudhary 2018-02-28

    FR Passed.
    PR's merged.</li>
<li>Lokesh Choudhary 2018-03-14

    Verified the fix in SDK 7.1.0.v20180308150545 & 7.2.0.v20180313125304 downloads map module 4.1.1.</li>
<li>Michael Gangolf 2018-07-10

    I think this PR leads to this error when you try to re-add an existing annotation:
    
    <code><pre>
    [WARN]  W/System.err: java.lang.NullPointerException: Attempt to invoke virtual method 'void com.google.android.gms.maps.model.Marker.remove()' on a null object reference
    [WARN]  W/System.err: 	at ti.map.TiUIMapView.addAnnotation(TiUIMapView.java:474)
    [WARN]  W/System.err: 	at ti.map.TiUIMapView.addAnnotations(TiUIMapView.java:489)
    [WARN]  W/System.err: 	at ti.map.TiUIMapView.updateAnnotations(TiUIMapView.java:498)
    [WARN]  W/System.err: 	at ti.map.TiUIMapView.propertyChanged(TiUIMapView.java:288)
    [WARN]  W/System.err: 	at org.appcelerator.kroll.KrollProxy.firePropertyChanged(KrollProxy.java:969)
    [WARN]  W/System.err: 	at org.appcelerator.kroll.KrollProxy.onPropertyChanged(KrollProxy.java:1058)
    [WARN]  W/System.err: 	at org.appcelerator.kroll.runtime.v8.V8Function.nativeInvoke(Native Method)
    [WARN]  W/System.err: 	at org.appcelerator.kroll.runtime.v8.V8Function.callSync(V8Function.java:55)
    [WARN]  W/System.err: 	at org.appcelerator.kroll.runtime.v8.V8Function.call(V8Function.java:41)
    [WARN]  W/System.err: 	at ti.modules.titanium.TitaniumModule$Timer.run(TitaniumModule.java:166)
    [WARN]  W/System.err: 	at android.os.Handler.handleCallback(Handler.java:751)
    [WARN]  W/System.err: 	at android.os.Handler.dispatchMessage(Handler.java:95)
    [WARN]  W/System.err: 	at android.os.Looper.loop(Looper.java:173)
    [WARN]  W/System.err: 	at android.app.ActivityThread.main(ActivityThread.java:6459)
    [WARN]  W/System.err: 	at java.lang.reflect.Method.invoke(Native Method)
    [WARN]  W/System.err: 	at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:938)
    [WARN]  W/System.err: 	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:828)
    </pre></code>
    
    Example: 
    <code><pre>
    var Map = require('ti.map');
    var win = Titanium.UI.createWindow();
    var mapview = Map.createView({
    	bottom: 0,
    	right: 0,
    	width: Ti.UI.FILL,
    	height: Ti.UI.FILL,
    	rotateEnabled: true,
    	mapType: Map.MUTED_STANDARD_TYPE,
    	showsPointsOfInterest: false,
    	userLocation: true,
    });
    var ann = [];	// store annotations
    
    function setData() {
    	for (var i = 0; i &lt; 10; i++) {
    		ann.push(Map.createAnnotation({
    			title: 'Title',
    			subtitle: 'subtitle',
    			latitude: Math.random() * 10 + 40,
    			longitude: Math.random() * 10,
    		}));
    	}
    	mapview.setAnnotations(ann);
    }
    setData();
    
    
    var btn = Ti.UI.createButton({
    	title: "add again",
    	bottom: 40
    });
    var btn2 = Ti.UI.createButton({
    	title: "add new",
    	bottom: 0
    });
    var btn3 = Ti.UI.createButton({
    	title: "set",
    	bottom: 80
    });
    btn.addEventListener("click", function() {
    	// remove and add existing annotation
    	mapview.removeAllAnnotations();
    	mapview.addAnnotation(ann[0]);
    })
    
    btn2.addEventListener("click", function() {
    	// create new annotation and set it
    	var anno = Map.createAnnotation({
    		title: 'Title',
    		subtitle: 'subtitle',
    		latitude: Math.random() * 10 + 40,
    		longitude: Math.random() * 10,
    	})
    	mapview.setAnnotations([anno]);
    })
    
    btn3.addEventListener("click", function() {
    	// reset existing annotation
    	mapview.setAnnotations([ann[0]]);
    })
    win.add(btn);
    win.add(btn2);
    win.add(btn3);
    win.add(mapview);
    win.open();
    
    </pre></code>
    
    Only the button "Add new" works. If I add or set an existing icon it will crash.
    
    Android 7 (HTC A9)
    Ti SDK 7.2.0.GA
    Ti.Map 4.3.0
    
    it has something todo with: <a href="https://github.com/appcelerator-modules/ti.map/blob/999bd092c0d41be8384d01271cc32888b64fcb05/android/src/ti/map/AnnotationProxy.java#L96" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.map/blob/999bd092c0d41be8384d01271cc32888b64fcb05/android/src/ti/map/AnnotationProxy.java#L96</a> 
    
    Here: <a href="https://github.com/appcelerator-modules/ti.map/blob/master/android/src/ti/map/TiUIMapView.java#L498" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.map/blob/master/android/src/ti/map/TiUIMapView.java#L498</a>
    annotation.getTiMarker() returns not-null but tiMarker.getMarker() is null (tiMarker.getMarker().remove();).
    
    Still investigating what needs to be fixed</li>
</ol>


<p><a href="/MOD/MOD-2378.json">JSON Source</a></p>