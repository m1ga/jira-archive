---
title: "[MOD-2589] Android: Optimize encrypted db open() when migration from older version not needed"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2020-04-22T17:37:30.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>appcelerator.encrypteddatabase 3.3.0</td></tr>
<tr><th>Components</th><td>Encrypted SQLite DB</td></tr>
<tr><th>Labels</th><td>android, database, encrypted_database, open, performance, sqlite</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2020-03-27T00:25:55.000+0000</td></tr>
<tr><th>Updated</th><td>2020-04-22T17:37:30.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
An Android encrypted database file created via "appcelerator.encrypteddatabase" module version <code>3.0.2</code> or older needs to be "migrated" when opened with module version <code>3.0.3</code> and higher or else it will fail to open. As of module version <code>3.1.0</code>, the module will automatically migrate the database when you call the <code>open()</code> method. This migration operation adds about <code>500ms</code> to the open time every time you open the database, even if it has already been migrated.

We should only migrate an encrypted database once and subsequent opens should not execute the migration operation.

*Test:*
<h4>Create a Classic Titanium project using the below code for your "app.js".</h4>
<h4>Set up "tiapp.xml" to use module "appcelerator.encrypteddatabase" version <code>3.0.2</code>.</h4>
<h4>Build and run on Android.</h4>
<h4>Set up "tiapp.xml" to use newest version of module "appcelerator.encrypteddatabase".</h4>
<h4>Build and run on Android.</h4>
<h4>In the log, look up the "DB open duration" time. It should be around <code>900ms</code>.</h4>
<h4>Press the Android back button.</h4>
<h4>Relaunch the app.</h4>
<h4>In the log, notice the "DB open duration" time is just as long. (This is what we want to optimize.)</h4>

<code><pre>
var database = require("appcelerator.encrypteddatabase");
database.setPassword("password");

var openStartTime = new Date();
var dbConnection = database.open("test_encrypted.db");
Ti.API.info("@@@ DB open duration: " + (new Date() - openStartTime) + " ms");

dbConnection.execute("DROP TABLE IF EXISTS test;");
dbConnection.execute("CREATE TABLE test(id integer PRIMARY KEY, name TEXT);");
dbConnection.close();
</pre></code>

*Recommended Solution:*
When we successfully open/create a database, we should store the sqlcipher version to a <code>SharedPreference</code>. This way the next time we open the database, we will know what version it was last opened with.

We can obtain the sqlcipher version via the follow Java constant.
[SQLiteDatabase.SQLCIPHER_ANDROID_VERSION](<a href="https://github.com/sqlcipher/android-database-sqlcipher/blob/23325436094c08f39dc704a851d2c989bfb6783e/android-database-sqlcipher/src/main/java/net/sqlcipher/database/SQLiteDatabase.java#L95)" rel="nofollow" target="_blank">https://github.com/sqlcipher/android-database-sqlcipher/blob/23325436094c08f39dc704a851d2c989bfb6783e/android-database-sqlcipher/src/main/java/net/sqlcipher/database/SQLiteDatabase.java#L95)</a>

Our code should do something similar to as follows...
<code><pre>
// The preferences file should use the module's name to avoid file collision.
final String MODULE_PREFERENCES_NAME = "appcelerator.encrypteddatabase";
SharedPreferences preferencesReader = TiApplication.getInstance().getSharedPreferences(
	MODULE_PREFERENCES_NAME, Context.MODE_PRIVATE);

// After opening the database, use the db file path as the key and store the db library version to it.
SharedPreferences.Editor preferencesWriter = preferencesReader.edit();
preferencesWriter.putString(dbFilePath, SQLiteDatabase.SQLCIPHER_ANDROID_VERSION);
</pre></code>

In our module, we have a <code>migrationHook</code> that gets invoked after the database has been open.
[EncrypteddatabaseModule.java - migrationHook ](<a href="https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/blob/ff743b74058d662014f53164355e4c8de3c308f2/android/src/appcelerator/encrypteddatabase/EncrypteddatabaseModule.java#L80)" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/blob/ff743b74058d662014f53164355e4c8de3c308f2/android/src/appcelerator/encrypteddatabase/EncrypteddatabaseModule.java#L80)</a>

We should only execute <code>PRAGMA cipher_migrate;</code> if the major version component of <code>SQLiteDatabase.SQLCIPHER_ANDROID_VERSION</code> is higher than what is stored to the above shared preference. If the shared preference cannot be found for the database file, then we should assume the worse and do the migration anyways. This is in case the database file is old and has been copied to a different directory.

<h3>Comments</h3>

<ol>
<li>Joshua Quick 2020-03-27

   -PR:- <a href="https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/pull/46" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/pull/46</a>
   _(Closed in favor of below PR.)_
   </li>
<li>Joshua Quick 2020-04-04

   PR: <a href="https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/pull/48" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/pull/48</a></li>
<li>Joshua Quick 2020-04-20

   Here is a back-port which will work with Titanium 7.0.0+. (Not built with gradle.)
   PR (android)(3_3_X): <a href="https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/pull/50" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/appcelerator.encrypteddatabase/pull/50</a>
   </li>
<li>Lokesh Choudhary 2020-04-21

   Backport PR Merged.</li>
<li>Lokesh Choudhary 2020-04-22

   Fix works as expected.
   Closing.</li>
</ol>


<p><a href="/MOD/MOD-2589.json">JSON Source</a></p>