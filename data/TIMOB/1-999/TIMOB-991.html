---
title: "[TIMOB-991] Crash on startup in iPhone OS 4.0"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T01:54:54.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 1.4.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>ios, iphone, mobile</td></tr>
<tr><th>Reporter</th><td>Blain Hamon</td></tr>
<tr><th>Assignee</th><td>Reggie Seagraves</td></tr>
<tr><th>Created</th><td>2011-04-15T02:40:53.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T01:54:54.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>When running any Titanium 0.9+ app in 4.0, the app crashes on
start. Jeff and I tracked it down to inside TiJSCore, namely
calling vm_map returns a mapped area in 3.x, but returns 4 (Invalid
parameters) with address 0. TiJSCore next tries to dereference the
0 address, crashing.</p>
<p>In some situations, building for 4.0 works but then it crashes
on 3.x. We may need to compare the arguments generated in each
case, and dynamically try (Or try multiple times) to get the memory
to stop the crasher.</p></div>

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-991_17905/archive.zip">archive.zip</td></td><td>2011-04-15T02:40:56.000+0000</td><td>11950081</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Blain Hamon 2011-04-15

   <div><p>The plot thickens. Why does this one project have vm_map fail
   and succeed in the same run? (Built in b2)</p></div></li>
<li>Blain Hamon 2011-04-15

   <div><p>Words fail me. When building for 4.0b4 or 3.2, running on a
   3.1.3 device:</p>
   <pre>
   <code>void foo(vm_address_t *unused)
   {
       vm_address_t resultaddress = 0;
       vm_address_t *address = &amp;resultaddress;
       kern_return_t result;
   
       printf("We're calling vm_map(0x%X (0x%X))\n",(unsigned int)address,*address);
       result = vm_map(current_task(),address,BLOCK_SIZE,BLOCK_OFFSET_MASK,VM_FLAGS_ANYWHERE | VM_MAKE_TAG(63),MEMORY_OBJECT_NULL,0,FALSE,VM_PROT_DEFAULT,VM_PROT_DEFAULT,VM_INHERIT_DEFAULT);
       printf("vm_map2 function was 0x%X. Result was 0x%X, Address is 0x%X\n",(unsigned int)vm_map,result,*address);
   }</code>
   </pre>
   <p>foo(NULL); will succeed. {vm_address_t resultaddress = 0;
   foo(&amp;resultaddress);} will fail.</p>
   <p>You read that right. A nonzero value in an unused variable will
   cause an error in a called function. I spent several minutes
   saying, "What?!"</p>
   <p>For 3.2 or 4.0b4 on a 4.0b4 device, the unused variable has no
   effect, as what should happen.</p>
   <p>This does not explain why there is a failure for 4.0 against the
   old 3.1-era TiJSCore code, but we at least have a workaround, and
   we can safely build tiJSCore with 3.2 as the base SDK, and it
   should be backwards and forwards compatible.</p></div></li>
<li>Blain Hamon 2011-04-15

   <div><p>Fix implemented in TiJSCore.</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-991.json">JSON Source</a></p>