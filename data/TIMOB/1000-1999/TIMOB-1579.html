---
title: "[TIMOB-1579] Memory leak: XML DOM NodeProxy never releases proxy objects from cache on Android"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T01:56:34.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 1.5.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, defect, dom, memory, xml</td></tr>
<tr><th>Reporter</th><td>Brion Vibber</td></tr>
<tr><th>Assignee</th><td>Don Thorp</td></tr>
<tr><th>Created</th><td>2011-04-15T02:56:34.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T01:56:34.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>I've been hitting terrible out-of-memory errors while working on
our StatusNet Mobile client app on Android. On some investigation,
it seems that the XML-related code is leaking a lot of memory:</p>
<p>The caching code in NodeProxy.getProxy() says:</p>
<pre>
<code>// We cache node proxies so we're not constructing new ones on every single call
// on node finalize we have to go back through and remove each proxy</code>
</pre>
<p>but I don't see any finalizer on NodeProxy and friends.</p>
<p>Dumping the proxy objects into an ever-growing HashMap means
that DOM-related objects never get garbage collected once they've
been accessed from JS code: both the proxy and the native object
are always referenced from the HashMap.</p>
<p>Simply removing the addition of proxy objects into that
proxyCache hash map makes my app's memory usage MUCH more stable.
If the cache is necessary, weaker references should probably be
used to ensure that the garbage collector can release the proxy
objects.</p></div>

<h3>Comments</h3>

<ol>
<li>Don Thorp 2011-04-15

   <div><p>After discussion, we've decided to remove the cache altogether.
   If the Ti developer wants to cache a node he/she can. iPhone impl
   doesn't seem to be preserving identity either so this should not be
   an issue.</p></div></li>
<li>Don Thorp 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/8c4255ae53929d6007537ea6d2275444e19e98fa"
   title=
   "Changeset [8c4255ae53929d6007537ea6d2275444e19e98fa]">[8c4255ae53929d6007537ea6d2275444e19e98fa]</a>)
   [<a href="/projects/32238/tickets/1579" title=
   "Ticket #1579">#1579</a> state:fixed-in-qa] completely removed the
   Node cache. To test you should be able to process several xml
   documents and see memory eventually GC. The original implementation
   had the cache as static so it would grow w/o bound and never clean
   with each XML document processed. Thanks to Brion Vibber (<a href=
   "<a href="https://appcelerator.lighthouseapp.com/users/100533" rel="nofollow" target="_blank">https://appcelerator.lighthouseapp.com/users/100533</a>"><a href="https://appcelerator.lighthouseapp.com/users/100533" rel="nofollow" target="_blank">https://appcelerator.lighthouseapp.com/users/100533</a></a>)
   for the original find <a href=
   "<a href="http://github.com/appcelerator/titanium_mobile/commit/8c4255ae53929d6007537ea6d2275444e19e98fa" rel="nofollow" target="_blank">http://github.com/appcelerator/titanium_mobile/commit/8c4255ae53929d6007537ea6d2275444e19e98fa</a>">
   <a href="http://github.com/appcelerator/titanium_mobile/commit/8c4255ae53929..." rel="nofollow" target="_blank">http://github.com/appcelerator/titanium_mobile/commit/8c4255ae53929...</a></a></p></div></li>
<li>Thomas Huelbert 2011-04-15

   <div><p>loaded a few xml docs, and saw the GC kick in<br>
   freed X objects / X bytes in Xms</p>
   <p>closing as resolved.</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-1579.json">JSON Source</a></p>