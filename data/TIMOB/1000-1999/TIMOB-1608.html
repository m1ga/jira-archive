---
title: "[TIMOB-1608] Android: Audio not stopped on incoming call"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Invalid</td></tr>
<tr><th>Resolution Date</th><td>2013-07-22T17:55:33.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>2013 Sprint 15 API, 2013 Sprint 15</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, audioplayer, interrupt, ios, ipass1, supportTeam</td></tr>
<tr><th>Reporter</th><td>Andrew Heebner</td></tr>
<tr><th>Assignee</th><td>Ping Wang</td></tr>
<tr><th>Created</th><td>2011-04-15T02:57:15.000+0000</td></tr>
<tr><th>Updated</th><td>2017-03-29T16:05:08.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Issue</h4>
createAudioPlayer() do not stop audio playback on an incoming. No events actually passed through these objects in order to check for calls.

<h4>Target environment</h4>
TiSDK 3.1.1.GA & new HTC One/Android 4.1.2 

<h4>Sample</h4>
To reproduce run snippet, start audio playback then call to phone. 
<code><pre>
var win = Titanium.UI.createWindow({  
    title:'Audio Test',
    backgroundColor:'#fff',
    layout: 'vertical'
});

var startStopButton = Titanium.UI.createButton({
    title:'Start/Stop Streaming',
    top:10,
    width:200,
    height:40
});

var pauseResumeButton = Titanium.UI.createButton({
    title:'Pause/Resume Streaming',
    top:10,
    width:200,
    height:40,
    enabled:false
});

win.add(startStopButton);
win.add(pauseResumeButton);

// allowBackground: true on Android allows the 
// player to keep playing when the app is in the 
// background. 
var audioUrl = '<a href="http://broadcast.infomaniak.net:80/energyzuerich-high.mp3" rel="nofollow" target="_blank">http://broadcast.infomaniak.net:80/energyzuerich-high.mp3</a>';
var audioPlayer = Ti.Media.createAudioPlayer({ 
    url: audioUrl,
    allowBackground: true
});           
    
startStopButton.addEventListener('click',function() {
    // When paused, playing returns false.
    // If both are false, playback is stopped.
    if (audioPlayer.playing || audioPlayer.paused)
    {
        audioPlayer.stop();
        pauseResumeButton.enabled = false;
        if (Ti.Platform.name === 'android')
        { 
            audioPlayer.release();
        }   
    }
    else
    {
        audioPlayer.start();
        pauseResumeButton.enabled = true;
    }
});

pauseResumeButton.addEventListener('click', function() {
    if (audioPlayer.paused) {
        audioPlayer.start();
    }
    else {
        audioPlayer.pause();
    }
});

audioPlayer.addEventListener('progress',function(e) {
    Ti.API.info('Time Played: ' + Math.round(e.progress) + ' milliseconds');
});

audioPlayer.addEventListener('change',function(e)
{
    Ti.API.info('State: ' + e.description + ' (' + e.state + ')');
});

win.addEventListener('close',function() {
    audioPlayer.stop();
    if (Ti.Platform.osname === 'android')
    { 
        audioPlayer.release();
    }
});

win.open();
</pre></code>

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-1608_40442/Razr_2.3.5_AudioPlayer_CallIncoming.txt">Razr_2.3.5_AudioPlayer_CallIncoming.txt</td></td><td>2013-07-01T20:25:21.000+0000</td><td>548291</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Stephen Tramer 2011-04-15

   <div><p>May actually be valid; not necessarily a call interrupt (which
   we do check for, I believe, and which users can handle). Would have
   to be fired on the media module.</p>
   <p>Tagging for both iOS and Android, though this was originally
   filed for Android only.</p></div></li>
<li>Gerry Cardinal III 2011-04-15

   <div><p>On iOS, it does not look like the AudioStreamerCUR is currently
   listening for interruptions:</p>
   <pre>
   <code>#ifdef TARGET_OS_IPHONE         
   //
   // MyAudioSessionInterruptionListener
   //
   // Invoked if the audio session is interrupted (like when the phone rings)
   //
   // TODO: Need to add this into the interruption framework, it's a bug!
   void MyAudioSessionInterruptionListenerCUR(void *inClientData, UInt32 inInterruptionState)
   {
       AudioStreamerCUR* streamer = (AudioStreamerCUR *)inClientData;
       [streamer handleInterruptionChangeToState:inInterruptionState];
   }
   #endif</code>
   </pre></div></li>
<li>Junaid Younus 2012-08-20

   No test case, ticket marked as invalid.</li>
<li>Neeraj Gupta 2012-08-20

   We should be able to put together a simple test case based on the description here.</li>
<li>Rahul Dhingra 2013-06-09

   Audio streaming apps require background streaming and with the incoming call event not automatically handled on the appcelerator android audioplayer, it leaves our appcelerator app with playing a stream while a user is having a telephonic conversation. Request to change priority of this ticket from trivial to higher priority and a fix implemented. 
   
   Please do suggest if you need code examples, but this can typically be replicated in kitchensink itself with a remote stream / shoutcast stream and the audio player.
   </li>
<li>Rahul Dhingra 2013-06-16

   Hi all,
   
   Any updates? Can you atleast suggest a work around for now? 
   
   I have exhausted all attempts with broadcast receivers, android modules, etc.
   
   - Rahul</li>
<li>Rahul Dhingra 2013-06-23

   Hi all,
   
   Anyone looking into this?
   Would be great if I could get a lead in the right direction for a work around in the meanwhile...
   
   - Rahul</li>
<li>Ping Wang 2013-07-19

   If the audio is created with {allowBackground: false}, it will stop on incoming call. Because setting allowBackground to false means the audio should stop playing when its activity is paused. Please see our [doc](<a href="http://docs.appcelerator.com/titanium/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/titanium/latest/#</a>!/api/Titanium.Media.Sound-property-allowBackground).</li>
<li>Joel Hulen 2013-07-22

   I don't see this request as invalid, because the requirement to set allowBackground to true is valid in most audio-based apps I've developed. Most people don't want to keep the application in the foreground while listening to music/streaming audio for long periods of time. To support this, you must have the allowBackground set to true, then you run across the issue of the audio not automatically pausing when a call comes in. Please re-open this support ticket to address this issue for audio applications that require background playback.</li>
<li>Ping Wang 2013-07-22

    The developers can use [BroadcastReceiver](<a href="http://docs.appcelerator.com/titanium/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/titanium/latest/#</a>!/api/Titanium.Android.BroadcastReceiver) to get the phone state. But right now, we don't expose the intent constant [ACTION_PHONE_STATE_CHANGED](<a href="http://developer.android.com/reference/android/telephony/TelephonyManager.html#ACTION_PHONE_STATE_CHANGED)." rel="nofollow" target="_blank">http://developer.android.com/reference/android/telephony/TelephonyManager.html#ACTION_PHONE_STATE_CHANGED).</a> Will file a feature request for that. For now, the developers can use the workaround attached below:
    <code><pre>
    var win = Titanium.UI.createWindow({  
        title:'Audio Test',
        backgroundColor:'#fff',
        layout: 'vertical'
    });
     
    var startStopButton = Titanium.UI.createButton({
        title:'Start/Stop Streaming',
        top:10,
        width:200,
        //height:40
    });
     
    var pauseResumeButton = Titanium.UI.createButton({
        title:'Pause/Resume Streaming',
        top:10,
        width:200,
        //height:40,
        enabled:false
    });
     
    win.add(startStopButton);
    win.add(pauseResumeButton);
     
    // allowBackground: true on Android allows the 
    // player to keep playing when the app is in the 
    // background. 
    var audioUrl = '<a href="http://broadcast.infomaniak.net:80/energyzuerich-high.mp3" rel="nofollow" target="_blank">http://broadcast.infomaniak.net:80/energyzuerich-high.mp3</a>';
    var audioPlayer = Ti.Media.createAudioPlayer({ 
        url: audioUrl,
        allowBackground: true
    });           
         
    startStopButton.addEventListener('click',function() {
        // When paused, playing returns false.
        // If both are false, playback is stopped.
        if (audioPlayer.playing || audioPlayer.paused)
        {
            audioPlayer.stop();
            pauseResumeButton.enabled = false;
            if (Ti.Platform.name === 'android')
            { 
                audioPlayer.release();
            }   
        }
        else
        {
            audioPlayer.start();
            pauseResumeButton.enabled = true;
        }
    });
     
    pauseResumeButton.addEventListener('click', function() {
        if (audioPlayer.paused) {
            audioPlayer.start();
        }
        else {
            audioPlayer.pause();
        }
    });
     
    audioPlayer.addEventListener('progress',function(e) {
        Ti.API.info('Time Played: ' + Math.round(e.progress) + ' milliseconds');
    });
     
    audioPlayer.addEventListener('change',function(e)
    {
        Ti.API.info('State: ' + e.description + ' (' + e.state + ')');
    });
     
    win.addEventListener('close',function() {
        audioPlayer.stop();
        if (Ti.Platform.osname === 'android')
        { 
            audioPlayer.release();
        }
    });
    
    var bc = Ti.Android.createBroadcastReceiver({
    	onReceived : function(e) {
    		Ti.API.info('****************** Handling broadcast: ');
    		if (e.intent) {
    			var state = e.intent.getStringExtra("state");
    			Ti.API.info("phone state: " + state);
    			if (state === "RINGING") {
    				// Incoming call. Pause the audio.
    				Ti.API.info("RINGING");
    				audioPlayer.pause()
    			}
    			if (state === "OFFHOOK") {
    				// A call is dialing, active or on hold
    				Ti.API.info("OFFHOOK");
    			}
    			if (state === "IDLE") {
    				// Not in call. Resume the audio.
    				Ti.API.info("IDLE");
    				audioPlayer.start()
    			}
    		}
    	}
    }); 
    
    Ti.Android.registerBroadcastReceiver(bc, ["android.intent.action.PHONE_STATE"]);
     
    win.open();
    </pre></code>
    In order to get the phone state, the READ_PHONE_STATE permission is required. So please add the permission to the tiapp.xml:
    <code><pre>
    &lt;android xmlns:android="<a href="http://schemas.android.com/apk/res/android" rel="nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"&gt;
            &lt;manifest&gt;
                &lt;uses-permission android:name="android.permission.READ_PHONE_STATE"/&gt;
            &lt;/manifest&gt;
        &lt;/android&gt;
    </pre></code></li>
<li>Lee Morris 2017-03-29

    Closing ticket as invalid.</li>
</ol>


<p><a href="/TIMOB/TIMOB-1608.json">JSON Source</a></p>