---
title: "[TIMOB-1635] Android: Errors with "logging and Unicode" test cases"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Low</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T01:56:43.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 1.6.0 M04</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, defect, release-1.6.0</td></tr>
<tr><th>Reporter</th><td>Thomas Huelbert</td></tr>
<tr><th>Assignee</th><td>Don Thorp</td></tr>
<tr><th>Created</th><td>2011-04-15T02:57:54.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T01:56:43.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>1.BaseUI&gt;Views&gt;WebViews&gt;Loggin and unicode<br>
2.check console output</p>
<p>results:<br>
E/Web Console( 627): Uncaught TypeError: Cannot read property 'API'
of undefined at
file:///android_asset/Resources/examples/webview_logging.html:5<br>
D/TiAPI ( 627): (kroll$31) [102,344500] webview loaded:
file:///android_asset/Resources/examples/webview_logging.html</p></div>

<h3>Comments</h3>

<ol>
<li>Bill Dawson 2011-04-15

   <div><p>Thomas, just curious, was the failcase from a device or the
   emulator? I'm getting weird mixed behavior. (You can assign to me
   after answering)</p></div></li>
<li>Thomas Huelbert 2011-04-15

   <div><p>Sorry for the omitted info Bill - this was device only (worked
   on the simulator when I tested it) - nexus one running 2.2</p></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>Ok, cool, I have the exact same behavior pattern. Fails on my
   HTC Desire using 2.2, works in an emulator (I tried it with a 2.1
   emulator but will also try 2.2).</p></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>So this has been broken (on devices -- at least 2.2) basically
   forever. I tried even for Titanium 1.3:</p>
   <pre>
   <code>I/TiAPI   (19880): (kroll$1) [115,154]  *** TITANIUM VERSION 1.3.0 ***
   I/ActivityManager(   97): Displayed activity com.billdawson.simplewebview/.SimplewebviewActivity: 548 ms (total 548 ms)
   I/TabGroupProxy(19880): (main) [82,236] handleOpen
   I/ActivityManager(   97): Starting activity: Intent { cmp=com.billdawson.simplewebview/ti.modules.titanium.ui.TiTabActivity (has extras) }
   W/TiTabActivity(19880): (main) [32,268] Notifying TiTabGroup, activity is created
   W/TiActivity(19880): (main) [114,382] Notifying TiUIWindow, activity is created
   I/ActivityManager(   97): Displayed activity com.billdawson.simplewebview/ti.modules.titanium.ui.TiTabActivity: 312 ms (total 312 ms)
   E/Web Console(19880): Uncaught ReferenceError: TiAPI is not defined at :1
   D/webkit-timers(19880): [JWebCoreJavaBridge::resume] &gt;&gt; do resume
   E/Web Console(19880): Uncaught TypeError: Cannot read property 'API' of undefined at file:///android_asset/Resources/simple.html:23</code>
   </pre>
   <p>That <code>D/webkit-timers(19880)</code> line is interesting. It
   does not occur in the emulator!</p>
   <p>Still researching...</p></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>Here is the core Android code for
   <code>WebView.addJavascriptInterface()</code>, which we use to put
   <code>TiAPI</code> and <code>TiApp</code> in the javascript
   scope:</p>
   <pre>
   <code class=
   "java">public void addJavascriptInterface(Object obj, String interfaceName) {
           WebViewCore.JSInterfaceData arg = new WebViewCore.JSInterfaceData();
           arg.mObject = obj;
           arg.mInterfaceName = interfaceName;
           mWebViewCore.sendMessage(EventHub.ADD_JS_INTERFACE, arg);
       }</code>
   </pre>
   <p>Messages in <code>mWebViewCore</code> are handled on a separate
   thread. Maybe the loading of a page in the webview is actually fast
   enough to occur before our objects are added to the javascript
   scope.</p>
   <p>In my tests on an HTC Desire running Android 2.2, this page
   loaded in a WebView and required the <code>setTimeout</code> to run
   once (with just 100 milliseconds) before <code>Ti.API</code> was
   available:</p>
   <pre>
   <code class="html">&lt;!doctype html&gt;
   &lt;html&gt;
       &lt;body&gt;
           &lt;div id="log"&gt;&lt;/div&gt;
       &lt;/body&gt;
       &lt;script&gt;
       var i = 1;
       function log(s) {
           document.getElementById('log').innerHTML += '&lt;br/&gt;' + s;
       }
       var interval = 100;
       function checkTi() {
           if (!window.hasOwnProperty("Ti") ) {
               log("Still no Ti.  Trying again (" + i + ")");
               i++;
               setTimeout(checkTi, interval);
           } else if (typeof window.Ti === 'undefined') {
               log('Got Ti, but it is undefined.  Trying again (' + i + ')');
               i++;
               setTimeout(checkTi, interval);
           } else if (!window.Ti.hasOwnProperty('API')) {
               log("Ti but no Ti.API.  Trying again (" + i + ")");
               i++;
               setTimeout(checkTi, interval);
           } else {
               log('got it on try ' + i);
               Ti.API.info('Welcome to my web page');
           }
       }
       window.onload = function() {
           checkTi();
       }
       &lt;/script&gt;
   &lt;/html&gt;</code>
   </pre></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/12d7bf6a90db72fa0aebe538c95128c8a0cdc625"
   title=
   "Changeset [12d7bf6a90db72fa0aebe538c95128c8a0cdc625]">[12d7bf6a90db72fa0aebe538c95128c8a0cdc625]</a>)
   Inject our Ti JS and JSON near beginning of local (and ONLY local)
   html file contents or html set directly via the html property.
   [<a href="/projects/32238/tickets/2153" title=
   "Ticket #2153">#2153</a> state:fixed-in-qa][<a href=
   "/projects/32238/tickets/2514" title="Ticket #2514">#2514</a>
   state:fixed-in-qa][<a href="/projects/32238/tickets/1635" title=
   "Ticket #1635">#1635</a> state:fixed-in-qa][<a href=
   "/projects/32238/tickets/1036" title="Ticket #1036">#1036</a>
   state:fixed-in-qa] <a href=
   "<a href="https://github.com/appcelerator/titanium_mobile/commit/12d7bf6a90db72fa0aebe538c95128c8a0cdc625" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/12d7bf6a90db72fa0aebe538c95128c8a0cdc625</a>">
   <a href="https://github.com/appcelerator/titanium_mobile/commit/12d7bf6a90db..." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/12d7bf6a90db...</a></a></p></div></li>
<li>Thomas Huelbert 2011-04-15

   <div><p>This works great on 2.2 devices, but on 1.6 the test fails
   with:</p>
   <p>I/ActivityManager( 76): Starting activity: Intent {
   cmp=com.appcelerator.pushtest/org.appcelerator.titanium.TiActivity
   (has extras) }<br>
   I/ActivityManager( 76): Displayed activity
   com.appcelerator.pushtest/org.appcelerator.titanium.TiActivity: 175
   ms (total 175 ms)<br>
   I/global ( 641): Default buffer size used in BufferedReader
   constructor. It would be better to be explicit if an 8k-char buffer
   is required.<br>
   D/WebCore ( 641): Console: ReferenceError: Can't find variable: Ti
   line: 5 source:
   file:///android_asset/Resources/examples/webview_logging.html</p>
   <p>Maybe a fact of life on 1.6? back to Bill.</p></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/3452f061796695f0ad14d49fe3b22689f2e27dce"
   title=
   "Changeset [3452f061796695f0ad14d49fe3b22689f2e27dce]">[3452f061796695f0ad14d49fe3b22689f2e27dce]</a>)
   [<a href="/projects/32238/tickets/1635" title=
   "Ticket #1635">#1635</a> state:fixed-in-qa] Android webkit
   MimeTypeMap does not have a mime type for file extension html until
   Android version 2.2. So we need to add it to our own mime type map
   in order for html files to be recognized as text/html and therefore
   get our javascript code injected. <a href=
   "<a href="https://github.com/appcelerator/titanium_mobile/commit/3452f061796695f0ad14d49fe3b22689f2e27dce" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/3452f061796695f0ad14d49fe3b22689f2e27dce</a>">
   <a href="https://github.com/appcelerator/titanium_mobile/commit/3452f0617966..." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/3452f0617966...</a></a></p></div></li>
<li>Thomas Huelbert 2011-04-15

   <div><p><a href="/projects/32238/changesets/INFO" title=
   "Changeset [INFO]">[INFO]</a> Titanium SDK version: 1.6.0 (01/10/11
   08:25 3452f06) G1 (1.6) and the 1.6 emulator.</p></div></li>
<li>vooood 2011-04-15

    <div><p>seems like the problem persists with the latest nightly build
    <a href="/projects/32238/changesets/INFO" title=
    "Changeset [INFO]">[INFO]</a> Titanium SDK version: 1.6.0 (01/22/11
    23:17 9177466...)</p>
    <p>the Titanium variable is just not available to the android
    simulator even after a wait of 60 seconds (tested using Bill
    Dawson's method above) making the API completely unavailable for
    use on remote web pages. The page was generated with PHP but the
    output is equal to what Bill Dawson provided.</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-1635.json">JSON Source</a></p>