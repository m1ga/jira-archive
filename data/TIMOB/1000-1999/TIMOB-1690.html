---
title: "[TIMOB-1690] Android: non-UTF-8 data from external source cannot be saved and reopened accurately"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Trivial</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T01:56:53.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 1.5.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, defect</td></tr>
<tr><th>Reporter</th><td>Bill Dawson</td></tr>
<tr><th>Assignee</th><td>Bill Dawson</td></tr>
<tr><th>Created</th><td>2011-04-15T02:59:27.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T01:56:53.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>Use case (helpdesk 38891): app fetches data via XHR. Data is XML
encoded in ISO-8859-1. Data is saved to file, to be opened later.
When re-opened, Titanium forces it to UTF-8, which screws up the
encoding of some of the special characters such as those with
umlaute (&ouml;, &auml; etc) or accents (&eacute; etc).</p>
<p>Fail case:</p>
<p>app.js</p>
<pre>
<code class="javascript">
Titanium.UI.setBackgroundColor('#000');
var win = Titanium.UI.createWindow({  
    title:'Feed encoding test',
    backgroundColor:'#fff',
    fullscreen: true,
    exitOnClose: true,
    url: 'main.js'
});
win.open();</code>
</pre>
<p>main.js:</p>
<pre>
<code class="javascript">var win = Ti.UI.currentWindow;
win.title = "Feed encoding via file"
var url = [SEE HELPDESK 38891]

var dir = Titanium.Filesystem.applicationDataDirectory;
var filename = 'feed.xml';
var file = Ti.Filesystem.getFile(dir, filename);


function saveFeed(data) {
    if (file.exists()){
        file.deleteFile();
    }
    file.write(data);
}

function buildTable() {
    var blob = file.read();
    var string = blob.text;
    var xml = Ti.XML.parseString(string);
    var rows = [];
    try {
        if (xml) {
            var session = xml.getElementsByTagName('session');
            if (session) {
                session = session.item(0);
            } else { 
                alert('session list not fetched');
                return;
            }
            if (session) {
                if (!session.hasChildNodes()) {
                    alert('No child nodes');
                    return;
                }
                var length = session.childNodes.length;
                for (var i = 0; i &lt; length; i++) {
                    var child = session.childNodes.item(i);
                    if (child.nodeType == child.ELEMENT_NODE) {
                        rows.push(Ti.UI.createTableViewRow({color: 'black', title: child.getAttribute("driver")}));
                    }
                }
                win.add(Ti.UI.createTableView({data: rows}));
            } else {
                alert('"session" not found');
            }
        } else {
            alert('XML did not load');
        }
    } catch(ex) {
        alert(ex);
    }
    
}

var xhr = Ti.Network.createHTTPClient();
xhr.onload = function(e) {
    try {
        var data = xhr.responseData;
        saveFeed(data);
        buildTable();
        
    } catch(ex) {
        alert(ex);
    }
};
xhr.open('GET', url);
xhr.send();</code>
</pre>
<p>In the tableview that results from running that code, you will
notice some of the names have characters that are messed up.</p></div>

<h3>Comments</h3>

<ol>
<li>Jeff Haynie 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/32cf760dca3156a8478fa47e519070c900a32fab"
   title=
   "Changeset [32cf760dca3156a8478fa47e519070c900a32fab]">[32cf760dca3156a8478fa47e519070c900a32fab]</a>)
   [<a href="/projects/32238/tickets/1690" title=
   "Ticket #1690">#1690</a>] Put a transcodeString() utility function
   into UtilsModule. <a href=
   "<a href="http://github.com/appcelerator/titanium_mobile/commit/32cf760dca3156a8478fa47e519070c900a32fab" rel="nofollow" target="_blank">http://github.com/appcelerator/titanium_mobile/commit/32cf760dca3156a8478fa47e519070c900a32fab</a>">
   <a href="http://github.com/appcelerator/titanium_mobile/commit/32cf760dca315..." rel="nofollow" target="_blank">http://github.com/appcelerator/titanium_mobile/commit/32cf760dca315...</a></a></p></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>We want to keep things internally in UTF-8, so instead of trying
   to track the other encoding throughout its lifetime in Titanium
   code (i.e., in TiBlob, TiFile, etc), we now give the developer a
   way to transcode the text to utf-8 and then save that:</p>
   <pre>
   <code class=
   "javascript">var utf8Text = Ti.Utils.transcodeString(origText, 'ISO-8859-1', 'UTF-8');</code>
   </pre>
   <p>So <code>Ti.Utils.transcodeString(origText, origEncoding,
   desiredEncoding)</code> is new.</p>
   <p>To fix the fail case from the description of this item, in the
   function <code>saveFeed</code> change <code>file.write(data)</code>
   to <code>file.write(Ti.Utils.transcodeString(data, 'ISO-8859-1',
   'UTF-8'))</code>.</p>
   <p>Then, because the feed contains <code>&lt;?xml version="1.0"
   encoding="ISO-8859-1"?&gt;</code>, you need to change the
   <code>encoding=</code> to read <code>encoding='UTF-8</code> before
   giving it to the xml parser. So in <code>buildTable()</code> change
   ...</p>
   <pre>
   <code class=
   "javascript">var xml = Ti.XML.parseString(string);</code>
   </pre>
   <p>... to ...</p>
   <pre>
   <code class=
   "javascript">var xml = Ti.XML.parseString(string.replace(/iso-8859-1/i, 'UTF-8'));</code>
   </pre>
   <p>Finally, when the data comes back from the provider, get it with
   <code>responseText</code> instead of <code>responseData</code><br>
   . So replace this...</p>
   <pre>
   <code class="javascript">var data = xhr.responseData;</code>
   </pre>
   <p>with this ...</p>
   <pre>
   <code class="javascript">
   var data = xhr.responseText;</code>
   </pre></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>I screwed up in the previous comment. I forgot to mention you
   need to also replace <code>xhr.responseData</code> with
   <code>xhr.responseText</code>. I edited the comment above to
   reflect this now.</p></div></li>
<li>Thomas Huelbert 2011-04-15

   <div><p>w00t - that did it, thanks Much Bill. Confirmed on nexus 1
   running 2.2 and simulator.</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-1690.json">JSON Source</a></p>