---
title: "[TIMOB-1774] Android: Reopening a window sometimes fails with runtime error"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T01:57:08.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 1.5.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, defect</td></tr>
<tr><th>Reporter</th><td>Bill Dawson</td></tr>
<tr><th>Assignee</th><td>Bill Dawson</td></tr>
<tr><th>Created</th><td>2011-04-15T03:01:55.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T01:57:08.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>This is a bit of a complex one and hard to test from a QE
perspective.</p>
<p>Because our memory cleanup (and the releasing / garbage
collecting of objects) has improved, we actually have a weird
situation where if you re-open an existing window (meaning, call
<code>.open</code> on an existing window proxy) that had previously
been closed, the activity attached to its context might be null
(garbage collected). The <code>.open()</code> process creates our
window view instance, which in turn creates an Android intent to
open a new activity. The code to create the intent is in the
TiUIWindow constructor:</p>
<pre>
<code>if (newActivity){
  lightWeight = false;
  Activity activity = proxy.getTiContext().getActivity();
  Intent intent = createIntent(activity, options);</code>
</pre>
<p>The problem is that the <code>getActivity()</code> you see there
might be null, because the proxy's context -- from the previous
time the window was closed -- has been released and its activity
cleaned up.</p>
<p>During the creation of a window, the proxy's context is actually
switched from the context it was created in to the context that it
creates -- and that's the context that gets cleaned up when it's
closed.</p>
<p>The fix for this is: when the window is closed, switch its
context back to its creating context (from which it was switched
away when it created its own context the last time it was
opened.)</p></div>

<h3>Comments</h3>

<ol>
<li>Bill Dawson 2011-04-15

   <div><p>By the way, you can get away with this error not happening --
   it's just that if a garbage collection occurs and wipes out that
   old activity, then it will happen when the window is reopened.
   Using DDMS I can force a garbage collection and get the problem to
   occur everytime.</p></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>Relevant commit, for which , as so often, i screwed up the
   comment so it didn't get here automatically:</p>
   <p><a href=
   "<a href="http://github.com/appcelerator/titanium_mobile/commit/6c2b0d450f4a879a2d48a2376564870d4ad06e8b" rel="nofollow" target="_blank">http://github.com/appcelerator/titanium_mobile/commit/6c2b0d450f4a879a2d48a2376564870d4ad06e8b</a>">
   <a href="http://github.com/appcelerator/titanium_mobile/commit/6c2b0d450f4a8..." rel="nofollow" target="_blank">http://github.com/appcelerator/titanium_mobile/commit/6c2b0d450f4a8...</a></a></p></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>Thomas,</p>
   <p>This might be tough one to test. You need a tool like DDMS to
   force a garbage collection. In case you want to try, here's a fail
   case consisting of three files:</p>
   <p>app.js:</p>
   <pre>
   <code class="javascript">var win = 
   Titanium.UI.createWindow({  
       title:'Test Anything',
       backgroundColor:'#fff',
       url: 'w1.js',
       fullscreen:true,
       exitOnClose: true
       
   });
   win.open();</code>
   </pre>
   <p>w1.js:</p>
   <pre>
   <code class="javascript">var win = Ti.UI.currentWindow;
   var win2;
   
   var btn = Ti.UI.createButton({
       title: 'open subwindow'
   });
   btn.addEventListener('click', function(){win2.open();});
   win.add(btn);
   
   win2 = Ti.UI.createWindow({
       url: 'w2.js', backgroundColor:'green', fullscreen: true
   });</code>
   </pre>
   <p>w2.js:</p>
   <pre>
   <code class="javascript">var win = Ti.UI.currentWindow;
   
   var lbl = Ti.UI.createLabel({color: 'black',text: 'Hit back button to go back'});
   win.add(lbl);</code>
   </pre>
   <p>Then follow these steps:</p>
   <ul>
   <li>Open the app</li>
   <li>Click the button to open the second window.</li>
   <li>Click the Android back button (hardware) to go back to the
   first window.</li>
   <li>Force a garbage collection. (DDMS)</li>
   <li>Click the button to open the second window. -- You should get a
   Force Close.</li>
   </ul>
   <p>To test the fail case, you need a version prior to the above
   commit (obviously :) ) but still very recent, like in the last two
   days.</p></div></li>
<li>Thomas Huelbert 2011-04-15

   <div><p>closing, 1.6 g1 device, 2.2 simulator. Thanks for the debug flag
   info for device, as well as the test case.</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-1774.json">JSON Source</a></p>