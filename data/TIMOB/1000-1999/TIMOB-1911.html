---
title: "[TIMOB-1911] Android: Titanium apps can't survive an activity relaunch"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>New Feature</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2012-02-10T19:50:29.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Sprint 2012-03, Release 2.0.0, Release 1.8.2</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, feature</td></tr>
<tr><th>Reporter</th><td>Bill Dawson</td></tr>
<tr><th>Assignee</th><td>Bill Dawson</td></tr>
<tr><th>Created</th><td>2011-04-15T03:05:22.000+0000</td></tr>
<tr><th>Updated</th><td>2017-03-24T21:01:49.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>Because of the cleanup code in TiUIWindow (see
<code>release()</code>), Titanium apps can't survive an activity
relaunch. Even the simplest app:</p>
<pre>
<code class="javascript">/*global Ti, Titanium, alert, JSON */
Titanium.UI.setBackgroundColor('#000');
Titanium.UI.createWindow({  
    title:'Test',
    backgroundColor:'#fff',
    fullscreen: true,
    exitOnClose: true
}).open();</code>
</pre>
<p>To cause an activity relaunch, change the locale while the
activity is running. Example:</p>
<ul>
<li>
<p>Open a titanium app.</p>
</li>
<li>
<p>Keeping it open (i.e., don't back out), hit your Home key.</p>
</li>
<li>
<p>Go to Settings -&gt; Language &amp; Keyboard -&gt; Select
language, then change the language.</p>
</li>
<li>
<p>Go back to the Titanium app -- it will crash.</p>
</li>
</ul>
<p>What's happening can be shown in the attached
relaunch_activity.png graphic. Apparently Android forces the
activity to relaunch if the locale has changed. This causes
<code>onDestroy</code>, which in our code results in the window
cleaning up itself, but then activity create occurs again. Now the
<code>handler</code> object is null, however, and all views are
gone.</p>
<p>Is there some way for us to determine if <code>onDestroy</code>
is occurring because of a relaunch?</p></div>

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-1911_18075/relaunch_activity.png">relaunch_activity.png</td></td><td>2011-04-15T03:05:23.000+0000</td><td>172489</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-1911_25684/SendLog (2).txt">SendLog (2).txt</td></td><td>2012-02-08T15:27:36.000+0000</td><td>152840</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Bill Dawson 2011-04-15

   <div><p>Assigning to Don for milestone/priority.</p></div></li>
<li>Don Thorp 2011-04-15

   <div><p>Need to add <code>locale</code> to the list of things we handle
   in the activity definitions in the AndroidManifest.xml see <a href=
   "<a href="http://developer.android.com/reference/android/R.attr.html#configChanges" rel="nofollow" target="_blank">http://developer.android.com/reference/android/R.attr.html#configChanges</a>">
   Android Docs</a></p>
   <p>What I'm not clear of is if we should fire a
   <code>localeChange</code> event to the activity. It might be a good
   thing to do.</p></div></li>
<li>Neeraj Gupta 2012-02-04

   We have suggested a way to fix this issue to Pedro and awaiting feedback from him.</li>
<li>Opie Cyrus 2012-02-04

   Adding the android:alwaysRetainTaskState="true" flag to the root activity in the manifest section of the tiapp.xml should address the problem of the black screen for the root activity.  The following is an example snippet from the Kitchen Sink tiapp.xml
   
   <code><pre>
   &lt;manifest&gt;&lt;application&gt;
   &lt;activity android:name=".KitchensinkActivity" 
      android:alwaysRetainTaskState="true" 
      android:configChanges="keyboardHidden|orientation" 
      android:label="Kitchensink" 
      android:name=".KitchensinkActivity" 
      android:theme="@style/Theme.Titanium"&gt;
     &lt;intent-filter&gt;
       &lt;action android:name="android.intent.action.MAIN"/&gt;
       &lt;category android:name="android.intent.category.LAUNCHER"/&gt;
     &lt;/intent-filter&gt;
   &lt;/activity&gt;
   &lt;/application&gt;&lt;/manifest&gt;
   </pre></code></li>
<li>Nikolai Derzhak 2012-02-06

   This issue latest notification was not sent due to JIRA mail setting. Fixed now. Please check the issue for latests changes.</li>
<li>Neeraj Gupta 2012-02-08

   We need to investigate the black screen issue with the work around.</li>
<li>Bill Dawson 2012-02-10

   <h4>Testing notes</h4>
   
   
   The app should now be forced to re-start when the condition is recognized.  To test it, put a Titanium app that has multiple heavyweight windows in it, or a TabGroup (like KitchenSink), on the device, and also put Astro or Advanced Task Killer on the device.  Then these steps:
   
   * Open the Titanium App.  Bring it to a state where at least one heavyweight window (or a TabGroup) is open.  Then...
   * Press the Home key/button to go to the home screen, keeping the Titanium App fully loaded.
   * Now open your favorite task killer app.
   * Kill the Titanium App.
   * Restart the Titanium App.
   
   You will likely see a flicker while Titanium realizes the condition it's in (an unsupported restart from Android, whereby Android attempts to first show the Activity that was top-most at the time the app was killed, rather than going through the "normal" launch sequence) and then forces a full re-start.
   
   If the app hangs or otherwise stays in a non-functional state, then it's a fail.  That's expected when you're testing the fail case with Titanium 1.8.1, but if you're testing the fix branch and this happens, then reject the Pull Request and shed a tear for me.
   </li>
<li>Bill Dawson 2012-02-10

   Pull request ready
   
   <a href="https://github.com/appcelerator/titanium_mobile/pull/1400" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/1400</a></li>
<li>Sander Beck 2012-02-13

   Unfortunately..., the problem persists.</li>
<li>Neeraj Gupta 2012-02-13

    Let us know the build you are using. Did you add the android:alwaysRetainTaskState="true" flag to the root activity in the manifest section of the tiapp.xml as per one of the comments in this bug?</li>
<li>Shawn Lipscomb 2012-02-22

    SDK 1.8.2.v20120221114636 fixed this for me, and I'm *not* using <code>android:alwaysRetainTaskState="true"</code>.
    
    However, the fix seems like a programmed workaround, in that the Black Screen of Death shows up for an instant, then the entire app goes away, then the app's starts up normally with the splash screen.  The question is, why isn't the entire app going away in the first place, like other Android apps do?  What's causing part of a Titanium app to stick around when the Android OS attempts to push it out of memory?</li>
<li>Justin Toth 2012-02-22

    I'd like to echo what Shawn has said, that the black screen issue is fixed by upgrading to the latest CI build of 1.8 or 2.0 and that the android:alwaysRetainTaskState="true" isn't required. It seems that many times when the app errors, regardless of whether it's a user bug or a titanium bug, the app just closes and restarts (with messages about WIN DEATH and Tombstones) rather than giving a error popup like in earlier versions of Titanium and Rhino. I hope the Android team can look into this even though the task is resolved.</li>
<li>Mauro Parra-Miranda 2012-02-22

    </li>
<li>Neeraj Gupta 2012-03-21

    @Eric - Please provide a test case that reproduces this issue. The test case in this ticket does not exhibit this behavior anymore.</li>
<li>Neeraj Gupta 2012-03-21

    @Eric - You should open another ticket for this issue.</li>
<li>Neeraj Gupta 2012-03-21

    @Eric - The question is if you can reproduce the issue with the test in this ticket. If not, please open another ticket with a test case.</li>
<li>Lee Morris 2017-03-24

    Closing ticket as fixed with reference to previous comments.</li>
</ol>


<p><a href="/TIMOB/TIMOB-1911.json">JSON Source</a></p>