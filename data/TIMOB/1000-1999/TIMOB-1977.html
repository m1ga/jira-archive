---
title: "[TIMOB-1977] Android: Backing out of window with other thread using proxies can cause FC"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T01:57:43.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 1.5.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, defect</td></tr>
<tr><th>Reporter</th><td>Bill Dawson</td></tr>
<tr><th>Assignee</th><td>Bill Dawson</td></tr>
<tr><th>Created</th><td>2011-04-15T03:07:03.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T01:57:43.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>If you back out of a window while a separate thread (such as a
callback from an XHR, which is how we discovered this problem) is
making use of proxy objects (view proxies and such) on that window,
you can cause an FC. The FC can occur at multiple places in code,
often in the form of a <code>NullPointerException</code> when
trying to access something that doesn't exist anymore because the
window's context and activity have been released. Here's a sample
FC:</p>
<pre>
<code>E/TiUncaughtHandler(  231): java.lang.NullPointerException
E/TiUncaughtHandler(  231):     at ti.modules.titanium.ui.TableViewProxy.rowProxyFor(TableViewProxy.java:400)
E/TiUncaughtHandler(  231):     at ti.modules.titanium.ui.TableViewProxy.handleInsertRowBefore(TableViewProxy.java:240)
E/TiUncaughtHandler(  231):     at ti.modules.titanium.ui.TableViewProxy.handleMessage(TableViewProxy.java:466)
E/TiUncaughtHandler(  231):     at android.os.Handler.dispatchMessage(Handler.java:95)
E/TiUncaughtHandler(  231):     at android.os.Looper.loop(Looper.java:123)
E/TiUncaughtHandler(  231):     at android.app.ActivityThread.main(ActivityThread.java:4203)
E/TiUncaughtHandler(  231):     at java.lang.reflect.Method.invokeNative(Native Method)
E/TiUncaughtHandler(  231):     at java.lang.reflect.Method.invoke(Method.java:521)</code>
</pre>
<p>You can cause an FC using this app.js + win.js + table.js:</p>
<p>app.js:</p>
<pre>
<code class="javascript">Titanium.UI.setBackgroundColor('#000');
Titanium.UI.createWindow({  
    title:'Test',
    backgroundColor:'#fff',
    fullscreen: true,
    exitOnClose: true,
    url: 'win.js'
}).open();</code>
</pre>
<p>win.js:</p>
<pre>
<code class="javascript">var win = Ti.UI.currentWindow;
var btn = Ti.UI.createButton({
    title: 'Open 2nd Window'
});
btn.addEventListener('click', function(){
    Ti.UI.createWindow( {
        fullscreen:true,
        url: 'table.js',
        backgroundColor: 'black'
    }).open();
});
win.add(btn);</code>
</pre>
<p>table.js:</p>
<pre>
<code class="javascript">var win = Ti.UI.currentWindow;
var tv = Ti.UI.createTableView();
tv.setData( [ Ti.UI.createTableViewRow({ title: 'Loading...' }) ] );
win.add(tv);

// Now start a second thread that will update the table
setTimeout(function() {
    for (var i = 1; i &lt;= 1000; i++) {
        tv.insertRowBefore(0, 
            Ti.UI.createTableViewRow( {title: 'New row ' + i} ));
    }
}, 50);</code>
</pre>
<p>When you run it and you open the second window, click your
hardware back button while the table is being assembled. After you
get back to the first window, just wait a while and it'll
crash.</p></div>

<h3>Comments</h3>

<ol>
<li>Bill Dawson 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/763b1ded2db7f71fac628db4261770f292f9d283"
   title=
   "Changeset [763b1ded2db7f71fac628db4261770f292f9d283]">[763b1ded2db7f71fac628db4261770f292f9d283]</a>)
   [<a href="/projects/32238/tickets/1977" title=
   "Ticket #1977">#1977</a> state:fixed-in-qa] Avoid NPEs in several
   locations when an activity and context have been released but code
   on some thread (like an XHR callback) is still trying to work with
   them. <a href=
   "<a href="http://github.com/appcelerator/titanium_mobile/commit/763b1ded2db7f71fac628db4261770f292f9d283" rel="nofollow" target="_blank">http://github.com/appcelerator/titanium_mobile/commit/763b1ded2db7f71fac628db4261770f292f9d283</a>">
   <a href="http://github.com/appcelerator/titanium_mobile/commit/763b1ded2db7f..." rel="nofollow" target="_blank">http://github.com/appcelerator/titanium_mobile/commit/763b1ded2db7f...</a></a></p></div></li>
<li>Thomas Huelbert 2011-04-15

   <div><p>thanks for the test case, 1.4.2.4ce7ff G1 running 1.6, 2.2
   simulator.</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-1977.json">JSON Source</a></p>