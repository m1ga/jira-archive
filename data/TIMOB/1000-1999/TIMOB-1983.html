---
title: "[TIMOB-1983] setRequestHeader Broken for iPhone platform "
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T01:57:44.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 1.5.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>ios, iphone, regression</td></tr>
<tr><th>Reporter</th><td>David Pratt</td></tr>
<tr><th>Assignee</th><td>Reggie Seagraves</td></tr>
<tr><th>Created</th><td>2011-04-15T03:07:10.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T01:57:44.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>setRequest is broken on trunk for iPhone. Authorization header
is not sent in request using latest nightly build r4c5cd4a3 (Oct
1).</p>
<p>var myUsername = 'testuser';<br>
var myPassword = 'testpass';</p>
<p>var request = Titanium.Network.createHTTPClient({<br></p>
<pre>
<code>    onload:function(e) {
        if (request.status != 200 &amp;&amp; request.status != 201) {
            request.onerror(e);
            return;
        }
    },
    onerror:function(e) {
        Ti.API.info("Got Error: "
            + e.error);
    }
});</code>
</pre>
<p>request.open('GET', '<a href=
"https://myserverurl'">https://myserverurl'</a>, true);<br>
request.setRequestHeader('Authorization','Basic ' +
Titanium.Utils.base64encode(myUsername + ':' + myPassword));<br>
request.send();</p></div>

<h3>Comments</h3>

<ol>
<li>Don Thorp 2011-04-15

   <div><p>Assigning to Ralf to triage. Ralf it looks like a regression so
   I've tagged it as such, it may not actually be.</p></div></li>
<li>Blain Hamon 2011-04-15

   <div><p>This is odd given that the files in question haven't been
   changed in any behavior-changing manner since before 1.4.0. The
   setRequestHeader in that form is also used in KS's fourSquare demo,
   so we can recreate that way.</p></div></li>
<li>johnmcknight (at yahoo) 2011-04-15

   <div><p>I don't think this is a bug. The open method expects that the
   requestMethod has been defined before it has been called. In the
   example, the open is done first and then the requestMethod is set
   and this can't work in the current implementation. If you swap the
   order it will work as expected. BTW - This also affects timeout in
   that it must be defined before the open method is called. I have
   assumed this is more of a documentation issue than a bug.</p></div></li>
<li>David Pratt 2011-04-15

   <div><p>Hi John. setRequestHeader was placed between the open and send
   as this was the only way it worked previously. Will confirm and
   reply back. Will be very satisfied if this simple change resolves
   the issue as I am attempting to stick with nightly builds.</p></div></li>
<li>David Pratt 2011-04-15

   <div><p>I can confirm that changing order does NOT work with the Sep 8
   nightly build I reverted to as a result of this issue. I does work
   with setRequestHeader following open but before send with this
   version.</p>
   <p>I am obtaining latest nightly build today and will check if
   lastest build is in anyway different and report back.</p></div></li>
<li>Don Thorp 2011-04-15

   <div><p>Here is the specification entry for <a href=
   "<a href="http://www.w3.org/TR/XMLHttpRequest/#the-setrequestheader-method" rel="nofollow" target="_blank">http://www.w3.org/TR/XMLHttpRequest/#the-setrequestheader-method</a>">setRequestHeader</a>
   notice that it's an error for it to be called before it's in an
   OPEN state.</p></div></li>
<li>johnmcknight (at yahoo) 2011-04-15

   <div><p>I am doing this with the build from last night and it is working
   for me.<br></p>
   <pre>
   <code>  xhr.setRequestHeader("content-type", "multipart/form-data");
     xhr.open("POST", service_url);
     xhr.send(parms);</code>
   </pre>
   <p>BTW - I am running iOS SDK 3.2 and 4.1 and running Oct 7
   r3be604b2.</p>
   <p>Did you empty your iPhone build so it can force a new build with
   the latest nightly?</p></div></li>
<li>David Pratt 2011-04-15

   <div><p>Hi Don. Right.</p>
   <p>I am on SDK 4.1. John, will let you know shortly whether this
   works with change of order. If it does, it is still a bug as it is
   meant to be set following open.</p></div></li>
<li>Stephen Tramer 2011-04-15

   <div><p>Passing to Thom so he can test. Our KS-&gt;XHR-&gt;Cookies test
   uses request headers (in the specified manner, after open() is
   called) and works.</p></div></li>
<li>Thomas Huelbert 2011-04-15

    <div><p>KS-&gt;XHR-&gt;Cookies ius failing in build 1.5.0.d58dbe. back
    to you Stephen.</p></div></li>
<li>Stephen Tramer 2011-04-15

    <div><p>Test is passing for me off of the same build. Not sure what's
    going on here.</p></div></li>
<li>Stephen Tramer 2011-04-15

    <div><p>Okay, test has intermittent failures. Pass/fail may have
    something to do with the remote service and not with our XHR
    header. We're going to need another way to test non-cookie headers,
    looking into it.</p></div></li>
<li>Stephen Tramer 2011-04-15

    <div><p>Thom, gonna say that this one is fixed again now that I've found
    a more reliable test, but with some (possible) caveats.</p>
    <p>The KS-&gt;Mashups-&gt;Foursquare test was always able to
    reliably produce a correct result for me. I would recommend you
    test it before performing the following, which you may need to do
    if you keep getting geolocation errors from it:</p>
    <ul>
    <li>Go to "Settings-&gt;General-&gt;Reset-&gt;Reset location
    warnings"</li>
    </ul>
    <p>If you must do this, it appears to be an Apple bug that has to
    do with geolocation fussiness in the transition from 3.1.x to 3.2,
    internally. Not sure why.</p>
    <p>Second, I've opened up bug <a href=
    "/projects/32238/tickets/2106" title="Ticket #2106">#2106</a>,
    which indicates how certain module listeners may interact poorly
    with themselves. 4SQ demonstrates this when used in conjunction
    with any other geolocation requests on a different context - so
    don't run the 4SQ test in the same session that you run
    geolocation.</p></div></li>
<li>Stephen Tramer 2011-04-15

    <div><p>Reassigning back to me. Thom should catch it because it's
    fixed-in-qa anyway.</p></div></li>
<li>Thomas Huelbert 2011-04-15

    <div><p>thanks for the info Stephen, closing against iPod 4th gen (4.1),
    3g 3.1.2 with mobile sdk build 1.5.0.62c1cae</p></div></li>
<li>David Pratt 2011-04-15

    <div><p>I can authenticate using Basic Authorization with my app using
    curl but returns 401 error with titanium most recent nightly
    1.4.2-r8e708e78. Were there commits to the code to change correct
    this problem. Something is not right. The alternative to setting
    headers is to embed username:password in url ie. <a href=
    "<a href="https://user:pw@example.com" rel="nofollow" target="_blank">https://user:pw@example.com</a>"><a href="https://user:pw@example.com" rel="nofollow" target="_blank">https://user:pw@example.com</a></a> which
    I had tried before but is also broken. See ticket <a href=
    "/projects/32238/tickets/2149" title="Ticket #2149">#2149</a>.
    Perhaps the original issue is related to <a href=
    "/projects/32238/tickets/1502" title="Ticket #1502">#1502</a> which
    is unresolved.</p></div></li>
<li>David Pratt 2011-04-15

    <div><p>Sorry. To be clear, I can authenticate against my api using curl
    using name:pw in url or by setting headers. With Titanium app
    cannot get past 401 with headers set and cannot authenticate with
    user:pw in url due to <a href="/projects/32238/tickets/2149" title=
    "Ticket #2149">#2149</a>.</p></div></li>
<li>Ralf Pfeiffer 2011-04-15

    <div><p>to scrub</p></div></li>
<li>Ralf Pfeiffer 2011-04-15

    <div><p>Our testing shows this to be working properly.</p>
    <p>If there is an issue, it is likely with 2149, which we are
    investigating.</p></div></li>
<li>David Pratt 2011-04-15

    <div><p>Hi Stephen. There is something here that is not getting picked
    up with whatever you are doing for testing. The httpclient does not
    consistently work. In fact, I can demonstrate authentication
    failure where curl succeeds always with same credentials (with
    headers set or user:pw in url where titanium fails on both counts.
    I am prepared to create a small app to demonstrate.</p></div></li>
<li>David Pratt 2011-04-15

    <div><p>Have not had a reply to above. The client is not reliable.
    Please advise whether you are willing to look at code that will
    demonstrate failure and I will bundle a small app to send along
    with instructions to demonstrate failure. Will need some detail for
    sending as will not post here. Am going to attempt wrapping another
    lib as a module in the interim. Am frustrated by the problems and
    the block to development on iOS.</p></div></li>
<li>Thomas Huelbert 2011-04-15

    <div><p>fairwinds - if you could post the file to drop.io and send me
    (<a href=
    "mailto:thuelbert@appcelerator.com">thuelbert@appcelerator.com</a>)
    an email, I'll make sure the file gets to Stephen. Thanks.</p></div></li>
<li>David Pratt 2011-04-15

    <div><p>Thomas. drop.io has been bought so will be unable to post there.
    Will simply send app.js content with some instructions as soon as I
    have them written up. I would expect this later today or tomorrow.
    You will see by the small example bad things have become with a
    small piece of code that does nothing but fetch json using the
    client. Parse, authentication failure, headers being ignored, and
    inability to get content as needed from the client. This will be
    contrasted by simple curl fetches that succeed in all cases.</p></div></li>
<li>Thomas Huelbert 2011-04-15

    <div><p>fairwinds - d'oh, that's right. I'll look for your email.</p></div></li>
<li>Anthony Webb 2011-04-15

    <div><p>I think this should be opened back up. I am still having the
    issue where headers cant be set properly. I am using the latest
    cont build from Dec 23 (Dec 23 2010 14:19 readb8ad1) and tested on
    the emulator and iphone device (4.2) No matter what I try I can
    never override the content-type, it always is:
    application/x-www-form-urlencoded;</p>
    <p>Consider the following code:<br>
    var xhr = Titanium.Network.createHTTPClient();<br>
    xhr.onload = function()<br>
    {</p>
    <pre>
    <code>Ti.API.info('I am in utf-8 onload for POST');</code>
    </pre>
    <p>}; xhr.onerror = function()<br>
    {</p>
    <pre>
    <code>Ti.API.info('I am in utf-8 error for POST');</code>
    </pre>
    <p>}; xhr.setRequestHeader("setoutside", "one");<br>
    xhr.open("POST","<a href=
    "<a href="http://api.localmedia.fm/files/endpoint_webform.cfm&quot" rel="nofollow" target="_blank">http://api.localmedia.fm/files/endpoint_webform.cfm&quot</a>;)"><a href="http://api.localmedia.fm/files/endpoint_webform.cfm" rel="nofollow" target="_blank">http://api.localmedia.fm/files/endpoint_webform.cfm</a>")</a>;<br>
    xhr.setRequestHeader("content-type", "multipart/form-data");<br>
    xhr.setRequestHeader("setinside", "two");<br>
    xhr.send({"a":"hi", "b":"there"});</p>
    <p>When this hits my server I have the following headers:</p>
    <p>Accept-Encoding gzip<br>
    Connection keep-alive<br>
    Content-Length 12<br>
    Content-Type application/x-www-form-urlencoded; charset=utf-8<br>
    Cookie CFID=3538862; CFTOKEN=38108057<br>
    Host api.localmedia.fm<br>
    Setinside two<br>
    User-Agent Appcelerator Titanium/cont-1.6.0 (iPhone Simulator/4.2;
    iPhone OS; en_US;)<br>
    X-Requested-With XMLHttpRequest</p></div></li>
<li>Stephen Tramer 2011-04-15

    <div><p>Please follow bug <a href="/projects/32238/tickets/2675" title=
    "Ticket #2675">#2675</a>. We are in the process of revising our XHR
    support and this issue will be taken care of as part of it.</p></div></li>
<li>Anthony Webb 2011-04-15

    <div><p>Thanks Stephen, I've remove photo support from my app as I cant
    post stuff to the server without using multipart/form-data, here's
    hoping it is fixed soon, I will watch 2675. It is worth nothing
    though that adding the interface bits to my app was a breeze with
    appcelerator :)</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-1983.json">JSON Source</a></p>