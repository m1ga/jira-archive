---
title: "[TIMOB-12866] Create c-based library to read source map"
---
<table>
<tr><th>Type</th><td>Sub-task</td></tr>
<tr><th>Priority</th><td>Low</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Won't Do</td></tr>
<tr><th>Resolution Date</th><td>2020-06-30T14:43:55.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Core</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Ingo Muschenetz</td></tr>
<tr><th>Assignee</th><td>Unknown</td></tr>
<tr><th>Created</th><td>2013-02-26T19:45:46.000+0000</td></tr>
<tr><th>Updated</th><td>2020-06-30T14:43:55.000+0000</td></tr>
</table>

<h3>Description</h3>

The source map file described by <a href="https://github.com/mozilla/source-map" rel="nofollow" target="_blank">https://github.com/mozilla/source-map</a> needs to be parseable by our framework. If we can't use the JavaScript version of the library, we'll need to convert it to a language we can use across platforms, likely C.

See here for links to a Java-based version (Apache License) as part of the Google closure compiler.

<h3>Comments</h3>

<ol>
<li>Matt Langston 2013-03-13

   I talked with Max through our source map use cases, and the pros and cons of various supporting architectures. We decided the best approach is to transcode the source map to a SQLite database at build time and deploy this database with the app. Our reasons for this decision are:
   
   1) Mobile apps only require fast query of the source map. This is best handled by mobile databases (e.g. SQLite).
   
   2) Source maps tend to be large (i.e. at least 3X the size of the original JavaScript), and mobile apps operate in an environment with limited resources.  This is best handled by mobile databases (e.g. SQLite) which are designed to provide a small memory footprint by storing the indexes on disk. We do the memory intensive work of parsing and decoding the source map at build time and encoding it into an efficient query-able format.
   
   3) SQLite is supported on all of our mobile platforms that require source map functionality.
   
   4) We can reuse two existing JavaScript node modules to do the source map <-> SQLite transcoding, which is easily integrated into the CLI:
   
   4.1) We'll use the node "source-map" module to parse and decode the source map (see <a href="https://github.com/mozilla/source-map)." rel="nofollow" target="_blank">https://github.com/mozilla/source-map).</a>
   
   4.2) We'll use the node "node-sqlite" module to encode the source map data into a SQLite database (see <a href="https://github.com/orlandov/node-sqlite)." rel="nofollow" target="_blank">https://github.com/orlandov/node-sqlite).</a>
   
   
   The task breakdown for this ticket is:
   
   1. Design the SQLite schema for source map data.
   
   2. Extend the CLI to transcode the source map data into a SQLite database.
   
   3. Extend all titanium_mobile platforms to query this SQLite database when reporting errors to Crittercism. On iOS this is TiScriptError and TiExceptionHandler.</li>
<li>Matt Langston 2013-03-14

   1. Reviewed source map specs.
   2. Identified our specific on-device use cases.
   3. Discussed with team the pros/cons of different architectures.
   4. Created prototype node package for parsing/decoding source map data.</li>
<li>Matt Langston 2013-03-20

   A few questions:
   
   1. Is this an Enterprise-only feature? Or will it be open sourced?
   
   2. When I deliver this feature after the 3.1 code freeze date, which repository does it belong in? This feature is a standalone utility that generates SQLite database files from source map files created by the CLI. This SQLite database file is a build artifact that will be an app Resource. Therefore, I'm thinking it should live in it's own github repository because it is standalone. Thoughts?
   </li>
<li>Matt Langston 2013-03-21

   {noformat}
   ** Schema
   
   This is the SQLite3 schema for source maps. See below for more details
   about each table and column.
   
   
                                   +------------------+
                                   | mappings         |
                                   |------------------|
                                   | generated_line   |
              +-----------+        | generated_column |
              | sources   |        | original_line    |       +---------+
              |-----------|        | original_column  |       | names   |
              | source_id |<------+| source_id        |       |---------|
              | source    |        | name_id          |+----->| name_id |
              +-----------+        +------------------+       | name    |
                                                              +---------+
   ** Table: mappings
   
   The "mappings" table maps a {line, column} from the "generated"
   JavaScript source file (e.g. minified and/or obfuscated) to the
   corresponding {line, column} of the "original" JavaScript source file
   and possible a symbol name.
   
      |------------------+---------+---------------------------|
      | Column Name      | Type    | Comments                  |
      |------------------+---------+---------------------------|
      | generated_line   | integer | primary key               |
      | generated_column | integer | primary key               |
      | original_line    | integer |                           |
      | original_column  | integer |                           |
      | source_id        | integer | foreign key (never null)  |
      | name_id          | integer | foreign key (may be null) |
      |------------------+---------+---------------------------|
   
   ** Table: sources
   
   The "sources" table contains the original JavaScript source file
   names.
   
      |-------------+---------+----------------------|
      | Column Name | Type    | Comments             |
      |-------------+---------+----------------------|
      | source_id   | integer | primary key          |
      | source      | text    | original source file |
      |-------------+---------+----------------------|
    
   ** Table: names
   
   The "names" table contains the original JavaScript symbol names.
   
      |-------------+---------+---------------------------------|
      | Column Name | Type    | Comments                        |
      |-------------+---------+---------------------------------|
      | name_id     | integer | primary key                     |
      | name        | text    | original JavaScript symbol name |
      |-------------+---------+---------------------------------|
   {noformat}
   </li>
<li>Matt Langston 2013-03-21

   {noformat}
   ** Example SQL SELECT
   
   #+begin_src sh
   #!/usr/bin/env bash
   
   <h4>This bash script demonstrates querying a SQLite3 "source map"</h4>
   <h4>database. It takes three arguments:</h4>
   #
   <h4>1. generated_line</h4>
   <h4>2. generated_column</h4>
   <h4>3. path to the SQLite3 database file</h4>
   #
   <h4>It then invokes the sqlite3 command line utility with these</h4>
   <h4>arguments by parameterizing a SQL SELECT that returns information</h4>
   <h4>about the original JavaScript source.</h4>
   
   GENERATED_LINE=$1
   GENERATED_COLUMN=$2
   SQLITE3_DBFLE=$3
   
   sqlite3 "${SQLITE3_DBFLE}"  <<EOF
   .header on
   .mode column
   	SELECT
   		  m.generated_line
   		, m.generated_column
   		, m.original_line
   		, m.original_column
   		, n.name
   		, s.source
   	FROM
   		mappings m
   	INNER JOIN names   n ON m.name_id   = n.name_id
   	INNER JOIN sources s ON m.source_id = s.source_id
   	WHERE
   		m.generated_line = ${GENERATED_LINE}
   	AND
   		m.generated_column = ${GENERATED_COLUMN}
   	;
   EOF
   #+end_src
   {noformat}</li>
<li>Matt Langston 2013-03-21

   Someone with privs to create repos under <a href="https://github.com/appcelerator" rel="nofollow" target="_blank">https://github.com/appcelerator</a> needs to do it (I don't have privs). I suggest the repo name be "node-sm2sqlite".</li>
<li>Matt Langston 2013-03-21

   Thank you Ingo. I have forked this repo, added the code, and submitted a pull request. Who should we assigned to it?</li>
<li>Ingo Muschenetz 2013-03-21

   Max seems like a good candidate.</li>
<li>Matt Langston 2013-04-16

   Made changes per Max and Chris's comments. All files now contain the Appcelerator licensing header and were refactored to follow Appcelerator's JavaScript coding standards.
   
   This is the PR: <a href="https://github.com/appcelerator/node-sm2sqlite/pull/2" rel="nofollow" target="_blank">https://github.com/appcelerator/node-sm2sqlite/pull/2</a></li>
</ol>


<p><a href="/TIMOB/TIMOB-12866.json">JSON Source</a></p>