---
title: "[TIMOB-14058] Code Processor - Alloy: analyzed code results can be different from the expected ones"
---
<table>
<tr><th>Type</th><td>Story</td></tr>
<tr><th>Priority</th><td>Low</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Won't Fix</td></tr>
<tr><th>Resolution Date</th><td>2016-08-24T20:00:39.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 3.1.1</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Code Processor</td></tr>
<tr><th>Labels</th><td>qe-3.1.1, usability</td></tr>
<tr><th>Reporter</th><td>Federico Casali</td></tr>
<tr><th>Assignee</th><td>Chris Barber</td></tr>
<tr><th>Created</th><td>2013-05-30T23:59:00.000+0000</td></tr>
<tr><th>Updated</th><td>2017-03-20T20:29:58.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Problem description</h4>

Code Processor results for Alloy projects are based an Analysis on the compiled code in the Resources folder.
This could generate unexpected results and parity issues for the end user whose expectations are that the Code Processor is checking his code, as included in the Alloy project 'app' folder, even if the Code Processor is actually correctly analyzing the javascript code compiled by Alloy.

<h4>Example:</h4>

<h4>"ContextTest" sample project</h4>
(<a href="https://github.com/appcelerator/titanium-code-processor/tree/master/test_projects/ContextTest" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium-code-processor/tree/master/test_projects/ContextTest</a> or attached here in the Jira)

In this case, the code to be analyzed is:
<code><pre>
(function foo() {
	var x = 10;
	setTimeout(function () {
		console.log(x);
	});

	function bar() {
		console.log(x);
		x = 20;
		require(x);
	}
	if (Date.now()) {
		bar();
	}
})();
console.log(x);
</pre></code>

and the result, as expected, is that: 
<code><pre>
"x" is not defined | app.js | 16 
</pre></code>
   
   
  

By placing the same identical code in an Alloy project index.js controller file, the result is a bit different.

Attached in the Jira there is the ContextTest sample for Alloy too.

After being compiled, the Resources/alloy/controllers/index.js looks like this:
<code><pre>
function Controller() {
    require("alloy/controllers/BaseController").apply(this, Array.prototype.slice.call(arguments));
    arguments[0] ? arguments[0]["__parentSymbol"] : null;
    arguments[0] ? arguments[0]["$model"] : null;
    var $ = this;
    var exports = {};
    $.__views.index = Ti.UI.createWindow({
        backgroundColor: "blue",
        id: "index"
    });
    $.__views.index && $.addTopLevelView($.__views.index);
    exports.destroy = function() {};
    _.extend($, $.__views);
    (function() {
        function bar() {
            console.log(x);
            x = 20;
            require(x);
        }
        var x = 10;
        setTimeout(function() {
            console.log(x);
        });
        Date.now() && bar();
    })();
    console.log(x);
    $.index.open();
    _.extend($, exports);
}

var Alloy = require("alloy"), Backbone = Alloy.Backbone, _ = Alloy._;

module.exports = Controller;
</pre></code>

so, lines 14 to 26 are the ones regarding the code put in the controller. The code is a bit different (for example the function "bar()" is declared before the 'var x = 10') and the Code Analyzer result is a bit different:

<code><pre>
The module "20" could not be found | app/controllers/index.js | 10
"x" is not defined | app/controllers/index.js | 17
</pre></code>


In this case the Code Processor is likely behaving correctly, in fact putting the generated code from lines 14 to 26 in a Classic Titanium project, I'm getting the same as the Alloy one.

The issue relates in the fact that from the end-user standpoint, the two results should be identical and the user could be easily confused by those results.


Attached both the classic and the Alloy 'ContextTest' sample projects and the Code Analyzer Results for each. 




<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-14058_39284/Alloy_ContextTest_RESULT.zip">Alloy_ContextTest_RESULT.zip</td></td><td>2013-05-30T23:59:01.000+0000</td><td>3967728</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-14058_39285/Alloy_ContextTest.zip">Alloy_ContextTest.zip</td></td><td>2013-05-30T23:59:01.000+0000</td><td>7407552</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-14058_39282/classic_ContextTest_RESULT.zip">classic_ContextTest_RESULT.zip</td></td><td>2013-05-30T23:59:01.000+0000</td><td>44560</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-14058_39283/classic_ContextTest.zip">classic_ContextTest.zip</td></td><td>2013-05-30T23:59:01.000+0000</td><td>3698133</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Ingo Muschenetz 2013-05-31

   [~tlukasavage] Two quick questions.
   
   * Why is the order of the code slightly different in the generated version of the controller?
   * Should the source map not point us back to app.js, line 16?</li>
<li>Tony Lukasavage 2013-05-31

   * The order is slightly different due to the fact that each controller gets broken down into an AST and then reassembled by uglify-js into code. There are options that can impact this reassembly, but I've never dug into them that much as there's never been a need to this point. I would definitely need a ticket logged to pursue that one further.
   * No, the second example is in index.js, not app.js, so it is pointing to the correct file. The numbering however seems to be off by a line, but could that perhaps simply be something that happened when the code was copied to another project? I'll bet there was just an additional line break in there. It seems unlikely that numbering is off only because studio debugging has been using it for a while.  
   
   But I ama bit confused and I read the ticket a few times. What is the expectation if not for the code processor to point back to the correct location in the original controller, because that appears to me what is happening? Am I missing something?</li>
<li>Tony Lukasavage 2013-05-31

   Federico, I agree with you in theory, but comparing an Alloy app and a non-Alloy app for code processor output will practically never happen in real world development. No one is going to write an app twice identically and then compare code processor output, except us of course. ;-)</li>
<li>Bryan Hughes 2013-06-03

   Some quick thoughts: I think this is worth some investigation. Ideally they should produce the same output, but as Tony said there are probably some technical reasons why they may differ. It would be nice if we could really investigate these differences and see if they are worthwhile to invest to time fix, if they are possible to fix.</li>
<li>Tony Lukasavage 2013-06-03

   [~fcasali] would you mind logging a ticket in ALOY for, let's say, "less modified" code generation? This is by no means a panacea, and I'm not certain at this moment how similar to the current code I can keep it, but I can start investigating making less changes to the structure of the code generated by uglify-js's AST parsing. This would not be for Alloy 1.1.3 & TiSDK 3.1.1 though. Heh, version palindrome.  </li>
<li>Bryan Hughes 2013-06-03

   IMO, before we start logging tickets, we should investigate a little more to see if "less modified" code actually is the proper approach. Figure out the problem first before we dive in to fix it.</li>
<li>Tony Lukasavage 2013-06-03

   [~bhughes] this is something i've been meaning to start investigating anyway for the sake of when the debugger drops a developer into generated code. It will make for a better experience if the code more closely resembles their original source files. This was more of a "two birds with one stone" idea than it was an effort specifically for this ticket. Also, investigating would be part of the ticket as mentioned in my previous comment.</li>
<li>Bryan Hughes 2013-06-03

   Ah, I gotcha now. Ticket away :)</li>
<li>Chris Barber 2016-08-24

   Code processor is dead.</li>
<li>Lee Morris 2017-03-20

    Closing ticket as Code processor is no longer supported.</li>
</ol>


<p><a href="/TIMOB/TIMOB-14058.json">JSON Source</a></p>