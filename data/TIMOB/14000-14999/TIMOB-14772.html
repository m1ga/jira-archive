---
title: "[TIMOB-14772] Android: Memory leak when removing MapView (Google Maps module v2)"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2013-09-20T20:48:25.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>2013 Sprint 19, 2013 Sprint 19 API, Release 3.2.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Philippe Wueger</td></tr>
<tr><th>Assignee</th><td>Hieu Pham</td></tr>
<tr><th>Created</th><td>2013-08-05T14:27:31.000+0000</td></tr>
<tr><th>Updated</th><td>2013-12-19T21:01:21.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Problem</h4>

Memory leak when removing MapView (Map Module v2)

Titanium SDK 3.2.0 (HEAD)
Android 4.2.1
Nexus S

<h4>Test case</h4>
Run the app below.
Dump HPROF file
Tap on "Toggle" multiple times.
Dump HPROF file
Compare memory usage of second memory dump against first one: TiUIFragement$1 and TiUIMapView do not get released, when the MapView is removed from the screen and with this the whole Google Map View is leaked (which is quite a lot of memory.)

<code><pre>
var win = Ti.UI.createWindow({
	modal: false,
	backgroundColor: 'white'
});
	
var button = Ti.UI.createButton({
	top: '10dp',
	width: '100dp',
	height: '40dp',
	title: 'Toggle',
});
	
var MapModule = require('ti.map');
var map = MapModule.createView({
	top: '60dp',	
	mapType:MapModule.NORMAL_TYPE
});

var showingMap = true;
button.addEventListener('click', function(evt) {
	if (showingMap) {
		this.window.remove(this.map);
	} else {
		this.window.add(this.map);
	}
	showingMap = !showingMap;	
});

win.add(button);
win.add(map);
win.open();
</pre></code>

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-14772_41310/after-5-toggles.hprof.zip">after-5-toggles.hprof.zip</td></td><td>2013-08-06T06:39:09.000+0000</td><td>2856601</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-14772_41307/before-baseline.hprof.zip">before-baseline.hprof.zip</td></td><td>2013-08-06T06:39:09.000+0000</td><td>2146222</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-14772_41306/log.txt">log.txt</td></td><td>2013-08-06T06:39:09.000+0000</td><td>18412</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-14772_41308/Screen Shot 2013-08-06 at 08.30.03.png">Screen Shot 2013-08-06 at 08.30.03.png</td></td><td>2013-08-06T06:39:09.000+0000</td><td>21311</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-14772_41309/Screen Shot 2013-08-06 at 08.30.23.png">Screen Shot 2013-08-06 at 08.30.23.png</td></td><td>2013-08-06T06:39:09.000+0000</td><td>105624</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Philippe Wueger 2013-08-05

   I could resolve this memory leak by adding the following to TiUIFragment:
   
   <code><pre>
   @Override
   public void release()
   {
     FragmentTransaction transaction = manager.beginTransaction();
     transaction.remove(fragment);
     transaction.commit();
     super.release();
   }
   </pre></code>
   
   And adding a call to "super.release()" at the end of "release()" in TiUIMapView.
   
   </li>
<li>Eduardo Gomez 2013-08-05

   Hi [~philet],
   
   Thanks for bring it up to our attention.
   
   Can you please provide either device or console output logs? Make sure to fill out reports according [Jira checklist](<a href="http://docs.appcelerator.com/titanium/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/titanium/latest/#</a>!/guide/How_to_Submit_a_Bug_Report-section-29004732_HowtoSubmitaBugReport-JIRATicketChecklist) so we are able to diagnose issues quicker. Also, would be great if you can share HPROF summary or screenshots to have a wider insight around this. Thanks.</li>
<li>Philippe Wueger 2013-08-06

   Hi Eduardo
   
   I have attached the log, 2 HPROF files as well as 2 screenshots containing the comparison of the 2 HPROF files.
   
   Thanks for looking into this.
   
   Regards,
   Philippe
   
   </li>
<li>Eduardo Gomez 2013-08-06

   </li>
<li>Hieu Pham 2013-09-19

   Master PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/4718" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/4718</a> + <a href="https://github.com/appcelerator-modules/ti.map/pull/12" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.map/pull/12</a></li>
<li>Lokesh Choudhary 2013-12-19

   Verified the fix by running the sample code & grabbing the hprof dumps before and after toggling the maps. Did not find any leaks.
   
   Closing.
   
   Environment:
   Appcel Studio : 3.2.0.201312181652
   Ti SDK : 3.2.0.v20131218153242
   Mac OSX : 10.8.5
   Alloy : 1.3.0-cr2	
   CLI - 3.2.0-cr3
   Samsung Galaxy S4 running android 4.2.2</li>
</ol>


<p><a href="/TIMOB/TIMOB-14772.json">JSON Source</a></p>