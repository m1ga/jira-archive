---
title: "[TIMOB-15594] Android: base64 encode of a large file fails"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2014-05-23T22:01:17.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 3.2.0, Release 3.2.1</td></tr>
<tr><th>Fix Version/s</th><td>2014 Sprint 08, 2014 Sprint 08 SDK, Release 3.3.0, Release 3.4.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>supportTeam</td></tr>
<tr><th>Reporter</th><td>Davide Cassenti</td></tr>
<tr><th>Assignee</th><td>Sunila</td></tr>
<tr><th>Created</th><td>2013-10-28T11:12:13.000+0000</td></tr>
<tr><th>Updated</th><td>2014-07-31T21:04:17.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Problem description</h4>
Trying to use base64encode with a very large file, fails with an 'out of memory' error.

<h4>Use case</h4>
The use case would be to upload a base64-encoded file using an HTTPClient. The conversion to base64 fails.

<h4>Sample code</h4>
<code><pre>
var filename = "SOME_LARGE_FILE";
var file = Titanium.Filesystem.getFile(filename);

var toUpload = file.read();
var ws = {
  file_name: filename,
  data: Ti.Utils.base64encode(toUpload)
};

var xhr = Ti.Network.createHTTPClient({
  onload: function(e) {
    Ti.API.info(this.responseText);
  }
});
xhr.open('POST', 'SOME_UPLOAD_URL');
xhr.send(ws);
</pre></code>

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-15594_48022/movie.mp4">movie.mp4</td></td><td>2014-05-13T18:02:05.000+0000</td><td>2549211</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Sunila 2014-01-27

   Modified the code to use the stream directly in the HTTPClient to avoid memory allocation. TiBlob is modified to support stream and take file as input.
   
   <a href="https://github.com/appcelerator/titanium_mobile/pull/5261" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/5261</a></li>
<li>Sunila 2014-01-27

   Modified the code to use the stream directly in the HTTPClient to avoid memory allocation. TiBlob is modified to support stream and take file as input.
   
   <a href="https://github.com/appcelerator/titanium_mobile/pull/5261" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/5261</a></li>
<li>Sunila 2014-01-27

   Run the following code to reproduce the issue. 
   After merging the fix, set the the 'tryTheFix' to true and run the sample again to see the fix
   
   <code><pre>
   	var win = Ti.UI.createWindow();
   	win.open();
   	  
   	  
   	var percent_done = 0;
   	  
   	var xhr = Ti.Network.createHTTPClient({
   	     onload : function(e) {
   	    	 Ti.API.info("onLoad:"+this.responseText);
   	       
   	     },
   	     onerror : function(e) {
   	    	 Ti.API.info("e.error: "+e.error);
   	     },
   	     onreadystatechange: function(e){
   	    	 Ti.API.info("onreadystatechange: "+this.readyState);  
   	     },
   	     timeout: 10000
   	});
   	  
   	  
   	function upload(){
   	    console.log("STARTING UPLOAD");
   	    var filename = "Wildlife.wmv";
   	    var url = "<a href="http://www.w3schools.com/ajax/demo_post.asp" rel="nofollow" target="_blank">http://www.w3schools.com/ajax/demo_post.asp</a>";    //using this server for simplicity's sake
   	    var file = Ti.Filesystem.getFile(Ti.Filesystem.getResourcesDirectory()+filename); //just use any large-ish file, 500kb+ or so
   	    xhr.open("POST", url);
   	    // set 'tryTheFix' to true to see the fix
   	    var tryTheFix = false;
   	    var ws;
   	    if (tryTheFix) {
   	        ws = {
   	            file_name: filename,
   	            data: Ti.Utils.base64encode(file)
   	        };
   	    } else {
   	        var toUpload = file.read();
   	        ws = {
   	            file_name: filename,
   	            data: Ti.Utils.base64encode(toUpload)
   	        };
   	    }
   	    xhr.send(ws);       
   	}    
   	  
   	upload();
   </pre></code></li>
<li>Lokesh Choudhary 2014-05-08

   Reopening the ticket.
   
   <h4>1. When tryTheFix = false:</h4>
   We get the following errors:
   <code><pre>
   [ERROR] :  TiHttpClient: (TiHttpClient-1) [3259,3259] HTTP Error (java.net.SocketException): sendto failed: EPIPE (Broken pipe)
   [ERROR] :  TiHttpClient: java.net.SocketException: sendto failed: EPIPE (Broken pipe)
   [ERROR] :  TiHttpClient: 	at libcore.io.IoBridge.maybeThrowAfterSendto(IoBridge.java:499)
   [ERROR] :  TiHttpClient: 	at libcore.io.IoBridge.sendto(IoBridge.java:468)
   [ERROR] :  TiHttpClient: 	at java.net.PlainSocketImpl.write(PlainSocketImpl.java:507)
   [ERROR] :  TiHttpClient: 	at java.net.PlainSocketImpl.access$100(PlainSocketImpl.java:46)
   [ERROR] :  TiHttpClient: 	at java.net.PlainSocketImpl$PlainSocketOutputStream.write(PlainSocketImpl.java:269)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.io.AbstractSessionOutputBuffer.flushBuffer(AbstractSessionOutputBuffer.java:87)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.io.AbstractSessionOutputBuffer.flush(AbstractSessionOutputBuffer.java:94)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.AbstractHttpClientConnection.doFlush(AbstractHttpClientConnection.java:169)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.SocketHttpClientConnection.close(SocketHttpClientConnection.java:192)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.conn.DefaultClientConnection.close(DefaultClientConnection.java:161)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.conn.AbstractPooledConnAdapter.close(AbstractPooledConnAdapter.java:158)
   [ERROR] :  TiHttpClient: 	at org.apache.http.protocol.HttpRequestExecutor.execute(HttpRequestExecutor.java:125)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.client.DefaultRequestDirector.execute(DefaultRequestDirector.java:428)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:555)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:653)
   [ERROR] :  TiHttpClient: 	at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:637)
   [ERROR] :  TiHttpClient: 	at ti.modules.titanium.network.TiHTTPClient$ClientRunnable.run(TiHTTPClient.java:1291)
   [ERROR] :  TiHttpClient: 	at java.lang.Thread.run(Thread.java:841)
   [ERROR] :  TiHttpClient: Caused by: libcore.io.ErrnoException: sendto failed: EPIPE (Broken pipe)
   [ERROR] :  TiHttpClient: 	at libcore.io.Posix.sendtoBytes(Native Method)
   [ERROR] :  TiHttpClient: 	at libcore.io.Posix.sendto(Posix.java:156)
   [ERROR] :  TiHttpClient: 	at libcore.io.BlockGuardOs.sendto(BlockGuardOs.java:177)
   [ERROR] :  TiHttpClient: 	at libcore.io.IoBridge.sendto(IoBridge.java:466)
   [ERROR] :  TiHttpClient: 	... 16 more
   </pre></code>
   
   <h4>2. When tryTheFix = true:</h4>
   We see these logs:
   <code><pre>
   [ERROR] :  TiHttpClient: (KrollRuntimeThread) [72,72] Error adding post data (data): bad base-64
   [INFO] :   onreadystatechange: 1
   [DEBUG] :  OpenGLRenderer: Enabling debug mode 0
   [TRACE] :  RenderScript: Application requested CPU execution
   [TRACE] :  RenderScript: 0x79e180b0 Launching thread(s), CPUs 4
   [DEBUG] :  Window: Checkpoint: postWindowCreated()
   [INFO] :   onreadystatechange: 3
   [INFO] :   onreadystatechange: 3
   [DEBUG] :  skia: --- SkImageDecoder::Factory returned null
   [DEBUG] :  skia: --- SkImageDecoder::Factory returned null
   [INFO] :   onreadystatechange: 4
   [INFO] :   onLoad:<p>This content was requested using the POST method.</p>
   [INFO] :   <p>Requested at: 5/8/2014 1:46:25 PM</p>
   [DEBUG] :  HTTPClient: The persistent handle is disposed.
   </pre></code></li>
<li>Sunila 2014-05-12

   Lokesh,
   The error you get with 1 may be because the server is terminating the connection because it is taking too long.
   Can you attach or upload the file you tried in some place?
   I am looking in to 2.</li>
<li>Lokesh Choudhary 2014-05-12

   Hi [~sunila],
   The link for the attachment is : <a href="https://www.dropbox.com/s/2wt6yo16i1lto2n/wildlife.wmv" rel="nofollow" target="_blank">https://www.dropbox.com/s/2wt6yo16i1lto2n/wildlife.wmv</a></li>
<li>Sunila 2014-05-13

   New PR submitted
   
   <a href="https://github.com/appcelerator/titanium_mobile/pull/5677" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/5677</a></li>
<li>Sunila 2014-05-16

   To avoid getting Broken pipe error, you could setup a local server to accept the file upload.
   Here is the PHP script to try
   
   <code><pre>
   <?php
   set_time_limit(0);
   $destination_path ="temp/"; 
   $target_path = "../htdocs/" . $destination_path;
   $target_path = $target_path . basename( $_FILES['data']['name']); 
   
   echo "Source=" .        $_FILES['data']['name'] . "<br />"; 
   echo "Destination=" .   $destination_path . "<br />"; 
   echo "Target path=" .   $target_path . "<br />"; 
   echo "Size=" .          $_FILES['data']['size'] . "<br />"; 
   
   
   if(move_uploaded_file($_FILES['data']['tmp_name'], $target_path)) {
       echo "The file ".  basename( $_FILES['data']['name']). 
       " has been uploaded";
   } else{
       echo "There was an error uploading the file, please try again!";
   }
   ?>
   </pre></code>
   
    up in Apache with PHP
   1. Save the file as upload.php in htdocs directory
   2.Create a subdirectory called temp under htdocs
   3. Change the url in the code to point to upload.php (you may need to use machine ip address instead of the localhost if you are debugging from eclipse) something like <a href="http://192.168.1.142:8080/upload.php" rel="nofollow" target="_blank">http://192.168.1.142:8080/upload.php</a>
   4. You should see the proper response once the file is uploaded. Try something around 10MB otherwise it may take a long time.
   5. Uploaded file will be under htdocs/temp, open and verify if it is base64 encoded. 
   </li>
<li>Hieu Pham 2014-05-23

   3.3.X PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/5733" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/5733</a></li>
<li>Samuel Dowse 2014-05-29

    Verified fixed on:
    Mac OSX 10.9.3
    Appcelerator Studio, build: 3.3.0.201405271647
    Titanium SDK, build: 3.3.0.v20140528144113
    Titanium CLI, build: 3.3.0-beta
    Alloy: 1.4.0-beta
    Android Device: Nexus 4 (4.4)
    
    Large file successfully uploaded with base64 encoding.
    Closing.</li>
<li>Ping Wang 2014-07-31

    update doc: <a href="https://github.com/appcelerator/titanium_mobile/pull/5942" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/5942</a></li>
</ol>


<p><a href="/TIMOB/TIMOB-15594.json">JSON Source</a></p>