---
title: "[TIMOB-15781] Android: KitKat crash when calling WebView method on wrong thread"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2013-11-23T01:18:52.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>2013 Sprint 24, 2013 Sprint 24 Core, Release 3.2.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>4.4, android, crash, kitkat, merge-3.1.4, module_webview, qe-closed-3.2.0, qe-testadded, triage, webview</td></tr>
<tr><th>Reporter</th><td>Mark Mokryn</td></tr>
<tr><th>Assignee</th><td>Allen Yeung</td></tr>
<tr><th>Created</th><td>2013-11-20T20:44:15.000+0000</td></tr>
<tr><th>Updated</th><td>2014-03-03T18:30:13.000+0000</td></tr>
</table>

<h3>Description</h3>

The following code crashes on Android 4.4, does not crash on Android 4.1.2.
The crash log is:
11-20 22:32:31.861: E/TiExceptionHandler(9656): (main) [0,995] - Message: Uncaught Error: java.lang.Throwable: A WebView method was called on thread 'KrollRuntimeThread'. All WebView methods must be called on the same thread. (Expected Looper Looper{41e338c0} called on Looper{41e52348}, FYI main Looper is Looper{41e338c0})
11-20 22:32:31.861: E/TiExceptionHandler(9656): (main) [0,995] - Source:         Ti.API.debug("user agent: " + $.webview.userAgent);

index.xml:
<code><pre>
&lt;Alloy&gt;
	&lt;Window class="container" fullscreen=true&gt;
		&lt;WebView id="webview" url="/test.html" /&gt;
	&lt;/Window&gt;
&lt;/Alloy&gt;
</pre></code>

index.js:
<code><pre>
Ti.API.debug('user agent: ' + $.webview.userAgent); // CRASH HERE ON KitKat

$.index.open();
</pre></code>

lib/test.html
<code><pre>
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;h2&gt;Hi there&lt;/h2&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre></code>



<h3>Comments</h3>

<ol>
<li>Mark Mokryn 2013-11-21

   Prior to KitKat we're used to seeing this warning:
   11-21 16:06:29.515: W/webview_proxy(4299): java.lang.Throwable: Warning: A WebView method was called on thread 'KrollRuntimeThread'. All WebView methods must be called on the UI thread. Future versions of WebView may not support use on other threads.
   
   Looks like in KitKat they finally made good on their warning. :-(</li>
<li>Lokesh Choudhary 2013-11-21

   Verified this for a non alloy & an alloy app & was able to reproduce the issue.
   Removing the "useragent" property in Ti.API.debug does not throw the error.
   
   Environment:
   Appcel Studio : 3.2.0.201311200357
   Ti SDK : 3.2.0.v20131119142443
   Mac OSX : 10.8.5
   Alloy : 1.3.0
   CLI - 3.2.0-alpha</li>
<li>Mark Mokryn 2013-11-21

   On a general note: In KitKat Google changed the WebView to Chrome, so there may be more issues:
   <a href="https://developers.google.com/chrome/mobile/docs/webview/overview" rel="nofollow" target="_blank">https://developers.google.com/chrome/mobile/docs/webview/overview</a></li>
<li>Lokesh Choudhary 2013-11-22

   I was able to reproduce this issue today on a nexus 4 running android 4.3
   
   Environment:
   Appcel Studio : 3.2.0.201311211712
   Ti SDK : 3.2.0.v20131119142443
   Mac OSX : 10.8.5
   Alloy : 1.3.0
   CLI - 3.2.0-alpha</li>
<li>Allen Yeung 2013-11-23

   Test case:
   
   <code><pre>
    var webview = Titanium.UI.createWebView({url:"/test.html", height: 400, width: 400, top: 0});
       var window = Titanium.UI.createWindow();
       window.add(webview);
       window.open({modal:true});
      	var button = Ti.UI.createButton({
      		title: 'webview tests',
      		height: 200,
      		width: 200,
      		bottom: 0
      	});
      	window.add(button);
      	button.addEventListener('click', function(){  			
      			webview.evalJS('console.log("test")');
      			webview.html = "&lt;html&gt;&lt;head&gt;&lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;Test&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;";
      			Ti.API.debug('----------------------------------setHTML: ' + webview.html);
      			Ti.API.debug('----------------------------------user agent: ' + webview.userAgent);
      			webview.userAgent = "test";
      			webview.setBasicAuthentication('ayeung', 'password123');
      			webview.canGoBack();
      			webview.canGoForward();
      			webview.goBack();
      			webview.goForward();
      			webview.reload();
      			webview.stopLoading(true);
      			Ti.API.debug('----------------------------------pluginState: ' + webview.pluginState);
      			webview.pause();
      			webview.resume();
      			webview.enableZoomControls = true;
      			Ti.API.debug('----------------------------------enableZoomControls: ' + webview.enableZoomControls);
      			webview.release();
      			alert('DONE, Please check logs');
      	});
   </pre></code>
   
   1. Set your target SDK to API 18 or 19 by putting this in your tiapp.xml:
   <code><pre>
       &lt;android xmlns:android="<a href="http://schemas.android.com/apk/res/android" rel="nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"&gt;
           &lt;manifest&gt;
               &lt;uses-sdk android:minSdkVersion="10" android:targetSdkVersion="18"/&gt;
           &lt;/manifest&gt;
       &lt;/android&gt;
   </pre></code>
   
   2. Run the test case
   3. click the button
   4. verify that no warning/errors appear relating to webview method called from wrong thread.</li>
<li>Allen Yeung 2013-11-23

   PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/5016" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/5016</a></li>
<li>Samuel Dowse 2013-11-25

   Verified fixed on:
   Mac OSX 10.9 Mavericks
   Titanium Studio, build: 3.2.0.201311221859
   Titanium SDK, build: 3.2.0.v20131125103938
   CLI: 3.2.0-alpha
   Alloy: 1.3.0-alpha6
   Android Device: Nexus 5, 4.4 (KitKat)
   
   Ran test case provided for Alloy and Classic projects.
   The test.html page is located and displayed correctly on screen.
   No error is thrown in console log.
   Closing.</li>
<li>Mark Mokryn 2013-11-26

   This should be backported to 3.1.X . This bug will crash a lot of apps as KitKat adoption ramps up.</li>
<li>Ingo Muschenetz 2013-11-26

   Yes, it is already scheduled for that. [~ayeung], can we prepare a backport for 3.1.X?</li>
</ol>


<p><a href="/TIMOB/TIMOB-15781.json">JSON Source</a></p>