---
title: "[TIMOB-16154] Android: XHR GZip 200 response code handled as error"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2014-01-15T01:57:53.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 3.1.3, Release 3.2.0</td></tr>
<tr><th>Fix Version/s</th><td>2014 Sprint 01, 2014 Sprint 01 Core, Release 3.3.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>gzip, module_android, qe-testadded</td></tr>
<tr><th>Reporter</th><td>Marco Cota</td></tr>
<tr><th>Assignee</th><td>Daniel Fortner</td></tr>
<tr><th>Created</th><td>2014-01-09T16:35:46.000+0000</td></tr>
<tr><th>Updated</th><td>2014-06-12T00:03:17.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Issue</h4>

When receiving Gzipped responses on Android this are being incorrectly handled as http errors by the titanium SDK even when the response code is 200 or 201.

This is only happening when the response have an empty body.

<h4>Logs</h4>

Gzip Response
<code><pre>
[INFO] :   Gzip Enabled
[WARN] :   IdleConnectionHandler: Removing a connection that never existed!
[ERROR] :  TiHttpClient: (TiHttpClient-23) [360048,1780592] HTTP Error (java.io.EOFException): java.io.EOFException
[ERROR] :  TiHttpClient: java.io.EOFException
[ERROR] :  TiHttpClient: 	at java.util.zip.GZIPInputStream.readFully(GZIPInputStream.java:202)
[ERROR] :  TiHttpClient: 	at java.util.zip.GZIPInputStream.&lt;init&gt;(GZIPInputStream.java:98)
[ERROR] :  TiHttpClient: 	at java.util.zip.GZIPInputStream.&lt;init&gt;(GZIPInputStream.java:81)
[ERROR] :  TiHttpClient: 	at ti.modules.titanium.network.TiHTTPClient$LocalResponseHandler.handleResponse(TiHTTPClient.java:268)
[ERROR] :  TiHttpClient: 	at ti.modules.titanium.network.TiHTTPClient$LocalResponseHandler.handleResponse(TiHTTPClient.java:217)
[ERROR] :  TiHttpClient: 	at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:657)
[ERROR] :  TiHttpClient: 	at org.apache.http.impl.client.AbstractHttpClient.execute(AbstractHttpClient.java:637)
[ERROR] :  TiHttpClient: 	at ti.modules.titanium.network.TiHTTPClient$ClientRunnable.run(TiHTTPClient.java:1287)
[ERROR] :  TiHttpClient: 	at java.lang.Thread.run(Thread.java:841)
[INFO] :   XHR RESPONSE Error &gt;&gt;&gt; Response:
[INFO] :   XHR RESPONSE Error &gt;&gt;&gt; Status: 200 Type: POST Headers: Date:Thu, 09 Jan 2014 16:01:28 GMT
[INFO] :   Server:Apache
[INFO] :   Content-Encoding:gzip
[INFO] :   Content-Length:0
[INFO] :   Keep-Alive:timeout=10, max=30
[INFO] :   Connection:Keep-Alive
[INFO] :   Content-Type:image/png
[DEBUG] :  HTTPClient: The persistent handle is disposed.
</pre></code>

Non Gzip Response
<code><pre>
[INFO] :   Gzip Disabled
[INFO] :   XHR RESPONSE Load &gt;&gt;&gt; Response: "null"
[INFO] :   XHR RESPONSE Load &gt;&gt;&gt; Status: 200 Type: POST Headers: Date:Thu, 09 Jan 2014 16:00:45 GMT
[INFO] :   Server:Apache
[INFO] :   Content-Length:0
[INFO] :   Vary:Accept-Encoding
[INFO] :   Keep-Alive:timeout=10, max=30
[INFO] :   Connection:Keep-Alive
[INFO] :   Content-Type:image/png; charset: UTF-8
[DEBUG] :  HTTPClient: The persistent handle is disposed.
</pre></code>

<h4>Steps to Reproduce</h4>

1. Run the test case
2. Click on Non Gzip Button
3. Receive a load response from the xhr
4. Click Gzip Button
5. Receive an error response from the xhr

The php server return the same body empty response with the difference of the gzip encoding header

<h4>Sample Code</h4>

<code><pre>

var win = Ti.UI.createWindow();
var bt1 = Ti.UI.createButton({
	title:'NonGZIP',
	width:80,
	left:10,
	gzip:false,
	bottom:10
});
var bt2 = Ti.UI.createButton({
	title:'GZIP',
	width:80,
	right:10,
	gzip:true,
	bottom:10
});
bt1.addEventListener('click',doRequest);
bt2.addEventListener('click',doRequest);

win.add(bt1);
win.add(bt2);
win.open();
function doRequest(e){
	var xhr = Ti.Network.createHTTPClient(); 
	
	xhr.onload = function(e){
	    Titanium.API.info('XHR RESPONSE Load &gt;&gt;&gt; Response: "'+this.responseText+'"');
	    Titanium.API.info('XHR RESPONSE Load &gt;&gt;&gt; Status: '+this.status+' Type: '+ this.connectionType+' Headers: '+ this.allResponseHeaders);
	};
	
	xhr.onerror = function(e){
	    Titanium.API.info('XHR RESPONSE Error &gt;&gt;&gt; Response: '+this.responseText);
	    Titanium.API.info('XHR RESPONSE Error &gt;&gt;&gt; Status: '+this.status+' Type: '+ this.connectionType+' Headers: '+ this.allResponseHeaders);
	};
	
	try {	
		xhr.open('POST','<a href="http://demo.cotaman.com/gzip.php" rel="nofollow" target="_blank">http://demo.cotaman.com/gzip.php</a>');
		xhr.setRequestHeader('User-Agent', Ti.userAgent);
		xhr.setRequestHeader('x-cmk-agent', 'M3 v' + Ti.App.version);
		if(e.source.gzip){
			xhr.setRequestHeader('Accept-Encoding', 'gzip,deflate');
			Ti.API.info('Gzip Enabled');
		}else{
			Ti.API.info('Gzip Disabled');
		}
		var imageFile = Ti.Filesystem.getFile(Ti.Filesystem.resourcesDirectory,'image.jpg');
        if(imageFile.exists()) {
          	xhr.send({
	            media: imageFile.read(),
	            test: 'pic_'
         	});
        }
	} catch(e) {
	    currentAction = null;
	    Ti.API.info('ERROR : '+e.message);
	}
};


</pre></code>

Sample App at <a href="https://www.dropbox.com/s/dhd9czzl5u488ft/testcase.zip" rel="nofollow" target="_blank">https://www.dropbox.com/s/dhd9czzl5u488ft/testcase.zip</a>

<h3>Comments</h3>

<ol>
<li>Allen Yeung 2014-01-14

   Test case to verify that GZIP works:
   
   <code><pre>
   Ti.UI.backgroundColor = '#dddddd';
     
   var url = "<a href="https://raw.github.com/appcelerator/titanium_mobile/master/package.json" rel="nofollow" target="_blank">https://raw.github.com/appcelerator/titanium_mobile/master/package.json</a>";
   var win = Ti.UI.createWindow();
     
   var xhr = Ti.Network.createHTTPClient({
       onload: function() {
       Ti.API.debug(this.responseText);
        
       },
       onerror: function(e) {
       Ti.API.debug("STATUS: " + this.status);
       Ti.API.debug("TEXT:   " + this.responseText);
       Ti.API.debug("ERROR:  " + e.error);
       alert('There was an error retrieving the remote data. Try again.');
       },
       timeout:5000
   });
    
    
   xhr.open("GET", url);
   xhr.setRequestHeader("Accept-Encoding","gzip,deflate"); 
   xhr.send();
     
   win.open();
   </pre></code></li>
<li>Allen Yeung 2014-01-14

   Master PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/5214" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/5214</a>
   
   Please test both original, and second test case to verify that gzip still works.</li>
<li>Lokesh Choudhary 2014-05-06

   Verified the fix. We see XHR GZip 200 response as expected in the console & do not see any errors.
   
   Environment:
   Appc Studio : 3.2.3.201404181520
   Ti SDK : 3.3.0.v20140502133323
   Mac OSX : 10.8.5
   Alloy : 1.3.1	
   CLI - 3.2.3
   Nexus 5 - android 4.4.2</li>
</ol>


<p><a href="/TIMOB/TIMOB-16154.json">JSON Source</a></p>