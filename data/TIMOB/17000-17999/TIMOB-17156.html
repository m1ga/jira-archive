---
title: "[TIMOB-17156] Supporting per user configuration for build.properties for Android modules"
---
<table>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Open</td></tr>
<tr><th>Resolution</th><td>Unresolved</td></tr>

<tr><th>Affected Version/s</th><td>Release 3.2.3</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>n/a</td></tr>
<tr><th>Labels</th><td>android, ant, cb-tooling, module_build</td></tr>
<tr><th>Reporter</th><td>Kevin Frugier</td></tr>
<tr><th>Assignee</th><td>Unknown</td></tr>
<tr><th>Created</th><td>2014-06-06T21:05:05.000+0000</td></tr>
<tr><th>Updated</th><td>2018-02-28T20:03:52.000+0000</td></tr>
</table>

<h3>Description</h3>

In Titanium 3.2.3 GA, it's impossible to work as a team on the development of modules since the paths in build.properties are hardcoded.
The only solution is to have all the team members store the SDKs in the same location but it becomes quite tricky when some are on OSX and some on Windows.

<h4>Step 1 : jar files</h4>
The jar files are inserted in the .classpath of the module with their absolute path. It's a trivial task to change them to use Classpath variables that each user can set in Preferences > Java > Build Path > Classpath Variables
No problem here and nothing needs to be changed, this manual step doesn't need to be automated.

<h4>Step 2 : build.properties</h4>
At first glance it looks like this file is used as part of the ant build so we are tempted to do like before and set our custom properties in Preferences > Ant > Runtime > Properties.
The variables that need to be defined:
* <code>ANDROID_SDK_ROOT</code> (parent folder of <code>platforms</code> & <code>add-ons</code>)
* <code>android.ndk</code>
* <code>TITANIUM_MOBILE_PATH</code> (<code>xxx\mobilesdk\win32\3.2.3.GA</code> for instance)

Then we change build.properties as such (for an android module):
<code><pre>
titanium.platform=${TITANIUM_MOBILE_PATH}/android
android.platform=${ANDROID_SDK_ROOT}/platforms/android-10
google.apis=${ANDROID_SDK_ROOT}/add-ons/addon-google_apis-google-10
</pre></code>

Now everything inside Ant looks fine except when it comes to the *docgen* target which can't decipher the android.platform.
We wouldn't expect it to even have to read the file since it's an Ant file.
However we find this ugly part in <code>module/builder.py</code>:
<code><pre>
build_properties = read_properties(open(os.path.join(project_dir, 'build.properties')))
android_sdk_path = os.path.dirname(os.path.dirname(build_properties['android.platform']))
</pre></code>

Python trying to read an Ant file seems to be an ugly hack.
Instead I suggest doing the following:

<h4>1. Changing in <code>module/android/build.xml</code> the macro <code>titanium</code> as such:</h4>
<code><pre>
	&lt;macrodef name="titanium"&gt;
		&lt;attribute name="command"/&gt;
		&lt;element name="args" implicit="true" optional="true"/&gt;
		&lt;sequential&gt;
			&lt;python file="${titanium.py}"&gt;
				&lt;env key="android.platform" file="${android.platform}"/&gt;
				&lt;arg value="@{command}"/&gt;
				&lt;args/&gt;
			&lt;/python&gt;
		&lt;/sequential&gt;
	&lt;/macrodef&gt;
</pre></code>

Doing so, we inject in the environment of the python execution the proper variable expanded by Ant.

<h4>2. Then, we change <code>builder.py</code> as such:</h4>
<code><pre>
	if is_android(platform):
		if 'android.platform' in os.environ:
			android_sdk_path = os.path.dirname(os.path.dirname(os.environ['android.platform']))
		else:
			build_properties = read_properties(open(os.path.join(project_dir, 'build.properties')))
			android_sdk_path = os.path.dirname(os.path.dirname(build_properties['android.platform']))
		android_sdk = AndroidSDK(android_sdk_path)
</pre></code>

I left the old code because I don't want to risk side effects but at least when Ant has properly set android.platform in the env of python before calling the titanium script, we make use of it, reducing the need to manually read a file we shouldn't even be looking into.

Those slight changes allow manual tweeking of the module project (for those interested) so that it can be worked on by users having stuff on different locations.
(A proper mention of this possibility would be nice on the wiki as well if those changes are accepted).

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-17156_48706/build.xml">build.xml</td></td><td>2014-06-06T21:05:05.000+0000</td><td>17650</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-17156_48707/builder.py">builder.py</td></td><td>2014-06-06T21:05:05.000+0000</td><td>8162</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Ritu Agrawal 2014-06-13

   [~kayl] Great writeup. Much appreciated.
   
   Moving this improvement request to engineering for further evaluation and prioritization.</li>
</ol>


<p><a href="/TIMOB/TIMOB-17156.json">JSON Source</a></p>