---
title: "[TIMOB-17403] iOS: final ondatastream event should be fired before final onreadystatechange event"
---
<table>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>Low</td></tr>
<tr><th>Status</th><td>Open</td></tr>
<tr><th>Resolution</th><td>Unresolved</td></tr>

<tr><th>Affected Version/s</th><td>Release 3.3.0</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Chris Barber</td></tr>
<tr><th>Assignee</th><td>Unknown</td></tr>
<tr><th>Created</th><td>2014-07-26T00:14:23.000+0000</td></tr>
<tr><th>Updated</th><td>2018-02-28T20:04:15.000+0000</td></tr>
</table>

<h3>Description</h3>

The final <code>ondatastream</code> event containing progress=1 is fired after the DONE <code>onreadystatechange</code> event. This means you fall into a wonky state where the request is finished but you haven't been notified that all of the data has been received.

<code><pre>
var xhr = Ti.Network.createHTTPClient();
xhr.setTimeout(6e4);
var dataStreamFinished = false;
xhr.onreadystatechange = function(e) {
	Ti.API.info('state = ' + this.readyState + ' (' + dataStreamFinished + ')');
	if (this.readyState == this.DONE && dataStreamFinished) finish();
};
xhr.ondatastream = function(e) {
	if (!e.progress) callback_error("Errors in ondatastream");
	Ti.API.info(e.progress);
	if (e.progress >= .9) dataStreamFinished = true;
};
xhr.onerror = function(e) {
	callback_error(e);
};
xhr.open("GET", "<a href="http://www.appcelerator.com/assets/The_iPad_App_Wave.pdf" rel="nofollow" target="_blank">http://www.appcelerator.com/assets/The_iPad_App_Wave.pdf</a>");
xhr.send();
</pre></code>

Apparently, this is how the events are dispatched in native land.

To resolve this issue, when the DONE <code>onreadystatechange</code> event is fired, disconnect the <code>ondatastream</code> event handler, manually fire the <code>ondatastream</code> event with progress=1, then continue to fire the DONE <code>onreadystatechange</code> event.

<h3>Comments</h3>

<ol>
<li>Hans Kn√∂chel 2016-07-02

   Correct me if I am wrong, but I guess we could just swap the lines in [here](<a href="https://github.com/appcelerator/APSHTTPClient/blob/master/APSHTTPClient/APSHTTPRequest.m#L537)" rel="nofollow" target="_blank">https://github.com/appcelerator/APSHTTPClient/blob/master/APSHTTPClient/APSHTTPRequest.m#L537)</a> and it should fit your expectations - which I share.</li>
</ol>


<p><a href="/TIMOB/TIMOB-17403.json">JSON Source</a></p>