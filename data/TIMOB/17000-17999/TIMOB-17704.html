---
title: "[TIMOB-17704] iOS: XHR onreadystatechange called multiple times"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2014-10-22T21:17:56.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 3.4.2, Release 3.5.0, Release 4.0.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>Release-3.4.0, TCSupportTriage, ios, module_network, qe-manualtest, release-3.3, release-3.4.0</td></tr>
<tr><th>Reporter</th><td>Donovan Lewis</td></tr>
<tr><th>Assignee</th><td>Vishal Duggal</td></tr>
<tr><th>Created</th><td>2014-09-09T15:40:15.000+0000</td></tr>
<tr><th>Updated</th><td>2014-11-24T23:51:17.000+0000</td></tr>
</table>

<h3>Description</h3>

When using a XHR createHTTPClient the onreadystatechange is called multiple times. This mostly seems to happen on readystate 4. If your app uses a lot of XHR threads this will cause the app to hang and crash. 

Log from test app:

{quote}
[DEBUG] Application booted in 62.319040 ms
[INFO] readystate: 1
[INFO] readystate: 4
[INFO] size 104874307
[INFO] readystate: 4
[INFO] size 104874307
{quote}

Test app:

<code><pre>
var win = Ti.UI.createWindow({title: 'Demo', tabBarHidden: true, backgroundColor: '#fff'});

var button = Titanium.UI.createButton({
   title: 'Start',
   top: 10,
   width: 100,
   height: 50
});

win.add(button);

function getSize() {
    
		var self = this,
	    xhr = Ti.Network.createHTTPClient({
	    timeout: this.timeout,

		    onreadystatechange: function (e) {
		    	Titanium.API.info("readystate: " + this.readyState);
		        if (this.readyState === this.DONE) {
		            Titanium.API.info('size ' + parseInt(this.getResponseHeader('Content-Length')));

		        }
		    },

		    onerror: function (e) {
		        
		    }
		});
		xhr.open('HEAD', '<a href="http://speedtest.dal05.softlayer.com/downloads/test100.zip" rel="nofollow" target="_blank">http://speedtest.dal05.softlayer.com/downloads/test100.zip</a>');
		xhr.send();
}

button.addEventListener('click',function(e)
{
   getSize();
});

win.open();
</pre></code>


<h3>Comments</h3>

<ol>
<li>Vishal Duggal 2014-10-16

   Test Case
   <code><pre>
   var win = Ti.UI.createWindow({title: 'Demo', tabBarHidden: true, backgroundColor: '#fff'});
    
   var button = Titanium.UI.createButton({
      title: 'Start',
      top: 10,
      width: 100,
      height: 50
   });
    
   win.add(button);
    
   function getSize() {
        
           var self = this,
           xhr = Ti.Network.createHTTPClient({
           timeout: this.timeout,
    
               onreadystatechange: function (e) {
                   if (e.readyState) {
                       Titanium.API.info('Event readystate: ' + e.readyState+' Object readyState: '+this.readyState);
                       if (e.readyState === this.DONE) {
                           Titanium.API.info('size ' + parseInt(this.getResponseHeader('Content-Length'))); 
                       }
                   } else {
                       Titanium.API.info("readystate: " + this.readyState);
                       if (this.readyState === this.DONE) {
                           Titanium.API.info('size ' + parseInt(this.getResponseHeader('Content-Length')));
                       }
                   }
               },
    
               onerror: function (e) {
                    
               }
           });
           xhr.open('HEAD', '<a href="http://speedtest.dal05.softlayer.com/downloads/test100.zip" rel="nofollow" target="_blank">http://speedtest.dal05.softlayer.com/downloads/test100.zip</a>');
           xhr.send();
   }
    
   button.addEventListener('click',function(e)
   {
      getSize();
   });
    
   win.open();
   </pre></code></li>
<li>Vishal Duggal 2014-10-16

   Pull pending
   master - <a href="https://github.com/appcelerator/titanium_mobile/pull/6228" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/6228</a>
   3_4_X - <a href="https://github.com/appcelerator/titanium_mobile/pull/6229" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/6229</a></li>
<li>Ewan Harris 2014-11-24

   Verified fix on:
   
   Mac OSX 10.10.1
   Appcelerator Studio, build: 3.4.1.201410281743
   Titanium SDK build: 3.5.0.v20141124092514, 3.6.0.v20141124111716
   Titanium CLI, build: 3.4.1
   Alloy: 1.5.1
   Xcode 6.1.1 GM Seed
   iPhone 6 Plus (8.1)
   Nexus 6 (5.0)
   
   Using the test code above ran on both devices and the output is as expected. The readyState property for the event, e, is always unique. On Android the app no longer crashes and it runs as expected.</li>
</ol>


<p><a href="/TIMOB/TIMOB-17704.json">JSON Source</a></p>