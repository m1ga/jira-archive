---
title: "[TIMOB-17826] iOS: Disabling analytics in tiapp.xml leads to iads crash on device"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2014-11-27T10:12:00.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 3.4.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 3.4.2, Release 3.5.0, Release 4.0.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>TCSupportTriage, analytics, device, iad, ios, module_analytics, qe-manualtest</td></tr>
<tr><th>Reporter</th><td>Dan Tamas</td></tr>
<tr><th>Assignee</th><td>Chee Kiat Ng</td></tr>
<tr><th>Created</th><td>2014-09-27T16:17:34.000+0000</td></tr>
<tr><th>Updated</th><td>2014-11-27T10:12:00.000+0000</td></tr>
</table>

<h3>Description</h3>

If you disable the analytics in tiapp.xml and then try to use iAds it will crash with the following log:
<code><pre>
[ERROR] The application has crashed with an uncaught exception 'NSInvalidArgumentException'.
[ERROR] Reason:
[ERROR] *** setObjectForKey: object cannot be nil (key: sid)
[ERROR] Stack trace:
[ERROR]   
[ERROR] 0   CoreFoundation                      0x240eae3f &lt;redacted&gt; + 126
[ERROR] 1   libobjc.A.dylib                     0x31798c8b objc_exception_throw + 38
[ERROR] 2   CoreFoundation                      0x24008ec3 &lt;redacted&gt; + 850
[ERROR] 3   Comnio                              0x0022de8f Comnio + 1871503
[ERROR] 4   Comnio                              0x0022febd Comnio + 1879741
[ERROR] 5   Foundation                          0x24de4ae1 &lt;redacted&gt; + 8
[ERROR] 6   Foundation                          0x24d4fb7d &lt;redacted&gt; + 148
[ERROR] 7   Foundation                          0x24d42337 &lt;redacted&gt; + 774
[ERROR] 8   Foundation                          0x24de744b &lt;redacted&gt; + 186
[ERROR] 9   libdispatch.dylib                   0x31d00651 &lt;redacted&gt; + 952
[ERROR] 10  libdispatch.dylib                   0x31cfb09d &lt;redacted&gt; + 84
[ERROR] 11  libdispatch.dylib                   0x31d01ba1 &lt;redacted&gt; + 320
[ERROR] 12  libdispatch.dylib                   0x31d02cd7 &lt;redacted&gt; + 94
[ERROR] 13  libsystem_pthread.dylib             0x31e59e31 _pthread_wqthread + 668
[ERROR] 14  libsystem_pthread.dylib             0x31e59b84 start_wqthread + 8
[ERROR] *** Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: '*** setObjectForKey: object cannot be nil (key: sid)'
[ERROR] *** First throw call stack:
[ERROR] (0x240eae3f 0x31798c8b 0x24008ec3 0x22de8f 0x22febd 0x24de4ae1 0x24d4fb7d 0x24d42337 0x24de744b 0x31d00651 0x31cfb09d 0x31d01ba1 0x31d02cd7 0x31e59e31 0x31e59b84)
^C 

</pre></code>

The only place where I see an object with a key "sid" is the Geolocation module

<a href="https://github.com/appcelerator/titanium_mobile/blob/ad9eea392dd7b0820c1b5f65c9147cf1ce4c8662/iphone/Classes/GeolocationModule.m#L525" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/ad9eea392dd7b0820c1b5f65c9147cf1ce4c8662/iphone/Classes/GeolocationModule.m#L525</a>

that asks for a Ti.App.sessionId that seems to be set by the analytics.

Putting back analytics to true in tiapp.xml fixes the issue, however it is not ok. 

How to reproduce:
1. Disable analytics in tiapp.xml
<code><pre>
&lt;analytics&gt;false&lt;/analytics&gt;
</pre></code>

2. Add this is alloy.js (or anywhere)
<code><pre>

iad = Titanium.UI.iOS.createAdView({
	adSize: Titanium.UI.iOS.AD_SIZE_PORTRAIT
});

</pre></code>



<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-17826_52144/monkey_console.txt">monkey_console.txt</td></td><td>2014-10-23T22:42:14.000+0000</td><td>1419</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-17826_52145/monkey_no_analytics.crash">monkey_no_analytics.crash</td></td><td>2014-10-23T22:42:14.000+0000</td><td>43942</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Fokke Zandbergen 2014-09-27

   That might even imply just geolocation module by itself only works with analyics enabled. Have you tested that?
   
   The <code>Ti.App.sessionId</code> is not set by analytics, but "just" an UUID set on boot:
   
   <a href="https://github.com/appcelerator/titanium_mobile/blob/ad9eea392dd7b0820c1b5f65c9147cf1ce4c8662/iphone/Classes/TiApp.m#L181" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/ad9eea392dd7b0820c1b5f65c9147cf1ce4c8662/iphone/Classes/TiApp.m#L181</a></li>
<li>Jon Alter 2014-09-29

   Hi [~rborn],
   
   We haven't been able to reproduce your issue using the instructions above.
   Below is a small sample that we have used to test for the crash when <code>analytics</code> is false on device. Please run it and let us know if <code>reateAdView</code> or <code>forwardGeocoder</code> cause the crash (If the issue was coming from geolocation then it should happen when calling <code>forwardGeocoder</code>). If this sample doesn't work, please include a sample that we can use to reproduce the issue.
   
   Also, what devices is this happening on?
   
   <code><pre>
   var win = Ti.UI.createWindow({
       backgroundColor: "#FFF"
   });
   win.open();
   
   win.addEventListener('click', function() {
       console.log('click');
       // Titanium.Geolocation.forwardGeocoder("440 N Bernardo Ave", function(evt) {
       //     console.log("callback");
       //     console.log(JSON.stringify(evt));
       // });
   
       var iad = Titanium.UI.iOS.createAdView({
           adSize: Titanium.UI.iOS.AD_SIZE_PORTRAIT
       });
       win.add(iad);
   });
   </pre></code>
   </li>
<li>Dan Tamas 2014-09-30

   Sorry for the late reply
   
   I'm using few modules
   <code><pre>
   &lt;modules&gt;
           &lt;module platform="iphone"&gt;com.widbook.blur&lt;/module&gt;
           &lt;module platform="iphone" version="1.7.4"&gt;dk.napp.social&lt;/module&gt;
           &lt;module platform="iphone" version="1.5.1"&gt;ti.admob&lt;/module&gt;
           &lt;module platform="iphone"&gt;facebook&lt;/module&gt;
           &lt;module platform="android" version="2.1.1"&gt;ti.admob&lt;/module&gt;
           &lt;module platform="android"&gt;facebook&lt;/module&gt;
           &lt;module platform="android"&gt;com.tripvi.drawerlayout&lt;/module&gt;
           &lt;module platform="iphone"&gt;bencoding.securely&lt;/module&gt;
           &lt;module platform="android"&gt;bencoding.securely&lt;/module&gt;
           &lt;module platform="android"&gt;de.marcelpociot.autofocus&lt;/module&gt;
       &lt;/modules&gt;
   </pre></code> 
   
   I will try to run your test app with and without the modules, and mine as well to see if there is any of the modules that does this.
   </li>
<li>Stephen Feather 2014-10-07

   <h4>Crittercism crash report (see symbolicated below)</h4>
   <code><pre>
   Name: NSInvalidArgumentException
   Reason: *** setObjectForKey: object cannot be nil (key: sid)
   App Version: 2.0.5
   Device: iPhone 6 (don't know if 6 or 6+)
   iOS Version: 8.0.2
   Reported: 2014-10-07 13:40:1412689212
   User: Anon.
   
   Stack Trace:
   
   0	CoreFoundation	0x2c078e3f __exceptionPreprocess + 127
   1	libobjc.A.dylib	0x39797c8b objc_exception_throw + 36
   2	CoreFoundation	0x2bf96ec3 -[__NSDictionaryM setObject:forKey:] + 848
   3	Uinterview	0x001c7627 0x000db000 + 968231
   4	Uinterview	0x001c9655 0x000db000 + 976469
   5	Foundation	0x2cd72ae1 __NSBLOCKOPERATION_IS_CALLING_OUT_TO_A_BLOCK__ + 6
   6	Foundation	0x2ccddb7d -[NSBlockOperation main] + 146
   7	Foundation	0x2ccd0337 -[__NSOperationInternal _start:] + 772
   8	Foundation	0x2cd7544b __NSOQSchedule_f + 184
   9	libdispatch.dylib	0x39cff651 _dispatch_queue_drain + 950
   10	libdispatch.dylib	0x39cfa09d _dispatch_queue_invoke + 82
   11	libdispatch.dylib	0x39d00ba1 _dispatch_root_queue_drain + 318
   12	libdispatch.dylib	0x39d01cd7 _dispatch_worker_thread3 + 92
   13	libsystem_pthread.dylib	0x39e58e31 _pthread_wqthread + 666
   14	libsystem_pthread.dylib	0x39e58b84 start_wqthread + 6
   </pre></code>
   
   <h4>Modules in use</h4>
   <code><pre>
   &lt;module platform="commonjs"&gt;ti.cloud&lt;/module&gt;    
       &lt;module platform="iphone"&gt;dk.napp.drawer&lt;/module&gt;
       &lt;module platform="iphone"&gt;com.featherdirect.ticomscore&lt;/module&gt;
       &lt;module platform="iphone"&gt;facebook&lt;/module&gt;
       &lt;module platform="iphone"&gt;crittercism&lt;/module&gt;
   </pre></code>
   
   <h4>Other</h4>
   iAds is used in the app.
   System Version: 8.0.2
   iOS sdk target was 7.x
   <code><pre>
   &lt;analytics&gt;false&lt;/analytics&gt;
   &lt;sdk-version&gt;3.4.0.v20140925164115&lt;/sdk-version&gt;
   </pre></code>
   
   Had to use the patched libAPSAnalytics.a from TIMOB-17350 to get around the duplicate symbols error at the time.
   
   <h4>Symbolicated report</h4>
   <code><pre>
   Crashed Thread
   0	
   CoreFoundation 0x2c078e3f __exceptionPreprocess + 127
   1	
   libobjc.A.dylib 0x39797c8b objc_exception_throw + 36
   2	
   CoreFoundation 0x2bf96ec3 -[__NSDictionaryM setObject:forKey:] + 848
   3	
   Uinterview 0x001c7627 -[APSAnalytics queueEvent:type:data:immediate:] (APSAnalytics.m:449)
   4	
   Uinterview 0x001c9655 __54-[APSAnalytics sendCustomEvent:withEventType:payload:]_block_invoke_2 (APSAnalytics.m:855)
   5	
   Foundation 0x2cd72ae1 __NSBLOCKOPERATION_IS_CALLING_OUT_TO_A_BLOCK__ + 6
   6	
   Foundation 0x2ccddb7d -[NSBlockOperation main] + 146
   7	
   Foundation 0x2ccd0337 -[__NSOperationInternal _start:] + 772
   8	
   Foundation 0x2cd7544b __NSOQSchedule_f + 184
   9	
   libdispatch.dylib 0x39cff651 _dispatch_queue_drain + 950
   10	
   libdispatch.dylib 0x39cfa09d _dispatch_queue_invoke + 82
   11	
   libdispatch.dylib 0x39d00ba1 _dispatch_root_queue_drain + 318
   12	
   libdispatch.dylib 0x39d01cd7 _dispatch_worker_thread3 + 92
   13	
   libsystem_pthread.dylib 0x39e58e31 _pthread_wqthread + 666
   14	
   libsystem_pthread.dylib 0x39e58b84 start_wqthread + 6
   </pre></code></li>
<li>Jon Alter 2014-10-07

   Hey [~sfeather] - Any chance we could get some repro steps?
   
   Also, can you reproduce this issue without the other modules included in the project?</li>
<li>Stephen Feather 2014-10-07

   This is an app in the wild.  Simply confirming the bug by Dan.
   I do not know what steps took place to cause it.
   
   I changed the comment to add the symbolicated report which indicates its in the APSanalytics.m
   
   </li>
<li>Muhammad Dadu 2014-10-07

   </li>
<li>Dan Tamas 2014-10-08

   I tried to reproduce the bug in a new project, however I didn't manage to do it yet. I'll keep trying.
   
   </li>
<li>Mario 2014-10-19

   I just ran into the same problem with an existing App and luckily found this ticket.
   
   Enabling Analytics in tiapp.xml fixed the iAd-Crash.
   
   Also using SDK 3.4.0GA (not tried the patch from TIMOB-17350 since I am OK with the analytics for now), iOS 8.0.2 on an iPhone 6.
   
   I'm using other modules then the ones mentioned in the other comments:
   {quote}
           <module platform="iphone">ti.storekit</module>
           <module platform="iphone">ti.airprint</module>
           <module platform="iphone">com.0x82.dropbox</module>
           <module platform="iphone">com.0x82.key.chain</module>
           <module platform="commonjs">ti.aws</module>
           <module platform="iphone">com.lightapps.icloudkeyvalue</module>
   {quote}
   
   From what I see, it crashes in the analytics-conditional in <code>bannerViewDidLoadAd</code> in which it should not go because analytics is disabled. Looking at <code>main.m</code> I can see that <code>TI_APPLICATION_ANALYTICS</code> is correctly set to <code>NO</code> but for some reasons must evaluate differently in the iAd module.</li>
<li>Jon Alter 2014-10-20

    Thanks for the info [~favo]. Agreed, it looks like the crash is here: <a href="https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUIiOSAdView.m#L81" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUIiOSAdView.m#L81</a>
    But we have still not been able to reproduce the issue on this end. Any info that will help us reproduce the issue will be greatly appreciated.</li>
<li>Wilson Luu 2014-10-23

    I was able to reproduce this issue with SDK build 3.4.1.v20141022101712; looks like adView.show() is triggering the crash.
    
    *Steps to reproduce:*
    1. Create a new Titanium classic app
    2. In the tiapp.xml, look for *analytics* node and set to false
    3. In the app.js, use the following code:
    <code><pre>
    var win = Ti.UI.createWindow({
        backgroundColor: 'white',
        layout: 'vertical' 
    });
    
    var adView = Ti.UI.iOS.createAdView({
        width : Ti.UI.FILL,
        height : Ti.UI.FILL,
        top : 10,
        backgroundColor: 'red'
    });
    
    win.add(adView);
    
    adView.show(); 
    win.open();
    </pre></code>
    4. Install app to device
    
    *Actual:* After the app launches and a couple of seconds, the app will crash; see monkey_console.txt and monkey_no_analytics.crash.
    
    *Tested on:*
    
    Appcelerator Studio, build: 3.4.1.201410191611
    SDK build: 3.4.1.v20141022101712
    CLI: 3.4.1-dev
    Alloy: 1.5.1
    Xcode: 6.1
    Devices: iphone 5 (8.1)</li>
<li>Chee Kiat Ng 2014-10-24

    Thanks [~wluu].
    Problem found and fixed.
    PR here: <a href="https://github.com/appcelerator/titanium_mobile/pull/6267" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/6267</a>
    3_4_X PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/6268" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/6268</a></li>
<li>Khushbu Agrawal 2014-11-26

    The Apple iAds view is showed without crash when the Analytics is turned off in tiApp.xml. Hence closing the ticket.
    Tested with below Environment: 
    1. Mac OSX Yosemite 10.10
    2. Appcelerator Studio, build: 3.4.1.201410281743
    3. Titanium SDK, build:  3.5.0.v20141125154115
    4. Titanium CLI, build: 3.4.1
    5. Alloy: 1.5.1
    6. Xcode 6.1
    7. iOS SDK 8.1
    8. iPhone 5s with iOS 8.1
    </li>
</ol>


<p><a href="/TIMOB/TIMOB-17826.json">JSON Source</a></p>