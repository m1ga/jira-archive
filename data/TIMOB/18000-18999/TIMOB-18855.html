---
title: "[TIMOB-18855] Windows: Time between creating Date() objects runs a factor 1000 slower then reality"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2015-05-04T14:19:19.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 4.1.0</td></tr>
<tr><th>Components</th><td>Windows</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Fokke Zandbergen</td></tr>
<tr><th>Assignee</th><td>Kota Iguchi</td></tr>
<tr><th>Created</th><td>2015-04-25T17:29:14.000+0000</td></tr>
<tr><th>Updated</th><td>2015-07-13T21:14:04.000+0000</td></tr>
</table>

<h3>Description</h3>

The following code demonstrates that when you create a <code>new Date()</code> object in a <code>setTimeout</code> or <code>setInterval</code> method the time is off by a factor 1000.

If you run <a href="https://github.com/appcelerator-developer-relations/Mobile-App-Performance/" rel="nofollow" target="_blank">https://github.com/appcelerator-developer-relations/Mobile-App-Performance/</a> you will see that this also occurs when you have a expensive computation that takes several seconds and you log the time before and after.

<code><pre>
var run = require('run');

var win = Ti.UI.createWindow({
	backgroundColor: 'white',
	layout: 'vertical'
});

var btnTimeout = Ti.UI.createButton({
	top: 20,
	height: 40,
	color: '#FFF',
	backgroundColor: '#000',
	title: 'setTimeout'
});

btnTimeout.addEventListener('click', function () {
	addLabel();

	setTimeout(function () {
		addLabel();

		setTimeout(function () {
			addLabel();

			win.add(btnInterval);

		}, 5000);

	}, 0);
});

win.add(btnTimeout);

var btnInterval = Ti.UI.createButton({
	top: 20,
	height: 40,
	color: '#FFF',
	backgroundColor: '#000',
	title: 'setInterval'
});

btnInterval.addEventListener('click', function () {
	var interval;
	var intervals = 0;

	addLabel();

	interval = setInterval(function () {

		intervals++;

		addLabel();

		if (intervals === 2) {
			clearInterval(interval);
		}

	}, 5000);
});

function addLabel() {
	var d = new Date();

	win.add(Ti.UI.createLabel({
		top: 20,
		width: Ti.UI.FILL,
		height: 40,
		text: pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds()) + ':' + pad(d.getMilliseconds()),
		color: '#000'
	}));
}

function pad(int) {
	var str = int.toString();

	if (str.length === 1) {
		str = '0' + str;
	}

	return str;
}

win.open();
</pre></code>

I did the tests on the Emulator, but looking at the results [~kota] achieved with <a href="https://github.com/appcelerator-developer-relations/Mobile-App-Performance/" rel="nofollow" target="_blank">https://github.com/appcelerator-developer-relations/Mobile-App-Performance/</a> the same is true for device.

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-18855_55084/iOS Simulator Screen Shot 25 Apr 2015 19.25.26.png">iOS Simulator Screen Shot 25 Apr 2015 19.25.26.png</td></td><td>2015-04-25T17:31:17.000+0000</td><td>41812</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-18855_55085/Screen Shot 2015-04-25 at 19.24.04.png">Screen Shot 2015-04-25 at 19.24.04.png</td></td><td>2015-04-25T17:31:17.000+0000</td><td>101032</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Fokke Zandbergen 2015-04-25

   Attached the results on iOS and Windows Emulator</li>
<li>Kota Iguchi 2015-04-27

   Confirmed that this issue is Windows-specific which originally because JavaScriptCore evaluates wrong <code>Date</code>. Following test cases represents the issue, which is failing on Windows, which is passed on OS X.
   
   <code><pre>
   TEST_F(JSContextTests, TIMOB_18855) {
     JSContext js_context = js_context_group.CreateContext();
     js_context.JSEvaluateScript("var start=new Date().getTime();");
     std::this_thread::sleep_for(std::chrono::milliseconds(1000));
     JSValue js_value = js_context.JSEvaluateScript("new Date().getTime() - start;");
     XCTAssertFalse(static_cast<std::int32_t>(js_value) == 1);
     XCTAssertTrue(static_cast<std::int32_t>(js_value) >  999);
     // assuming JS evaluation is done within 100 msec...
     XCTAssertTrue(static_cast<std::int32_t>(js_value) < 1100);
   }
   </pre></code></li>
<li>Kota Iguchi 2015-04-27

   I suspect it is somewhat related to "date time cache" because first "new Date()" call returns valid value. Note that Ti Windows is based on nearly 2 years old JavaScriptCore and there are numerous changes since then, including date time calculation and cache. <a href="https://github.com/WebKit/webkit/commits/master/Source/JavaScriptCore/runtime/JSDateMath.cpp" rel="nofollow" target="_blank">https://github.com/WebKit/webkit/commits/master/Source/JavaScriptCore/runtime/JSDateMath.cpp</a></li>
<li>Kota Iguchi 2015-04-29

   I was able to fix this. It was a small bug originally introduced by Igalia: <a href="https://github.com/infosia/webkit-wp8/commit/e4d0d6034ba12c8b2ae9563836b078ace9d59fac" rel="nofollow" target="_blank">https://github.com/infosia/webkit-wp8/commit/e4d0d6034ba12c8b2ae9563836b078ace9d59fac</a> The bad news is that I have been failing to build JavaScriptCore for ARM locally, maybe it is environmental issue. Do we have CI build server for JavaScriptCore?</li>
<li>Kota Iguchi 2015-04-30

   <a href="https://github.com/appcelerator/HAL/pull/45" rel="nofollow" target="_blank">https://github.com/appcelerator/HAL/pull/45</a></li>
<li>Fokke Zandbergen 2015-04-30

   [~kota] is there a build available already that I can run the benchmarks on?</li>
<li>Kota Iguchi 2015-04-30

   [~fokkezb] Yes, download latest JavaScriptCore [JavaScriptCore-Windows-1430359270.zip](<a href="http://timobile.appcelerator.com.s3.amazonaws.com/jscore/JavaScriptCore-Windows-1430359270.zip)" rel="nofollow" target="_blank">http://timobile.appcelerator.com.s3.amazonaws.com/jscore/JavaScriptCore-Windows-1430359270.zip)</a>, and extract it to your JavaScriptCore_HOME. It's safe to overwrite existing *.lib there. Then clean and rebuild your benchmark app.</li>
<li>Ewan Harris 2015-07-13

   Verified using:
   
   Windows 8.1
   Appc CLI (NPM): 4.1.0
   Appc CLI (Registry): 4.1.0
   Ti SDK: 4.1.0.GA
   
   Using the provided sample code the results provided are expected and match the pattern of the iOS results
   
   Closing ticket</li>
</ol>


<p><a href="/TIMOB/TIMOB-18855.json">JSON Source</a></p>