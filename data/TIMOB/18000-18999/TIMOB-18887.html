---
title: "[TIMOB-18887] Android: Wrong implementation of TiResponseCache may cause occasional crashes in Lollipop"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2015-05-20T22:15:43.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 4.1.0, Release 4.0.1</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android-5</td></tr>
<tr><th>Reporter</th><td>grebulon</td></tr>
<tr><th>Assignee</th><td>Hieu Pham</td></tr>
<tr><th>Created</th><td>2015-03-19T14:23:17.000+0000</td></tr>
<tr><th>Updated</th><td>2015-06-23T20:16:35.000+0000</td></tr>
</table>

<h3>Description</h3>

I was getting occasional crashes in my titanium module when downloading files using HttpUrlConnection on a Lollipop device. Tracing this to okhttp (the http client used in android 5), I posted a bug report (see: <a href="https://code.google.com/p/android/issues/detail?id=160522)" rel="nofollow" target="_blank">https://code.google.com/p/android/issues/detail?id=160522)</a>

There is a bug in okhttp where they don't handle null pointer correctly, which is returned from TiCacheResponse.getHeaders() or its null key's value, but the fact is that it shouldn't return null in the first place. This all comes from the way the cached header's multimap assumes that the status is in the null key at position 0 (see: <a href="http://developer.android.com/reference/java/net/URLConnection.html#getHeaderFields%28%29)" rel="nofollow" target="_blank">http://developer.android.com/reference/java/net/URLConnection.html#getHeaderFields%28%29)</a>

For a full explanation of the cause see: <a href="https://code.google.com/p/android/issues/detail?id=160522#c5" rel="nofollow" target="_blank">https://code.google.com/p/android/issues/detail?id=160522#c5</a>

Partial stack dump of the problem:
{quote}
 Attempt to invoke virtual method 'boolean java.lang.String.startsWith(java.lang.String)' on a null object reference
 java.lang.NullPointerException: Attempt to invoke virtual method 'boolean java.lang.String.startsWith(java.lang.String)' on a null object reference
   at com.android.okhttp.internal.http.StatusLine.<init>(StatusLine.java:24)
   at com.android.okhttp.Response$Builder.statusLine(Response.java:419)
   at com.android.okhttp.internal.http.JavaApiConverter.createOkResponse(JavaApiConverter.java:116)
  at com.android.okhttp.internal.http.ResponseCacheAdapter.get(ResponseCacheAdapter.java:53)
   at com.android.okhttp.internal.http.HttpEngine.sendRequest(HttpEngine.java:269)
   at com.android.okhttp.internal.http.HttpURLConnectionImpl.execute(HttpURLConnectionImpl.java:373)
   at com.android.okhttp.internal.http.HttpURLConnectionImpl.getResponse(HttpURLConnectionImpl.java:323)
   at com.android.okhttp.internal.http.HttpURLConnectionImpl.getResponseCode(HttpURLConnectionImpl.java:491)
   at com.android.okhttp.internal.http.DelegatingHttpsURLConnection.getResponseCode(DelegatingHttpsURLConnection.java:105)
   at com.android.okhttp.internal.http.HttpsURLConnectionImpl.getResponseCode(HttpsURLConnectionImpl.java:25)
{quote}

<h3>Comments</h3>

<ol>
<li>grebulon 2015-03-22

   More discussion of this issue here:
   <a href="https://github.com/square/okhttp/issues/1523" rel="nofollow" target="_blank">https://github.com/square/okhttp/issues/1523</a>
   
   As for TiResponseCache, the problem starts at makeLowerCaseHeaders() where the implementation just throws away the null key-pair, instead of encoding it (say to a "null=xxx" string in the cache file).</li>
<li>grebulon 2015-04-13

   My fix is here:
   
   ﻿﻿<a href="https://www.dropbox.com/s/z814rg68p8qz7ew/TiResponseCache.java?dl=0" rel="nofollow" target="_blank">https://www.dropbox.com/s/z814rg68p8qz7ew/TiResponseCache.java?dl=0</a>
   
   Look for hopflow comments in the code</li>
<li>Muhammad Ahmed Fahad 2015-04-17

   Please resolve this issue soon probably with @grebulon's fix, before more devices get upgraded to Android Lollipop where the effects of this bug are more visible.</li>
<li>Praveen Kodakkad 2015-05-08

   Please resolve this issue ASAP.</li>
<li>Ingo Muschenetz 2015-05-11

   [~buddyguards] Thank you for the fix. Is it possible to submit it as a pull request? We can't accept it otherwise.</li>
<li>grebulon 2015-05-12

   Ingo, my fix is a quick hack so that users can take it and quickly build it into titanium. It should be taken as a basis for a cleaner implementation.</li>
<li>Hieu Pham 2015-05-14

   [~buddyguards] Thank you for the fix. Your fix seems pretty straightforward, so I put together a PR for it: <a href="https://github.com/appcelerator/titanium_mobile/pull/6850." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/6850.</a> 
   Test code:
   <code><pre>
   var vidWin = Titanium.UI.createWindow({
       title : 'Video View Demo',
       backgroundColor : '#fff'
   });
    
   var videoPlayer = Titanium.Media.createVideoPlayer({
       top : 2,
       autoplay : true,
       backgroundColor : 'blue',
       height : 300,
       width : 300,
       mediaControlStyle : Titanium.Media.VIDEO_CONTROL_DEFAULT,
       scalingMode : Titanium.Media.VIDEO_SCALING_ASPECT_FIT
   });
    
   videoPlayer.url = '<a href="http://techslides.com/demos/sample-videos/small.mp4" rel="nofollow" target="_blank">http://techslides.com/demos/sample-videos/small.mp4</a>';
   vidWin.add(videoPlayer);
   vidWin.open();
   </pre></code>
   
   1. Run app, wait until video is finished (autoplay)
   2. Hit back button (close the app)
   3. Run app again, make sure video played properly
   </li>
<li>Muhammad Ahmed Fahad 2015-05-21

   Can't this fix be put in the next immediate release rather than 4.1.0?</li>
<li>Ingo Muschenetz 2015-05-21

   I have marked it as such.</li>
<li>Hieu Pham 2015-05-21

    4.0.X backport: <a href="https://github.com/appcelerator/titanium_mobile/pull/6868" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/6868</a></li>
<li>Lokesh Choudhary 2015-05-29

    Verified the fix by running the test case above.
    
    Closing.
    
    Environment:
    Appc Studio :  4.0.1.201505282200
    Ti SDK :  4.0.1.v20150529150210, 4.1.0.v20150529013634
    CLI : 4.0.0
    Alloy : 1.6.0
    MAC Yosemite : 10.10.3
    Appc npm : 4.0.0
    Appc CLI : 4.0.1-rc
    Node: v0.10.37
    Nexus 5 - Android 5.1.1</li>
</ol>


<p><a href="/TIMOB/TIMOB-18887.json">JSON Source</a></p>