---
title: "[TIMOB-19285] iOS: App throws error when building to device with commonjs modules"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Invalid</td></tr>
<tr><th>Resolution Date</th><td>2015-07-31T16:23:22.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 5.0.0</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>iOS, Tooling</td></tr>
<tr><th>Labels</th><td>qe-5.0.0, regression</td></tr>
<tr><th>Reporter</th><td>Ewan Harris</td></tr>
<tr><th>Assignee</th><td>Chris Barber</td></tr>
<tr><th>Created</th><td>2015-07-29T23:05:03.000+0000</td></tr>
<tr><th>Updated</th><td>2015-09-01T21:49:41.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Description</h4>

When building to a device and including commonjs modules the app will crash with <code>\[ERROR] Script Error Couldn't find module: ti.cloud for architecture: arm64</code>. Requiring modules such as ti.map work fine.

*When building to simulator the app works fine*

<h4>Steps to reproduce</h4>

1. Create a project using <code>appc new</code> and ensure services are enabled
2.Build to device

<h4>Actual result</h4>

The app will crash with <code>\[ERROR] Script Error Couldn't find module: ti.cloud for architecture: arm64</code>

<h4>Expected result</h4>

The app should not crash

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-19285_56283/commonjs.example.test1.zip">commonjs.example.test1.zip</td></td><td>2015-07-30T05:17:53.000+0000</td><td>1435</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-19285_56312/Screen Shot 2015-07-31 at 9.45.01 AM.png">Screen Shot 2015-07-31 at 9.45.01 AM.png</td></td><td>2015-07-31T16:54:11.000+0000</td><td>30070</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Chee Kiat Ng 2015-07-30

   Additional info: 4.1.0.GA works. Only 4.2.0 fails. Something related to handling commonjs modules or specifically ti.cloud module must have changed somewhere in titanium_mobile </li>
<li>Ewan Harris 2015-07-30

   [~cng] I believe it is all commonjs modules, I made a basic module which I have attached and that also throws an error.
   
   Also I believe that it is symlinking the commonjs file when it builds. If I open up the .app for the project I built then the commonjs file is shown as an alias which links to the file in my Titanium module location, which is probably the root cause of this </li>
<li>Chee Kiat Ng 2015-07-30

   Thanks [~eharris], think I have pinpointed the problem. It's with the generated ApplicationMods.h. It used to contain all the definitions of modules, now 4.2.0 it's empty.
   Also realized ApplicationDefaults.m is different in both versions as well.</li>
<li>Chee Kiat Ng 2015-07-30

   Additional info: using ti create, ti build to device, it's ok. So most likely this is related to appc_cli too.</li>
<li>Chee Kiat Ng 2015-07-30

   PR here: <a href="https://github.com/appcelerator/titanium_mobile/pull/6997" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/6997</a>
   Tested that appc run works for both simulator and device. And so far it looks like it hasn't changed any original ti build behavior.
   Basically i made sure that the ApplicationMods.m and ApplicationDefaults.m file contents are the same as what appc used to produce in 4.1.0.GA, and also added a rule not to symlink commonjs modules, and to only copy if file didn't exist.
   [~cbarber], please review to see if this is ok. Only thing I'm not sure how to tackle is, if the commonjs module is updated to a newer version in the installed SDK, how does builder.js register the change and copy the file accordingly.</li>
<li>Chris Barber 2015-07-31

   This works as expected. The example MUST go in a platform directory named "commonjs":
   
   <code><pre>
   mkdir -p modules/commonjs
   cd modules/commonjs
   unzip commonjs.example.test1.zip
   </pre></code>
   </li>
<li>Ewan Harris 2015-07-31

   [~cbarber] the modules are inside the modules/commonjs folder in the Titanium SDK, see attached screenshot, I can still reproduce this using the latest SDK(4.2.0.v20150730093157). Also below is the output showing that the ti.cloud.js inside my app is a symlink to the one inside my modules folder
   
   <code><pre>
   Ewans-MacBook-Pro:testApp1234 eharris$ ls -l /Users/eharris/Documents/Appcelerator_Studio_Workspace/testApp1234/build/iphone/build/Debug-iphoneos/testApp1234.app/
   total 38760
   -rw-r--r--  1 eharris  staff   635075 Jul 31 09:42 Default-568h@2x.png
   -rw-r--r--  1 eharris  staff   610220 Jul 31 09:42 Default-667h@2x.png
   -rw-r--r--  1 eharris  staff  2004257 Jul 31 09:42 Default-Landscape-736h@3x.png
   -rw-r--r--  1 eharris  staff   622531 Jul 31 09:42 Default-Landscape.png
   -rw-r--r--  1 eharris  staff  1784621 Jul 31 09:42 Default-Landscape@2x.png
   -rw-r--r--  1 eharris  staff  1240741 Jul 31 09:42 Default-Portrait-736h@3x.png
   -rw-r--r--  1 eharris  staff   669227 Jul 31 09:42 Default-Portrait.png
   -rw-r--r--  1 eharris  staff  1826311 Jul 31 09:42 Default-Portrait@2x.png
   -rw-r--r--  1 eharris  staff   127342 Jul 31 09:42 Default.png
   -rw-r--r--  1 eharris  staff   413614 Jul 31 09:42 Default@2x.png
   drwxr-xr-x  2 eharris  staff       68 Jul 31 09:43 Frameworks
   -rw-r--r--  1 eharris  staff     1829 Jul 31 09:42 Info.plist
   -rw-r--r--  1 eharris  staff      808 Jul 31 09:42 KS_nav_ui.png
   -rw-r--r--  1 eharris  staff      811 Jul 31 09:42 KS_nav_views.png
   -rw-r--r--  1 eharris  staff        8 Jul 31 09:42 PkgInfo
   drwxr-xr-x  3 eharris  staff      102 Jul 31 09:43 _CodeSignature
   -rw-r--r--  1 eharris  staff     6836 Jul 31 09:42 appicon.png
   -rw-r--r--  1 eharris  staff    12393 Jul 31 09:43 embedded.mobileprovision
   drwxr-xr-x  3 eharris  staff      102 Jul 31 09:42 modules
   -rwxr-xr-x  1 eharris  staff  9848608 Jul 31 09:43 testApp1234
   lrwxr-xr-x  1 eharris  staff       95 Jul 31 09:42 ti.cloud.js -&gt; /Users/eharris/Library/Application Support/Titanium/modules/commonjs/ti.cloud/3.2.9/ti.cloud.js
   </pre></code></li>
<li>Chee Kiat Ng 2015-08-03

   [~cbarber], aside from using the example, if you use 
   <code><pre>appc run -p ios -T device</pre></code>
   on a brand new  *appc* project, it will copy a commonjs module, specifically ti.cloud, by default. And this is causing the error.
   </li>
<li>Chris Barber 2015-08-03

   [~cng] Merged a ton of fixes. Try again. :)</li>
<li>Wilson Luu 2015-09-01

    Closing ticket as fixed. Verified that if build a mobile app and install to device with commonjs modules, then I do not get any runtime errors.
    
    Tested on:
    
    Appc CLI NPM: 4.2.0-1
    Appc CLI Core: 5.0.0-33
    Arrow: 1.2.52
    SDK: 5.0.0.v20150901105514
    Node: v0.10.38
    OS: Yosemite (10.10.5)
    Xcode: 7 beta 6
    Devices: iphone 6 (8.4.1)</li>
</ol>


<p><a href="/TIMOB/TIMOB-19285.json">JSON Source</a></p>