---
title: "[TIMOB-19567] Last change made after useractivitywillsave does not make it to other device"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2015-10-29T20:38:40.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 5.0.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 5.2.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>handoff</td></tr>
<tr><th>Reporter</th><td>Fokke Zandbergen</td></tr>
<tr><th>Assignee</th><td>Chee Kiat Ng</td></tr>
<tr><th>Created</th><td>2015-09-22T14:22:37.000+0000</td></tr>
<tr><th>Updated</th><td>2016-02-23T10:47:24.000+0000</td></tr>
</table>

<h3>Description</h3>

While I was working on <a href="https://github.com/appcelerator-developer-relations/appc-sample-handoff" rel="nofollow" target="_blank">https://github.com/appcelerator-developer-relations/appc-sample-handoff</a> when our SDK and Apple's were still not GA and since they became GA it seems like the behaviour around <code>useractivitywillsave</code> has changed:

* Before it fired directly after setting <code>needsSave:true</code> but now it only does before the activity is handed off. This is expected behaviour, so I guess OK.
* Before I any change I did to the activity's <code>userInfo</code> in the event listener for <code>useractivitywillsave</code> would be received by the <code>continueactivity</code> event on the other device. But now it is no longer. This is not expected behaviour, so definitely a bug!

To reproduce:

1. Build <a href="https://github.com/appcelerator-developer-relations/appc-sample-handoff" rel="nofollow" target="_blank">https://github.com/appcelerator-developer-relations/appc-sample-handoff</a> to 2 devices
2. Make a change to the <code>needsSave</code> tab's title/message and continue on the other device
3. Check the logs on both and see that while the <code>userInfo</code> was updated in the <code>useractivitywillsave</code> on the first, it is not received in <code>continueactivity</code> on the other.

This seems like a serious bug because this makes handoff not usable for dynamic content.

<h3>Comments</h3>

<ol>
<li>Chee Kiat Ng 2015-09-29

   [~fokkezb], try out my classic app.js sample code
   <code><pre>
   var win = Ti.UI.createWindow({
   	title: 'testActibity',
   	backgroundColor: 'white'
   });
   
   var btn = Ti.UI.createButton({
   	top: 40,
   	title: 'make activity current'
   });
   
   btn.addEventListener('click',function(e){
   	if (activity.supported) {
   	    activity.becomeCurrent();
   	}
   });
   
   var btn2 = Ti.UI.createButton({
   	top: 80,
   	title: 'needs save'
   });
   
   btn2.addEventListener('click',function(e){
   	activity.needsSave = true;
   });
   
   win.add(btn);
   win.add(btn2);
   win.open();
   
   var activity = Ti.App.iOS.createUserActivity({
       activityType: 'com.appcelerator.sg.SGTestHandoff2.needssave',
       title: 'first activity',
       userInfo: {
           body: 'first activity'
       }
   });
   activity.addEventListener('useractivitywillsave', onUseractivitywillsave);
   activity.addEventListener('useractivitywascontinued', onUseractivitywascontinued);
   
   Ti.App.iOS.addEventListener('continueactivity', onContinueactivity);
   
   
   
   /**
    * Called when our activity was continued on another device.
    */
   function onContinueactivity(e) {
   
   	// We only respond to the writing activity
   	if (e.activityType !== 'com.appcelerator.sg.SGTestHandoff2.needssave') {
   		return;
   	}
   
   	alert('Ti.App.iOS:continueactivity: ' + JSON.stringify(e));
   
   	// Update our content with activity handed off to us
   
   }
   
   /**
    * Called before our activity is continued on another device so we can update its state.
    */
   function onUseractivitywillsave(e) {
   	alert('Ti.App.iOS.UserActivity:useractivitywillsave ' + JSON.stringify(e));
   
   	activity.title = 'before you go';
   
   	activity.userInfo = {
   		body: 'i changed my body text'
   	};
   
   	Ti.API.info('Updated activity: '+ activity.title +', ' + activity.userInfo.body);
   }
   
   /**
    * Called when our activity was continued on another device.
    */
   function onUseractivitywascontinued(e) {
   	alert('Ti.App.iOS.UserActivity:useractivitywascontinued ' + JSON.stringify(e));
   }
   </pre></code>
   and include in tiapp.xml
   <code><pre>
    &lt;key&gt;NSUserActivityTypes&lt;/key&gt;
   		        &lt;array&gt;
   		          &lt;string&gt;com.appcelerator.sg.SGTestHandoff2.needssave&lt;/string&gt;
   		        &lt;/array&gt;
   </pre></code>
   It seems to be behaving correctly. 
   
   <h4>Steps to verify</h4>
   1. install app on 2 devices
   2. on device A, open the app, and press "make activity current"
   3. An alert will pop up, indicating will save event with the current activity info
   4. on device B, continue the activity via the lock screen
   5. alert will pop up in device A, indicating will save event with the new activity info
   6. close the alert
   7. alert will pop up in device A, indicating new activity is continued on another device
   8. alert will pop up in device B, indicating new activity is continuing, with NEW activity info</li>
<li>Chee Kiat Ng 2015-09-29

   Though i noticed, i completely did not use 'needSave' property. i'm assuming that's true by default.</li>
<li>Fokke Zandbergen 2015-09-29

   [~cng] <code>useractivitywillsave</code> will always fire right after <code>becomeCurrent()</code> regardless of <code>needsSave</code>, but indeed I see that in your sample it is also fires when you handover without first setting <code>needsSave</code>, while I've also seen it not do that. It seems to be very unpredictable.
   
   I've modified your sample to better demonstrates what I can still demonstrate going wrong:
   
   <code><pre>
   var win = Ti.UI.createWindow({
   	title: 'testActibity',
   	backgroundColor: 'white'
   });
    
   var btn = Ti.UI.createButton({
   	top: 40,
   	title: 'make activity current'
   });
    
   btn.addEventListener('click',function(e){
   	if (activity.supported) {
   	    activity.becomeCurrent();
   	}
   });
    
   var btn2 = Ti.UI.createButton({
   	top: 80,
   	title: 'needs save'
   });
    
   btn2.addEventListener('click',function(e){
   	activity.needsSave = true;
   
   	log.value = log.value + 'Set activity.needsSave=true\n\n';
   });
    
   var btn3 = Ti.UI.createButton({
   	top: 120,
   	title: 'clear log'
   });
    
   btn3.addEventListener('click',function(e){
   	log.value = '';
   });
   
   var log = Ti.UI.createTextArea({
   	top: 160,
   	right: 0,
   	bottom: 0,
   	left: 0,
   	font: {
   		fontFamily: 'Courier'
   	},
   	editable: false
   });
    
   win.add(btn);
   win.add(btn2);
   win.add(btn3);
   win.add(log);
   win.open();
    
   var activity = Ti.App.iOS.createUserActivity({
       activityType: 'com.appcelerator.sg.SGTestHandoff2.needssave',
       title: 'Initial title',
       userInfo: {
           body: 'Initial body'
       }
   });
   activity.addEventListener('useractivitywillsave', onUseractivitywillsave);
    
   Ti.App.iOS.addEventListener('continueactivity', onContinueactivity);
    
   /**
    * Called when our activity was continued on another device.
    */
   function onContinueactivity(e) {
    
   	// We only respond to the writing activity
   	if (e.activityType !== 'com.appcelerator.sg.SGTestHandoff2.needssave') {
   		return;
   	}
   
   	log.value = log.value + 'continueactivity: ' + JSON.stringify(e) + '\n\n';
   }
    
   /**
    * Called before our activity is continued on another device so we can update its state.
    */
   function onUseractivitywillsave(e) {
   	log.value = log.value + 'useractivitywillsave: ' + JSON.stringify(e) + '\n\n';
   
   	var time = 'Time: ' + Date.now().toString();
    
   	activity.title = time;
   	activity.userInfo = {
   		body: time
   	};
   
   	log.value = log.value + 'Updated activity with "' + time + '": ' + JSON.stringify({
   		title: activity.title,
   		userinfo: activity.userInfo
   	}) + '\n\n';
   }
   </pre></code>
   
   *Steps*
   
   1. Make current on first device
   2. Handoff on other device
   3. See that the activity the other device received does not have the timestamp set by the first in <code>useractivitywillsave</code>
   
   *Logs Device 1*
   
   <code><pre>
   useractivitywillsave: {"title":"Initial title","activityType":"com.appcelerator.sg.SGTestHandoff2.needssave","userInfo":{"body":"Initial body"},"bubbles":true,"type":"useractivitywillsave","source":{},"cancelBubble":false}
   
   Updated activity with "Time: 1443512899529": {"title":"Initial title","userinfo":{"body":"Initial body"}}
   
   useractivitywillsave: {"title":"Time: 1443512899529","activityType":"com.appcelerator.sg.SGTestHandoff2.needssave","userInfo":{"body":"Time: 1443512899529"},"bubbles":true,"type":"useractivitywillsave","source":{},"cancelBubble":false}
   
   Updated activity with "Time: 1443512907367": {"title":"Time: 1443512907367","userinfo":{"body":"Time: 1443512907367"}}
   </pre></code>
   
   *Log Device 2*
   
   <code><pre>
   continueactivity: {"title":"Time: 1443512899529","activityType":"com.appcelerator.sg.SGTestHandoff2.needssave","userInfo":{"body":"Time: 1443512899529"},"bubbles":true,"type":"continueactivity","source":{},"cancelBubble":false}
   </pre></code>
   
   As you can see when I update the activity on device 1 even on that device after setting <code>activity.title</code> a get on that same variable returns the old value. So there seems to be something wrong there. Sometimes the get does give the right value, sometimes only for the title, other times only the body. Very odd!</li>
<li>Chee Kiat Ng 2015-10-01

   Hm. Looking at the code, i think the reason is because of this line:
   <a href="https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiAppiOSUserActivityProxy.m#L189" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiAppiOSUserActivityProxy.m#L189</a>
   see it fires the event to JS, after which it continues to do what it is supposed to do, to continue activity on another device. So it looks like it won't wait for you to make changes to the activity. that's why you see the race condition. Some thoughts have to be put in on this, this may be a little tricky.</li>
<li>Fokke Zandbergen 2015-10-01

   The workaround is to update the activity when you set <code>needsSave:true</code>, but that's.. well, ugly.
   
   Could we do a callback or something?</li>
<li>Chee Kiat Ng 2015-10-02

   We could somehow hack it such that the main thread waits for the JS to complete a callback or something, but 
   1. That sounds like a bad idea
   2. i don't think we have ever done something like that in the sdk
   
   We might have to consider deprecating and removing this event altogether. users could stick to "useractivitywascontinued", used for remembering the state the app was in before continued on to another device. Because i relate a user activity to a app state, and can only imagine a small use case whereby you want to change the activity content on the last minute before it's handed off.</li>
<li>Fokke Zandbergen 2015-10-02

   Well if we remove it we break parity with the native API. *The* example for handoff is starting an email on your iPhone and continue it on your iPad or Mac. For this typical use case it *is* very important that you can update the activity before it is continued on the other device. I really need we do need to fix this. And until we do we should inform people about the workaround, which is to update the activity when they set <code>needsSave:true</code>. I will update the blog post that will go out today with that and link to this issue.</li>
<li>Fokke Zandbergen 2015-10-03

   [~ben.bahrenburg@gmail.com] since you implemented this (right?) any ideas on this issue?</li>
<li>Ben Bahrenburg 2015-10-03

   [~fokkezb] what you have as the workaround is the actual behavior.  Please reference <a href="http://stackoverflow.com/questions/26715531/nsuseractivity-handoff-not-working-for-custom-data" rel="nofollow" target="_blank">http://stackoverflow.com/questions/26715531/nsuseractivity-handoff-not-working-for-custom-data</a>
   
   If you made any chances you need to update the needsSave property.  Sounds like this is just a documentation update.  Alternatively we could break with the native API and set the property for the developer.  Would suggest the first strategy.</li>
<li>Fokke Zandbergen 2015-10-03

    [~ben.bahrenburg@gmail.com] I know you need to set <code>needsSave:true</code> when you have changes that need to be saved before another device continues the activity. That's not the point.
    
    The point is that Apple is (somewhat) [clear](<a href="https://developer.apple.com/library/mac/documentation/UserExperience/Conceptual/Handoff/AdoptingHandoff/AdoptingHandoff.html#//apple_ref/doc/uid/TP40014338-CH2-SW14)" rel="nofollow" target="_blank">https://developer.apple.com/library/mac/documentation/UserExperience/Conceptual/Handoff/AdoptingHandoff/AdoptingHandoff.html#//apple_ref/doc/uid/TP40014338-CH2-SW14)</a> that you shouldn't actually update the activity until the <code>useractivitywillsave</code> event.
    
    {quote}To update the activity object’s userInfo dictionary efficiently, configure its delegate and set its needsSave property to YES whenever the userInfo needs updating. At appropriate times, Handoff invokes the delegate’s userActivityWillSave: callback, and the delegate can update the activity state.{quote}
    
    And *that* is not (always) working in our Titanium implementation because the Obj-C thread doesn't wait for the JS event to be finished before allowing the other device to continue. Which causes the other device to not always get the updated information but rather the previous state.</li>
<li>Ben Bahrenburg 2015-10-03

    [~fokkezb] you are not going to be able to have the Obj-C wait for the JS event to finish.  This is just a delegate event that is fired in native, that then raises the event in JS.
    
    Truthfully you should be re-building your activity on the other side of your application if there is concern over latency.</li>
<li>Fokke Zandbergen 2015-10-05

    I don't get what you mean with re-building. Surely we need to be able to get this working as Apple has documented it should work?</li>
<li>Ben Bahrenburg 2015-10-05

    [~fokkezb] see [~cng] comment he sums up your options well. Even read your second to last statement with some thought, i.e. you want ObjC to wait for JS in a delegate call.... think about what you just said.  I think the key is how do you work around this in your example.  Personally when I coded the hand-off part of my application, using this code, I never had to use this event.</li>
<li>Fokke Zandbergen 2015-10-06

    I know it works fine if you update the activity before/when you set <code>needsSave:true</code> it would just be better if we can make our implementation follow Apple's best practices.
    
    If that is technically impossible then we should indeed remove the <code>useractivitywillsave</code> event and tell people that in contrast to what Apple says they need to update the activity where they set <code>needsSave:true</code>.</li>
<li>Chee Kiat Ng 2015-10-28

    PR here: <a href="https://github.com/appcelerator/titanium_mobile/pull/7357" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/7357</a>
    to deprecate useractivitywillsave to avoid confusion.</li>
<li>Fokke Zandbergen 2015-10-28

    [~cng] Added a few comments to the PR.
    
    If we don't expect to ever be able to restore <code>useractivitywillsave</code> it would be good to look into if it wouldn't be better if we call needsSave automatically whenever the user makes a change to the user activity.</li>
<li>Chee Kiat Ng 2015-10-28

    [~fokkezb] it sure sounds reasonable. maybe new a ticket for that?</li>
<li>Fokke Zandbergen 2015-10-29

    Done: TIMOB-19567</li>
<li>Hans Knöchel 2015-10-29

    PR approved!</li>
<li>Harry Bryant 2016-02-22

    Verified as fixed, This was tested using two iOS9 devices, and an iOS9 to iOS8 device. info made by <code>useractivitywillsave</code> returns correct values on multiple tries, and the information received by Device B is reflected correctly.
    
    Tested on:
    
    iPhone 6Plus device (9.0.2) , iPhone 6S Plus (9.2.1) & iOS8.4 Device
    Mac OSX El Capitan 10.11.3 (15D21)
    Ti SDK: 5.2.0.v20160220080449
    Appc Studio: 4.5.0.201602170821
    Appc NPM: 4.2.3-2
    App CLI: 5.2.0-269
    Xcode 7.2
    Node v4.2.6
    production
    
    *Closing ticket.*</li>
<li>Fokke Zandbergen 2016-02-23

    [~htbryant] not sure I get your test report. The event should give a deprecation message now because it does _not_ (always) work as expected.</li>
</ol>


<p><a href="/TIMOB/TIMOB-19567.json">JSON Source</a></p>