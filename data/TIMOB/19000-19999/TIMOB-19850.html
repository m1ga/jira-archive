---
title: "[TIMOB-19850] iOS: Permissions (Geolocation) Bugs in implementation & documentation"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2015-11-04T04:08:27.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 5.1.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 5.1.0, Release 5.2.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>permissions</td></tr>
<tr><th>Reporter</th><td>Fokke Zandbergen</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2015-11-03T09:43:23.000+0000</td></tr>
<tr><th>Updated</th><td>2015-11-20T23:27:31.000+0000</td></tr>
</table>

<h3>Description</h3>

While working on the permissions sample app I ran into some irregularities:

* The API reference for [hasLocationPermissions](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Geolocation-method-hasLocationPermissions) lists all <code>AUTHORIZATION_*</code> constants as possible values, while only <code>AUTHORIZATION_ALWAYS</code> and <code>AUTHORIZATION_WHEN_IN_USE</code> are valid.
* The API reference for [requestLocationPermissions](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Geolocation-method-requestLocationPermissions) lists all <code>AUTHORIZATION_*</code> constants as possible values, while only <code>AUTHORIZATION_ALWAYS</code> and <code>AUTHORIZATION_WHEN_IN_USE</code> are valid.
* The implementation of [requestLocationPermissions](<a href="https://github.com/appcelerator/titanium_mobile/blob/1607237763f9e490e41d98b8d711ac49eeb01043/iphone/Classes/GeolocationModule.m#L879-L884)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/1607237763f9e490e41d98b8d711ac49eeb01043/iphone/Classes/GeolocationModule.m#L879-L884)</a> seems to call the <code>locationPermissionManager</code> twice if the first statement is false:

<code><pre>
            if (currentPermissionLevel == kCLAuthorizationStatusAuthorizedWhenInUse) {
                NSLog(@"[ERROR] cannot change already granted permission from AUTHORIZATION_WHEN_IN_USE to AUTHORIZATION_ALWAYS");
            } else {
                [[self locationPermissionManager] requestAlwaysAuthorization];
            }
            [[self locationPermissionManager] requestAlwaysAuthorization];
</pre></code>

* On Android <code>Ti.Calendar.requestCalendarPermissions</code>, <code>Ti.Contacts.requestContactsPermissions</code> and <code>Ti.Media.requestCameraPermissions</code> will call back with <code>success:false</code> if the required permission is missing in <code>tiapp.xml</code> but on iOS <code>Ti.Geolocation.requestLocationPermissions</code> will not call back at all when the required <code>NSLocation*UsageDescription</code> key is missing in <code>tiapp.xml</code>. It should call back with <code>success:false</code> as well.
* If you don't allow permission when asked by <code>Ti.Calendar.requestCalendarPermissions</code> or <code>Ti.Contacts.requestContactsPermissions</code> it will call back with <code>success:false</code> but <code>Ti.Geolocation.requestLocationPermissions</code> does not call back at all.
* For both <code>hasLocationPermissions</code> and <code>requestLocationPermissions</code> wouldn't the expected behaviour be that if <code>AUTHORIZATION_ALWAYS</code> was granted then <code>AUTHORIZATION_WHEN_IN_USE</code> would be seen as granted as well since always > when in use?

<h3>Comments</h3>

<ol>
<li>Fokke Zandbergen 2015-11-03

   Ti 5.1.0 sample app for testing:
   <a href="https://github.com/appcelerator-developer-relations/appc-sample-ti510/blob/master/app/controllers/permissions.js" rel="nofollow" target="_blank">https://github.com/appcelerator-developer-relations/appc-sample-ti510/blob/master/app/controllers/permissions.js</a></li>
<li>Hans Knöchel 2015-11-04

   All changes implemented, except of the "auto grant <code>when-in-use</code>, if <code>always</code> was granted before" since that is no bug but a question on how to check the permissions. In my opinion, a user requests either <code>when-in-use</code> or <code>always</code> on one use case, not both. And if so, the users can now check against this, but we don't do it automatically.
   
   PR master: <a href="https://github.com/appcelerator/titanium_mobile/pull/7395" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/7395</a>
   PR 5_1_X: <a href="https://github.com/appcelerator/titanium_mobile/pull/7396" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/7396</a> </li>
<li>Chee Kiat Ng 2015-11-04

   CR and FT passed. PRs merged.</li>
<li>Harry Bryant 2015-11-06

   Verified as fixed, using the permissions sample app, tested that permissions were correctly requested and granted. Verified that this was reflected under Settings > Privacy. Setting the permissions to deny the app will cause the app to request permission access again. 
   
   Tested on:
   iPhone 6S+ iOS 9.1 Device & iPhone 6 iOS 9.1 Sim
   Mac OSX El Capitan 10.11 (15A284) 
   Ti SDK: 5.1.0.v20151104190037 
   Appc NPM: 4.2.1 
   Appc CLI: 5.1.0-43
   Ti CLI: 5.0.4 
   Alloy: 1.7.23 
   Xcode 7.1(7B91b) 
   Node v0.12.7 
   production
   
   Closing ticket.</li>
</ol>


<p><a href="/TIMOB/TIMOB-19850.json">JSON Source</a></p>