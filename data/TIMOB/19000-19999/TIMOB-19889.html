---
title: "[TIMOB-19889] iOS: Core Motion crashes when the user moves"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Duplicate</td></tr>
<tr><th>Resolution Date</th><td>2015-11-23T02:49:15.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 5.0.1, Release 5.0.2, Release 5.0.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 5.2.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>ios</td></tr>
<tr><th>Reporter</th><td> Ricardo Ramirez</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2015-11-06T21:40:39.000+0000</td></tr>
<tr><th>Updated</th><td>2016-01-19T19:19:13.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Issue Description</h4>

Core motion is crashing using iOS 9.1 on device when the user start to move or walk 

<h4>Steps to reproduce </h4>
1- create a sample app alloy project
2. paste the next code: 

app/views/index.xml
<code><pre>
&lt;Alloy&gt;
    &lt;Window backgroundColor="white" layout="vertical"&gt;
        &lt;Label&gt;Pitch:&lt;/Label&gt;
        &lt;ProgressBar id="pitch" /&gt;
        &lt;Label&gt;Roll:&lt;/Label&gt;
        &lt;ProgressBar id="roll" /&gt;
        &lt;Label&gt;Yaw:&lt;/Label&gt;
        &lt;ProgressBar id="yaw" /&gt;
    &lt;/Window&gt;
&lt;/Alloy&gt;
</pre></code>

app/styles/index.tss
<code><pre>
"ProgressBar" : {
    "top" : 10,
    "width" : 200,
    "min" : 0,
    "max" : 3.1415927
},
"Label" : {
    "font" : {
        textStyle: Ti.UI.TEXT_STYLE_SUBHEADLINE
    },
    "top" : 50,
    "left" : 10
} 
</pre></code>

app/controllers/index.js
<code><pre>
var accelX = accelY = accelZ = 0;
var lastX = lastY = lastZ = 0;
var ACCEL_THRESHOLD = 2;
var SHAKE_THRESHOLD = 5;
var CoreMotion = require('ti.coremotion');
if (CoreMotion.isDeviceMotionAvailable()) {
    CoreMotion.setDeviceMotionUpdateInterval(500);
    var frames = CoreMotion.availableAttitudeReferenceFrames();
    var ref_frame = CoreMotion.ATTITUDE_REFERENCE_FRAME_X_TRUE_NORTH_Z_VERTICAL;
    if (frames & ref_frame) {
        // Use the True North Frame if available
        Ti.API.debug('REFERENCE FRAME: True North');
        CoreMotion.startDeviceMotionUpdatesUsingReferenceFrame(
            {referenceFrame: ref_frame},
            updateMotionData    
        );
    }
    else if (ref_frame = CoreMotion.getAttitudeReferenceFrame()) {
        // Use the default frame if it exists
        Ti.API.debug('REFERENCE FRAME: Default ' + ref_frame);
        CoreMotion.startDeviceMotionUpdatesUsingReferenceFrame(
            {referenceFrame: ref_frame},
            updateMotionData    
        );        
    } else {
        // Do not use a reference frame
        Ti.API.debug('REFERENCE FRAME: None');
        CoreMotion.startDeviceMotionUpdates(updateMotionData);
    }
}
function updateMotionData (e) {
    
    if (e.success) {     
        var data = e.userAcceleration;
        if (Math.abs(lastX - data.x) &gt; ACCEL_THRESHOLD) {
            accelX++;
        }
        if (Math.abs(lastY - data.y) &gt; ACCEL_THRESHOLD) {
            accelY++;
        }
        if (Math.abs(lastZ - data.z) &gt; ACCEL_THRESHOLD) {
            accelZ++;
        }
        analyzeResults();
        lastX = data.x;
        lastY = data.y;
        lastZ = data.z;
        
        data = e.attitude;
        $.pitch.message = data.pitch;
        $.pitch.value = Math.abs(data.pitch);
        $.roll.message = data.roll;
        $.roll.value = Math.abs(data.roll);
        $.yaw.message = data.yaw;
        $.yaw.value = Math.abs(data.yaw);
    } else {
        if (e.error) Ti.API.error(e.error);
    }
}
function analyzeResults(){
    if (accelX &gt; SHAKE_THRESHOLD || accelY &gt; SHAKE_THRESHOLD || accelZ &gt; SHAKE_THRESHOLD) {
        var err = SHAKE_THRESHOLD * 0.5;
        if (accelX &gt; SHAKE_THRESHOLD && (accelY &lt; err && accelZ &lt; err)){
            alert("Quit shaking me back and forth!");
        }
        else if (accelY &gt; SHAKE_THRESHOLD && (accelX &lt; err && accelZ &lt; err)){
            alert("Quit shaking me up and down!");
        }
        else if (accelZ &gt; SHAKE_THRESHOLD && (accelX &lt; err && accelY &lt; err)){
            alert("Why are you shaking me like that?!");
        }
        else {
            alert("Quit shaking me!");
        }        
        accelX = accelY = accelZ = 0;
    }
}
$.pitch.show();
$.roll.show();
$.yaw.show();
$.index.open();
</pre></code>

3- Add the Core Motion Module
4- Build and run on device
5.- Move and Walk 

The app will close unexpectedly

<h4>Expected Behavior </h4>
The app should keep working



**Additional notes: 
Attached Xcode crash log image.
This is also happening on the movies sample app

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-19889_57278/Screen Shot 2015-11-06 at 3.01.29 PM.png">Screen Shot 2015-11-06 at 3.01.29 PM.png</td></td><td>2015-11-06T21:40:22.000+0000</td><td>498230</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2015-11-08

   [~rramirez] Do you have infos where it it did work? [~cng] [~penrique] This module is also compiled with the old hyperloop, we should clean it up for now just like in MOD-2150, thoughts?.</li>
<li>Hans Knöchel 2015-11-19

   This issue was fixed as part of the ti.coremotion refactoring process. The current version can be found [here](<a href="https://github.com/appcelerator-modules/ti.coremotion/releases)" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.coremotion/releases)</a> and will be packed into Ti.SDK 5.2.0 by default. [Docs](<a href="https://github.com/appcelerator-modules/ti.coremotion/tree/master/apidoc)" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.coremotion/tree/master/apidoc)</a> and an [example](<a href="https://github.com/appcelerator-modules/ti.coremotion/blob/master/iphone/example/app.js)" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.coremotion/blob/master/iphone/example/app.js)</a> covering every available API is also packed into the module. 
   
   As we cleaned everything up, the device motion has now its own namespace, the updated sample code following (view and style remain the same):
   
   <code><pre>
   var accelX = accelY = accelZ = 0;
   var lastX = lastY = lastZ = 0;
   var ACCEL_THRESHOLD = 2;
   var SHAKE_THRESHOLD = 5;
   var CoreMotion = require('ti.coremotion');
   var DeviceMotion = CoreMotion.createDeviceMotion();
   
   if (DeviceMotion.isDeviceMotionAvailable()) {
       DeviceMotion.setDeviceMotionUpdateInterval(500);
       var frames = DeviceMotion.availableAttitudeReferenceFrames();
       var ref_frame = CoreMotion.ATTITUDE_REFERENCE_FRAME_X_TRUE_NORTH_Z_VERTICAL;
       if (frames & ref_frame) {
           // Use the True North Frame if available
           Ti.API.debug('REFERENCE FRAME: True North');
           DeviceMotion.startDeviceMotionUpdatesUsingReferenceFrame(
               {referenceFrame: ref_frame},
               updateMotionData    
           );
       }
       else if (ref_frame = DeviceMotion.getAttitudeReferenceFrame()) {
           // Use the default frame if it exists
           Ti.API.debug('REFERENCE FRAME: Default ' + ref_frame);
           DeviceMotion.startDeviceMotionUpdatesUsingReferenceFrame(
               {referenceFrame: ref_frame},
               updateMotionData    
           );        
       } else {
           // Do not use a reference frame
           Ti.API.debug('REFERENCE FRAME: None');
           DeviceMotion.startDeviceMotionUpdates(updateMotionData);
       }
   }
   function updateMotionData (e) {
       
       if (e.success) {     
           var data = e.userAcceleration;
           if (Math.abs(lastX - data.x) &gt; ACCEL_THRESHOLD) {
               accelX++;
           }
           if (Math.abs(lastY - data.y) &gt; ACCEL_THRESHOLD) {
               accelY++;
           }
           if (Math.abs(lastZ - data.z) &gt; ACCEL_THRESHOLD) {
               accelZ++;
           }
           analyzeResults();
           lastX = data.x;
           lastY = data.y;
           lastZ = data.z;
           
           data = e.attitude;
           $.pitch.message = data.pitch;
           $.pitch.value = Math.abs(data.pitch);
           $.roll.message = data.roll;
           $.roll.value = Math.abs(data.roll);
           $.yaw.message = data.yaw;
           $.yaw.value = Math.abs(data.yaw);
       } else {
           if (e.error) Ti.API.error(e.error);
       }
   }
   function analyzeResults(){
       if (accelX &gt; SHAKE_THRESHOLD || accelY &gt; SHAKE_THRESHOLD || accelZ &gt; SHAKE_THRESHOLD) {
           var err = SHAKE_THRESHOLD * 0.5;
           if (accelX &gt; SHAKE_THRESHOLD && (accelY &lt; err && accelZ &lt; err)){
               alert("Quit shaking me back and forth!");
           }
           else if (accelY &gt; SHAKE_THRESHOLD && (accelX &lt; err && accelZ &lt; err)){
               alert("Quit shaking me up and down!");
           }
           else if (accelZ &gt; SHAKE_THRESHOLD && (accelX &lt; err && accelY &lt; err)){
               alert("Why are you shaking me like that?!");
           }
           else {
               alert("Quit shaking me!");
           }        
           accelX = accelY = accelZ = 0;
       }
   }
   $.pitch.show();
   $.roll.show();
   $.yaw.show();
   $.index.open();
   </pre></code>
   
   Thanks!</li>
<li> Ricardo Ramirez 2015-11-19

   The module is working great ! Thank you guys!</li>
<li>Wilson Luu 2016-01-19

   Closing ticket as fixed. Verified that if I use ti.coremotion (2.0.0), the app will not crash when I move around or leave the app idle.
   
   Tested on:
   
   Appc CLI NPM: 4.2.2
   Appc CLI Core: 5.2.0-229
   ti.coremotion: 2.0.0
   SDK: 5.2.0.v20160114021251
   Node: v4.2.4
   OS: El Capitan (10.11.2)
   Xcode: 7.2
   Devices: iphone 6 (9.2)</li>
</ol>


<p><a href="/TIMOB/TIMOB-19889.json">JSON Source</a></p>