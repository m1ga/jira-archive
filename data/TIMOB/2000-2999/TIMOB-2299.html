---
title: "[TIMOB-2299] Some ASI objects leaked"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T01:58:41.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 1.6.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>asihttp, critical, defect, ios, leak, memory, proxy, release-1.6.0</td></tr>
<tr><th>Reporter</th><td>Stephen Tramer</td></tr>
<tr><th>Assignee</th><td>Stephen Tramer</td></tr>
<tr><th>Created</th><td>2011-04-15T03:16:02.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T01:58:41.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>Looks like some ASI objects are not released. Running the
following test in instruments revealed that no ASIFormDataRequest
objects are ever deallocated:</p>
<pre>
<code>var count = 0;
function runXHR(){
    var xhr = Titanium.Network.createHTTPClient();

    xhr.onload = function()
    {
        count++;
        Ti.API.log('available memory:' + Titanium.Platform.availableMemory + ' cnt: ' + count);
    };
    // open the client
    xhr.open('GET','<a href="http://www.developedit.com/test.json" rel="nofollow" target="_blank">http://www.developedit.com/test.json</a>');

    // send the data
    xhr.send();
}

runXHR();

setInterval(function()
{
    runXHR();
},1000);</code>
</pre></div>

<h3>Comments</h3>

<ol>
<li>Jeff Haynie 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/6e72cfc6d42fc819ccb2632b7ea90f777c3c6307"
   title=
   "Changeset [6e72cfc6d42fc819ccb2632b7ea90f777c3c6307]">[6e72cfc6d42fc819ccb2632b7ea90f777c3c6307]</a>)
   [<a href="/projects/32238/tickets/2299" title=
   "Ticket #2299">#2299</a> state:open] Fixes to set appropriate
   values. Resetting bug to open because this actually has to do with
   indefinite proxy retention; see bug for details. <a href=
   "<a href="https://github.com/appcelerator/titanium_mobile/commit/6e72cfc6d42fc819ccb2632b7ea90f777c3c6307" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/6e72cfc6d42fc819ccb2632b7ea90f777c3c6307</a>">
   <a href="https://github.com/appcelerator/titanium_mobile/commit/6e72cfc6d42f..." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/6e72cfc6d42f...</a></a></p></div></li>
<li>Stephen Tramer 2011-04-15

   <div><p>Very bad news; this is an endemic problem throughout Titanium,
   the dreaded "proxy retention issue." This is because we retain
   proxies as part of contexts, and then NEVER release them until the
   context is closed. This is especially bad for HTTP requests, as we
   return response information in the proxy - that means that over
   time huge amounts of cruft may accumulate, even with just a few
   (expensive) HTTP requests.</p>
   <p>Marking this bug <strong>CRITICAL</strong> even though it may
   not be completed before 1.5.0.</p></div></li>
<li>Jeff Haynie 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/93f5ab4b4fb667df89641cf97b7495321ee5b02b"
   title=
   "Changeset [93f5ab4b4fb667df89641cf97b7495321ee5b02b]">[93f5ab4b4fb667df89641cf97b7495321ee5b02b]</a>)
   [<a href="/projects/32238/tickets/2299" title=
   "Ticket #2299">#2299</a>] Minor fix to handle some crashers.
   <a href=
   "<a href="https://github.com/appcelerator/titanium_mobile/commit/93f5ab4b4fb667df89641cf97b7495321ee5b02b" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/93f5ab4b4fb667df89641cf97b7495321ee5b02b</a>">
   <a href="https://github.com/appcelerator/titanium_mobile/commit/93f5ab4b4fb6..." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/93f5ab4b4fb6...</a></a></p></div></li>
<li>Jeff Haynie 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/c499a6e69be9895cce1cf02741b90f679ea34c87"
   title=
   "Changeset [c499a6e69be9895cce1cf02741b90f679ea34c87]">[c499a6e69be9895cce1cf02741b90f679ea34c87]</a>)
   [<a href="/projects/32238/tickets/2299" title=
   "Ticket #2299">#2299</a> state:fixed-in-qa] Closer conformance to
   XHR and plugging of memory leak. <a href=
   "<a href="https://github.com/appcelerator/titanium_mobile/commit/c499a6e69be9895cce1cf02741b90f679ea34c87" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/c499a6e69be9895cce1cf02741b90f679ea34c87</a>">
   <a href="https://github.com/appcelerator/titanium_mobile/commit/c499a6e69be9..." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/c499a6e69be9...</a></a></p></div></li>
<li>Stephen Tramer 2011-04-15

   <div><p>How did that last commit just get discovered? It was made before
   the first one, and... well, who cares. Reopening the bug.</p></div></li>
<li>Stephen Tramer 2011-04-15

   <div><p>Bumping this down the road, with a note. It's two-pronged: Proxy
   retention issues (how we handle memory warnings is not smart right
   now, because it LEADS to memory warnings) and problems in Kroll
   involving certain objects which should be autoreleased (but never
   are, because they're retained at very bad points in their
   lifecycle).</p>
   <p>Unfortunately at this time there's no good way to handle
   clearing out stale client responses, simply because there's no good
   way to tell when they're "stale."</p>
   <p>This bug should be a <strong>high priority target</strong> for a
   1.5.1 release due to its critical nature.</p></div></li>
<li>Damien Elmes 2011-04-15

   <div><p>Sound objects don't get released until they're explicitly
   .release()d - could a similar approach be taken with ASI, at least
   as a stop gap?</p></div></li>
<li>Stephen Tramer 2011-04-15

   <div><p>Possibly. Let me know if doing "this.release()" inside of your
   onload callbacks helps alleviate memory problems. This will not
   release the ASI request, but rather the ASI response (you will have
   to release your XHR objects separately).</p>
   <p>There may be a stopgap measure put in place to handle ASI
   response memory management, but it will not take care of ASI
   request retention.</p></div></li>
<li>Jeff Haynie 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/eb3656b0297a2a28a4b394cd505311415bac7d14"
   title=
   "Changeset [eb3656b0297a2a28a4b394cd505311415bac7d14]">[eb3656b0297a2a28a4b394cd505311415bac7d14]</a>)
   [<a href="/projects/32238/tickets/2299" title=
   "Ticket #2299">#2299</a> state:fixed-in-qa] - Don't retain HTTP
   responses as if they're normal proxies - Cleanup to not use
   'connected' to detect an error vs. success when sending responses;
   was leading to a race condition that would cause reused HTTP
   clients to stall - Fix for bad juju of separate alloc and init
   calls in TiModule <a href=
   "<a href="https://github.com/appcelerator/titanium_mobile/commit/eb3656b0297a2a28a4b394cd505311415bac7d14" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/eb3656b0297a2a28a4b394cd505311415bac7d14</a>">
   <a href="https://github.com/appcelerator/titanium_mobile/commit/eb3656b0297a..." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/eb3656b0297a...</a></a></p></div></li>
<li>Stephen Tramer 2011-04-15

    <div><p>Bug <a href="/projects/32238/tickets/2616" title=
    "Ticket #2616">#2616</a> deals with the memory management issues
    described earlier in this bug ticket.</p>
    <p>Bug <a href="/projects/32238/tickets/2617" title=
    "Ticket #2617">#2617</a> deals with XHR compliance in general.</p></div></li>
<li>Thomas Huelbert 2011-04-15

    <div><p>closing this record while noting the 2 open issues Stephen
    lists.</p></div></li>
<li>Thomas Huelbert 2011-04-15

    <div><p>should actually close it maybe</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-2299.json">JSON Source</a></p>