---
title: "[TIMOB-2392] iOS: Drillbit regression: kroll.js"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Won't Fix</td></tr>
<tr><th>Resolution Date</th><td>2013-11-15T20:53:52.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 3.0.0</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>SupportTeam, core, hard_to_verify, regression</td></tr>
<tr><th>Reporter</th><td>Stephen Tramer</td></tr>
<tr><th>Assignee</th><td>Ingo Muschenetz</td></tr>
<tr><th>Created</th><td>2011-04-15T03:18:29.000+0000</td></tr>
<tr><th>Updated</th><td>2017-03-22T18:16:35.000+0000</td></tr>
</table>

<h3>Description</h3>

Test fails customObjects:53

<code><pre>
view.customObj = {};
view.customObj.test = "hello";
valueOf(view.customObj.test).shouldBe("hello");
</pre></code>

Note that view.customObj = { test:"hello" } passes. Probably has to do with objects being presented as raw NSDictionary, and not translating property accessors as [setValue:forKey:].

<h3>Comments</h3>

<ol>
<li>Stephen Tramer 2011-04-15

   <div><p>Okay - this is super serious, and a massive overhaul. Here's the
   full story:</p>
   <ul>
   <li>TiCore processes some javascript, which indicates that we have
   some kind of concrete value to work with. This is presented as a
   TiValueRef.</li>
   <li>This TiValueRef is passed through to Kroll, which then
   <strong>copies</strong> it into an NSObject of the corresponding
   type, and sets that value on the KrollObject.</li>
   <li>When we request this value from the KrollObject, we get back
   what we expect - the initial (copied) NSObject. But this is then
   translated into a <strong>new</strong> TiValueRef (not any
   corresponding existing one) which is then passed back to TiCore for
   javascript processing. So the object that's being modified is a
   <strong>copy</strong> of the value actually "attached" to the
   object - not the value itself.</li>
   </ul>
   <p>There are two solutions:</p>
   <ul>
   <li>More robust lvalue detection in TiCore (was an Object involved
   at any point in the resolution, and if it was, re-reset the value
   upon completion of assignment)</li>
   <li>Obj-C value wrappers for the TiCore stuff, which would allow us
   something similar to Apple's Toll-Free bridging between CF-&gt;NS
   classes.</li>
   </ul>
   <p>Going to strongly recommend the latter and push this for 1.6.0
   but expect it to become a "future".</p></div></li>
<li>Stephen Tramer 2011-04-15

   <div><p>Going to assign for M05 as part of "massive meeting."</p></div></li>
<li>Stephen Tramer 2011-04-15

   <div><p>Tagging for inclusion in 1.7 since we don't have a milestone
   yet.</p></div></li>
<li>Don Thorp 2011-04-15

   <div><p>removing release- tag as it's for committed code. Using
   tbs-1.7.0 to find items we know need to go in the next release.</p></div></li>
<li>Blain Hamon 2011-06-22

   </li>
<li>Stephen Tramer 2011-07-27

   Going to strongly recommend we schedule this out of 1.8.0 as it is a significant Kroll layer change.</li>
<li>Shawn Lipscomb 2012-01-10

   </li>
<li>Blain Hamon 2012-08-27

   The issue here is that it's a 'rewrite Titanium' issue. The way Titanium on iOS works is that there's a native object (TiProxy) underlying all Titanium JS objects. The data stored in TiProxy are wildly different than JS objects, partially because NSObjects can be threadsafe, and JSCore is explicitly not threadsafe.
   
   In order to make this really happen:
   <h4>Enforce single context running at a time.</h4>
   <h4>Modify the KrollObject behavior so that the JS portion stores away adhoc properties.</h4>
   <h4>Introduce a means to indicate which properties are stored on proxy</h4>
   <h4>Modify all Titanium classes to implement this.</h4>
   <h4>Document which properties still copy-on-read and copy-on-write for safety issues (eg., Ti.UI.TableView's data and sections properties)</h4>
   
   (I'm probably forgetting a lot more about it)</li>
<li>Andrey Verbin 2013-03-20

   Hi, 
   
   I think this bug related to how titanium marshall objects between iOS and JS. AFAIK it just copies them, example below demonstrates that.
   {noformat}
   var array = [1,2]
   var view = Ti.UI.createView()
   view.array = array
   view.array[3] = 3
   console.log(array) //[1,2] expecting [1,2,3]
   console.log(view.array) //[1,2] expecting [1,2,3]
   array[3] = 3
   console.log(array) //[1,2,3] as it should be
   console.log(view.array) //[1,2] expecting [1,2,3]
   {noformat}
   You can also get stack overflow if you assign a complex JS object with cycles to proxy property due to the copying process.</li>
<li>Ingo Muschenetz 2013-11-15

    We're not going to be addressing this particular issue for two reasons:
    
    <h4>Drillbit has been superseded by Anvil</h4>
    <h4>Ti.Next will take a different architecture approach not involving a Kroll layer per se.</h4>
    
    The value in fixing this is outweighed by the amount of effort it would take that is better spent on other areas.</li>
<li>Lee Morris 2017-03-22

    Closing ticket as the issue will not fix and with reference to the above comments. </li>
</ol>


<p><a href="/TIMOB/TIMOB-2392.json">JSON Source</a></p>