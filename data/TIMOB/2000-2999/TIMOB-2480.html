---
title: "[TIMOB-2480] iOS: httpclient assumes XML with reponseText emitting parse error "
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Low</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T01:59:13.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Backlog</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>httpclient, ios, response</td></tr>
<tr><th>Reporter</th><td>David Pratt</td></tr>
<tr><th>Assignee</th><td>Reggie Seagraves</td></tr>
<tr><th>Created</th><td>2011-04-15T03:20:52.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T01:59:13.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>This is a serious problem. Code samples sent to Thomas Huelbert
earlier today to demonstrate. JSON response is being interpreted as
XML despite fact we are obtaining responseText from client and not
responseXML.</p>
<p>"Accept" header in code set to "application/json". With recent
fixes <a href="/projects/32238/tickets/519" title=
"Ticket #519">#519</a> and <a href="/projects/32238/tickets/1502"
title="Ticket #1502">#1502</a>, responseHeaders verifies response
received is application/json.</p>
<p>All JSON responses received with following error</p>
<p>Entity: line 1: parser error : Start tag expected, '&lt;' not
found</p>
<p><a href="/projects/32238/changesets/ERROR" title=
"Changeset [ERROR]">[ERROR]</a> Error Domain=com.google.GDataXML
Code=-1 "The operation couldn&#8217;t be completed.
(com.google.GDataXML error -1.)". in -<a>TiDOMDocumentProxy
parseString:</a></p>
<p>It is possible to parse the response without error checking but
not possible to work around this with proper error handling.</p></div>

<h3>Comments</h3>

<ol>
<li>David Pratt 2011-04-15

   <div><p>Note that most recent tests using Dec 1 2010 18:59 r44a760a9
   nightly</p></div></li>
<li>David Pratt 2011-04-15

   <div><p>According to another developer on Q&amp;A, the last working
   httpclient in 1.5.0 without parsing error has githash of 3ee6a97
   who has another simple use case to demonstrate issue at <a href=
   "<a href="http://developer.appcelerator.com/question/84881/httpclient-broken-for-150--githash1dd0106" rel="nofollow" target="_blank">http://developer.appcelerator.com/question/84881/httpclient-broken-for-150--githash1dd0106</a>">
   <a href="http://developer.appcelerator.com/question/84881/httpclient-broken-..." rel="nofollow" target="_blank">http://developer.appcelerator.com/question/84881/httpclient-broken-...</a></a>.</p></div></li>
<li>David Pratt 2011-04-15

   <div><p>Looks like Steven Tramer is to blame for issue in result proxy.
   There were a few commits Nov 9, 10 after which Jeff Hanie attempted
   a fix of this very issue on Nov 22 so it was recognized at that
   time but fix is apparently not adequate. Jeff's fix was to examine
   Content-Type in header to differentiate however I am able to verify
   that Content-Type in response is application/json.</p>
   <pre>
   <code>    @try {
           value = [delegate valueForKey:key];
           if ([key isEqual:@"responseXML"])
           {
               // check response content-type before trying to parse into XML - gets rid
               // of the silent XML parse error when not XML content
               id ct = [delegate getResponseHeader:[NSArray arrayWithObject:@"Content-Type"]];
               if ([ct rangeOfString:@"xml"].location==NSNotFound)
               {
                   return;
               }
           }
       }</code>
   </pre></div></li>
<li>Thomas Huelbert 2011-04-15

   <div><p>sending for triage</p></div></li>
<li>Blain Hamon 2011-04-15

   <div><p>Odd. That code checks for "responseXML" which MUST be valid XML,
   not 'responseText', which can be any old text. What is the sample
   code for this? To get a proper fix, it'd be necessary to test
   against the actual server, or at very least, the expected result
   from the server as to work with the real data.</p></div></li>
<li>David Pratt 2011-04-15

   <div><p>Blain. Exactly. I have sent Thomas complete sample apps and in
   addition to link for couchDBX that you can use to test. No xml
   there, JSON request and responses only. The code and server tests
   that I spend a good amount of time detailing for you can all be run
   within 15 mins, Please let me know if you would like me to send it
   directly to you. Need your email address to do so.</p></div></li>
<li>David Pratt 2011-04-15

   <div><p>Blain. The info I sent Thomas also contains curl comparisons
   made against the server. This was one of a few issues I brought
   forward concerning httpclient including getResponseHeaders that was
   recently fixed. There are others outstanding including this one,
   which is the most serious that is a show stopper for any web
   services work with JSON. I am using pre Nov 9 httpclient files with
   1.5.0 nightly build in order to continue my own development without
   the issue.</p></div></li>
<li>Tamas Daniel 2011-04-15

   <div><p>I'm the author of the post <a href=
   "<a href="http://developer.appcelerator.com/question/84881/httpclient-broken-for-150--githash1dd0106" rel="nofollow" target="_blank">http://developer.appcelerator.com/question/84881/httpclient-broken-for-150--githash1dd0106</a>">
   <a href="http://developer.appcelerator.com/question/84881/httpclient-broken-..." rel="nofollow" target="_blank">http://developer.appcelerator.com/question/84881/httpclient-broken-...</a></a></p>
   <p>The last commit that suppress the responseXML parse errors still
   gives error in some cases:</p>
   <p>I simply call a link that makes a redirect with a 302, and try
   to get the new location and nothing more (so no parsing for any
   kind of response).</p>
   <p>The headers the server sends seems to be ok to me, but the
   location never gets populated.</p>
   <p>The older commit githash=3ee6a97 works just fine.</p>
   <p>Here are the headers:</p>
   <p>Tamas-Daniels-MacBook-Pro:~ Spawn$ curl -vvv <a href=
   "<a href="http://www.motorsport-total.com/f1/live/htdocs/ticker.php" rel="nofollow" target="_blank">http://www.motorsport-total.com/f1/live/htdocs/ticker.php</a>"><a href="http://www.motorsport-total.com/f1/live/htdocs/ticker.php" rel="nofollow" target="_blank">http://www.motorsport-total.com/f1/live/htdocs/ticker.php</a></a><br>
   <em>About to connect() to <a href=
   "<a href="http://www.motorsport-total.com" rel="nofollow" target="_blank">http://www.motorsport-total.com</a>">www.motorsport-total.com</a> port
   80 (#0)</em> Trying 87.119.204.100... connected * Connected to
   <a href=
   "<a href="http://www.motorsport-total.com" rel="nofollow" target="_blank">http://www.motorsport-total.com</a>">www.motorsport-total.com</a>
   (87.119.204.100) port 80 (#0)</p>
   <blockquote>
   <p>GET /f1/live/htdocs/ticker.php HTTP/1.1 User-Agent: curl/7.19.7
   (universal-apple-darwin10.0) libcurl/7.19.7 OpenSSL/0.9.8l
   zlib/1.2.3 Host: <a href=
   "<a href="http://www.motorsport-total.com" rel="nofollow" target="_blank">http://www.motorsport-total.com</a>">www.motorsport-total.com</a>
   Accept: <em>/</em></p>
   <p>&lt; HTTP/1.1 302 Found<br>
   &lt; Date: Wed, 08 Dec 2010 21:01:02 GMT<br>
   &lt; Server: Apache/2.0.52 (CentOS)<br>
   &lt; Set-Cookie: f1totaluser=q67sgsc5fcouj6vp9j47d1bn80; path=/<br>
   &lt; Expires: Thu, 19 Nov 1981 08:52:00 GMT<br>
   &lt; Cache-Control: no-store, no-cache, must-revalidate,
   post-check=0, pre-check=0<br>
   &lt; Pragma: no-cache<br>
   &lt; Location: <a href=
   "<a href="http://www.motorsport-total.com/f1/live/htdocs/ticker.php?strecken_id=19&amp" rel="nofollow" target="_blank">http://www.motorsport-total.com/f1/live/htdocs/ticker.php?strecken_id=19&amp</a>;event_id=7&amp;kunde=default">
   <a href="http://www.motorsport-total.com/f1/live/htdocs/ticker.php?strecken_..." rel="nofollow" target="_blank">http://www.motorsport-total.com/f1/live/htdocs/ticker.php?strecken_...</a></a><br>
   &lt; Content-Length: 0<br>
   &lt; Connection: close<br>
   &lt; Content-Type: text/html; charset=iso-8859-1<br>
   &lt;<br>
   * Closing connection <a href="/projects/32238/tickets/0" title=
   "Ticket #0">#0</a></p>
   </blockquote></div></li>
<li>Tamas Daniel 2011-04-15

   <div><p>I think I found the issue<br>
   in TiNetworkHTTPClientProxy.m you are releasing to nil the request
   after it finishes.</p>
   <pre>
   <code class="javascript">
   -(void)requestFinished:(ASIHTTPRequest *)request_
   {
       [self _fireReadyStateChange:NetworkClientStateDone];
       if (connected)
       {
           connected = NO;
           [[TiApp app] stopNetwork];
       }
       RELEASE_TO_NIL(request);
   }</code>
   </pre>
   <p>I commented the <strong>RELEASE_TO_NIL(request);</strong> line
   and location is back in place</p></div></li>
<li>David Pratt 2011-04-15

    <div><p>Blain - This issue was repaired two days ago by Steven Tramer
    who fixed his original work that caused the problem. Why has this
    ticket not been updated?</p>
    <p>Noting for others that response codes have recently been changed
    to text from integers.</p>
    <p>I believe this issue ought to have been categorized as a high
    priority. The client is such an important component to the SDK and
    when issues like this arise, it is impossible to carry on
    productive development (as opposed to a UI bug that you can afford
    to work around or wait until fixed).</p></div></li>
<li>Blain Hamon 2011-04-15

    <div><p>Still missing from the ticket is any sample code to fully
    recreate the issue and more importantly, verify any impact beyond a
    false warning that is safely contained within a try/catch
    structure.</p></div></li>
<li>Blain Hamon 2011-04-15

    <div><p>Is there any example JS to better illustrate the impact beyond
    the spurious warning? This may be like the 4.1 issue where there
    was a warning about missing symbols that did not have any actual
    impact on performance.</p></div></li>
<li>David Pratt 2011-04-15

    <div><p>Blain. Comprehensive documentation of the issue including three
    sample apps had been sent to Thomas Huelbert almost two weeks ago.
    He advised he would ensure it would be forwarded to whomever was
    assigned the issue. This is noted in the first paragraph when
    ticket was filed. I spent significant time writing this up. This
    was followed up with detailed information with what was broken,
    when it occurred and who was to blame. Please see Thomas for the
    info which was emailed to him Dec 1.</p>
    <p>Seeing this sort of request for additional information almost
    two weeks afterwards does not illicit good feelings since you are
    late to the party. Steven Tramer modified the code about 4 days
    ago. Issue cannot be duplicated since the issue has since been
    resolved.</p>
    <p>This was a high priority item with a release immanent. Thomas
    received the information but was not responsible for the ticket.
    Steven did the work (possibly with or without the information) and
    almost two weeks later, you want more information after it has been
    fixed with notations in the repository. So far as I am concerned, I
    would have expected Steven to communicate on the ticket. For most
    projects, the repository and tickets system are the primary means
    of developers communication and not stepping on each other's toes.
    I sincerely want to help you folks and possibly contribute bug
    fixes in future however this sort of experience can't help.</p></div></li>
<li>Tamas Daniel 2011-04-15

    <div><p>Blain,<br>
    Here is the issue with the location - build 1.5.1 9819ce0
    13/12/2010</p>
    <pre>
    <code>
    var xhr = Titanium.Network.createHTTPClient();
    
    xhr.onload = function(e){
        Ti.API.info('onload');
        Ti.API.info(xhr.location);
        // Ti.API.info(xhr.responseText);
    };
    
    xhr.onerror = function(e){
        Ti.API.info('onerror');
        // Ti.API.info(xhr.responseText);
    };
    
    xhr.open('GET','<a href="http://www.motorsport-total.com/f1/live/htdocs/ticker.php" rel="nofollow" target="_blank">http://www.motorsport-total.com/f1/live/htdocs/ticker.php</a>');
    xhr.send();</code>
    </pre>
    <p>The result is:<br></p>
    <pre>
    <code>
    [INFO] test/1.0 (1.5.1_9819ce0_13122010.9819ce0)
    [INFO] onload
    [INFO] &lt;null&gt;</code>
    </pre>
    <p>Commenting the</p>
    <pre>
    <code>
    RELEASE_TO_NIL(request);</code>
    </pre>
    <p>line in <strong>TiNetworkHTTPClientProxy.m</strong> in
    <strong>function -(void)requestFinished:(ASIHTTPRequest
    *)request_</strong></p>
    <p>puts the location back in place</p>
    <pre>
    <code>
    [INFO] test/1.0 (1.5.1_9819ce0_13122010.9819ce0)
    [INFO] onload
    [INFO] <a href="http://www.motorsport-total.com/f1/live/htdocs/ticker.php?strecken_id=19&amp" rel="nofollow" target="_blank">http://www.motorsport-total.com/f1/live/htdocs/ticker.php?strecken_id=19&amp</a>;event_id=7&amp;kunde=default</code>
    </pre></div></li>
<li>Blain Hamon 2011-04-15

    <div><p>Tamas, I think the issue with xhr.responseText is something
    else. I've opened it as <a href="/projects/32238/tickets/2573"
    title="Ticket #2573">#2573</a>. As mentioned on the bug, this is an
    known compromise to stop memory issues caused by recursive XHR
    chains, and the workaround is to use 'this'.</p></div></li>
<li>Stephen Tramer 2011-04-15

    <div><p>This bug may be fixed by <a href="/projects/32238/tickets/2450"
    title="Ticket #2450">#2450</a> and <a href=
    "/projects/32238/tickets/2573" title="Ticket #2573">#2573</a>.
    Please test and let us know if this is the case.</p></div></li>
<li>David Pratt 2011-04-15

    <div><p>Have tested from 1.5.1 continuous build and changes appear good.
    There are two additional issues I have identified with iOS
    httpclient but will file under separate tickets. So far as I am
    concerned this ticket should be marked resolved.</p></div></li>
<li>Stephen Tramer 2011-04-15

    <div><p>Going to fixed-in-qa this due to lack of activity and the fact
    that it seems to be a dupe of several bugs.</p></div></li>
<li>Thomas Huelbert 2011-04-15

    <div><p><a href="/projects/32238/changesets/INFO" title=
    "Changeset [INFO]">[INFO]</a> Titanium SDK version: 1.6.0 (01/13/11
    08:11 7ca73a3)</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-2480.json">JSON Source</a></p>