---
title: "[TIMOB-20064] Windows: Convert platform-specific (store or phone only) code to using macros to guard"
---
<table>
<tr><th>Type</th><td>Story</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2015-12-22T17:38:02.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 5.3.0</td></tr>
<tr><th>Components</th><td>Windows</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Christopher Williams</td></tr>
<tr><th>Assignee</th><td>Kota Iguchi</td></tr>
<tr><th>Created</th><td>2015-11-25T18:56:53.000+0000</td></tr>
<tr><th>Updated</th><td>2016-05-12T17:12:55.000+0000</td></tr>
</table>

<h3>Description</h3>

We currently use macros that will effectively compile one block or another depending on whether the code works/is available on phone or desktop.
i.e.
<code><pre>
#if WINAPI_FAMILY != WINAPI_FAMILY_PHONE_APP
</pre></code>

This is the right approach for Windows 8, but in Windows 10 a universal app is generated and the check must be done at runtime. We need to convert these checks into a macro and have the macro defined to do different things for 8.1 versus 10.

See <a href="https://msdn.microsoft.com/en-us/library/windows/apps/mt188202.aspx" rel="nofollow" target="_blank">https://msdn.microsoft.com/en-us/library/windows/apps/mt188202.aspx</a> and <a href="https://msdn.microsoft.com/en-us/library/windows/apps/mt188203.aspx#reviewing_conditional_compilation" rel="nofollow" target="_blank">https://msdn.microsoft.com/en-us/library/windows/apps/mt188203.aspx#reviewing_conditional_compilation</a>

I think we can extract a simple macro like:
<code><pre>
// Only on Win 8.1
#define PHONE_ONLY_START \
#if WINAPI_FAMILY == WINAPI_FAMILY_PHONE_APP

#define PHONE_ONLY_END \
#endif

// Only on Win 10
#define PHONE_ONLY_START \
if (Windows::System::Profile::AnalyticsInfo::VersionInfo::DeviceFamily == "Windows.Mobile") {

#define PHONE_ONLY_END \
}
</pre></code>

We may of course need more variants for things where the API is now available in Win10, but was only available for phone or store on 8.1, etc. (i.e. Clipboard was only for store.desktop in 8.1, but is universal in 10)

<h3>Comments</h3>

<ol>
<li>Kota Iguchi 2015-12-15

   Turns out <code>#define xxx #if (xxx)</code> is not valid as well as <code>#define xxx #endif</code>.
   I would simply do
   
   <code><pre>
   #if (WINVER >= 0x0A00)
   #define IS_WINDOWS_10
   #define WINDOWS_PHONE_START if (Windows::System::Profile::AnalyticsInfo::VersionInfo->DeviceFamily == "Windows.Mobile") {
   #define WINDOWS_PHONE_ELSE } else {
   #define WINDOWS_PHONE_END }
   #elif (WINAPI_FAMILY == WINAPI_FAMILY_PHONE_APP)
   #define IS_WINDOWS_PHONE
   #endif
   </pre></code>
   
   and
   
   <code><pre>
   #ifdef IS_WINDOWS_10
       WINDOWS_PHONE_START
       // Windows 10 Mobile specific code
       WINDOWS_PHONE_ELSE
       // Windows 10 specific code
       WINDOWS_PHONE_END
   #else
   #ifdef IS_WINDOWS_PHONE
       // Windows Phone 8.1 specific code
   #else
       // Windows 8.1 specific code
   #endif
   #endif
   </pre></code></li>
<li>Kota Iguchi 2015-12-21

   <a href="https://github.com/appcelerator/titanium_mobile_windows/pull/512" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile_windows/pull/512</a></li>
<li>Eric Merriman  2016-05-12

   Closing as implemented.</li>
</ol>


<p><a href="/TIMOB/TIMOB-20064.json">JSON Source</a></p>