---
title: "[TIMOB-20094] TCP Socket buffer corrupts data if too large"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>n/a</td></tr>
<tr><th>Status</th><td>Open</td></tr>
<tr><th>Resolution</th><td>Unresolved</td></tr>

<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>TiAPI</td></tr>
<tr><th>Labels</th><td>sockets, tcp, titanium, xmpp</td></tr>
<tr><th>Reporter</th><td>Aggelos Papageorgiou</td></tr>
<tr><th>Assignee</th><td>Unknown</td></tr>
<tr><th>Created</th><td>2015-06-22T22:29:09.000+0000</td></tr>
<tr><th>Updated</th><td>2018-02-28T19:55:24.000+0000</td></tr>
</table>

<h3>Description</h3>

I have duplicated an XMPP communication system using the TCP Sockets Module on Titanium Studio and for the most part it is working like a dream. The part where it does not work correctly is if I receive a message that is too big and the heap needs to grow in order to accommodate it in memory. It is then that many parts of the message are lost, thus making the message unreadable from the XML parser. I am placing the code that receives the buffer data below:


<code><pre>
JXMPPConnection.prototype._pumpCallback = function(e) {
	//that.oDbg.log("pumpCallback ...", 1);

	 if (e.bytesProcessed ==-1) {// EOF 
		Ti.API.error("&lt;EOF&gt; - Can't perform any more operations on connected socket");
	} else if (e.errorDescription == null || e.errorDescription == "") {
		Ti.API.debug("DATA&gt;&gt;&gt;: " + e.buffer.toString());
		var data = e.buffer.toString();
		repeatInterval=false;
		//var i=0;
		e.buffer.clear();
		//while(i&lt;data.length){
			if(data.indexOf('&lt;')&lt;0 || data.length&lt;10)
			return;
			data=data.replace(/&amp;/g,'&').replace(/&lt;/g,'&lt;').replace(/&gt;/g,'&gt;').replace(/&nbsp;/g,' ').replace(/&g/g,'&gt;').replace(/&gt;/g,'&gt;');
			// if(data.charAt(0)!='&lt;'){
				// data=data.substr(1);
				// }else{break;}
			// i++;
		// }
		if(data.indexOf("ping")&gt;=0){
			that._doAutoPing(Ti.XML.parseString(data));
			that.registerHandler('autoPing',that._doAutoPingResult);
			return;
		}
		//fix xml finish and prefix
		var response = data.replace(/\&lt;\?xml.+\?\&gt;/, "");
		if(response.indexOf("&lt;/stream:stream&gt;")==0) {
			Ti.API.error("end connection XML: " + response);
			that._req.close();
			return;
		}
		if (that.autenticated()) {
			var xmls = that._getSplitXml(response);
			for ( i = 0; i &lt; xmls.length; i++) {
				var xml = xmls[i];
				xml=that._fixXmlToParse(xml);
				Ti.API.info('length: '+xmls.length+xml);
				if(xml.indexOf('&lt;message')&gt;=0 && xml.indexOf('&lt;/message&gt;')&lt;0){buffer.push(xml);break;}
				if(buffer.length&gt;=1 && (xml.indexOf('&lt;message')&lt;0 && xml.indexOf('&lt;/message&gt;')&lt;0)){buffer.push(xml);break;}
				 if(xml.indexOf('&lt;message')&lt;0 && xml.indexOf('&lt;/message&gt;')&gt;0){xml=buffer.toString()+xml;buffer=new Array();}
				if(buffer.length&gt;0 && xmls.length&gt;1){
					for(i;i&lt;xmls.length;i++){
						xml+=xmls[i];
						if(xml.indexOf('&lt;/message')&gt;0){buffer=new Array();break;}
					}
				}
				Ti.API.info("_handleResponse: " +xml);
				that._handleResponse(xml);
			}
		} else {
			response=that._fixXmlToParse(response);
			that._getStreamID(response);
		}

	} else {
		Ti.API.error("READ ERROR: " + e.errorDescription);
		that.disconnect();
	}
};
</pre></code>

this code works like magic for most of my messages but when I request the history of a user of my xmpp service, which is quite a big message, the message gets corrupt.

example of the reply of the server with the corrupt part included


<code><pre>
&lt;message id=“xxxxxx|1435011247" to=“xxxxxx@domain.com" from="triphistory@domain.com/res“&gt;&lt;body&gt;&lt;TripHistory&gt;
&lt;Trips&gt;
&lt;total&gt;10&lt;/total&gt;
&lt;Trip&gt;
&lt;id&gt;xxxxxxxx&lt;/id&gt;
&lt;hailtime&gt;1434576550000&lt;/hailtime&gt;
&lt;pickuptime&gt;1434576725000&lt;/pickuptime&gt;
&lt;from&gt;&lt;![CDATA[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]]&gt;&lt;/from&gt;
&lt;to&gt;&lt;![CDATA[]]&gt;&lt;/to&gt;
&lt;special&gt;&lt;![CDATA[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]]&gt;&lt;/special&gt;
&lt;agent&gt;s&lt;/agent&gt;
&lt;status&gt;com&lt;/status&gt;
&lt;rating&gt;0&lt;/rating&gt;
&lt;plateno&gt;xxxxxxxx&lt;/plateno&gt;
&lt;carmodel&gt;xxxxxxxx&lt;/carmodel&gt;
&lt;drivername&gt;xx&lt;/drivername&gt;
&lt;driversurname&gt;xx&lt;/driversurname&gt;
&lt;drivercode&gt;xxxxxx&lt;/drivercode&gt;
&lt;driverid&gt;xxxx&lt;/driverid&gt;
&lt;isfaved&gt;false&lt;/isfaved&gt;
&lt;isblocked&gt;false&lt;/isblocked&gt;
&lt;tripfare&gt;0.000000&lt;/tripfare&gt;
&lt;tripcurr&gt;&lt;/tripcurr&gt;
&lt;tripchannel&gt;&lt;/tripchannel&gt;
&lt;companyemail&gt;aggelos@domain.gr&lt;/companyemail&gt;
&lt;companyfacebook&gt;domain&lt;/companyfacebook&gt;
&lt;companytwitter&gt;domain&lt;/companytwitter&gt;
&lt;/Trip&gt;&lt;Trip&gt;
&lt;id&gt;xxxxxxx&lt;/id&gt;
</pre></code>
{color:red}<hailtime>xxxxxSome String]]></special>{color}
<code><pre>
&lt;agent&gt;s&lt;/agent&gt;
&lt;status&gt;com&lt;/status&gt;
&lt;rating&gt;0&lt;/rating&gt;
&lt;plateno&gt;xxxxxx&lt;/plateno&gt;
&lt;carmodel&gt;xxxxxxxxx&lt;/carmodel&gt;
&lt;drivername&gt;xxxx&lt;/drivername&gt;
&lt;driversurname&gt;xxxxx&lt;/driversurname&gt;
&lt;drivercode&gt;xxxxxx&lt;/drivercode&gt;
&lt;driverid&gt;xxxx&lt;/driverid&gt;
&lt;isfaved&gt;false&lt;/isfaved&gt;
&lt;isblocked&gt;false&lt;/isblocked&gt;
&lt;tripfare&gt;0.000000&lt;/tripfare&gt;
&lt;tripcurr&gt;&lt;/tripcurr&gt;
&lt;tripchannel&gt;&lt;/tripchannel&gt;
&lt;companyemail&gt;aggelos@domain.gr&lt;/companyemail&gt;
&lt;companyfacebook&gt;domain&lt;/companyfacebook&gt;
&lt;companytwitter&gt;domain&lt;/companytwitter&gt;
&lt;/Trip&gt;&lt;Trip&gt;
&lt;id&gt;xxxxxxxx&lt;/id&gt;
&lt;hailtime&gt;1434576550000&lt;/hailtime&gt;
&lt;pickuptime&gt;1434576725000&lt;/pickuptime&gt;
&lt;from&gt;&lt;![CDATA[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]]&gt;&lt;/from&gt;
&lt;to&gt;&lt;![CDATA[]]&gt;&lt;/to&gt;
&lt;special&gt;&lt;![CDATA[xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx]]&gt;&lt;/special&gt;
&lt;agent&gt;s&lt;/agent&gt;
&lt;status&gt;com&lt;/status&gt;
&lt;rating&gt;0&lt;/rating&gt;
&lt;plateno&gt;xxxxxxxx&lt;/plateno&gt;
&lt;carmodel&gt;xxxxxxxx&lt;/carmodel&gt;
&lt;drivername&gt;xx&lt;/drivername&gt;
&lt;driversurname&gt;xx&lt;/driversurname&gt;
&lt;drivercode&gt;xxxxxx&lt;/drivercode&gt;
&lt;driverid&gt;xxxx&lt;/driverid&gt;
&lt;isfaved&gt;false&lt;/isfaved&gt;
&lt;isblocked&gt;false&lt;/isblocked&gt;
&lt;tripfare&gt;0.000000&lt;/tripfare&gt;
&lt;tripcurr&gt;&lt;/tripcurr&gt;
&lt;tripchannel&gt;&lt;/tripchannel&gt;
&lt;companyemail&gt;aggelos@domain.gr&lt;/companyemail&gt;
&lt;companyfacebook&gt;domain&lt;/companyfacebook&gt;
&lt;companytwitter&gt;domain&lt;/companytwitter&gt;
&lt;/Trip&gt;&lt;/Trips&gt;
&lt;/TripHistory&gt;&lt;/body&gt;&lt;/message&gt;
</pre></code>

I have highlighted the corrupt part of the message in red. Is this behavior to be expected? If it is how can I alleviate it? I need to have my messages correctly reported back to me from the socket no matter what the computational cost that may bring. 


I am attaching below the code used to setup the tcp socket:


<code><pre>
try {
			this._req = Ti.Network.Socket.createTCP({
				host : this.host,
				port : this.port,
				connected : function(e) {
					//send initial request

					var reqstr = that._getInitialRequestString();
					Ti.API.debug(reqstr);

					e.socket.write(Ti.createBuffer({
						type:Titanium.Codec.CHARSET_UTF8,
						value : reqstr
					}));
					Ti.Stream.pump(e.socket, that._pumpCallback, 1000000, true);

				},
				error : function(e) {
					Ti.API.error('Socket error');
					that._connected=false;
					that.disconnect();
				},
				closed : function(e) {
					Ti.API.error('Socket close');
					that._connected=false;
				},
			});
			this._req.connect();
		} catch (e) {
			Ti.API.error('Error creating socket');
			that._connected=false;
			that.disconnect();
		}
</pre></code>

<h3>Comments</h3>

<ol>
<li>Aggelos Papageorgiou 2015-07-01

   Please look into this issue I am on a really tight schedule and this bug is a really BIG showstopper. Please ask for any further information required to resolve this bug. thank you</li>
<li>Chee Kiat Ng 2015-12-04

   Have you tried with the latest environment we have? And is this specific to android or ios?</li>
<li>Aggelos Papageorgiou 2015-12-04

   I have tried up to the 5.1.0.GA SDK and it has not remedied it self neither on iOS nor on Android!</li>
</ol>


<p><a href="/TIMOB/TIMOB-20094.json">JSON Source</a></p>