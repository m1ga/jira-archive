---
title: "[TIMOB-20206] Android : TiCompositeLayout's viewSorter does not abide by Comparator's contract"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2016-09-06T06:00:49.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.0.2</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Narayan K</td></tr>
<tr><th>Assignee</th><td>Ashraf Abu</td></tr>
<tr><th>Created</th><td>2016-01-05T17:56:04.000+0000</td></tr>
<tr><th>Updated</th><td>2017-01-31T18:30:59.000+0000</td></tr>
</table>

<h3>Description</h3>

I'm writing in from the Android team. The "N" release of Android is moving over to using OpenJdk as its implementation for java.* libraries. One of the issues that came up in our testing a crash that looks like this : 

java.lang.IllegalStateException: Ambiguous Z-Order
  at org.appcelerator.titanium.view.TiCompositeLayout$1.compare(TiCompositeLayout.java:164)
  at org.appcelerator.titanium.view.TiCompositeLayout$1.compare(TiCompositeLayout.java:127)
  at java.util.TreeMap.compare(TreeMap.java:1190)
  at java.util.TreeMap.put(TreeMap.java:532)
  at java.util.TreeSet.add(TreeSet.java:255)
  at org.appcelerator.titanium.view.TiCompositeLayout.onLayout(TiCompositeLayout.java:491)
  at android.view.View.layout(View.java:16945)
  at android.view.ViewGroup.layout(ViewGroup.java:5516)

The issue here is their Comparator expects that its arguments are never equal (i.e, none of its code paths return 0). That seems pretty brittle and contrary to the documented contract.

It fails on OpenJdk because of this snippet of code in TreeMap#put :

        TreeMapEntry<K,V> t = root;
        if (t == null) {
            compare(key, key); // type (and possibly null) check  <--- [BUG HERE] we're deliberately comparing a view with itself for the side effects : null & type check
        .....

I will put in a workaround for the upcoming release, but It will be reverted in a future Android release.


<h3>Comments</h3>

<ol>
<li>Ashraf Abu 2016-01-07

   [~kamath.narayan@gmail.com] Thanks for the ticket!
   
   Is this something that only occurs with "N" (with the OpenJDK implementation)?</li>
<li>Brian Carlstrom 2016-01-07

   Yes, this is new with the OpenJDK TreeMap implementation in N</li>
<li>Narayan K 2016-03-23

   Hello all - have you had any luck fixing this issue ? The Android N preview is now public and contains a platform workaround. We would like to remove the workaround at some point, which would leave apps that use this class broken.</li>
<li>Ashraf Abu 2016-03-28

   [~kamath.narayan@gmail.com] Thanks for the ping. We will be working on this and testing it on N. :)</li>
<li>Narayan K 2016-08-18

   In the change cited here [1], we have reverted the workaround I mentioned in my earlier comment.
   
   All applications using TiCompositeLayout will break in a future android release unless this bug is fixed.
   
   [1] <a href="https://android-review.googlesource.com/#/c/257511/1" rel="nofollow" target="_blank">https://android-review.googlesource.com/#/c/257511/1</a> </li>
<li>Ashraf Abu 2016-08-19

   [~kamath.narayan@gmail.com] Thanks for the update! So basically beyond N will break this?</li>
<li>Ashraf Abu 2016-08-19

   To refer to <a href="https://android-review.googlesource.com/#/c/257511/1/ojluni/src/main/java/java/util/TreeMap.java" rel="nofollow" target="_blank">https://android-review.googlesource.com/#/c/257511/1/ojluni/src/main/java/java/util/TreeMap.java</a></li>
<li>Narayan K 2016-08-19

   hi - yes, that's right.</li>
<li>Ashraf Abu 2016-08-19

   Thanks for replying! Appreciate it a whole lot.</li>
<li>Ashraf Abu 2016-08-30

    For ref: <a href="http://grepcode.com/file_/repository.grepcode.com/java/root/jdk/openjdk/6-b14/java/util/Comparator.java/?v=source" rel="nofollow" target="_blank">http://grepcode.com/file_/repository.grepcode.com/java/root/jdk/openjdk/6-b14/java/util/Comparator.java/?v=source</a>
    
    <code><pre>
        /**
         * Compares its two arguments for order.  Returns a negative integer,
         * zero, or a positive integer as the first argument is less than, equal
         * to, or greater than the second.&lt;p&gt;
         *
         * In the foregoing description, the notation
         * &lt;tt&gt;sgn(&lt;/tt&gt;&lt;i&gt;expression&lt;/i&gt;&lt;tt&gt;)&lt;/tt&gt; designates the mathematical
         * &lt;i&gt;signum&lt;/i&gt; function, which is defined to return one of &lt;tt&gt;-1&lt;/tt&gt;,
         * &lt;tt&gt;0&lt;/tt&gt;, or &lt;tt&gt;1&lt;/tt&gt; according to whether the value of
         * &lt;i&gt;expression&lt;/i&gt; is negative, zero or positive.&lt;p&gt;
         *
         * The implementor must ensure that &lt;tt&gt;sgn(compare(x, y)) ==
         * -sgn(compare(y, x))&lt;/tt&gt; for all &lt;tt&gt;x&lt;/tt&gt; and &lt;tt&gt;y&lt;/tt&gt;.  (This
         * implies that &lt;tt&gt;compare(x, y)&lt;/tt&gt; must throw an exception if and only
         * if &lt;tt&gt;compare(y, x)&lt;/tt&gt; throws an exception.)&lt;p&gt;
         *
         * The implementor must also ensure that the relation is transitive:
         * &lt;tt&gt;((compare(x, y)&gt;0) &amp;&amp; (compare(y, z)&gt;0))&lt;/tt&gt; implies
         * &lt;tt&gt;compare(x, z)&gt;0&lt;/tt&gt;.&lt;p&gt;
         *
         * Finally, the implementor must ensure that &lt;tt&gt;compare(x, y)==0&lt;/tt&gt;
         * implies that &lt;tt&gt;sgn(compare(x, z))==sgn(compare(y, z))&lt;/tt&gt; for all
         * &lt;tt&gt;z&lt;/tt&gt;.&lt;p&gt;
         *
         * It is generally the case, but &lt;i&gt;not&lt;/i&gt; strictly required that
         * &lt;tt&gt;(compare(x, y)==0) == (x.equals(y))&lt;/tt&gt;.  Generally speaking,
         * any comparator that violates this condition should clearly indicate
         * this fact.  The recommended language is "Note: this comparator
         * imposes orderings that are inconsistent with equals."
         *
         * @param o1 the first object to be compared.
         * @param o2 the second object to be compared.
         * @return a negative integer, zero, or a positive integer as the
         *         first argument is less than, equal to, or greater than the
         *         second.
         * @throws ClassCastException if the arguments' types prevent them from
         *         being compared by this comparator.
         */
        int compare(T o1, T o2);
    </pre></code></li>
<li>Ashraf Abu 2016-08-30

    PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/8287" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8287</a>
    [~cwilliams] for your review.</li>
<li>Narayan K 2017-01-06

    </li>
<li>Gary Mathews 2017-01-26

    6_0_X: <a href="https://github.com/appcelerator/titanium_mobile/pull/8793" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8793</a></li>
<li>Andy Waldman 2017-01-31

    Test Tuesday 31st January 2017
    ENV:
    Thursday 26th January 2017:
    ENV: 
    MacOS:10.12.1 
    XCODE: 8.2.1 GM (golden master) 
    APPC CLI Core: 6.1.0 
    APPC CLI NPM: 4.2.8 
    SDK: 6.0.2.v20170130045621
    Studio build: 4.8.1.201612050850 
    NPM: 2.15.9 
    Node: 4.5.0 
    Device: Google Pixel
    Android Version: 7.1
    
    Step 1) Create a new classic app in studio
    Step 2) Run the classic app with the latest 6.0.2 build on a android phone with 7.0 or greater
    Step 3) Verify that the app does not crash 
    
    After completing the steps above i can verify that the fix is ok</li>
<li>Andy Waldman 2017-01-31

    In Addition to the above here is the app.js code i tested to verify this ticket
    
    <code><pre>
    var win = Ti.UI.createWindow({backgroundColor: 'gray'}),
        view = Ti.UI.createView({backgroundColor: 'red', width: '66%', height: '66%'});
    
    win.add(view);
    win.add(view);
    
    win.open();
    </pre></code>
    </li>
</ol>


<p><a href="/TIMOB/TIMOB-20206.json">JSON Source</a></p>