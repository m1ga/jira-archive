---
title: "[TIMOB-20217] iOS: Ti.Geolocation.hasGeolocationPermission()  and Ti.Geolocation.getCurrentPosition() are not working on IOS 7"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2016-02-02T08:52:52.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 5.1.1</td></tr>
<tr><th>Fix Version/s</th><td>Release 5.2.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>qe-5.2.0</td></tr>
<tr><th>Reporter</th><td> Ricardo Ramirez</td></tr>
<tr><th>Assignee</th><td>Srikanth Sombhatla</td></tr>
<tr><th>Created</th><td>2016-01-09T01:36:09.000+0000</td></tr>
<tr><th>Updated</th><td>2016-02-02T22:20:40.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Issue Description </h4>
Geolocation popup permission is not triggered by Ti.Geolocation.hasGeolocatinPermission()
Ti.Geolocation.hasGeolocatinPermission() does not work on iOS 7. It returns true before permission has been determined. Once it is determined it does not return the right value.
Ti.Geolocation.requestLocationPermissions() never calls the callback on iOS 7.

<h4>TestCase</h4>
<h4>Create a new Alloy default Application</h4>
<h4>Open views/index.xml</h4>
<h4>Replace the inside with the next code:</h4>
<code><pre>
&lt;Alloy&gt;
	&lt;Window class="container" id="win"&gt;
		&lt;View&gt;
			&lt;View class="container2"&gt;
				&lt;Button class="btn" title="Check Permission" onClick="checkPermission" /&gt;
				&lt;Button class="btn" title="Request Permission" onClick="requestPermission" /&gt;
				&lt;Button class="btn" title="Check & Request Permission" onClick="checkRequestPermission" /&gt;
				&lt;Button class="btn" title="Get Current Position" onClick="getCurrentPosition" /&gt;
			&lt;/View&gt;
		&lt;/View&gt;
	&lt;/Window&gt;
&lt;/Alloy&gt;
</pre></code>
<h4>Open controllers/index.js</h4>
<h4>Replace the inside with the next code:</h4>
<code><pre>
$.win.open();

function checkPermission(){
	if(Ti.Geolocation.hasLocationPermissions(Ti.Geolocation.AUTHORIZATION_WHEN_IN_USE)){
		Ti.API.info("APP HAS PERMISSION");	
	}else{
		Ti.API.info("APP DOES NOT HAVE PERMISSION");
		requestPermission();
	}
}

function requestPermission(){
	Ti.API.info("REQUESTING PERMISSION");
	Ti.Geolocation.requestLocationPermissions(Titanium.Geolocation.AUTHORIZATION_WHEN_IN_USE,function(e){
		Ti.API.info("INSIDE CALLBACK");
		if(e.success){
			Ti.API.info("PERMISSION GRANTED");
		}else{
			Ti.API.info("PERMISSION DENIED");
		}
	});
}

function checkRequestPermission(){
	checkPermission(requestPermission);
}

function getCurrentPosition(successHandler,errorHandler){
	Ti.Geolocation.getCurrentPosition(function(result){
		if (result.error) {
			Ti.API.info("GetCurrentPosition Error");
		}else{
			Ti.API.info("GetCurrentPosition returned" + JSON.stringify(result));
		}
	});
}
</pre></code>
#open the tiapp.xml file and add the next lines inside ios/plist/dict
<code><pre>
                &lt;key&gt;NSLocationWhenInUseUsageDescription&lt;/key&gt;
                &lt;string&gt;Testing Location in use &lt;/string&gt;
</pre></code>
<h4>Run</h4>

<h4>Steps to Reproduce</h4>

<h4>Press "Check Location Permission" button which calls Ti.Geolocation.hasLocationPermissions(). It should return true and you should see "APP HAS PERMISSION" output. </h4>
<h4>Press "Request Geolocation Permission" which calls Ti.Geolocation.requestLocationPermissions() You should see "REQUESTING PERMISSION" in your output.</h4>
<h4>Third button calls Ti.Geolocation.getCurrentPosition() to get users current position which is what triggers geolocation permission popup to show. If you grant permission in the popup then press "Check Location Permission" button again and you should see "APP DOES NOT HAVE PERMISSION" followed by "REQUESTING PERMISSION". This also happens if you refuse permission. </h4>

<h3>Comments</h3>

<ol>
<li>Srikanth Sombhatla 2016-01-11

   </li>
<li> Ricardo Ramirez 2016-01-15

   This is not working using iOS 7</li>
<li>Chee Kiat Ng 2016-01-15

   </li>
<li>Srikanth Sombhatla 2016-01-15

   [~cng] This has nothing to do with TIMOB-20165. 
   
   [~rramirez] [~egomez] 
   In iOS7 User cannot request permission explicitly (like in iOS 8). System automatically presents location permission alert when we try to call <code>Ti.Geolocation.getCurrentPosition()</code> or geofencing. This should be updated in our docs. 
   
   Secondly <code>hasLocationPermissions</code> has a regression issue which is caused because it always operates in iOS 8 mode. This should be fixed. </li>
<li>Srikanth Sombhatla 2016-01-19

   PR <a href="https://github.com/appcelerator/titanium_mobile/pull/7639" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/7639</a>
   
   Changes for iOS 7:
   1. Console warning when using <code>Ti.Geolocation.requestLocationPermissions</code>
   2. Correctly returns value of <code>Ti.Geolocation.hasLocationPermissions</code>
   3. Updated docs accordingly. 
   
   Alternatively can use the following app.js for testing
   
   <code><pre>
   // this sets the background color of the master UIView (when there are no windows/tab groups on it)
   Titanium.UI.setBackgroundColor('#000');
   
   // create base UI tab and root window
   //
   var win = Titanium.UI.createWindow({className:'win1'});
   
   var reqPerm = Titanium.UI.createButton({title: "Request Permission", top: 50});
   reqPerm.addEventListener('click', function(e) {
     checkPermission();
     requestPermission();
   });
   
   var reqLoc = Titanium.UI.createButton({title: "Request Location", top: 150});
   reqLoc.addEventListener('click', function(e) {
     checkPermission();
     getCurrentPosition();
   });
   
   win.add(reqPerm);
   win.add(reqLoc);
   
   function checkPermission(){
     if(Ti.Geolocation.hasLocationPermissions(Ti.Geolocation.AUTHORIZATION_WHEN_IN_USE)){
       Ti.API.info("APP HAS PERMISSION");  
     }else{
       Ti.API.info("APP DOES NOT HAVE PERMISSION");
     }
   }
    
   function requestPermission(){
     Ti.API.info("REQUESTING PERMISSION");
     Ti.Geolocation.requestLocationPermissions(Titanium.Geolocation.AUTHORIZATION_WHEN_IN_USE,function(e){
       Ti.API.info("INSIDE CALLBACK");
       if(e.success){
         Ti.API.info("PERMISSION GRANTED");
       }else{
         Ti.API.info("PERMISSION DENIED");
       }
     });
   }
    
   function checkRequestPermission(){
     checkPermission(requestPermission);
   }
    
   function getCurrentPosition(successHandler,errorHandler){
     Ti.API.info("REQUESTING LOCATION");
     Ti.Geolocation.getCurrentPosition(function(result){
       if (result.error) {
         Ti.API.info("GetCurrentPosition Error");
       }else{
         Ti.API.info("-GetCurrentPosition returned" + JSON.stringify(result));
       }
     });
   }
   
   win.open();
   </pre></code></li>
<li>Nikita Radaev 2016-01-22

   I disagree that this is the right fix guys. The whole point of using Appcelerator is to abstract away all (or most ) platform-specific conditionals. Besides, same functionality is backwards compatible on Android. I dont understand why it is not possible to do same thing on IOS. SDK should be taking care of addressing this issue and not the users.</li>
<li>Collin Price 2016-01-22

   So instead of making the function backwards compatible, like it is on Android, my code has to check if the user is running iOS and is on iOS 7? I thought the major advantage of using Titanium is that I don't have to think about what platform/OS version the user is running.
   
   @ssombhatla Sure iOS 7 doesn't request location permission the same as iOS 8+ but why can't the requestLocationPermissions method do whatever it needs to do to prompt the user on iOS 7?</li>
<li>Srikanth Sombhatla 2016-01-26

   [~CollinPrice], [~nradaev] point taken. </li>
<li>Srikanth Sombhatla 2016-01-26

   Reopening to address community comments. </li>
<li>Srikanth Sombhatla 2016-01-26

    PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/7642" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/7642</a>
    Use the same app.js for testing. 
    
    Reworked to make requestLocationPermissions in iOS7 to behave like iOS8+, where permission alert is presented and continued based on User selection.</li>
<li>Angel Petkov 2016-01-26

    FT and CR approved, thanks Srikanth!</li>
<li>Nikita Radaev 2016-01-28

    Srikanth Sombhatla, yes the issue with Ti.Geolocation.hasLocationPermissions is fixed and it now works as promised, however Ti.Geolocation.requestLocationPermissions() still does not work properly on IOS 7. There is simply no callback being thrown after user GRANTS or DENIES permission untill the app is reloaded. Here is a code snippet to recreate the issue:if(!Ti.Geolocation.hasLocationPermissions(Ti.Geolocation.AUTHORIZATION_WHEN_IN_USE)){
    	
    	Ti.Geolocation.requestLocationPermissions(Ti.Geolocation.AUTHORIZATION_WHEN_IN_USE, function(resp){
    	
    		Ti.API.info("Callback returned = " + JSON.stringify(resp));
    		
    		if(resp.success){
    			Ti.API.info("Geolocation permission GRANTED");
    		}else{
    			Ti.API.info("Permision denied");			
    		}
    		
    	});
    }else{
    	Ti.API.info("This device has geolocation permissions");
    } </li>
<li>Srikanth Sombhatla 2016-01-31

    PR <a href="https://github.com/appcelerator/titanium_mobile/pull/7656" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/7656</a>
    
    This requires that creation of location delegate and subsequent permission alert are presented on main thread. This is because by default JS runs on its own thread enabled by TI_USE_KROLL_THREAD.</li>
<li>Srikanth Sombhatla 2016-02-02

    5_2_X PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/7667" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/7667</a></li>
<li>Hans Knöchel 2016-02-02

    Approved, thanks!</li>
<li>Harry Bryant 2016-02-02

    Verified as fixed, using an iOS7 device <code>Ti.Geolocation.requestLocationPermissions</code> & <code>Ti.Geolocation.hasLocationPermissions</code> now returns correct value, & <code>Ti.Geolocation.getCurrentPosition()</code> now correctly returns the correct position.
    
    Tested on:
    iPhone 4S (7.1.2) & iPhone 6S (9.2) Devices
    Mac OSX El Capitan 10.11 (15A284)
    Appc Studio: 4.5.0.201601262138
    Ti SDK: 5.2.0.v20160202103508
    Appc NPM: 4.2.3-1
    App CLI: 5.2.0-239
    Xcode 7.2
    Node v4.2.3
    
    *Closing Ticket.*
    </li>
</ol>


<p><a href="/TIMOB/TIMOB-20217.json">JSON Source</a></p>