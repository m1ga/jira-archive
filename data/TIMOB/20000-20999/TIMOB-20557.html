---
title: "[TIMOB-20557] iOS: Allow modules to use third party dynamic libraries"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>New Feature</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-08-30T19:15:18.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.2.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Pedro Enrique</td></tr>
<tr><th>Assignee</th><td>Jan Vennemann</td></tr>
<tr><th>Created</th><td>2016-03-11T16:51:34.000+0000</td></tr>
<tr><th>Updated</th><td>2017-09-07T14:07:14.000+0000</td></tr>
</table>

<h3>Description</h3>

Traditionally, any library built for iOS was always a static library. This changed with Swift, and any library build with Swift is now a dynamic library instead. These dynamic libraries are just a binary, but they come in the a *.framework package.
We currently do not support dynamic frameworks Titanium.

There are a couple of things that need to happen for us to support these types of frameworks:

<h4>*Edit your module.xcconfig to look like this*</h4>
<code><pre>
FRAMEWORK_SEARCH_PATHS="$(SRCROOT)/../../modules/iphone/{mod.id}/{mod.ver}/platform" "/Library/Application\ Support/Titanium/modules/iphone/{mod.id}/{mod.ver}/platform" "~/Library/Application\ Support/Titanium/modules/iphone/{mod.id}/{mod.ver}/platform"
LD_RUNPATH_SEARCH_PATHS= $(inherited) "@executable_path/Frameworks" $(FRAMEWORK_SEARCH_PATHS)
</pre></code>
Note: The new <code>LD_RUNPATH_SEARCH_PATHS</code> allows the app to find the framework. And this is the most important step for running the app on simulator.
<h4>*Add a temporary plugin and eventually modify the CLI*</h4>
I have attached a Titanium plugin to this ticket. To use, place it in the plugins folder at the root of your project. The only change needed is line 46 of the <code>plugins/ti.dynamiclib/hooks/ti.dynamiclib.js</code>
Note: This plugin is a workaround for the moment. Eventually, we'll need to copy the framework to the device and _sign_ it. This is something that needs to happen in the CLI.
<h4>*Modify your tiapp.xml*</h4>
And the very last thing, this is possible only with iOS 8 and greater. So make sure you have this in your <code>tiapp.xml</code>
<code><pre>
&lt;ios&gt;
  &lt;min-ios-ver&gt;8.0&lt;/min-ios-ver&gt;
  &lt;!-- more stuff --&gt;
&lt;/ios&gt;
</pre></code>

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-20557_58589/ti.dynamiclib.zip">ti.dynamiclib.zip</td></td><td>2016-03-11T16:51:32.000+0000</td><td>2318</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Jeroen van Dijk 2016-04-05

   I can confirm that this solution works!</li>
<li>Timan Rebel 2016-05-18

   The script works! But to upload the app to iTunes Connect we'd need to strip the unwanted i386 and x64 archs from the dynamic library. We could do that by building the app via the cli, open Xcode, add the needed Build Pahse shell script and build from Xcode, but I'm curious if we could do it via the plugin or Appcelerator CLI. I have tried a couple of things but could not get it to work (yet)</li>
<li>Jeroen van Dijk 2016-05-18

   [~timanrebel]: have a look here <a href="https://developer.pathsense.com/node/6" rel="nofollow" target="_blank">https://developer.pathsense.com/node/6</a>, this framework suffers from the same issue and might help you resolve the issue.</li>
<li>Timan Rebel 2016-05-19

   @jvandijk that is exactly how I solve it at the moment, but am looking for a solution via the CLI or a plugin</li>
<li>Jeroen van Dijk 2016-05-19

   [~timanrebel] We've just packaged both frameworks for the simulator & the one for the app store in the external dependency. After this we updated this dynamic lib to switch based on the active <code>cli.argv["target"]</code></li>
<li>Timan Rebel 2016-05-20

   Could you share your code and how you did that here?</li>
<li>Jeroen van Dijk 2016-06-09

   [~timanrebel] sorry for the late reply. But here is how we do it.
   
   In the addLibrary method:
   ---
   {{
   var module = {
   	version: 0
   };
   
   cli.tiapp.modules.forEach(function(item) {
   	if (item.id === "<your module>" && item.platform[0] === "iphone") {
   		module = item;
   	}
   });
   
   var frameworkPaths = [
   	'../../modules/iphone/<your module>/' + module.version + '/platform/<module needed>.framework'
   ];
   
   require('wrench').rmdirSyncRecursive("modules/iphone/<your module>/" + module.version + "/platform/<module needed>.framework", true);
   
   if (cli.argv["$platform"] === "iphone" && cli.argv["target"] === "dist-adhoc") {
   	require('wrench').copyDirSyncRecursive("modules/iphone/<your module>/" + module.version + "/platform/appstore/<module needed>.framework", "modules/iphone/<your module>/" + module.version + "/platform/<module needed>.framework");
   } else {
   	require('wrench').copyDirSyncRecursive("modules/iphone/<your module>/" + module.version + "/platform/sim/<module needed>.framework", "modules/iphone/<your module>/" + module.version + "/platform/<module needed>.framework");
   }
   }}
   ---
   
   So in our module we distribute both the architectures, but on build select the right architecture.</li>
<li>Antonio Romano 2016-07-06

   I tried to use this solution but something went wrong, when I run the project the application crashed for the following error:
   
   *dyld: Library not loaded: @rpath/libswiftCore.dylib
     Referenced from: /Users/antonioromano/Library/Developer/Xcode/DerivedData/MyApplication-bnrttzcdaaaulcbaeovdscbntnfw/Build/Products/Debug-iphonesimulator/MyFramework.framework/MyFramework
     Reason: image not found*
   
   my module.xconfig is the following:
   
   *FRAMEWORK_SEARCH_PATHS="$(SRCROOT)/../../modules/iphone/{mod.id}/{mod.ver}/platform" "/Library/Application\ Support/Titanium/modules/iphone/{mod.id}/{mod.ver}/platform" "~/Library/Application\ Support/Titanium/modules/iphone/{mod.id}/{mod.ver}/platform"
   LD_RUNPATH_SEARCH_PATHS= $(inherited) "@executable_path/Frameworks" $(FRAMEWORK_SEARCH_PATHS)
   OTHER_LDFLAGS=$(inherited) -F"$(SRCROOT)/../../modules/iphone/{mod.id}/{mod.ver}/platform/MyFramework.framework" -framework MyFramework*
   
   (I also tried without 'OTHER_LDFLAGS')
   
   
   Do I miss something?
   I think is a problem of copy, because if I drag and drop the .framework in the xcodeproject then the application doesn't crash anymore.</li>
<li>John Staunton 2016-07-08

   Same problem as Antonio Romano here... application crashes instantly saying "image not found". I've added the plugin, updated the appropriate line, etc.</li>
<li>John Staunton 2016-07-15

    Anyone with any ideas? It works 'fine' in the simulator (doesn't load our icons properly, but that's a different story) but crashes immediately on a real device...</li>
<li>John Staunton 2016-08-20

    Ok, eventually and after much trial-and-error I have this working - both on the device and for packaging new apps for distribution.
    
    1) There is a small omission in the above instructions - in TiApp.xml you also need to ensure that the plugin is called: 
        <plugins>
            <plugin>ti.dynamiclib</plugin>
        </plugins>
    
    2) Modify ti.dynamiclib.js to add a run script phase to strip the frameworks - after frameworkPaths.forEach(...) add:
    
    	// Add frameworks tidyup run script phase (has to be after Frameworks)
    	var script_uuid = builder.generateXcodeUuid();
    	var shell_path = '/bin/sh';
    	var shell_script = 'bash \"<path to strip-frameworks script>/strip-frameworks.sh\"';
    	createPBXRunShellScriptBuildPhase(xobjs, script_uuid, shell_path, shell_script);
    	createPBXRunScriptNativeTarget(xobjs, script_uuid);
    
    The 2 new functions are:
    
    function createPBXRunShellScriptBuildPhase(xobjs, script_uuid, shell_path, shell_script){
    	xobjs.PBXShellScriptBuildPhase = xobjs.PBXShellScriptBuildPhase || {};
    	xobjs.PBXShellScriptBuildPhase[script_uuid] = {
    		isa: 'PBXShellScriptBuildPhase',
    		buildActionMask: '2147483647',
    		files: '(\n)',
    		inputPaths: '(\n)',
    		outputPaths: '(\n)',
    		runOnlyForDeploymentPostprocessing: 0,
    		shellPath: shell_path,
    		shellScript: JSON.stringify(shell_script)
    	};
    }
    
    and
    
    function createPBXRunScriptNativeTarget(xobjs, script_uuid) {
    	for (var key in xobjs.PBXNativeTarget) {
    		xobjs.PBXNativeTarget[key].buildPhases.push({
    			value: script_uuid + '',
    			comment: 'Run Script Phase'
    		});
    		return;
    	}
    }
    
    Not the best code ever written, but gets the job done. Doing the above, I am able to build apps with embedded frameworks again and can directly publish apps for the app store from Studio.</li>
<li>Richard Lustemberg 2017-01-24

    I am using John Staunton's approach with success. The dynamic libs are on a native module. I am including the CLI hook plugin as a module hook, not a global one.</li>
<li>Hans Kn√∂chel 2017-01-24

    Hey guys, we recently updated the CLI-hook with the script-phase, Hyperloop usage and more docs. It can be found [here](<a href="https://gist.github.com/hansemannn/5046fcc9a14cc3d09d0874f964b443aa)." rel="nofollow" target="_blank">https://gist.github.com/hansemannn/5046fcc9a14cc3d09d0874f964b443aa).</a> To make things easier for the user of your module, you can simply place the file in <code>&lt;module-root&gt;/iphone/hooks/</code> and the app-CLI will pick it up during build process. No manual <code>&lt;plugin/&gt;</code> reference needed.</li>
<li>Jan Vennemann 2017-08-23

    PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/9346" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9346</a>
    PR (6_2_X): <a href="https://github.com/appcelerator/titanium_mobile/pull/9351" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9351</a>
    
    Testing instructions for QE will follow tomorrow. Just wanted to put this in review now so [~hknoechel] and [~cbarber] can already do a CR since it's quite some change to the iOS build.</li>
<li>Jan Vennemann 2017-08-24

    This new hook does a lot under the hood, so here are some extended testing steps to check all the use cases.
    
    *Basic FR steps*
    <h4>Download the test module at <a href="https://drive.google.com/open?id=0BzhMoExz43YBX2F6ODVCb2Ntd1k." rel="nofollow" target="_blank">https://drive.google.com/open?id=0BzhMoExz43YBX2F6ODVCb2Ntd1k.</a> This is a simple test module with one static (FBSDK) and dynamic (Mapbox) framework</h4>
    <h4>Add the module <code>com.appc.mapbox</code> to your app</h4>
    <h4>Add the following to {{app/controllers/index.js}:</h4>
    <code><pre>
    var TestModule = require('com.appc.mapbox');
    $.label.text = 'Mapbox: ' + TestModule.mapboxVersion + '\nFB: ' + TestModule.fbSdkVersion;
    </pre></code>
    <h4>Run the app. It should print two version strings for the bundled Mapbox and Facebook SDK</h4>
    
    *Additional steps*
    <h4>The hook includes a caching system for the framework metadata it collects to properly integrate the frameworks. This metadata will only be (re)generated if a framework changes. In the first run after dropping in the test module you should see log messages that indicate the metadata generation like this: </h4>
    <code><pre>
    [DEBUG] ti:inspectFrameworks: Found framework FBSDKCoreKit (type: static, archs: i386, armv7, x86_64, arm64) at /Users/jvennemann/Development/appc/dftest/modules/iphone/com.appc.mapbox/1.0.0/platform/FBSDKCoreKit.framework
    [DEBUG] ti:inspectFrameworks: Found framework Mapbox (type: dynamic, archs: i386, x86_64, armv7, arm64) at /Users/jvennemann/Development/appc/dftest/modules/iphone/com.appc.mapbox/1.0.0/platform/Mapbox.framework
    [DEBUG] ti:inspectFrameworks: Found framework Bolts (type: static, archs: i386, armv7, x86_64, arm64) at /Users/jvennemann/Development/appc/dftest/modules/iphone/com.appc.mapbox/1.0.0/platform/Bolts.framework
    </pre></code>
    <h4>Moving the module to a new location, e.g. from the app to the global modules folder, the metabase should be invalidated and regenerated, indicated by the following log messages:</h4>
    <code><pre>
    [TRACE] ti:inspectFrameworks: Framework at /Users/jvennemann/Development/appc/dftest/modules/iphone/com.appc.mapbox/1.0.0/platform/FBSDKCoreKit.framework deleted, removing metadata
    [TRACE] ti:inspectFrameworks: Framework at /Users/jvennemann/Development/appc/dftest/modules/iphone/com.appc.mapbox/1.0.0/platform/Mapbox.framework deleted, removing metadata
    [TRACE] ti:inspectFrameworks: Framework at /Users/jvennemann/Development/appc/dftest/modules/iphone/com.appc.mapbox/1.0.0/platform/Bolts.framework deleted, removing metadata
    [TRACE] ti:inspectFrameworks: Framework at /Users/jvennemann/Library/Application Support/Titanium/modules/iphone/com.appc.mapbox/1.0.0/platform/Bolts.framework changed, regenerating metadata
    [TRACE] ti:inspectFrameworks: Framework at /Users/jvennemann/Library/Application Support/Titanium/modules/iphone/com.appc.mapbox/1.0.0/platform/FBSDKCoreKit.framework changed, regenerating metadata
    [TRACE] ti:inspectFrameworks: Framework at /Users/jvennemann/Library/Application Support/Titanium/modules/iphone/com.appc.mapbox/1.0.0/platform/Mapbox.framework changed, regenerating metadata
    </pre></code>
    <h4>The same should happen if a single framework is added, changed or removed from a module or the project's <code>platform/ios</code> folder.</h4>
    <h4>When a dynamic framework is used, a script will be provided by default that strips the frameworks of unused architectures. This is indicated by this log message:</h4>
    <code><pre>
    [TRACE] Framework with fat binary present, integrating script to strip invalid architectures.
    [TRACE] Using bundled script at /Users/jvennemann/Library/Application Support/Titanium/mobilesdk/osx/6.2.0.v20170811022027/iphone/templates/build/strip-frameworks.sh
    </pre></code>
    To allow the user to use their own script it is possible to override this script by dropping in their own script in <code>platform/ios</code> and name it <code>strip-frameworks.sh</code>. To test that create a simple shell script which only contains an <code>echo</code>
    The log message should change to 
    <code><pre>
    [TRACE] Framework with fat binary present, integrating script to strip invalid architectures.
    [TRACE] Using custom user script at /Users/jvennemann/Development/appc/dftest/platform/ios/strip-frameworks.sh
    </pre></code>
    and you should see the you echo'd text at the very end of the build.</li>
<li>Eric Wieber 2017-08-30

    Verified in SDK builds 7.0.0.v20170830123430 & 6.2.0.v20170830125819</li>
</ol>


<p><a href="/TIMOB/TIMOB-20557.json">JSON Source</a></p>