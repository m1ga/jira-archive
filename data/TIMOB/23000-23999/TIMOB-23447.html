---
title: "[TIMOB-23447] Android: Optimize removeAllChildren()"
---
<table>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Open</td></tr>
<tr><th>Resolution</th><td>Unresolved</td></tr>

<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, community, remove, speed</td></tr>
<tr><th>Reporter</th><td>Michael Gangolf</td></tr>
<tr><th>Assignee</th><td>Ashraf Abu</td></tr>
<tr><th>Created</th><td>2016-05-27T12:04:55.000+0000</td></tr>
<tr><th>Updated</th><td>2017-08-11T14:52:37.000+0000</td></tr>
</table>

<h3>Description</h3>

The current implementation of [removeAllChildren()](<a href="https://github.com/appcelerator/titanium_mobile/blob/415bd6c66dcc55b1a59a59574f3babd3c3a84ede/android/titanium/src/java/org/appcelerator/titanium/proxy/TiViewProxy.java#L719)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/415bd6c66dcc55b1a59a59574f3babd3c3a84ede/android/titanium/src/java/org/appcelerator/titanium/proxy/TiViewProxy.java#L719)</a> creates a copy of all views and removes each view in a while loop.
The people at Shockoe showed in a [blog post](<a href="http://shockoe.com/development/profiling-titanium/)" rel="nofollow" target="_blank">http://shockoe.com/development/profiling-titanium/)</a> that it takes up to 24 seconds to remove 1000 views with 
<code><pre>
theWindow.removeAllChildren();
</pre></code>

Changing the TiViewProxy method to use the native [ViewGroup.removeAllViews()](<a href="https://developer.android.com/reference/android/view/ViewGroup.html#removeAllViews%28%29)" rel="nofollow" target="_blank">https://developer.android.com/reference/android/view/ViewGroup.html#removeAllViews%28%29)</a> would bring down delay below 100ms!

*Test app:*
<a href="https://github.com/bpulley/titanium-profiling" rel="nofollow" target="_blank">https://github.com/bpulley/titanium-profiling</a> can be used to test the behavior. Just run the "Remove views en masse" test.



<code><pre>
var win = Ti.UI.createWindow({
    backgroundColor: "white"
});

var view = Ti.UI.createView({
    top: 0,
    left: 0,
    right: 0,
    height: 100,
    layout: "horizontal"
});

var scrollview = Ti.UI.createScrollView({
    top: 100,
    left: 0,
    right: 0,
    height: 100,
    layout: "horizontal",
    type: "horizontal"
});

for (var i = 0; i < 100; i++) {
    var v = Ti.UI.createView({
        width: 10,
        height: 10,
        backgroundColor: "red",
        left: 10
    });
    view.add(v);
    v = null;

    var v2 = Ti.UI.createView({
        width: 10,
        height: 10,
        backgroundColor: "red",
        left: 10
    });
    scrollview.add(v2);
    v2 = null;
}

// Listview

var listView = Ti.UI.createListView({
    top: 200,
    height: 100
});
var sections = [];

var fruitSection = Ti.UI.createListSection({
    headerTitle: 'Fruits'
});
var fruitDataSet = [{
    properties: {
        title: 'Apple'
    }
}, {
    properties: {
        title: 'Banana'
    }
}, ];
fruitSection.setItems(fruitDataSet);
sections.push(fruitSection);

var vegSection = Ti.UI.createListSection({
    headerTitle: 'Vegetables'
});
var vegDataSet = [{
    properties: {
        title: 'Carrots'
    }
}, {
    properties: {
        title: 'Potatoes'
    }
}, ];
vegSection.setItems(vegDataSet);
sections.push(vegSection);

listView.sections = sections;

var fishSection = Ti.UI.createListSection({
    headerTitle: 'Fish'
});
var fishDataSet = [{
    properties: {
        title: 'Cod'
    }
}, {
    properties: {
        title: 'Haddock'
    }
}, ];
fishSection.setItems(fishDataSet);

function onOpen(e) {
    var startTime = new Date();
    console.log("View length: " + view.getChildren().length);
    view.removeAllChildren();
    console.log("View after remove length: " + view.getChildren().length);

    console.log("ScrollView length: " + scrollview.getChildren().length);
    scrollview.removeAllChildren();
    console.log("ScrollView after remove length: " + scrollview.getChildren().length);

    console.log("ListView length: " + listView.getSections().length);
    listView.removeAllChildren();
    console.log("ListView after remove length: " + listView.getSections().length);
    
    var endTime = new Date();
	var delta = endTime - startTime;
    alert('time ' + delta + 'ms');
}

win.add(listView);
win.add(view);
win.add(scrollview);
win.addEventListener("open", onOpen);
win.open();
</pre></code>

Ti SDK 5.2.2 = 4160ms (and listview.removeAllViews() is not working)
Patched Version = 333ms (listview will be empty)

<h3>Comments</h3>

<ol>
<li>Michael Gangolf 2016-05-27

   I'm still testing the PR in various situations. It is working already with normal <code>Views</code> and <code>ScrollViews</code>. Both showed a big time improvement.</li>
<li>Michael Gangolf 2016-05-27

   Added example and listview is working, too</li>
<li>Sharif AbuDarda 2016-05-27

   Hello,
   
   I tried to test the issue. Here are my findings. 
   
   Classic code provided above:
   1. Android Emulator (6.0.0)- 4482ms(1st run), 3716ms(2nd run).
   2. Android Device (4.4.2)- 4658ms.
   
   Alloy sample in Github
   1. Android Emulator (6.0.0)- Removed 1000 views in 18860ms.
   2. Android Device (4.4.2)- Removed 1000 views in 13954ms.
   
   Listview removeAllChildren() needs to be optimized. 
   
   Regards,
   Sharif.</li>
<li>Michael Gangolf 2016-05-27

   Those numbers are with the PR or without?</li>
<li>Michael Gangolf 2016-06-04

   Removed the ListView part! The <code>removeAllChildren()</code> inside the TiListView doesn't remove the ListViewItems in the current SDKs (as they are not chlidren of the ListView), so I don't need to do it in this PR. I just added an if-part so it won't produce an error if you call it on a ListView (behaves the same as in e.g. 5.2.2.GA).</li>
<li>Michael Gangolf 2016-06-14

   @sdarda did you test it with the patch, too?
   
   Any other notes on the behavior? It will just work on View with children, so ListView is not included (and works like before)</li>
<li>Michael Gangolf 2016-06-27

   Using the app from the blogpost and android monitor heap:
   
   *before:*
   !<a href="http://migaweb.de/mem1.png" rel="nofollow" target="_blank">http://migaweb.de/mem1.png</a>!
   
   
   *during creation*
   !<a href="http://migaweb.de/mem2.png" rel="nofollow" target="_blank">http://migaweb.de/mem2.png</a>!
   !<a href="http://migaweb.de/mem3.png" rel="nofollow" target="_blank">http://migaweb.de/mem3.png</a>!
   
   
   *after deleting the views and pressing GC:*
   !<a href="http://migaweb.de/mem4.png" rel="nofollow" target="_blank">http://migaweb.de/mem4.png</a>!</li>
<li>Ashraf Abu 2016-06-28

   The PR by [~michael] for this ticket is here: <a href="https://github.com/appcelerator/titanium_mobile/pull/8026" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8026</a></li>
<li>Hazem Khaled 2016-12-15

   It'll be great if you release this issue with TIMOB-19482 together 6.1.0 :)</li>
</ol>


<p><a href="/TIMOB/TIMOB-23447.json">JSON Source</a></p>