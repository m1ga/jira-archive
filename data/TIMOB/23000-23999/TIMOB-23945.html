---
title: "[TIMOB-23945] Hyperloop does not extract /jni/<abi>/*.so files from an aar"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2016-09-26T14:22:54.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 5.5.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.0.0, Hyperloop 2.0.0</td></tr>
<tr><th>Components</th><td>Android, Hyperloop, Tooling</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Brian Knorr</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2016-09-22T21:16:08.000+0000</td></tr>
<tr><th>Updated</th><td>2016-11-27T19:49:41.000+0000</td></tr>
</table>

<h3>Description</h3>

It's very easy to reproduce. Just add an aar file to your hyperloop enabled Titanium project. Here is the one we are using:

<a href="https://github.com/card-io/card.io-Android-SDK/tree/master/aars" rel="nofollow" target="_blank">https://github.com/card-io/card.io-Android-SDK/tree/master/aars</a>

Then build for android. Find the apk and unpack it. You will not see any of the aar's .so files in the lib folder, only the Titanium specific ones. This causes the use of this aar libray to fail with:

[ERROR] : E/card.io : Failed to load native library: dalvik.system.PathClassLoader[DexPathList[[zip file "/data/app/com.jasonsdeli.mobile-2/base.apk"],nativeLibraryDirectories=[/data/app/com.jasonsdeli.mobile-2/lib/arm, /vendor/lib, /system/lib]]] couldn't find "libcardioDecider.so"

<h3>Comments</h3>

<ol>
<li>Brian Knorr 2016-09-22

   Also the AppC documentation states that extracting *.so files from an aar is supported.  But this seems to be wrong, because it doesn't work.  Here is the documentation <a href="http://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/platform/latest/#</a>!/guide/Android_Hyperloop_Programming_Guide-section-46253495_AndroidHyperloopProgrammingGuide-UsingThird-partylibraries</li>
<li>Hans Knöchel 2016-09-24

   [~cwilliams] I see that we do handle .so files in .aar files, but only if they are in the <code>jni</code> directory, is that correct? I looked at [this](<a href="https://github.com/appcelerator/hyperloop.next/blob/master/android/plugins/hyperloop/hooks/android/hyperloop.js#L403)" rel="nofollow" target="_blank">https://github.com/appcelerator/hyperloop.next/blob/master/android/plugins/hyperloop/hooks/android/hyperloop.js#L403)</a> piece of code.
   
   *EDIT*: I could happen because the provided .aar has it's .so files in <code>/jni/<api>/*.so</code>, so they are not "flat" inside there.</li>
<li>Brian Knorr 2016-09-24

   The spec for AAR format doesn't allow for *.so to be "flat" inside the jni folder.  See <a href="http://tools.android.com/tech-docs/new-build-system/aar-format" rel="nofollow" target="_blank">http://tools.android.com/tech-docs/new-build-system/aar-format</a>
   
   This means that AARs with *.so files are not supported by hyperloop until this is fixed.  We need this working for a big client of yours - we are the firm building the Titanium app.  Please let us know what the ETA is on this.
   
   Thanks,
   
   Brian</li>
<li>Hans Knöchel 2016-09-24

   Actually I think the issue is something else. Because we search recursively for the files and copy them over afterwards. So maybe a duplicate file-name (if a file is found in both <code>x86</code> and <code>x86_64</code>) might cause problems. This is just some troubleshooting for now.</li>
<li>Hans Knöchel 2016-09-24

   *PR*: <a href="https://github.com/appcelerator/hyperloop.next/pull/77" rel="nofollow" target="_blank">https://github.com/appcelerator/hyperloop.next/pull/77</a>
   
   *Steps to test:*
   1. Create a new Hyperloop-based Titanium project: <code>appc new -p android</code>
   2. Download [card.io-5.4.1.aar](<a href="https://github.com/card-io/card.io-Android-SDK/raw/master/aars/card.io-5.4.1.aar)" rel="nofollow" target="_blank">https://github.com/card-io/card.io-Android-SDK/raw/master/aars/card.io-5.4.1.aar)</a> and copy it to <code>/app/platform/android</code>
   3. In the index.js, copy the following line to access the library:
   <code><pre>
   var CardIOActivity = require("io.card.payment.CardIOActivity");
   </pre></code>
   
   *Expected behavior:* The build does not fail, the app does not crash after requiring the class.
   
   [~btknorr] You can test the patch even before we release the next version by going to <code>~/Library/Application Support/Titanium/plugins/hyperloop/<version>/hooks/android/hyperloop.js</code>, and replacing the following line (around 369):
   <code><pre>
   buildLibs = path.join(cli.argv['project-dir'], 'build', 'libs');
   </pre></code>
   with
   <code><pre>
   buildLibs = path.join(cli.argv['project-dir'], 'build', 'android', 'libs');
   </pre></code>
   
   The generated project looks good:
   !<a href="https://abload.de/img/bildschirmfoto2016-09hps6z.png" rel="nofollow" target="_blank">https://abload.de/img/bildschirmfoto2016-09hps6z.png</a>!</li>
<li>Brian Knorr 2016-09-24

   Hans - I made the code modification like you suggested and everything works great now :)  Thanks!</li>
<li>Lokesh Choudhary 2016-10-05

   Verified the fix.
   
   Hyperloop now successfully extracts <code>/jni/<abi>/*.so</code> files from an <code>aar</code> file.
   Closing.
   
   Environment:
   Appc Studio : 4.8.0.201609292239
   Ti SDK :  6.0.0.v20161005072811
   Ti CLI : 5.0.10
   Alloy : 1.9.2
   MAC El Capitan : 10.11.6
   Appc NPM : 4.2.8-7
   Appc CLI : 6.0.0-56
   Node: 4.4.4
   Nexus 5 - Android 6.0.1
   Hyperloop plugin & module : 2.0.0</li>
</ol>


<p><a href="/TIMOB/TIMOB-23945.json">JSON Source</a></p>