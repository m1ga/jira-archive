---
title: "[TIMOB-23972] iOS: BgService more than 10 minutes and show blue bar issue for Location."
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Invalid</td></tr>
<tr><th>Resolution Date</th><td>2016-10-02T13:05:36.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>allowsBackgroundLocationUpdates, backgroundservice, ios, ipass1, location</td></tr>
<tr><th>Reporter</th><td>Motiur Rahman</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2016-10-01T20:28:59.000+0000</td></tr>
<tr><th>Updated</th><td>2018-08-06T17:37:01.000+0000</td></tr>
</table>

<h3>Description</h3>

Steps to Reproduce.

1. Create a classic project.
2. paste the following code to the corresponding file.
<code><pre>
var win = Ti.UI.createWindow({
	title : 'Background Services Example',
	backgroundColor : '#4186cd',
	modal : true
});

// Create a Button.
var bgService = Ti.UI.createButton({
	title : 'StartService',
	height : Ti.UI.SIZE,
	width : Ti.UI.SIZE,
	top : 20,

});


function bgServiceStart() {
	Ti.API.info('Registering background services');
	var service = Ti.App.iOS.registerBackgroundService({
		url : 'bgservice.js'
	});
	Ti.API.info('*** Press home button to pause application ***');
}

// Listen for click events.
bgService.addEventListener('click', function() {
	bgServiceStart();

	alert('click bg service');
});

// Add to the parent view.
win.add(bgService);

win.open();


</pre></code>
<code><pre>
Ti.API.info('bg-service1: service page');

if (Ti.Platform.name == "iPhone OS" && parseInt(Ti.Platform.version.split(".")[0]) &gt;= 8) {
	Ti.App.iOS.registerUserNotificationSettings({
		types : [Ti.App.iOS.USER_NOTIFICATION_TYPE_ALERT, Ti.App.iOS.USER_NOTIFICATION_TYPE_SOUND, Ti.App.iOS.USER_NOTIFICATION_TYPE_BADGE]
	});
}

function pushData(latLong) {

	var curNotif = Ti.App.iOS.scheduleLocalNotification({
		alertBody : latLong,
		date : new Date(new Date().getTime() + 1000)
	});
}

function getCoords() {

	if (Ti.Geolocation.locationServicesEnabled) {
		Ti.Geolocation.allowsBackgroundLocationUpdates = true;
		Ti.Geolocation.accuracy = Ti.Geolocation.ACCURACY_BEST;
		Ti.Geolocation.preferredProvider = Ti.Geolocation.PROVIDER_GPS;
		Ti.Geolocation.addEventListener('location', function(e) {
			if (e.error) {
				alert('Error: ' + e.error);
			} else {
				Ti.API.info("value=" + e.coords);
				pushData(e.coords.latitude + '\n' + e.coords.longitude);
			}
		});
	}

}

setInterval(function() {
	getCoords();

}, 10000);

</pre></code>
<code><pre>
&lt;key&gt;UIBackgroundModes&lt;/key&gt;
&lt;array&gt;
&lt;string&gt;location&lt;/string&gt;
&lt;/array&gt;
&lt;key&gt;NSLocationAlwaysUsageDescription&lt;/key&gt;
&lt;string&gt;Specify the reason for accessing the user's location information.
This appears in the alert dialog when asking the user for permission to
access their location.&lt;/string&gt;
&lt;key&gt;UISupportedInterfaceOrientations~iphone&lt;/key&gt;
</pre></code>
3. Run that code to the device
4. It does not work more that 10 minutes even below 10 minutes and don't  show blue bar.
5. It should work more that 10 minutes and show blue bar as well since I have added UIBackgroundModes key 
- <a href="http://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/platform/latest/#</a>!/guide/tiapp.xml_and_timodule.xml_Reference-section-29004921_tiapp.xmlandtimodule.xmlReference-UIBackgroundModes

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2016-10-01

   *app.js*:
   <code><pre>
   var win = Ti.UI.createWindow({
       backgroundColor: '#fff'
   });
   
   // Create a Button.
   var bgService = Ti.UI.createButton({
       title: 'StartService'
   });
   
   // The event-listener needs to be outside the background-service
   Ti.Geolocation.addEventListener('location', function(e) {
       if (e.error) {
           alert('Error: ' + e.error);
       } else {
           Ti.API.info("value=" + JSON.stringify(e.coords));
       }
   });
   
   function bgServiceStart() {
       Ti.Geolocation.allowsBackgroundLocationUpdates = true;
       Ti.Geolocation.accuracy = Ti.Geolocation.ACCURACY_BEST;
       Ti.Geolocation.preferredProvider = Ti.Geolocation.PROVIDER_GPS;
   
       Ti.API.info('Registering background services');
       var service = Ti.App.iOS.registerBackgroundService({
           url: 'bgservice.js'
       });
       Ti.API.info('*** Press home button to pause application ***');
   }
   
   // Listen for click events.
   bgService.addEventListener('click', function() {
       // If you havr the AUTHORIZATION_ALWAYS permissions, the blue bar will not be shown
       if (!Ti.Geolocation.hasLocationPermissions(Ti.Geolocation.AUTHORIZATION_WHEN_IN_USE)) {
           Ti.Geolocation.requestLocationPermissions(Ti.Geolocation.AUTHORIZATION_WHEN_IN_USE, function(e) {
               if (!e.success) {
                   Ti.API.error("Location permissions not granted: " + e.error);
                   return;
               }
   
               bgServiceStart();
           });
       } else {
           bgServiceStart();
       }
   });
   
   win.add(bgService);
   win.open();
   </pre></code>
   
   *bgservice.js*:
   <code><pre>
   Ti.API.info('bg-service1: service page');
   
   function getCoords() {
       Ti.Geolocation.getCurrentPosition(function(e) {
           Ti.API.warn(e);
       });
   }
   
   setInterval(function() {
       getCoords();
   }, 10000);
   </pre></code>
   If you have the <code>AUTHORIZATION_ALWAYS</code> permissions, the bar will not be shown (since the user already agreed to always check the location). So you need the <code>AUTHORIZATION_WHEN_IN_USE</code> permission and the <code>NSLocationWhenInUseUsageDescription</code> key only. After that, the bar will be shown when you put your app in the background.
   
   *EDIT*: And the app just ran 15+ minutes, so the first problem also looks invalid after the made changes. So to note: The (proper) background-service itself it used to stay active > 10 minutes and the permissions are used in conjunction with the background-modes to show the "blue bar"
   
   Please give it a try. Resolving for now.</li>
<li>Hans Knöchel 2016-10-02

   In addition, we may place this code (with some more refactoring and documentation) in the [Background Services Guide|docs.appcelerator.com/platform/latest/#!/guide/iOS_Background_Services] and link that to the <code>allowsBackgroundLocationUpdates</code> docs.</li>
<li>Rainer Schleevoigt 2016-11-05

   I used your proposed code and the service will killed after 3 minutes. 
   I start from app.js with  <code>require("bgservicestarter")();</code>
   
   content of bgservicestarter:
   <a href="https://gist.github.com/AppWerft/a31fdf98132077c37ae33809938c917f" rel="nofollow" target="_blank">https://gist.github.com/AppWerft/a31fdf98132077c37ae33809938c917f</a>
   
   and here the service: <a href="https://gist.github.com/AppWerft/c3dd3b7b2d00da2bd91e034156dcb8d1" rel="nofollow" target="_blank">https://gist.github.com/AppWerft/c3dd3b7b2d00da2bd91e034156dcb8d1</a>
   
   In tiapp.xml is the UIBackgroundModes key and <code>NSLocationWhenInUseUsageDescription</code>
   
   Don you see way?</li>
<li>Rainer Schleevoigt 2016-11-06

   Hi Hans,
   
   I think we need generally AUTHORIZATION_ALWAYS permission? The other is only for foreground - or?
   And I think 
   Ti.Geolocation.allowsBackgroundLocationUpdates = true;
   Ti.Geolocation.preferredProvider = Ti.Geolocation.PROVIDER_NETWORK;
   Ti.Geolocation.accuracy = Ti.Geolocation.ACCURACY_THREE_KILOMETERS;
   Ti.Geolocation.trackSignificantLocationChange = true;
   is better then 
   Ti.Geolocation.allowsBackgroundLocationUpdates = true;
   Ti.Geolocation.accuracy = Ti.Geolocation.ACCURACY_BEST;
   Ti.Geolocation.preferredProvider = Ti.Geolocation.PROVIDER_GPS;
   
   But I'm not sure. In my app it doesn't work  in both cases.
   The app will kill after ca. 200 sec.
   
   Any ideas why? </li>
<li>Eric Merriman  2018-08-06

   Closing as invalid. If incorrect, please reopen.</li>
</ol>


<p><a href="/TIMOB/TIMOB-23972.json">JSON Source</a></p>