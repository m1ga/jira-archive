---
title: "[TIMOB-23997] iOS and Android revert incorrect CommonJS module changes"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Low</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2016-12-05T18:04:46.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.1.0</td></tr>
<tr><th>Components</th><td>Tooling</td></tr>
<tr><th>Labels</th><td>cb-tooling</td></tr>
<tr><th>Reporter</th><td>Chris Barber</td></tr>
<tr><th>Assignee</th><td>Christopher Williams</td></tr>
<tr><th>Created</th><td>2016-10-07T06:18:43.000+0000</td></tr>
<tr><th>Updated</th><td>2017-07-19T15:21:27.000+0000</td></tr>
</table>

<h3>Description</h3>

Both the Android and iOS build have a bug when resolving the main JS file in a CommonJS Titanium module. Normally the JS files are named <code>&lt;module id&gt;.js</code>, but if this doesn't exist, it should:

* See if there's a package.json
* If there is, read it in and find a <code>main</code> property
* Check that the file defined by <code>main</code> actually exists
* If exists, use it
* If not exists, look for an <code>index.js</code> file

As apart of TIMOB-23382 (PR <a href="https://github.com/appcelerator/titanium_mobile/pull/8004)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8004)</a>, the logic is bad. It will set the <code>module.libFile</code> to <code>package.json</code> or <code>index.json</code> which is technically incorrect. The good news is <code>module.libFile</code> for CommonJS modules is not used anywhere, however we should still fix it.

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-23997_60488/modules.zip">modules.zip</td></td><td>2016-10-11T20:22:12.000+0000</td><td>14995</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-23997_60829/timob23997BuildLog.rtf">timob23997BuildLog.rtf</td></td><td>2016-12-05T19:50:53.000+0000</td><td>29438</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Chris Barber 2016-10-11

   TiSDK master PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/8500" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8500</a>
   
   To test, add the following to your <code>tiapp.xml</code>:
   
   <code><pre>
   &lt;modules&gt;
   	&lt;module&gt;foo&lt;/module&gt; &lt;!-- foo.js --&gt;
   	&lt;module&gt;foo-main&lt;/module&gt; &lt;!-- bar.js --&gt;
   	&lt;module&gt;foo-main-noext&lt;/module&gt; &lt;!-- bar --&gt;
   	&lt;module&gt;foo-main-rel&lt;/module&gt; &lt;!-- ./bar --&gt;
   	&lt;module&gt;foo-main-rel-subdir&lt;/module&gt; &lt;!-- lib/bar --&gt;
   	&lt;module&gt;foo-index&lt;/module&gt; &lt;!-- index.js --&gt;
   	&lt;module&gt;foo-bad-nofile&lt;/module&gt;
   &lt;/modules&gt;
   </pre></code>
   
   Then unzip the attached <code>modules.zip</code> file into your project directory and build the app for both iOS and Android. You should see something like the following:
   
   <code><pre>
   [DEBUG] Detected commonjs module: com.appc.foo 1.0.0 @ /Users/chris/appc/workspace/testapp/modules/commonjs/foo/1.0.0
   [DEBUG] Detected commonjs module: com.appc.foo 1.0.0 @ /Users/chris/appc/workspace/testapp/modules/commonjs/foo-bad-nofile/1.0.0
   [DEBUG] Detected commonjs module: com.appc.foo 1.0.0 @ /Users/chris/appc/workspace/testapp/modules/commonjs/foo-index/1.0.0
   [DEBUG] Detected commonjs module: com.appc.foo 1.0.0 @ /Users/chris/appc/workspace/testapp/modules/commonjs/foo-main/1.0.0
   [DEBUG] Detected commonjs module: com.appc.foo 1.0.0 @ /Users/chris/appc/workspace/testapp/modules/commonjs/foo-main-noext/1.0.0
   [DEBUG] Detected commonjs module: com.appc.foo 1.0.0 @ /Users/chris/appc/workspace/testapp/modules/commonjs/foo-main-rel/1.0.0
   [DEBUG] Detected commonjs module: com.appc.foo 1.0.0 @ /Users/chris/appc/workspace/testapp/modules/commonjs/foo-main-rel-subdir/1.0.0
   &lt;snip&gt;
   [DEBUG] Looking for Titanium module id=foo version=latest platform=android,commonjs deploy-type=development
   [INFO]  Found Titanium module id=foo version=1.0.0 platform=commonjs deploy-type=development path=/Users/chris/appc/workspace/testapp/modules/commonjs/foo/1.0.0
   [DEBUG] Looking for Titanium module id=foo-main version=latest platform=android,commonjs deploy-type=development
   [INFO]  Found Titanium module id=foo-main version=1.0.0 platform=commonjs deploy-type=development path=/Users/chris/appc/workspace/testapp/modules/commonjs/foo-main/1.0.0
   [DEBUG] Looking for Titanium module id=foo-main-noext version=latest platform=android,commonjs deploy-type=development
   [INFO]  Found Titanium module id=foo-main-noext version=1.0.0 platform=commonjs deploy-type=development path=/Users/chris/appc/workspace/testapp/modules/commonjs/foo-main-noext/1.0.0
   [DEBUG] Looking for Titanium module id=foo-main-rel version=latest platform=android,commonjs deploy-type=development
   [INFO]  Found Titanium module id=foo-main-rel version=1.0.0 platform=commonjs deploy-type=development path=/Users/chris/appc/workspace/testapp/modules/commonjs/foo-main-rel/1.0.0
   [DEBUG] Looking for Titanium module id=foo-main-rel-subdir version=latest platform=android,commonjs deploy-type=development
   [INFO]  Found Titanium module id=foo-main-rel-subdir version=1.0.0 platform=commonjs deploy-type=development path=/Users/chris/appc/workspace/testapp/modules/commonjs/foo-main-rel-subdir/1.0.0
   [DEBUG] Looking for Titanium module id=foo-index version=latest platform=android,commonjs deploy-type=development
   [INFO]  Found Titanium module id=foo-index version=1.0.0 platform=commonjs deploy-type=development path=/Users/chris/appc/workspace/testapp/modules/commonjs/foo-index/1.0.0
   [DEBUG] Looking for Titanium module id=foo-bad-nofile version=latest platform=android,commonjs deploy-type=development
   [INFO]  Found Titanium module id=foo-bad-nofile version=1.0.0 platform=commonjs deploy-type=development path=/Users/chris/appc/workspace/testapp/modules/commonjs/foo-bad-nofile/1.0.0
   [ERROR] Module "foo-bad-nofile" v1.0.0 is missing main file: foo-bad-nofile.js, package.json with "main" entry, or index.js
   </pre></code></li>
<li>Chris Barber 2016-11-03

   I reverted all changes to the build with respect to CommonJS modules in the Android and IOS build.
   
   TiSDK master PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/8500" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8500</a>
   TiSDK 6_0_X PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/8623" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8623</a></li>
<li>Christopher Williams 2016-12-01

   The PRs here have broken functionality for us to support commonJS modules that don't have a file named the exact same as the module id inside. </li>
<li>Christopher Williams 2016-12-01

   <a href="https://github.com/appcelerator/titanium_mobile/pull/8649" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8649</a>
   <a href="https://github.com/appcelerator/titanium_mobile/pull/8648" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8648</a>
   </li>
<li>Abir Mukherjee 2016-12-05

   I tested with this environment:
   NPM Version: 2.15.9
   Node Version: 4.5.0
   Mac OS: 10.12.1
   Appc CLI: 6.0.0
   Appc CLI NPM: 4.2.8
   Titanium SDK version: 6.0.1.v20161202124626
   Appcelerator Studio, build: 4.8.0.201611121409
   Xcode 8.1 GM
   
   I did get the messages that the modules were found. However, I also got this message for each module when I tried to build it on either Android or iOS device:
   <code><pre>
   [DEBUG] Module foo requires Titanium SDK 6.1.0 or newer, but the selected SDK is 6.0.1
   [WARN]  Could not find a valid Titanium module id=foo version=latest platform=ios,iphone,commonjs deploy-type=development
   </pre></code>
   <code><pre>
   [ERROR] Could not find all required Titanium Modules:
   [ERROR]    id: foo	 version: latest	 platform: ios,iphone,commonjs	 deploy-type: development
   </pre></code>
   The log is attached.
   [^timob23997BuildLog.rtf]</li>
<li>Abir Mukherjee 2016-12-09

   NPM Version: 2.15.9
   Node Version: 4.5.0
   Mac OS: 10.12.1
   Appc CLI: 6.0.0
   Appc CLI NPM: 4.2.8
   Titanium SDK version: 6.1.0.v20161205110006
   Appcelerator Studio, build: 4.8.0.201611121409
   Xcode 8.1 GM
   
   Fix is validated. Note that fix was validated using the attached zip, which has a min SDK 6.1.0</li>
<li>Alberto Marcone 2017-07-19

   since the update to 6.1.0, the app freezes on startup on a real device (everything works fine on the simulator). The app is pre-alloy, so everything is in CommonJS.
   
   The error I get:
   [ERROR] Application received error: undefined is not a constructor (evaluating 'new(void 0)') at downloader.js (line 1)
   [ERROR] Application received error: Module "module/controllers/loginController.js" failed to leave a valid exports object
   
   The only thing I can think of, is that inside downloader.js there's this kind of code:
   ---
   var downloader = function() {
   	
   	var myModule = require('com.myNativeModule');
   	
   	var downloadUtility = require("/module/helpers/download_utility");
   
           [.....]
   }
   module.exports = downloader;
   ---</li>
<li>Alberto Marcone 2017-07-19

   not sure if the error is related to this ticket, I went through all of the fixes/new features and this looked something that could interfere with CommonJS and modules. In case I will open a new ticket.</li>
</ol>


<p><a href="/TIMOB/TIMOB-23997.json">JSON Source</a></p>