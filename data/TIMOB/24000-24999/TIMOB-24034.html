---
title: "[TIMOB-24034] iOS: New logging system breaks differential builds - simulator builds only"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2016-10-18T02:47:24.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.0.0</td></tr>
<tr><th>Components</th><td>iOS, Tooling</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Chris Barber</td></tr>
<tr><th>Assignee</th><td>Chris Barber</td></tr>
<tr><th>Created</th><td>2016-10-13T23:33:25.000+0000</td></tr>
<tr><th>Updated</th><td>2018-08-06T17:49:34.000+0000</td></tr>
</table>

<h3>Description</h3>

The iOS Simulator shares ports with the host machine. The iOS build will select a log server port based on the <code>&lt;log-server-port&gt;</code> in the tiapp.xml or based on the hash of the app id using the following logic:

<code><pre>
parseInt(sha1(this.tiapp.id), 16) % 50000 + 10000
</pre></code>

Because we only allow a possible 50,000 possibilities, the likelihood of a collision is high. In my tests, it's about 5%. The solution to the collisions is to just allow manual override by setting a <code>&lt;log-server-port&gt;</code> in the tiapp.xml.

The next problem is what if the app id hash port resolves a port number used by another piece of software? Say you have MongoDB installed and it's listening on port 27017. It's entirely possible Titanium will pick 27017.

The current iOS build logic tries to be smart. It starts a Node.js server listening on the selected port and if it can't bind to it, then that means some other app already has bound to the port. It will then select a random port. I knew at design time that random ports will break the differential build system, but figured it would only happen if there was a collision.

Turns out that's not quite accurate. If you build an app for the sim and then rebuild our app while leaving the previous build running in the sim, the iOS build will detect the desired port is not available because the iOS app is currently listening on it. This causes the iOS build to randomly select a port.

The port number gets written to the Xcode project. Since it will generate a new random port every build (as long as the sim and previous build is running), the iOS build detects the Xcode project is different and forces a full rebuild.

We have 5 solutions:

1. Don't select a random port. Just use the port regardless if it's in use. Cons: high chance of port collisions and false positives, the iOS app will fail to bind to it and there will be no logs and no warning.

2. Don't select a random port. If the port is already in use, try connecting to it and see if it's the app we're trying to build and if so, then proceed with the build. If the port is being used by something such as a web server, it will be expecting data, but because the log server clients do not send data, we end up in a stalemate. We would need to add a timeout. Cons: the timeout will pause the build by ~1 second.

3. Allow random ports if the desired port is unavailable. Pass the <code>GCC_PREPROCESSOR_DEFINITIONS="TI_LOG_SERVER_PORT=XXXX"</code> directly into <code>xcodebuild</code> instead of baking it into the Xcode project. Cons: you will run in a loop where the build will alternate between the hashed port and a random one, we would need to force <code>xcodebuild</code> to re-compile using the new port value.

4. Write the port to a file (could be any file) and bundle it with the app. Avoids the Xcode project and <code>xcodebuild</code>. If the file does not exist or is empty, then logging is disabled. Cons: easy to accidentally ship with the app and enable logging in production.

5. Pass the port number in as an argument when we call <code>simctl launch</code>. We would still bake the <code>DISABLE_TI_LOG_SERVER=1</code> into the Xcode project for dist builds. Cons: ioslib currently does not support passing arguments into <code>simctl launch</code>, subsequent manually launching the app will not have the argument.

I think option 1 and 3 are not too good. Option 2 is not so great. Option 4 is not too bad. <a href="https://www.youtube.com/watch?v=vm-MrkoJPC8" rel="nofollow" target="_blank">https://www.youtube.com/watch?v=vm-MrkoJPC8</a>

Thoughts?

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-24034_60532/cleanBuild.trace">cleanBuild.trace</td></td><td>2016-10-17T13:52:27.000+0000</td><td>1608787</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-24034_60533/subseqBuild.trace">subseqBuild.trace</td></td><td>2016-10-17T13:52:25.000+0000</td><td>51092</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Hans Kn√∂chel 2016-10-14

   I like option 2 if the timeout doesn't actively the build. When you say it could be done when resources are copied, it sounds like a good idea. I also like option 4, if we can ensure that it doesn't get shipped with production apps. Could be store it in the build dir or does that also make problems with recurring builds?</li>
<li>Chris Barber 2016-10-14

   Turns out we can't resolve log server port while copying resources... we must do it before we write the Xcode project which is right before we do all the parallel tasks.</li>
<li>Chris Barber 2016-10-14

   I did a bunch of testing and ended up going with Option 2. I removed the code that selects a random port.
   
   New logic:
   
   <h4>Select the port to use based on either the <code>&lt;log-server-port&gt;</code> in the tiapp.xml or generate a port based on the app id</h4>
   <h4>Validate that the port is an integer between 1024 and 65535</h4>
   <h4>Start a Node server and try to bind to the port</h4>
   <h4>If we can bind, the port is available and we kill the server and continue with the build</h4>
   <h4>If we cannot bind, then connect to the port to see if it's a Titanium app:</h4>
   <h4>If it's a Titanium app, check if the app id matches the one app we're building</h4>
   <h4>If yes, then continue with the build... when we install the new version, it'll kill the old one and release the port</h4>
   <h4>If no, then error out</h4>
   <h4>If it's not a Titanium app...</h4>
   <h4>and the remote server expects data upon connect...</h4>
   <h4>and the server times out the connection because of no activity</h4>
   <h4>and server hangs and we timeout the connection because of no activity</h4>
   <h4>and the remote server immediately sends us data, but the first line of data is not our JSON encoded log header</h4>
   
   To test:
   <h4>Create 2 apps</h4>
   <h4>Set a <code>&lt;log-server-port&gt;6666&lt;/log-server-port&gt;</code> in the tiapp.xml</h4>
   <h4>Build app1 for simulator</h4>
   <h4>Leave app running</h4>
   <h4>Build app2 for simulator</h4>
   <h4>App2 should fail to build:</h4>
   <code><pre>
   [ERROR] Another Titanium app "com.appcelerator.testapp" is currently running and using the log server port 6666
   [ERROR] Stop the running Titanium app, then rebuild this app
   [ERROR] -or-
   [ERROR] Set a unique &lt;log-server-port&gt; between 1024 and 65535 in the &lt;ios&gt; section of the tiapp.xml
   </pre></code>
   <h4>Kill App1 and it's build</h4>
   <h4>Start a node server on port 6666</h4>
   <code><pre>require('net').createServer(function () {
   	console.log('got a new connection!');
   }).listen({
   	host: 'localhost',
   	port: 6666
   }, function () {
   	console.info('Server started');
   });</pre></code>
   <h4>Build App1 or app2</h4>
   <code><pre>
   [ERROR] Another process is currently bound to port 6666
   [ERROR] Set a unique &lt;log-server-port&gt; between 1024 and 65535 in the &lt;ios&gt; section of the tiapp.xml
   </pre></code>
   
   For bonus points, install something like MongoDB (27017) or MySQL (3306), set the <code>&lt;log-server-port&gt;</code>, and build. Should be same as last error above.
   
   TiSDK master PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/8515" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8515</a>
   TiSDK 6_0_X PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/8516" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8516</a></li>
<li>Chee Kiat Ng 2016-10-17

   [~cbarber] the test cases work fine but i don't think it fixed differential build.
   When I initiated the subsequent build, sure enough there's a lot of "No change, skipping ...", but it still says "Invoking xcodebuild". Last I remember, it should say "Skipping xcodebuild". Please let me know if this is expected behavior.</li>
<li>Chris Barber 2016-10-17

   [~cng] It will say in the log output what is triggering xcodebuild, so what does it say?</li>
<li>Chee Kiat Ng 2016-10-17

   [~cbarber]
   Strangely enough it is saying 
   [INFO] :   Forcing rebuild: image was updated, recompiling asset catalog
   
   but i didn't do any image change. See attached 2 trace files.</li>
<li>Chris Barber 2016-10-17

   Then that means that the Xcode project and thus the log server port are not the reason for the rebuilds in which case this ticket is fixed. There obviously is a new issue surrounding asset catalog images. You could trying disabling app thinning and see if the problem is exclusively related to asset catalog images and file a ticket if so.</li>
<li>Chee Kiat Ng 2016-10-18

   PRs merged. CR and FT passed.</li>
<li>Eric Merriman  2018-08-06

   Cleaning up older fixed issues. If this issue should not have been closed as fixed, please reopen.</li>
</ol>


<p><a href="/TIMOB/TIMOB-24034.json">JSON Source</a></p>