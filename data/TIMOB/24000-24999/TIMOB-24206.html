---
title: "[TIMOB-24206] iOS: Memory leaks after select camera or photo gallery with jscore framework"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2018-05-23T08:38:59.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 6.0.0, Release 5.5.1</td></tr>
<tr><th>Fix Version/s</th><td>Release 7.3.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>ios</td></tr>
<tr><th>Reporter</th><td>Hazem Khaled</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2016-12-10T07:20:45.000+0000</td></tr>
<tr><th>Updated</th><td>2018-07-10T01:11:29.000+0000</td></tr>
</table>

<h3>Description</h3>

If <code><use-jscore-framework>false</use-jscore-framework></code> memory leaking happen after selecting image or capture picture from camera,
attached memory allocation after selecting 10 images from photo gallery, with true/false for <code>run-on-main-thread</code>, <code>use-auto-layout</code> and <code>use-jscore-framework</code>, I think the problem in last one.

<code><pre>
	<property name="run-on-main-thread" type="bool">true</property>
	<ios>
		<enable-launch-screen-storyboard>true</enable-launch-screen-storyboard>
		<use-app-thinning>true</use-app-thinning>
		<use-jscore-framework>false</use-jscore-framework>
		<use-auto-layout>true</use-auto-layout>
	<ios>
</pre></code>

<code><pre>
var win = Ti.UI.createWindow(),
    button = Ti.UI.createButton({
        title: 'Open Gallery',
    });

button.addEventListener('click', function() {
    Ti.Media.openPhotoGallery({
        mediaTypes: Ti.Media.MEDIA_TYPE_PHOTO,
        success: function(e) {
            win.backgroundImage = e.media;
        }
    });
});

win.add(button);

win.open();
</pre></code>

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61046/1. main=false jscore=false autoLayout=false.png">1. main=false jscore=false autoLayout=false.png</td></td><td>2016-12-10T07:16:43.000+0000</td><td>635739</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61047/1. main=false jscore=false autoLayout=true.png">1. main=false jscore=false autoLayout=true.png</td></td><td>2016-12-10T07:16:40.000+0000</td><td>637833</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61048/1. main=false jscore=true autoLayout=true.png">1. main=false jscore=true autoLayout=true.png</td></td><td>2016-12-10T07:16:40.000+0000</td><td>634482</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61049/1. main=true jscore=false autoLayout=false.png">1. main=true jscore=false autoLayout=false.png</td></td><td>2016-12-10T07:16:37.000+0000</td><td>638313</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61050/1. main=true jscore=false autoLayout=true.png">1. main=true jscore=false autoLayout=true.png</td></td><td>2016-12-10T07:16:38.000+0000</td><td>638644</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61051/1. main=true jscore=true autoLayout=true.png">1. main=true jscore=true autoLayout=true.png</td></td><td>2016-12-10T07:16:39.000+0000</td><td>685247</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_64796/example-jscore-released.png">example-jscore-released.png</td></td><td>2018-02-03T16:04:36.000+0000</td><td>24041</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61851/Jscore_Krollobject_for_Tiblob_3d0.png">Jscore_Krollobject_for_Tiblob_3d0.png</td></td><td>2017-03-14T10:28:30.000+0000</td><td>334939</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61850/Jscore_Tiblob_3d0.png">Jscore_Tiblob_3d0.png</td></td><td>2017-03-14T10:28:30.000+0000</td><td>294628</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61849/Kroll.png">Kroll.png</td></td><td>2017-03-14T10:28:30.000+0000</td><td>402736</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24206_61848/TIblob.png">TIblob.png</td></td><td>2017-03-14T10:28:30.000+0000</td><td>407668</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2016-12-10

   Note: This PR also resolves an issue where the picker was closed after a 0.5s delay. I refactored it to close the dialog on the main-thread again, so it won't cause problems and gives a better performance as well.
   
   PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/8676" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8676</a>
   
   *Steps to test*:
   1. Ensure to enable JSCore as stated in the ticket description
   2. Start Instruments > Allocations to monitor memory allocations
   3. Run the following test-case
   <code><pre>
   var win = Ti.UI.createWindow(),
       button = Ti.UI.createButton({
           title: 'Open Gallery',
       });
    
   button.addEventListener('click', function() {
       Ti.Media.openPhotoGallery({
           mediaTypes: Ti.Media.MEDIA_TYPE_PHOTO,
           success: function(e) {
               win.backgroundImage = e.media;
               alert("DONE");
           }
       });
   });
    
   win.add(button);
   win.open();
   </pre></code>
   
   Expected result: The memory should be deallocated to the same state as before after closing the picker. Also, the alert-dialog should be shown after the picker is closed.</li>
<li>Hans Knöchel 2016-12-10

   [~hazemkhaled] I was also wondering if this was happening with Ti SDK 5.5.1?</li>
<li>Hazem Khaled 2016-12-10

   @hans, tester report it just after 6, don't know what was before, but i'll test again tomorrow on 5.5.1</li>
<li>Hans Knöchel 2016-12-11

   Thanks! And please also check if the patch works for you</li>
<li>Hazem Khaled 2016-12-19

   alert-dialog appear after picker closed, but ram still as is, started 10 MB end with 290 MB
   sdk: 6.0.1.v20161217061750</li>
<li>Hans Knöchel 2016-12-19

   [~hazemkhaled] As said on Slack, the PR is not merged, yet and would need to be patched with your current SDK (e.g. replace the MediaModule.m with the contents of [this diff](<a href="https://github.com/appcelerator/titanium_mobile/pull/8676/files))." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8676/files)).</a> *If* it works, we would merge it. As 6.0.1 is already here ion Wednesday, it won't make it there anymore by now.</li>
<li>Hazem Khaled 2016-12-19

   Sorry for that, now fine memory deallocated
   start 17 MB end with 36 MB after pick 10 photos
   
   Thanks </li>
<li>Hans Knöchel 2016-12-19

   Thanks man! [~vijaysingh] will continue with the review then.</li>
<li>Hans Knöchel 2017-01-03

   [~hazemkhaled] Can you do me a favor and test TIMOB-24270 regarding your leaks as well? This one caused a small regression I'd like to get rid of asap. Thx!</li>
<li>Samir Mohammed 2017-01-18

    Verified fix with the test case provided above by [~hansknoechel] was able to see memory being deallocated, started at 10mb and ended at 37mb (5 photos selected).
    (Tested using Xcode Instruments (Allocations). 
    *Environement*
    <code><pre>
    Appcelerator Command-Line Interface, version 6.1.0
    Iphone SE (10.2) Simulator 
    Operating System Name: Mac OS X El Capitan
    Operating System Version: 10.11.6
    Node.js Version: 4.6.0
    npm: 4.2.8
    Titanium SDK Version: 6.1.0.v20170115172707
    Xcode: 8.2
    Appcelerator Studio: 4.8.1.201612050850
    </pre></code>
    </li>
<li>Hans Knöchel 2017-01-24

    Reopening issue together with [this PR](<a href="https://github.com/appcelerator/titanium_mobile/pull/8783)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8783)</a>, since it's causing major other issues for running on kroll-thread (TIMOB-24270). Will re-investigate this one.</li>
<li>Vijay Singh 2017-03-14

    I have attached memory graph of TiBlob and KrollObject   with and without jscore.Which shows the difference in referencing of memory. [~hansknoechel] let us discuss on this. Probably it can help on our debugging.</li>
<li>Eric Merriman  2017-08-09

    Work has been ongoing on this, with no proper solution. As of now, it will not make the schedule for 6.2.0. Apologies, we will continue to work on this.</li>
<li>Joe 2017-09-13

    Any updates / timeline on this issue? Extensive camera use in the app is causing app to lock up and/or sometime no longer auto focus.</li>
<li>Vijay Singh 2017-09-14

    [~NewportSolutions] 
    We are looking in this problem to find a proper solution for this.
    
    The problem is happening only if-
     <use-jscore-framework>true</use-jscore-framework> in tiapp.xml.
    
    Can you try with -
    <use-jscore-framework>false</use-jscore-framework>
    in your tiapp.xml. 
    
    Thanks.
    </li>
<li>Hans Knöchel 2018-02-03

    Some observations and thoughts after spending more time on that the last week:
    
    I tested again using three images and - they are actually removed (not directly, but after being autoreleased). See the following image with some markers that indicate the different states (click to expand):
    
     !example-jscore-released.png|thumbnail!  
    
    And in case this really still an issue, couldn't we just pull in [the initial PR](<a href="https://github.com/appcelerator/titanium_mobile/pull/8676)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/8676)</a> again and wrap it to only be used when using main-thread + jscore (instead of allowing the kroll-thread, too, which caused the revert of the PR as noted above in the comments)? The kroll-thread will go away this year anyway and since main-thread is the default now, I don't see many reasons not to do it.</li>
<li>Joe 2018-02-04

    Hans, 
    This is exactly what I thought was causing my "file upload issue" that I mentioned on LinkedIn. 
    I isolated the crash/freeze cause - taking photos before the upload. 
    Uploading the same photo is no problem. 
    
    Taking new photo before each upload causes the app crashes / freeze. 
    
    I added 	_{color:#d04437}<use-jscore-framework>false</use-jscore-framework>{color}_ and now I am taking 20+ photos without issue and seeing the memory released in instruments.  
    
    I agree this needs to be fixed as you suggested. </li>
<li>Vijay Singh 2018-02-05

    [~hknoechel] Your proposal sounds good. Would you like to create PR for this? Thanks!</li>
<li>Vijay Singh 2018-02-14

    [~hknoechel] I verified your proposal and found following result -
    1. On iOS 11.2 , with main-thread and Jscore, TiBlob get released after approx. 3 mints. It looks some changes has made in JavaScriptCore framework from apple side. But if we continue selecting more images, it doesn't get released.
    2. On iOS 10.3.1,  with main-thread and Jscore, TiBlob get released after approx. 12 mints.
    3. On iOS 10.0, with main-thread and Jscore, TiBlob didn't get released even after 20 mints.
    4. If we use [image autorelease] in point 1 & 2, it will crash the app.</li>
<li>Hans Knöchel 2018-02-16

    PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/9850" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9850</a>
    PR (7_1_X): <a href="https://github.com/appcelerator/titanium_mobile/pull/9851" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9851</a></li>
<li>Hans Knöchel 2018-02-21

    It turned out that there can still be leaks on larger data uploads, so I'll put it back to <code>In Progress</code> and investigate it for the next patch.</li>
<li>Samir Mohammed 2018-07-10

    *Closing ticket.* Verified fix in SDK Version <code>7.3.0.v20180613110103</code>.
    
    *FR Passed*
    Using the test case mentioned in the description each image added would increase the memory each time and after a certain time the images will be autoreleased; autoreleasing no longer causes the application to crash.
    
    *Test Environment*
    <code><pre>
    APPC Studio: 5.0.0.201712081732
    APPC CLI: 7.0.4
    iPhone 6 simulator (11.2)
    Operating System Name: Mac OS High Sierra
    Operating System Version: 10.13
    Node.js Version: 8.9.1
    Xcode 9.2
    </pre></code>
    </li>
</ol>


<p><a href="/TIMOB/TIMOB-24206.json">JSON Source</a></p>