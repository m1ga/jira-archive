---
title: "[TIMOB-24373] npm node_modules are erroring out during build"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>None</td></tr>
<tr><th>Status</th><td>Resolved</td></tr>
<tr><th>Resolution</th><td>Duplicate</td></tr>
<tr><th>Resolution Date</th><td>2018-08-13T07:37:32.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>n/a</td></tr>
<tr><th>Labels</th><td>cb-tooling</td></tr>
<tr><th>Reporter</th><td>Feon Sua Xin Miao</td></tr>
<tr><th>Assignee</th><td>Unknown</td></tr>
<tr><th>Created</th><td>2017-02-04T03:57:50.000+0000</td></tr>
<tr><th>Updated</th><td>2018-08-13T07:37:33.000+0000</td></tr>
</table>

<h3>Description</h3>

*Reproduce Steps*
1. Create a ti classic app
2. Create a package.json file under Resources folder:
<code><pre>
{
  "name": "myapp",
  "description": "myapp",
  "private": true,
  "dependencies": {
  },
  "devDependencies": {
    "mocha": "2.5.3",
    "should": "7.1.1",
    "ti-mocha": "0.2.0"
  }
}
</pre></code>
3. Run <code>npm install</code> under Resources folder
4. Build the project

*Expected Result*
The app builds without error

*Actual Result*
<code><pre>
[ERROR] Failed to parse /Users/feonsua/work/apps/test/Resources/node_modules/mocha/node_modules/glob/test/00-setup.js
[ERROR] SyntaxError: 'return' outside of function [line 82, column 0]
[ERROR]   
[ERROR]     }
[ERROR]   
</pre></code>

<h3>Comments</h3>

<ol>
<li>Chris Barber 2017-02-17

   Well, we don't have a lot of options. We either A) gut the entire <code>catch</code> clause and completely ignore any parse errors, or B) replace the <code>this.logger.error</code> with <code>this.logger.warn</code> and remove the <code>process.exit(1)</code>.
   
   <code><pre>
   try {
   	// parse the AST
   	var r = jsanalyze.analyzeJsFile(from, { minify: this.minifyJS });
   } catch (ex) {
   	ex.message.split('\n').forEach(this.logger.error);
   	this.logger.log();
   	process.exit(1);
   }
   </pre></code>
   
   <a href="https://github.com/appcelerator/titanium_mobile/blob/master/iphone/cli/commands/_build.js#L5642-L5649" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/iphone/cli/commands/_build.js#L5642-L5649</a>
   
   We AST parse all .js files using Uglify to find all Titanium APIs that are used so we can enable only the modules that are needed. The second we trying parsing a .js file that Uglify doesn't like or understand, the build fails. This is actually a much bigger problem than some bad .js syntax. The version of Uglify that we use is pretty old and doesn't support the latest ECMAScript standards. This means valid syntax will cause builds to fail. The next major Titanium build architecture will use Babylon, which is fantastic and allows plugins that will adapt to new standard changes. Unfortunately, we can't just rip out Uglify and drop in Babylon. It's going to be a significant amount of work.</li>
<li>Brenton House 2017-04-10

   As a workaround for anyone dealing with this issue, you can use nativeloop <a href="https://github.com/nativeloop/nativeloop." rel="nofollow" target="_blank">https://github.com/nativeloop/nativeloop.</a>   Basically, nativeloop looks for every call to uglifyjs.parse and make sure to run babeljs before those calls.  This ensures that the code is downgraded to an es5 format before uglifyjs tries to parse it.</li>
<li>Hans Kn√∂chel 2018-08-13

   Duplicate of ALOY-1540, fixed in Alloy 1.9.11+</li>
</ol>


<p><a href="/TIMOB/TIMOB-24373.json">JSON Source</a></p>