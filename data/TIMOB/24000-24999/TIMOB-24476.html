---
title: "[TIMOB-24476] iOS: Audio recording when exiting the app."
---
<table>
<tr><th>Type</th><td>Story</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Not Our Bug</td></tr>
<tr><th>Resolution Date</th><td>2017-03-25T15:49:43.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Motiur Rahman</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2017-03-11T17:03:19.000+0000</td></tr>
<tr><th>Updated</th><td>2017-05-31T22:24:56.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>description</h4>
Is it possible to activate the audio recorder when exiting the App? (pressed the home button for exiting the app)

I have tried with the following test code but it's not working.

<code><pre>
var win = Ti.UI.createWindow({
	backgroundColor : 'green',
	layout : "vertical"

});

win.open();

function onResume() {

	recorder.stop();

	Ti.Media.audioSessionCategory = Ti.Media.AUDIO_SESSION_CATEGORY_PLAYBACK;
	Ti.API.info("onReasume");

}

function onPause() {

	Ti.Media.audioSessionCategory = Ti.Media.AUDIO_SESSION_CATEGORY_PLAY_AND_RECORD;

	recorder.start();
	Ti.API.info("onPause");

}

var recorder = Ti.Media.createAudioRecorder();

Ti.App.addEventListener("resumed", onResume);

Ti.App.addEventListener("pause", onPause);


</pre></code>

If I press the home button then reopen it, several times, it shows this error.

<code><pre>
[ERROR] :  Script Error {
[ERROR] :      column = 15;
[ERROR] :      line = 63;
[ERROR] :      message = "+[NSBlock boundBridge:withKrollObject:]: unrecognized selector sent to class 0x1a91ccd58";
[ERROR] :      sourceURL = "file:///var/containers/Bundle/Application/03E1B455-31D7-4FB0-8509-CF99D1F972D8/commonJSApp.app/app.js";
[ERROR] :      stack = "[native code]\nonResume@file:///var/containers/Bundle/Application/03E1B455-31D7-4FB0-8509-CF99D1F972D8/commonJSApp.app/app.js:63:15";
[ERROR] :  }

</pre></code>

Thanks.

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24476_61835/test_media.zip">test_media.zip</td></td><td>2017-03-12T18:02:49.000+0000</td><td>2545123</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2017-03-12

   The error indicates a problem in line 64, but the test-case only has 31 lines. Please check!
   
   *EDIT*: I am able to reproduce this issue. Putting it in the current sprint and 6.0.3 release version for now. If possible, it would be very helpful to know if this used to work with 5.5.1.GA.
   
   *EDIT 2*: The error did not happen to me when using the latest 6.0.3 build together with the following tiapp.xml properties:
   <code><pre>
   &lt;key&gt;NSMicrophoneUsageDescription&lt;/key&gt;
   &lt;string&gt;Can we use your microphone?&lt;/string&gt;
   &lt;key&gt;UIBackgroundModes&lt;/key&gt;
   &lt;array&gt;
       &lt;string&gt;audio&lt;/string&gt;
   &lt;/array&gt;
   </pre></code>
   
   I also attached my example project that's based on your code. It works fine now and the red status bar appears to indicate the background recording to the user (that's native).</li>
<li>Tamir Ishay Sharbat 2017-03-13

   Hans can you run it multiple times... sometimes it works and sometimes it doesn't. Run it 5 times (rebuild every time and exit the app from the task manager) on/off liveview (important that you try both) if you never get a "Could not activate session" message then it's solved. otherwise please inform me</li>
<li>Hans Knöchel 2017-03-13

   Then it's solved :-) I received the message before, but after doing the above changes, it works now. You did test the changes and checked my example project right? And you can get the latest 6.0.3 build from [here](<a href="http://builds.appcelerator.com/#6_0_X)" rel="nofollow" target="_blank">http://builds.appcelerator.com/#6_0_X)</a> (release this / next week).</li>
<li>Tamir Ishay Sharbat 2017-03-15

   hans I checked it again with sdk version 6.0.3.v20170314141715 and I am still getting
    [INFO] :   Could not activate session
   when trying to activate the audio recorder when exiting the app
   can you please look into that?</li>
<li>Hans Knöchel 2017-03-15

   You ensured to included the above keys into your ios section of the tiapp.xml? Then I'd like to request the tiapp.xml to clarify.</li>
<li>Tamir Ishay Sharbat 2017-03-15

   yes! of course I included them. you may not get the bug because this behavior is incosistent (most times it works sometimes it doesn't)
   
   here is the tiapp.xml so you 
   
   <code><pre>
   &lt;?xml version="1.0" encoding="UTF-8"?&gt;
   &lt;ti:app xmlns:ti="<a href="http://ti.appcelerator.org" rel="nofollow" target="_blank">http://ti.appcelerator.org</a>"&gt;
       &lt;id&gt;com.tamir.wakeapp&lt;/id&gt;
       &lt;name&gt;wakeapp&lt;/name&gt;
       &lt;version&gt;1.0&lt;/version&gt;
       &lt;publisher&gt;tamir&lt;/publisher&gt;
       &lt;url&gt;undefined&lt;/url&gt;
       &lt;description&gt;undefined&lt;/description&gt;
       &lt;copyright&gt;2016 by tamir&lt;/copyright&gt;
       &lt;icon&gt;appicon.png&lt;/icon&gt;
       &lt;fullscreen&gt;false&lt;/fullscreen&gt;
       &lt;navbar-hidden&gt;false&lt;/navbar-hidden&gt;
       &lt;analytics&gt;true&lt;/analytics&gt;
       &lt;guid&gt;996fbe63-xxxx-xxxx-xxxx-49ba79a8eee9&lt;/guid&gt;
       &lt;property name="ti.ui.defaultunit" type="string"&gt;dp&lt;/property&gt;
       &lt;ios&gt;
           &lt;enable-launch-screen-storyboard&gt;true&lt;/enable-launch-screen-storyboard&gt;
           &lt;plist&gt;
               &lt;dict&gt;
                   &lt;key&gt;NSLocationAlwaysUsageDescription&lt;/key&gt;
                   &lt;string&gt;we need to keep track of your location to wake you up when you arrive at your destination&lt;/string&gt;
                   &lt;key&gt;NSMicrophoneUsageDescription&lt;/key&gt;
                   &lt;string&gt;because&lt;/string&gt;
                   &lt;key&gt;NSAppleMusicUsageDescription&lt;/key&gt;
                   &lt;string&gt;enable if you wish to use songs from your music library&lt;/string&gt;
                   &lt;key&gt;UISupportedInterfaceOrientations&lt;/key&gt;
                   &lt;array&gt;
                       &lt;string&gt;UIInterfaceOrientationPortrait&lt;/string&gt;
                   &lt;/array&gt;
                   &lt;key&gt;UIBackgroundModes&lt;/key&gt;
                   &lt;array&gt;
                       &lt;string&gt;audio&lt;/string&gt;
                   &lt;/array&gt;
                   &lt;key&gt;UIRequiresPersistentWiFi&lt;/key&gt;
                   &lt;false/&gt;
                   &lt;key&gt;UIPrerenderedIcon&lt;/key&gt;
                   &lt;false/&gt;
                   &lt;key&gt;UIStatusBarHidden&lt;/key&gt;
                   &lt;false/&gt;
                   &lt;key&gt;UIStatusBarStyle&lt;/key&gt;
                   &lt;string&gt;UIStatusBarStyleDefault&lt;/string&gt;
               &lt;/dict&gt;
           &lt;/plist&gt;
       &lt;/ios&gt;
       &lt;android xmlns:android="<a href="http://schemas.android.com/apk/res/android" rel="nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"/&gt;
       &lt;mobileweb&gt;
           &lt;precache/&gt;
           &lt;splash&gt;
               &lt;enabled&gt;true&lt;/enabled&gt;
               &lt;inline-css-images&gt;true&lt;/inline-css-images&gt;
           &lt;/splash&gt;
           &lt;theme&gt;default&lt;/theme&gt;
       &lt;/mobileweb&gt;
       &lt;modules&gt;
           &lt;module platform="commonjs"&gt;ti.cloud&lt;/module&gt;
       &lt;/modules&gt;
       &lt;deployment-targets&gt;
           &lt;target device="android"&gt;false&lt;/target&gt;
           &lt;target device="ipad"&gt;false&lt;/target&gt;
           &lt;target device="iphone"&gt;true&lt;/target&gt;
           &lt;target device="mobileweb"&gt;false&lt;/target&gt;
           &lt;target device="windows"&gt;false&lt;/target&gt;
       &lt;/deployment-targets&gt;
       &lt;sdk-version&gt;6.0.3.v20170314141715&lt;/sdk-version&gt;
       &lt;plugins&gt;
           &lt;plugin version="1.0"&gt;ti.alloy&lt;/plugin&gt;
       &lt;/plugins&gt;
   &lt;/ti:app&gt;
   
   </pre></code>
   
   When I said try multiple times I meant it.</li>
<li>Tamir Ishay Sharbat 2017-03-17

   have you experienced the bug yet?</li>
<li>Motiur Rahman 2017-03-24

   Any updates on it?</li>
<li>Hans Knöchel 2017-03-24

   Hey Tamir,
   
   I am still not getting the error any more when using the background-modes like in the example project. I also cleaned up the event-handling of the app.js to only register the events when the audio permissions are granted properly. Try this please:
   <code><pre>
   var recorder = null;
   
   var win = Ti.UI.createWindow({
   	backgroundColor : 'green',
   	layout : "vertical"
   });
   
   win.addEventListener("open", function() {
   	if (!Ti.Media.hasAudioPermissions()) {
   		Ti.Media.requestAudioPermissions(function(e) {
   			if (!e.success) {
   				alert("Audio Recording Permissions not granted. Skipping!");
   				return;
   			}		
   			
   			Ti.API.info('Audio Recorder Permissions now granted!');
   			initializeAudioEvents();
   		});
   	} else {
   		Ti.API.info('Audio Recorder Permissions already granted!');
   		initializeAudioEvents();
   	}
   });
    
   win.open();
   
   function initializeAudioEvents() {
   	recorder = Ti.Media.createAudioRecorder();
   
   	Ti.App.addEventListener("resumed", onResume);
   	Ti.App.addEventListener("pause", onPause);
   }
    
   function onResume() {
   	if (!recorder) {
   		return;
   	}
    
   	recorder.stop();
    
   	Ti.Media.audioSessionCategory = Ti.Media.AUDIO_SESSION_CATEGORY_PLAYBACK;
   	
   	Ti.API.warn("category: " + Ti.Media.audioSessionCategory);
   	Ti.API.warn("playback: " + Ti.Media.AUDIO_SESSION_CATEGORY_PLAYBACK);
   	
   	Ti.API.info("onResume");
    
   }
    
   function onPause() {
   	if (!recorder) {
   		return;
   	}
    
   	Ti.Media.audioSessionCategory = Ti.Media.AUDIO_SESSION_CATEGORY_PLAY_AND_RECORD;
    
   	Ti.API.warn("category: " + Ti.Media.audioSessionCategory);
       Ti.API.warn("play_and_record: " + Ti.Media.AUDIO_SESSION_CATEGORY_PLAY_AND_RECORD);
       
   	recorder.start();
   	Ti.API.info("onPause");
   }
   </pre></code>
   
   And for better debugging, please go to <code>~/Library/Application Support/Titanium/mobilesdk/osx/6.0.3.GA/iphone/Classes/TiMediaAudioSession.m</code> and change the line 45 to <code>DebugLog(@"Could not activate session: %@ (%ld)", error.localizedDescription, error.code);</code>, so we can see what's the actual error and code. Thx!
   
   P.S.: Also note that you have to know that when you force-quit the app and open it again, it will of course create a new recorder instance to record, so you should really be careful with adding the global events. I am not sure how this is natively done, but you could probably store the current audio session ID and check if that one is currently running before creating a new recorder. I hope that's clear to understand.</li>
<li>Hans Knöchel 2017-03-24

    I was just able to reproduce the error and received the internal error code <code>561015905</code>, which means that the audio session could not be activated from the background. Digging more into it, it looks like you cannot start audio sessions from the background (especially not when the app gets closed). See [this](<a href="https://forums.developer.apple.com/thread/38917)" rel="nofollow" target="_blank">https://forums.developer.apple.com/thread/38917)</a> and [this](<a href="https://developer.apple.com/reference/avfoundation/avaudiosessionerrorcode/avaudiosessionerrorcodecannotstartplaying)" rel="nofollow" target="_blank">https://developer.apple.com/reference/avfoundation/avaudiosessionerrorcode/avaudiosessionerrorcodecannotstartplaying)</a> link for more technical details from Apple directly. So I have to correct myself: You can record when the app is paused (not terminated), but only when you start the recording in the foreground already. The background modes are for that state, but also primarily for *playing* audio, which also works when the app is terminated. I hope that helps a bit. Please feel free to get in touch with Apple for more detailed API behaviors, thanks!</li>
<li>Tamir Ishay Sharbat 2017-03-25

    thanks Hans, good to know that.
    
    I have question that isn't entirely on subject. Do you have any idea about the kind of background mode sleep cycle is using?
    (it's not audio recording I checked by disabling the microphone for the app and this still works. plus when I use the microphone in the background the lock screen looks differently than what it looks like when sleep cycle is in the background.)
    If not, do you have any idea about who can I talk to about that?
    
    thanks in advance, Tamir.</li>
<li>Hans Knöchel 2017-03-25

    Hey Tamir, that's a very general iOS question. I'd ask a new question on StackOverflow, there are audio-related experts that will be able to give you a solid answer on that, I'd need to do some more research to do the same. Thanks man!</li>
<li>Lee Morris 2017-05-31

    Closing this issue as the problem is not our bug.</li>
</ol>


<p><a href="/TIMOB/TIMOB-24476.json">JSON Source</a></p>