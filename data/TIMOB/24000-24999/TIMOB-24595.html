---
title: "[TIMOB-24595] Windows: Hyperloop addEventListener doesn't work"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-05-01T18:22:54.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 6.1.0, Hyperloop 2.1.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.1.0</td></tr>
<tr><th>Components</th><td>Windows</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Kota Iguchi</td></tr>
<tr><th>Assignee</th><td>Kota Iguchi</td></tr>
<tr><th>Created</th><td>2017-04-19T05:58:20.000+0000</td></tr>
<tr><th>Updated</th><td>2017-05-05T19:22:05.000+0000</td></tr>
</table>

<h3>Description</h3>

Use of Hyperloop <code>addEventListener</code> throws "unknow exception".

<code><pre>
var win = Ti.UI.createWindow({ backgroundColor: 'green' }),
    Button = require('Windows.UI.Xaml.Controls.Button'),
    button = new Button();

button.Content = "PUSH";
button.addEventListener('Tapped', function (e) {
    alert('pushed');
});

win.add(button);
win.open();
</pre></code>

*Expected*
Pushing "PUSH" button should show "pushed" dialog.

*Note*
After some investigation, I found that at some point of Titanium SDK update, we updated <code>uglify-js</code> but it looks like it contains breaking changes. Uglify-js doesn't resolve constructor (<code>init</code> property of <code>AST_Symbol</code> on its [scope analyzer](<a href="http://lisperator.net/uglifyjs/scope)." rel="nofollow" target="_blank">http://lisperator.net/uglifyjs/scope).</a> It looks like there was breaking changes there, maybe from uglify-js 2.8.x, because I saw uglify-js 2.7.x (Titanium SDK <code>6.1.0.v20170315131319</code>) worked fine.


<h3>Comments</h3>

<ol>
<li>Kota Iguchi 2017-04-19

   This is sample code to show the breaking-changes between <code>uglify-js@2.7.0</code> and <code>uglify-js@2.8.21</code>
   
   <code><pre>
   var UglifyJS = require('uglify-js'),
       topLevel = UglifyJS.parse('var A = require("We.should.resolve.this"), a = new A(); a.addEventListener();');
   
   topLevel.figure_out_scope();
   
   var walker = new UglifyJS.TreeWalker(function(node) {
     if (node instanceof UglifyJS.AST_Call && node.expression.property == 'addEventListener') {
       console.log(node.expression.expression.thedef.init);
     }
   });
   
   topLevel.walk(walker);
   </pre></code>
   
   *uglify-js@2.7.0 (Titanium SDK 6.1.0.v20170315131319)*
   
   <code><pre>
   AST_Node {
     end: 
      AST_Token {
        raw: undefined,
        file: null,
        comments_before: [],
        nlb: false,
        endpos: 54,
        endcol: 54,
        endline: 1,
        pos: 53,
        col: 53,
        line: 1,
        value: ')',
        type: 'punc' },
     start: 
      AST_Token {
        raw: undefined,
        file: null,
        comments_before: [],
        nlb: false,
        endpos: 50,
        endcol: 50,
        endline: 1,
        pos: 47,
        col: 47,
        line: 1,
        value: 'new',
        type: 'operator' },
     args: [],
     expression: 
      AST_Node {
        end: 
         AST_Token {
           raw: undefined,
           file: null,
           comments_before: [],
           nlb: false,
           endpos: 52,
           endcol: 52,
           endline: 1,
           pos: 51,
           col: 51,
           line: 1,
           value: 'A',
           type: 'name' },
        start: 
         AST_Token {
           raw: undefined,
           file: null,
           comments_before: [],
           nlb: false,
           endpos: 52,
           endcol: 52,
           endline: 1,
           pos: 51,
           col: 51,
           line: 1,
           value: 'A',
           type: 'name' },
        thedef: 
         { name: 'A',
           orig: [Object],
           scope: [Object],
           references: [Object],
           global: true,
           mangled_name: null,
           undeclared: false,
           constant: undefined,
           index: 0,
           id: 1,
           init: [Object] },
        name: 'A',
        scope: 
         AST_Node {
           end: [Object],
           start: [Object],
           body: [Object],
           cname: -1,
           enclosed: [Object],
           parent_scope: null,
           uses_eval: false,
           uses_with: false,
           functions: [Object],
           variables: [Object],
           directives: undefined,
           globals: [Object],
           nesting: 0 },
        frame: 0 } }
   </pre></code>
   
   *uglify-js@2.8.21 (Titanium SDK 6.1.0.v20170417190415)*
   
   <code><pre>
   undefined
   </pre></code></li>
<li>Hans Knöchel 2017-04-19

   We should *not* use any of the Titanium API's in Hyperloop, I hope this was the only case. Instead of using <code>addEventListener</code>, <code>removeEventListener</code> etc, the developer expects to use the native event handling instead (delegates on iOS, callbacks on Android, etc.). Or do I understand this wrong?</li>
<li>Kota Iguchi 2017-04-19

   {quote}
   > developer expects to use the native event handling instead
   {quote}
   
   We've been enabling <code>addEventListener/removeEventListener</code> on Hyperloop for Windows. (See also [Windows Runtime Direct API Access Event Handling](<a href="http://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/platform/latest/#</a>!/guide/Windows_Runtime_Direct_API_Access-section-src-43315893_WindowsRuntimeDirectAPIAccess-EventHandling)).  
   
   But yes, this should be an interesting point to discuss. Basically on Windows, C\+\+/CX uses <code>+=</code> to represent "add event listener" function like below. But the question is, do we have better style to represent this in JavaScript syntax?
   
   <code><pre>
   click_event_ = component-&gt;Tapped += ref new TappedEventHandler([this, ctx](Platform::Object^ sender, TappedRoutedEventArgs^ e) {
       // do something
   });
   </pre></code>
   
   Currently we've been using <code>addEventListener</code> for this like below.
   
   <code><pre>
   component.addEventListener('Tapped', function(e) {
       // do something
   });
   </pre></code>
   
   I was thinking <code>addEventListener</code> can be more familiar for JavaScript developers.
   
   We could do like below, regarding following C\+\+ syntax...but is this better?
   
   <code><pre>
   component.Tapped += function(e) {
       // do something
   };
   
   Or...?
   
   component.Tapped += new TappedEventHandler(function(e) {
       // do something
   });
   </pre></code>
   
   We could have better way to do this, any suggestions would be appreciated! (on)</li>
<li>Hans Knöchel 2017-04-19

   Puuh, yeah the syntax is really hard to map to JavaScript. How we do we handle the same syntax for other class usages?</li>
<li>Kota Iguchi 2017-04-19

   We just basically maps C\+\+/CX <code>ref new</code> with JavaScript <code>new</code>. Use of <code>+=</code> for adding event listener is kind of special syntax in C\+\+/CX. </li>
<li>Hans Knöchel 2017-04-19

   Yeah, the += could be misunderstood in JavaScript. I personally do like
   <code><pre>
   component.Tapped = new TappedEventHandler(function(e) {
       // do something
   });
   </pre></code>
   but only if people will understand it and you would agree. It looks like the closest syntax without interfering using custom/non-native methods. You decide! :-)</li>
<li>Kota Iguchi 2017-04-21

   I would prefer <code>+=</code> because it clearly indicates we are "adding" something. (<code>=</code> actually means different behavior (assign) on C# & C\+\+). I've create TIMOB-24612, because this new syntax is not going to happen on release 2.1.0.
   
   <code><pre>
   component.Tapped += new TappedEventHandler(function(e) {
       // do something
   })
   </pre></code></li>
<li>Kota Iguchi 2017-04-22

   <a href="https://github.com/appcelerator/titanium_mobile_windows/pull/974" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile_windows/pull/974</a></li>
<li>Hans Knöchel 2017-04-22

   [~kota] Removing from "Hyperloop 2.1.0" milestone, since it's an SDK-PR.</li>
<li>Kota Iguchi 2017-05-02

    Verified - <a href="https://github.com/appcelerator/titanium_mobile_windows/pull/974#pullrequestreview-35609940" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile_windows/pull/974#pullrequestreview-35609940</a></li>
<li>Samir Mohammed 2017-05-02

    Fix can be viewed in 6.2.0.v20170501192357 and  6.1.0.v20170501130025</li>
</ol>


<p><a href="/TIMOB/TIMOB-24595.json">JSON Source</a></p>