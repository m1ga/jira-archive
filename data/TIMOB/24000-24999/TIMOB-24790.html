---
title: "[TIMOB-24790] iOS: HTTPClient - URL with invalid characters causes a crash"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Cannot Reproduce</td></tr>
<tr><th>Resolution Date</th><td>2019-07-02T17:59:54.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 6.1.0</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>httpclient, ios</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Unknown</td></tr>
<tr><th>Created</th><td>2017-06-07T01:53:08.000+0000</td></tr>
<tr><th>Updated</th><td>2019-07-02T17:59:54.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
The HTTPClient will cause a crash on iOS when given a URL containing invalid characters such as:
* Space ' ' character.
* Percent '%' sign not followed by a hex digit.
* Unicode character.

*Steps to reproduce:*
<h4>Set up a Titanium project to use the attached JavaScript file.</h4>
<h4>Build and run for iOS.</h4>
<h4>Tap the "Send HTTP Request" button.</h4>

*Result:*
Crashes due to invalid characters in the URL.

*Expected Result:*
Should not crash. Should log a warning and/or invoke the onerror callback.

Even better, we should add "autoEncodeUrl" support to iOS for feature parity with Android and Windows Phone. By default, this property is set true. This way, invalid URLs will be automatically %-encoded.
<a href="http://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">http://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Network.HTTPClient-property-autoEncodeUrl

*Notes:*
* The attached project does not crash on Android. Invalid URLs are automatically encoded.
* Percent signs are the only characters that should not be automatically encoded. This is in case the given URL already contains %-encoded characters. If there is a lone percent sign without a hex value, then it should produce an invalid URL.

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-24790_62426/app.js">app.js</td></td><td>2017-06-07T01:52:26.000+0000</td><td>1043</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Hans Kn√∂chel 2017-06-07

   Good catch! It returns a <code>nil</code> values from [here](<a href="https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUtils.m#L926)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUtils.m#L926)</a>, causing the APSHTTPClient URL to be nil as well, the assertion then fails and the crash is produced. What's interesting is that the fix (like in [this line](<a href="https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUtils.m#L933))" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUtils.m#L933))</a> is already there, but not honored for URL's beginning with http/https. Not sure why that was done and what the best approach would be.
   
   *EDIT*: The way it was implemented was because of TIMOB-18765 - probably because the remote-URL case was not recognized. So we could:
   a) Add the encoding for both local and remote URL's (now: only local)
   b) Support the <code>autoEncodeUrl</code> property on iOS and check that one. Problem: We auto-encode it by default for local URL's already, how to handle that?</li>
<li>Joshua Quick 2017-06-07

   Hmm... I just noticed that iOS already auto-encodes http/https URL parameters. So, as long as the URL part to the left of the '?' are valid, it works fine. I tested it with the following URL...
   <code>http://localhost:40404/path?test=Hello World&percent=50%</code>
   
   ...and the above gave me the following encoded URL path and parameter in my test code...
   <code>/path?test=hello%20world&percent=50%25</code>
   
   So, it seems like our Objective-C "toURL" method was already intended to auto-encode by default. I can see that we call CFURLCreateStringByAddingPercentEscapes() [here](<a href="https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUtils.m#L917)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUtils.m#L917)</a> for an http/https URL's  path part, which would include the parameters. The toURL method just has the above mentioned bug and doesn't support disabling auto-encoding. So, I suppose if we were to add the ability to disable auto-encoding in the future, we could create another "toURL" method with an extra argument to enable/disable auto-encoding.
   
   Also, I noticed an issue with my URL parameter test above. We're not supposed to encode a space to %20 in URL parameters. We're supposed to encode them to '+' characters instead. That is, URL query parameters are supposed to use the "application/x-www-form-urlencoded" MIME format and the rest of the URL is supposed to follow the "RFC 2373" specification.
   <a href="https://en.wikipedia.org/wiki/Uniform_Resource_Identifier#Syntax" rel="nofollow" target="_blank">https://en.wikipedia.org/wiki/Uniform_Resource_Identifier#Syntax</a>
   
   I'm currently fixing URL auto-encoding issues on Android now and I'm finding the tricky things to handle are:
   * The username part of the URL (the part to the left of the <code>@hostname</code>) can be an e-mail account name. Which means it'll have an additional <code>@</code> character in the URL that'll have to be %-escaped. For example, <code><a href="http://john@domain.com@host.com" rel="nofollow" target="_blank">http://john@domain.com@host.com</a></code> would have to be escaped to <code><a href="http://john%40domain.com@host.com" rel="nofollow" target="_blank">http://john%40domain.com@host.com</a></code>. (This currently work on iOS now.)
   * The <code>:</code> and <code>@</code> characters don't have to be encoded in the URL's path, query parameters, or <code>#</code>fragment/anchor-tag. They only get special treatment in the authority part of the URL.
   * The <code>?</code> and <code>/</code> characters don't have to be encoded in the URL's query parameters or <code>#</code>fragment/anchor-tag.
   * Spaces should be encoded as <code>+</code> in the query parameters and as <code>%20</code> in all other places.  Note that the URL <code>#</code>fragment/anchor-tag comes after the query parameters. For example, <code><a href="http://host.com/my" rel="nofollow" target="_blank">http://host.com/my</a> path?test=hello world#my anchor</code> should be encoded to <code><a href="http://host.com/my%20path?test=hello+world#my%20anchor" rel="nofollow" target="_blank">http://host.com/my%20path?test=hello+world#my%20anchor</a></code>.
   * The existing %-encoded characters in the URL string should be preserved. A simple solution to this is to %-encode the given URL string, then replace all <code>%25</code> substrings with <code>%</code>. For example, a string such as <code>100%25</code> (intended to be decoded as <code>100%</code>) would be encoded as <code>100%2525</code> and then the substring substitution would turn it back to <code>100%25</code>. The only limitation is that standalone <code>%</code> characters without hex values would not get encoded, making the URL invalid... but I think this is the 1 ambiguous case we can't handle and it's fine.
   
   Is there a simple Objective-C function/method to auto-encode URLs? I hope so. I ask because the CFURLCreateStringByAddingPercentEscapes() function can create invalid URLs if applied to the entire URL string, which is probably why we don't do it. (On Android, there is no single magic Java function either and I have to do this myself.)
   
   Starting off, we may just want to fix the crash and let the URL be invalid. We can punt on the auto-encoding for now if we feel like it's a riskier change.</li>
</ol>


<p><a href="/TIMOB/TIMOB-24790.json">JSON Source</a></p>