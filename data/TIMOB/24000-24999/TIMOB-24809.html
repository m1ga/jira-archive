---
title: "[TIMOB-24809] Android: HTTPClient - \"onload\" not dispatched"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-06-14T17:41:53.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 6.1.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.1.1</td></tr>
<tr><th>Components</th><td>n/a</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>gianluca</td></tr>
<tr><th>Assignee</th><td>Yordan Banev</td></tr>
<tr><th>Created</th><td>2017-06-12T08:53:19.000+0000</td></tr>
<tr><th>Updated</th><td>2017-06-15T19:02:16.000+0000</td></tr>
</table>

<h3>Description</h3>

When an instance of TiHTTPClient is reused for another request with a file passed in the data the contentLength is not calculated properly. The request passes but the "onLoad" event is not dispatched.

*Test case*:

Click "Get Photos", wait for the reponse, dismiss the alert, and then click "Upload photo" - the request finishes but the "onload" event listener is not called.

<code><pre>
var window = Ti.UI.createWindow();
var buttonUpload = Ti.UI.createButton({title:"Upload", top:50});
var buttonGetPhotos = Ti.UI.createButton({title:"Get Photos", top: 110});
var xhr = Titanium.Network.createHTTPClient({timeout:5000});
 
var tempF = Ti.Filesystem.getFile(Ti.Filesystem.resourcesDirectory,"simpleTest.png");
Ti.API.info(tempF);
 
buttonUpload.addEventListener('click', function (e) {
    xhr.open("POST","<a href="https://requestb.in/zwfzmzzw" rel="nofollow" target="_blank">https://requestb.in/zwfzmzzw</a>");

    var data_to_send = {
        "file": tempF.read(),
    };
 
    xhr.onload = function () {(alert(this.responseText))};
    xhr.send(data_to_send);
});
 
buttonGetPhotos.addEventListener('click', function (e) {    
    xhr.open("POST","<a href="https://requestb.in/zwfzmzzw" rel="nofollow" target="_blank">https://requestb.in/zwfzmzzw</a>");

    var params = {
            id:46
    };
 
    xhr.onload = function (e) {alert(this.responseText)};
    xhr.send(params);
});
 
window.add(buttonGetPhotos);
window.add(buttonUpload);
window.open();
</pre></code>

_Another instance of requestb.in may need to be created for testing._

*Console Log:*

<code><pre>
E/TiHTTPClient: (TiHttpClient-2) [142,13649] HTTP Error (java.lang.IllegalStateException): state: 2
                java.lang.IllegalStateException: state: 2
                    at com.android.okhttp.internal.http.HttpConnection.readResponse(HttpConnection.java:186)
                    at com.android.okhttp.internal.http.HttpTransport.readResponseHeaders(HttpTransport.java:80)
                    at com.android.okhttp.internal.http.HttpEngine.readNetworkResponse(HttpEngine.java:906)
                    at com.android.okhttp.internal.http.HttpEngine.readResponse(HttpEngine.java:782)
                    at com.android.okhttp.internal.huc.HttpURLConnectionImpl.execute(HttpURLConnectionImpl.java:463)
                    at com.android.okhttp.internal.huc.HttpURLConnectionImpl.getResponse(HttpURLConnectionImpl.java:405)
                    at com.android.okhttp.internal.huc.HttpURLConnectionImpl.getResponseCode(HttpURLConnectionImpl.java:521)
                    at com.android.okhttp.internal.huc.DelegatingHttpsURLConnection.getResponseCode(DelegatingHttpsURLConnection.java:105)
                    at com.android.okhttp.internal.huc.HttpsURLConnectionImpl.getResponseCode(HttpsURLConnectionImpl.java)
                    at ti.modules.titanium.network.TiHTTPClient$ClientRunnable.run(TiHTTPClient.java:1231)
                    at java.lang.Thread.run(Thread.java:761)
</pre></code>


<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-24809_62636/simpleTest.png">simpleTest.png</td></td><td>2017-06-12T08:54:34.000+0000</td><td>6826</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Yordan Banev 2017-06-12

   PR(master): <a href="https://github.com/appcelerator/titanium_mobile/pull/9139" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9139</a>
   PR(6_1_X): <a href="https://github.com/appcelerator/titanium_mobile/pull/9140" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9140</a></li>
<li>Samir Mohammed 2017-06-15

   Verified in SDK Version 6.1.1.v20170614134051 and 6.2.0.v20170614131253. Test and other information can be found at: 
   PR(master): <a href="https://github.com/appcelerator/titanium_mobile/pull/9139" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9139</a>
   PR(6_1_X): <a href="https://github.com/appcelerator/titanium_mobile/pull/9140" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9140</a></li>
</ol>


<p><a href="/TIMOB/TIMOB-24809.json">JSON Source</a></p>