---
title: "[TIMOB-24830] iOS: Cache module after the first require() call (regression to 5.x)"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-07-27T08:33:54.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 6.1.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.1.2</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>ios, merge-6.1.2, regression, require</td></tr>
<tr><th>Reporter</th><td>Sergey Nosenko</td></tr>
<tr><th>Assignee</th><td>Christopher Williams</td></tr>
<tr><th>Created</th><td>2017-06-14T00:56:31.000+0000</td></tr>
<tr><th>Updated</th><td>2017-07-27T16:38:40.000+0000</td></tr>
</table>

<h3>Description</h3>

After adding NodeJS style require we have a regression with huge performance issue. Previously all modules were required() only once. Now every module including Alloy models, controllers, and widgets are looking for a lot of places on each require call.


simple replace of this code in KrollBridge.m

<code><pre>
else if ([path hasPrefix:@"/"]) {
  module = [self loadAsFileOrDirectory:[[path substringFromIndex:1] stringByStandardizingPath] withContext:context];
  if (module) {
    return module;
  }
}
</pre></code>

to old style:
<code><pre>
else if ([path hasPrefix:@"/"]) {
	module = [modules objectForKey:path];
	if (module != nil) {
	    return module;
	}
	module = [self loadAsFileOrDirectory:[[path substringFromIndex:1] stringByStandardizingPath] withContext:context];
	if (module) {
	    [modules setObject:module forKey:path];
	    return module;
	}
}
</pre></code>

makes an application ten times more responsive in case you have a lot Alloy.createModel or Alloy.createController.

and rid out logs like:
<code><pre>
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/node_modules/alloy/models/ServerCommonMasterTable/index.js, Resource: node_modules/alloy/models/ServerCommonMasterTable/index_js
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/node_modules/alloy/models/ServerCommonMasterTable/index.json, Resource: node_modules/alloy/models/ServerCommonMasterTable/index_json
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/alloy/models/ServerCommonMasterTable, Resource: alloy/models/ServerCommonMasterTable
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/alloy/models/ServerCommonMasterTable.js, Resource: alloy/models/ServerCommonMasterTable_js
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/node_modules/alloy/models/ServerCommonMasterTable, Resource: node_modules/alloy/models/ServerCommonMasterTable
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/node_modules/alloy/models/ServerCommonMasterTable.js, Resource: node_modules/alloy/models/ServerCommonMasterTable_js
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/node_modules/alloy/models/ServerCommonMasterTable.json, Resource: node_modules/alloy/models/ServerCommonMasterTable_json
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/node_modules/alloy/models/ServerCommonMasterTable/package.json, Resource: node_modules/alloy/models/ServerCommonMasterTable/package_json
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/node_modules/alloy/models/ServerCommonMasterTable/index.js, Resource: node_modules/alloy/models/ServerCommonMasterTable/index_js
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/node_modules/alloy/models/ServerCommonMasterTable/index.json, Resource: node_modules/alloy/models/ServerCommonMasterTable/index_json
[DEBUG] :  Loading: /Users/npatel/Library/Developer/CoreSimulator/Devices/E263476D-A174-40E7-A1BB-C300E0C1E468/data/Containers/Bundle/Application/CCB3551A-D92F-4555-8B85-1C17871EF502/Residential Test.app/node_modules/alloy/models/ServerCommonMasterTable, Resource: node_modules/alloy/models/ServerCommonMasterTable
</pre></code>

<h3>Comments</h3>

<ol>
<li>Sergey Nosenko 2017-06-14

   this is how Nodjs works with require:
   <code><pre>
   Module._load = function(request, parent, isMain) {
     // 1. Check Module._cache for the cached module.
     // 2. Create a new Module instance if cache is empty.
     // 3. Save it to the cache.
     // 4. Call module.load() with your the given filename.
     //    This will call module.compile() after reading the file contents.
     // 5. If there was an error loading/parsing the file,
     //    delete the bad module from the cache
     // 6. return module.exports
   };
   </pre></code></li>
<li>Hans Knöchel 2017-06-15

   Hey there, tackling the issue now. Discussed it with [~cwilliams], we should also cache the [relative paths](<a href="https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/KrollBridge.m#L1165)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/KrollBridge.m#L1165)</a> the same way. Preparing a PR now.</li>
<li>Sergey Nosenko 2017-06-15

   I already did following. Do you need a PR?
   <code><pre>
   		// 2. If X begins with './' or '/' or '../'
           if ([path hasPrefix:@"./"] || [path hasPrefix:@"../"]) {
               // Need base path to work from for relative modules...
               NSString *workingPath = [oldURL relativePath];
               NSString *relativePath = (workingPath == nil) ? path : [workingPath stringByAppendingPathComponent:path];
               module = [modules objectForKey:relativePath];
               if (module != nil) {
                   return module;
               }
               module = [self loadAsFileOrDirectory:[relativePath stringByStandardizingPath] withContext:context];
               if (module) {
                   [modules setObject:module forKey:relativePath];
                   return module;
               }
               // Treat '/' special as absolute, drop the leading '/'
           }
           else if ([path hasPrefix:@"/"]) {
               module = [modules objectForKey:path];
               if (module != nil) {
                   return module;
               }
               module = [self loadAsFileOrDirectory:[[path substringFromIndex:1] stringByStandardizingPath] withContext:context];
               if (module) {
                   [modules setObject:module forKey:path];
                   return module;
               }         
   </pre></code></li>
<li>Hans Knöchel 2017-06-16

   *PR* (By Chris): <a href="https://github.com/appcelerator/titanium_mobile/pull/9158" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9158</a>
   
   *Test-Case*:
   1. Create a new app with <code>appc new -p ios</code>
   2. Create a file called <code>file.js</code> in <code>app/lib</code> and paste the following into it:
   <code><pre>
   exports.hello = 'World!';
   </pre></code>
   3. Paste the following to the <code>index.js</code> (Alloy)
   <code><pre>
   var test1 = require('/file'); // Will load the module for the first time and cache it
   var test2 = require('/file'); // Will use a cached reference of the module
   
   var win = Ti.UI.createWindow({
       backgroundColor: '#fff'
   });
   
   var btn = Ti.UI.createButton({
       title: 'Log Exports'
   });
   
   btn.addEventListener('click', function() {
   	console.log('#1' + test1.hello);
   	console.log('#2 ' + test2.hello);
   });
   
   win.add(btn);
   win.open();
   </pre></code></li>
<li>Hans Knöchel 2017-07-20

   Backport (6.1.2): <a href="https://github.com/appcelerator/titanium_mobile/pull/9232" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9232</a>
   Backport (6.2.0): <a href="https://github.com/appcelerator/titanium_mobile/pull/9238" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9238</a></li>
<li>Abir Mukherjee 2017-07-26

   Passed FR. Details are in github (in the PR). I'll merge as soon as [~hknoechel] confirms the intermittent failing unit tests are not an issue.</li>
<li>Abir Mukherjee 2017-07-27

   Closing ticket as fix is found in SDK 6.1.2.v20170727014823.</li>
</ol>


<p><a href="/TIMOB/TIMOB-24830.json">JSON Source</a></p>