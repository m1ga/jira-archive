---
title: "[TIMOB-24893] Windows: onreadystatechange should not be called on the UI thread"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-08-25T12:40:42.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 6.2.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.2.0</td></tr>
<tr><th>Components</th><td>Windows</td></tr>
<tr><th>Labels</th><td>regression</td></tr>
<tr><th>Reporter</th><td>Ewan Harris</td></tr>
<tr><th>Assignee</th><td>Kota Iguchi</td></tr>
<tr><th>Created</th><td>2017-06-26T14:15:52.000+0000</td></tr>
<tr><th>Updated</th><td>2017-08-28T15:20:41.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Description</h4>

**The code below is a boiled down version of how LiveView makes http requests so it is crucial for this to work**

The following code below appears to freeze the application, I believe this is because HTTPClient is running things such as onreadystatechange on the UI thread which is being blocked by the while loop, the following diff appears to fix the issue but I am not sure whether the changes were required <a href="https://gist.github.com/ewanharris/f45cf4347759247a3965e02161342fde" rel="nofollow" target="_blank">https://gist.github.com/ewanharris/f45cf4347759247a3965e02161342fde</a>

<code><pre>
var win = Ti.UI.createWindow(),
    btn = Ti.UI.createButton({
        title: 'HTTP GET'
    });
btn.addEventListener('click', function () {
    var request = Ti.Network.createHTTPClient({
        onload: function () {
            alert('onload:\n\treadyState: ' + request.readyState);
        },
        onerror: function (e) {
            alert('onerror:\n\treadyState: ' + request.readyState + '\n\terror: ' + e.error);
        }
    }),
        timeout = new Date().getTime() + 5000,
        host = '<a href="http://www.google.com/" rel="nofollow" target="_blank">http://www.google.com/</a>',
        done = false;
    request.cache = false;
    request.open('GET', host);
    request.send();
    while (!done) {
        if (request.readyState === 4 || request.status === 404) {
            done = true;
            alert('success');
        } else if ((timeout - (new Date()).getTime()) &lt;= 0) {
            done = true;
            alert('failed');
        }
    }
});
win.add(btn);
win.open();

</pre></code>

<h4>Steps to reproduce</h4>

<h4>Add the above code to an existing app.js and build for Windows</h4>
<h4>Click the HTTP GET button</h4>

<h4>Actual</h4>

App appears to freeze (button stays in clicked position), failed alert appears

<h4>Expected</h4>

App should not appear to freeze, no failed alert should show

<h3>Comments</h3>

<ol>
<li>Ewan Harris 2017-07-27

   Assigning this to 6.2.0 as it is a regression and breaks liveview</li>
<li>Kota Iguchi 2017-08-11

   Basically we need to ensure all JavaScript callbacks including <code>onload</code> and <code>onerror</code> should be called from UI thread especially on Windows 10 Store app, otherwise the app will crash. That's what TIMOB-24671 originally meant. For instance even following simple app crashes when you don't use <code>RunOnUIThread</code>. I would think that waiting <code>readyState</code> in while loop was basically a bad idea, but for a quick workaround I would suggest just removing <code>RunOnUIThread</code> from <code>onreadystate</code> for now, and deprecate listening <code>onreadystate</code> event on Windows Store app?
   
   <code><pre>
   var win = Ti.UI.createWindow(),
       btn = Ti.UI.createButton({
           title: 'HTTP GET'
       });
   btn.addEventListener('click', function () {
       var request = Ti.Network.createHTTPClient({
           onload: function () {
               alert('onload:\n\treadyState: ' + request.readyState);
           },
           onerror: function (e) {
               alert('onerror:\n\treadyState: ' + request.readyState + '\n\terror: ' + e.error);
           }
       }),
           timeout = new Date().getTime() + 5000,
           host = '<a href="http://www.theresnosuchdomain.com/" rel="nofollow" target="_blank">http://www.theresnosuchdomain.com/</a>',
           done = false;
       request.cache = false;
       request.open('GET', host);
       request.send();
   });
   win.add(btn);
   win.open();
   </pre></code></li>
<li>Kota Iguchi 2017-08-11

   Can't we just update the LiveView to use <code>setTimeout</code> instead of waiting in while loop? We can use <code>Ti.Platform.name == 'windows' </code> to ensure this change affects only for Windows.
   
   <code><pre>
       if (Ti.Platform.name == 'windows' ) {
           setTimeout(function () {
               if (request.readyState === 4 || request.status === 404) {
                   alert('success');
               } else if ((timeout - (new Date()).getTime()) &lt;= 0) {
                   alert('failed');
               }
           }, timeout);
       }
   </pre></code></li>
<li>Ewan Harris 2017-08-14

   [~kiguchi] While I do agree that we could and should change LiveView I think we'd still need to revert the changes as we can't break usage in a minor. Also I'm not sure whether we're planning to release Studio alongside 6.2.0 which would be required if we made the changes in LiveView</li>
<li>Kota Iguchi 2017-08-15

   <a href="https://github.com/appcelerator/titanium_mobile_windows/pull/1075" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile_windows/pull/1075</a></li>
<li>Ewan Harris 2017-08-25

   6_2_X backport: <a href="https://github.com/appcelerator/titanium_mobile_windows/pull/1086" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile_windows/pull/1086</a></li>
<li>Ewan Harris 2017-08-28

   Verified in 6.2.0.v20170825165823. Changes are not in master (7.0.0) yet though, will hold on closing til it is</li>
<li>Ewan Harris 2017-08-28

   Aaaand verified in 7.0.0.v20170828071347, closing ticket</li>
</ol>


<p><a href="/TIMOB/TIMOB-24893.json">JSON Source</a></p>