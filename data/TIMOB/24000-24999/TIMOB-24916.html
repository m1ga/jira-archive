---
title: "[TIMOB-24916] [iOS] Application crashes when \"Ti.Geolocation.getLastGeolocation\" is called before a geoLocation is set "
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-07-11T23:46:19.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 6.2.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.2.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Samir Mohammed</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2017-06-30T17:15:30.000+0000</td></tr>
<tr><th>Updated</th><td>2017-07-20T21:09:22.000+0000</td></tr>
</table>

<h3>Description</h3>

When <code>Ti.Geolocation.getLastGeolocation</code> is called before a geoLocaiton has been set the application crashes and the log displays the following error. 
<code><pre>
[ERROR] :  Script Error {
[ERROR] :      column = 967;
[ERROR] :      line = 1;
[ERROR] :      message = "*** +[NSJSONSerialization dataWithJSONObject:options:error:]: value parameter is nil";
[ERROR] :      sourceURL = "file:///var/containers/Bundle/Application/E14637A6-6008-4878-868B-BE5E7555A790/T8.app/app.js";
[ERROR] :      stack = "[native code]\nfile:///var/containers/Bundle/Application/E14637A6-6008-4878-868B-BE5E7555A790/T8.app/app.js:1:967";
[ERROR] :  }
</pre></code>
This is different to Android and 6.1.1.GA where the log instead showed: 
<code><pre>
[DEBUG] :  Location undefined
</pre></code>

*Test Steps*
1. Create a new titanium project using SDK version: 6.2.0.v20170630062735
2. Add the following code to the <code>app.js</code>
<code><pre>
Titanium.UI.setBackgroundColor('#000');
var win1 = Titanium.UI.createWindow({  
    title:'Geo Test',
    backgroundColor:'#fff'
});
var label1 = Titanium.UI.createLabel({
	color:'#999',
	text:'GEO TEST',
	font:{fontSize:20,fontFamily:'Helvetica Neue'},
	textAlign:'center',
	width:'auto',top:280
});
win1.add(label1);
 
var btn1 = Ti.UI.createButton({title:'Last analytics',top:10,left:10,right:10,height:80});
btn1.addEventListener('click',function(){Ti.API.debug('Event?'); label1.text = 'Event: ' + Ti.Analytics.lastEvent;});
win1.add(btn1);
 
var btn2 = Ti.UI.createButton({title:'Start Geo',top:100,left:10,right:10,height:80});
btn2.addEventListener('click',function(){Ti.API.debug('Geo Started!'); 

	Titanium.Geolocation.addEventListener('location',function(e)
	
	{
		if (e.error)
		{
			label1.text = 'error: ' + e.error;
			return;
		}
	});
});
win1.add(btn2);

var btn3 = Ti.UI.createButton({title:'Get Geo',top:190,left:10,right:10,height:80});
btn3.addEventListener('click',function(){Ti.API.debug("Location " + Ti.Geolocation.getLastGeolocation()); 
});
win1.add(btn3);

win1.open();
</pre></code>
3. Run the application on an iOS device 
4. Once the application has launched press the <code>Get Geo</code> button 

*Expected result*
Application should not crash and the log should display the following message 
<code><pre>
[DEBUG] :  Location undefined
</pre></code>

*Actual result*
Application crashes and the above error message is displayed

NOTE:* This could also be why some of the newer Jenkins builds have been failing as the test case for this failed in a few builds.  


<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2017-07-02

   PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/9186" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9186</a></li>
<li>Samir Mohammed 2017-07-20

   Verified fix in SDK Version: 6.2.0.v20170719160617 . Test and other information can be found at: 
   <a href="https://github.com/appcelerator/titanium_mobile/pull/9186" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9186</a> </li>
</ol>


<p><a href="/TIMOB/TIMOB-24916.json">JSON Source</a></p>