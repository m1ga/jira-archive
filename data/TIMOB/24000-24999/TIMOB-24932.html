---
title: "[TIMOB-24932] Android Hybrid modules: cannot instantiate a proxy in a js file that is packaged in the same module"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-07-11T16:57:48.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.1.2</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, module</td></tr>
<tr><th>Reporter</th><td>Andrea Vitale</td></tr>
<tr><th>Assignee</th><td>Christopher Williams</td></tr>
<tr><th>Created</th><td>2017-07-05T08:45:24.000+0000</td></tr>
<tr><th>Updated</th><td>2017-07-20T22:29:16.000+0000</td></tr>
</table>

<h3>Description</h3>

Suppose that I have a module is called <code>it.andreavitale.commonjs.test</code>:
it has a <code>it.andreavitale.commonjs.test.js</code> file inside <code>my-module/android/assets</code> folder and a proxy file under <code>my-module/android/src/it/andreavitale/commonjs/test/ExampleProxy.java</code>

If inside <code>it.andreavitale.commonjs.test.js</code> file I call <code>require('it.andreavitale.commonjs.test').createExample()</code> I always get this error:

<code><pre>
[ERROR] TiExceptionHandler: (main) [126,126] ----- Titanium Javascript Runtime Error -----
[ERROR] TiExceptionHandler: (main) [0,126] - In ti:/module.js:129,37
[ERROR] TiExceptionHandler: (main) [0,126] - Message: Uncaught TypeError: Cannot read property 'length' of undefined
[ERROR] TiExceptionHandler: (main) [0,126] - Source:     var invocationsLen = invocationAPIs.length;
[ERROR] V8Exception: Exception occurred at ti:/module.js:129: Uncaught TypeError: Cannot read property 'length' of undefined
</pre></code>

If I call <code>require('it.andreavitale.commonjs.test').createExample()</code> inside my app alloy.js the proxy is correctly created.

I attach a sample module project to reproduce the error.
If you comment the line <code>9</code> inside <code>android/assets/it.andreavitale.commonjs.test.js</code> and you run the example app everything will work fine.

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24932_62831/commonjs-test.zip">commonjs-test.zip</td></td><td>2017-07-05T08:39:45.000+0000</td><td>867279</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-24932_62832/it.andreavitale.commonjs.test-android-1.0.0.zip">it.andreavitale.commonjs.test-android-1.0.0.zip</td></td><td>2017-07-05T11:48:36.000+0000</td><td>50553</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Ewan Harris 2017-07-05

   I am able to reproduce the issue using the below
   
   Ti SDK: 6.1.1.GA
   OnePlus 3 7.1.1
   
   <h4>Add the attached module zip (it.andreavitale.commonjs.test-android-1.0.0.zip) either globally or in your app</h4>
   <h4>Add the below code and tiapp module entry to your app</h4>
   <h4>Build for Android (device or emulator)</h4>
   
   <code><pre>
   var win = Ti.UI.createWindow({ backgroundColor: 'green', layout: 'vertical' });
   var x = require("it.andreavitale.commonjs.test");
   x.sayHello();
   win.open();
   </pre></code>
   
   <code><pre>
   &lt;modules&gt;
       &lt;module&gt;it.andreavitale.commonjs.test&lt;/module&gt;
   &lt;/modules&gt;
   </pre></code></li>
<li>Christopher Williams 2017-07-07

   So I'm not entirely sure this is really a bug here, or at least I think there's a simple workaround to avoid this. What happens when we create a hybrid module is that the CommonJS file and the native module get "merged". In practice what that really means is that we instantiate the native module, then we load the commonjs file as a module and "copy" all the own properties of the module.exports from it onto the native module's wrapper object.
   
   So in this case, if you wanted to invoke the native module's createExample() in the commonjs portion, you'd actually call <code>this.createExample();</code>
   
   Here's the whole file:
   <code><pre>
   module.exports = {
       secondFile: require("it.andreavitale.commonjs.test/another.file"),
       sayHello: function() {
           alert('hello');
   
           Ti.API.info("Creating Example proxy");
   
           // This will not work
           // return require("it.andreavitale.commonjs.test").createExample();
           //This WILL work
           return this.createExample();
       }
   };
   </pre></code>
   
   Calling <code>require("module.id")</code> from the commonjs extension file may just confuse the system a bit. I think specifically our caching of the combined native + CommonJS  is somehow getting confused in this specific case. We cache the native module portion globally, but the combined native+CommonJS portion gets cached per-module (i.e. we try to re-generate it from each module that attempts to require it). We may still need to investigate and better handle this issue, but for now please just use "this".</li>
<li>Christopher Williams 2017-07-07

   6.1.2: <a href="https://github.com/appcelerator/titanium_mobile/pull/9206" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9206</a>
   master: <a href="https://github.com/appcelerator/titanium_mobile/pull/9207" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9207</a></li>
<li>Lokesh Choudhary 2017-07-11

   Passing review according to [~eharris]'s comments in the PR.</li>
<li>Abir Mukherjee 2017-07-13

   Closing ticket. The changes are compiled to a binary so I cannot see the actually. However by grepping contents, I am able to see ASCII texts in the file that was changed.  Changes are in SDK 6.1.2.v20170710160853.</li>
</ol>


<p><a href="/TIMOB/TIMOB-24932.json">JSON Source</a></p>