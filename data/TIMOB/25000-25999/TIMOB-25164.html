---
title: "[TIMOB-25164] Ti.iCloud: Inject iCloud SystemCapabilities via module-hook"
---
<table>
<tr><th>Type</th><td>New Feature</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-08-15T15:22:39.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Ti.iCloud 2.0.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>icloud, system-capabilities</td></tr>
<tr><th>Reporter</th><td>Dawson Toth</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2017-08-12T11:57:06.000+0000</td></tr>
<tr><th>Updated</th><td>2018-08-02T21:50:17.000+0000</td></tr>
</table>

<h3>Description</h3>

One of my apps uses the Ti.ICloud module, which works great, if you have the SystemCapabilities properly configured. The Xcode project generated by Titanium doesn't have the proper capabilities turned on. So I have to <code>--build-only</code>, run some regular expressions to fix the SystemCapabilities, and then <code>fastlane gym</code> my project to build and upload it as a part of my CI process. Outside of CI, I'd have to build from Xcode directly, if I want iCloud to work right.

If I run my regular expressions, and then do another <code>appc ti build</code>, my changes to project.pbxproj are wiped out, so that doesn't work either.

Is there any way to customize the capabilities in the generated project?

<code><pre>
SystemCapabilities = {
	com.apple.iCloud = {
		enabled = 1;
	};
	com.apple.InAppPurchase = {
		enabled = 1;
	};
};
</pre></code>

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2017-08-13

   Hey there! Can't you just use the entitlements-keys ?
   <code><pre>
   <?xml version="1.0" encoding="UTF-8"?>
   <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "<a href="http://www.apple.com/DTDs/PropertyList-1.0.dtd" rel="nofollow" target="_blank">http://www.apple.com/DTDs/PropertyList-1.0.dtd</a>">
   <plist version="1.0">
   <dict>
   	<key>com.apple.developer.icloud-container-identifiers</key>
   	<array/>
   	<key>com.apple.developer.ubiquity-kvstore-identifier</key>
   	<string>$(TeamIdentifierPrefix)$(CFBundleIdentifier)</string>
   </dict>
   </plist>
   </pre></code>
   If that does not work, the module should provide a hook to inject the keys. The [Ti.DynamicLib](<a href="https://github.com/appcelerator-modules/hook-embedded-frameworks/blob/master/ti.dynamiclib.js)" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/hook-embedded-frameworks/blob/master/ti.dynamiclib.js)</a> plugin does something similar to enable dynamic libraries in Titanium. You basically just jump from the UUID's of the different PBX-sections until you reach the <code>SystemCapabilities</code> section and then add the <code>com.apple.iCloud</code> object and set it to <code>true</code>. The module should provide that functionality already, so if you bought it, the vendor should add it.</li>
<li>Dawson Toth 2017-08-13

   I don't think the functionality existed when Matt wrote the original module, or when I worked on it. I finally thought to ask, years later... I'll add that support to it in the next couple of days and submit a PR.</li>
<li>Hans Knöchel 2017-08-13

   Is the module open source? I can only find a commercial version.</li>
<li>Dawson Toth 2017-08-14

   I'm not convinced this is "not our bug", given it's the Appcelerator enterprise version of the module that has trouble -- <a href="https://github.com/appcelerator-modules/ti.icloud" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.icloud</a> I'm guessing because it's enterprise, very few people have used it. Those that have used it have also figured out the Xcode settings or the Entitlements.plist. But if the general public tried to use it...
   
   There's even a guide on how to write it, essentially. It doesn't expose as many methods. Why not open source the module?
   <a href="http://www.lighthouselogic.com/icloud-in-titanium/" rel="nofollow" target="_blank">http://www.lighthouselogic.com/icloud-in-titanium/</a></li>
<li>Dawson Toth 2017-08-14

   The Ti.StoreKit module could exhibit the same behavior. If StoreKit is enabled in the generated project, it's not deliberately enabled by the module.</li>
<li>Hans Knöchel 2017-08-14

   Hey Dawson,
   
   I did not know it was an Appc-curated module. That makes it a whole different thing. For Ti.StoreKit, the capabilities are managed via the Entitlements.plist and the capabilities used in the provisioning profile. *EDIT*: Btw, the linked blog post also suggests to enable it via the entitlements file, which is necessary either way (since Xcode generates the file as well when you enable it).</li>
<li>Hans Knöchel 2017-08-14

   I've added a PoC PR of injecting the required "com.apple.iCloud" key [here](<a href="https://github.com/appcelerator-modules/ti.icloud/pull/2)." rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.icloud/pull/2).</a> It is untested for now and would need a closer look. I basically just went through the pbx file, looked up the required UUID to handle and rewrote the system-capabilities to enable the iCloud key.</li>
<li>Hans Knöchel 2017-08-15

   PR works for me, the <code>com.apple.iCloud</code> key is injected properly. Open-sourced the script [here](<a href="https://github.com/hansemannn/titanium-system-capabilities)" rel="nofollow" target="_blank">https://github.com/hansemannn/titanium-system-capabilities)</a> for everyone else who wants to use it!</li>
</ol>


<p><a href="/TIMOB/TIMOB-25164.json">JSON Source</a></p>