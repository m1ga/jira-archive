---
title: "[TIMOB-25319] iOS: Fails to package app when using CloudKit"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-09-20T22:08:40.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 6.3.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Chris Barber</td></tr>
<tr><th>Assignee</th><td>Chris Barber</td></tr>
<tr><th>Created</th><td>2017-09-19T16:50:24.000+0000</td></tr>
<tr><th>Updated</th><td>2017-09-21T03:33:13.000+0000</td></tr>
</table>

<h3>Description</h3>

When packaging an app that uses CloudKit, the IPA export fails:

<code><pre>
[DEBUG] Running: /Applications/Xcode-9-gm-seed.app/Contents/Developer/usr/bin/xcodebuild -exportArchive -archivePath "/Users/chris/appc/workspace/testapp3/build/iphone/testapp3.xcarchive" -exportPath "/Users/chris/appc/workspace/testapp3/dist" -exportOptionsPlist "/Users/chris/appc/workspace/testapp3/build/iphone/export_options.plist"
[TRACE] 2017-09-19 11:46:26.873 xcodebuild[38383:2547226] [MT] IDEDistribution: -[IDEDistributionLogging _createLoggingBundleAtPath:]: Created bundle at path '/var/folders/wx/j1v32g355xj28rnt9yb_6hfm0000gn/T/testapp3_2017-09-19_11-46-26.872.xcdistributionlogs'.
[TRACE] 2017-09-19 11:46:26.954 xcodebuild[38383:2547226] [MT] IDEDistribution: Step failed: <IDEDistributionOptionsStep: 0x7f99adee0400>: Error Domain=IDEFoundationErrorDomain Code=1 "exportOptionsPlist error for key 'iCloudContainerEnvironment': expected one of {Development, Production}, but no value was provided" UserInfo={NSLocalizedDescription=exportOptionsPlist error for key 'iCloudContainerEnvironment': expected one of {Development, Production}, but no value was provided}
[TRACE] error: exportArchive: exportOptionsPlist error for key 'iCloudContainerEnvironment': expected one of {Development, Production}, but no value was provided
[TRACE]
[TRACE] Error Domain=IDEFoundationErrorDomain Code=1 "exportOptionsPlist error for key 'iCloudContainerEnvironment': expected one of {Development, Production}, but no value was provided" UserInfo={NSLocalizedDescription=exportOptionsPlist error for key 'iCloudContainerEnvironment': expected one of {Development, Production}, but no value was provided}
</pre></code>

When packaging, the code needs to open the generated entitlements plist file and check if it is using CloudKit, then set the export option.

<h3>Comments</h3>

<ol>
<li>Chris Barber 2017-09-19

   Ti SDK master PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/9446" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9446</a>
   Ti SDK 6_3_X PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/9447" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9447</a>
   
   To test, you need to enable CloudKit. I probably did this the hard way, but here goes.
   
   1. Open the Titanium.xcodeproj in the installed SDK and enabled iCloud under Capabilities
   
   2. Add the following <code>Entitlements.plist</code> file to the ROOT of your Titanium project directory:
   
   <code><pre>
   <?xml version="1.0" encoding="UTF-8"?>
   <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "<a href="http://www.apple.com/DTDs/PropertyList-1.0.dtd" rel="nofollow" target="_blank">http://www.apple.com/DTDs/PropertyList-1.0.dtd</a>">
   <plist version="1.0">
   <dict>
   	<key>com.apple.developer.icloud-container-identifiers</key>
   	<array>
   		<string>iCloud.$(CFBundleIdentifier)</string>
   	</array>
   	<key>com.apple.developer.icloud-services</key>
   	<array>
   		<string>CloudDocuments</string>
   	</array>
   	<key>com.apple.developer.ubiquity-container-identifiers</key>
   	<array>
   		<string>iCloud.$(CFBundleIdentifier)</string>
   	</array>
   	<key>com.apple.developer.ubiquity-kvstore-identifier</key>
   	<string>$(TeamIdentifierPrefix)$(CFBundleIdentifier)</string>
   </dict>
   </plist>
   </pre></code>
   
   3. Add iCloud to your distribution provisioning profile and regenerate/install it
   
   4. Package your app for ad hoc or the app store
   
   Note that you need to specify an <code>\-\-output\-dir</code> when testing an app store build.</li>
<li>Eric Wieber 2017-09-20

   FR Passed, using:
   MacOS 10.12.6 (16G29)
   Ti SDK 6.3.0.v20170919115035
   Appc NPM 4.2.9
   Appc CLI 6.2.4
   Alloy 1.9.14
   Xcode 9.0 (9A235)
   
   Able to package projects using CloudKit for adhoc and app store without issue.</li>
<li>Eric Wieber 2017-09-21

   Verified in SDK builds 6.3.0.v20170920151245 & 7.0.0.v20170920153129</li>
</ol>


<p><a href="/TIMOB/TIMOB-25319.json">JSON Source</a></p>