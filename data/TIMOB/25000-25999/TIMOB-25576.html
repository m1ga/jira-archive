---
title: "[TIMOB-25576] Ensuring usage of macros bundled core utilities and shells when adding to iOS buildPhases"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2017-12-15T21:08:06.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 5.5.1, Release 6.3.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 7.0.2</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Richard Lustemberg</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2017-11-28T17:39:55.000+0000</td></tr>
<tr><th>Updated</th><td>2018-01-20T11:14:25.000+0000</td></tr>
</table>

<h3>Description</h3>

Either running from CLI ('appc run -p ios -T dist-appstore') or from Studio, building an xcarchive using the build scripts delivers a sort of corrupted build. 
The problem is that all assets are copied from the ArchiveStaging  build directory into a directory of the same name in the xcarchive directory.

{noformat}
DEBUG]  Copying /Users/richard/Code/Inzdr/inzdr_app/src/Inzdr/build/iphone/iNZDR.xcarchive/Products/Applications/iNZDR.app/ArchiveStaging/progress => /Users/richard/Library/Developer/Xcode/Archives/2017-11-28/iNZDR 2017-11-28 18-02-52.xcarchive/Products/
{noformat}
As a result all the assets are copied to the incorrect directory , 'ArchiveStaging' instead of the root of the xcarchive directory. 
The problem only happens on AppStore or Ad Hoc builds, but not on device builds. The computer in question has a relatively recent clean installation of High Sierra.

<h3>Comments</h3>

<ol>
<li>Richard Lustemberg 2017-11-29

   It looks like the build phase 'Copy resources to archive' is not executed.
   It should run <code>cp -rf "$PROJECT_DIR/ArchiveStaging"/ "$TARGET_BUILD_DIR/$PRODUCT_NAME.app/"</code> but it doesn't seem to be executed.</li>
<li>Richard Lustemberg 2017-11-29

   I found the cause. I had the homebrew package 'coreutils' installed, which has a different version of cp, which will copy the whole directory recursively , including itself.
   The macos bundled version has a different behaviour, which is copying the directory contents recursively , but not itself.
   Shall I send a pr?
   Modifying
   
   <code><pre>
   //line 3149 of _build.js
   xobjs.PBXShellScriptBuildPhase[buildPhaseUuid] = {
   			isa: 'PBXShellScriptBuildPhase',
   			buildActionMask: 2147483647,
   			files: [],
   			inputPaths: [],
   			name: '"' + name + '"',
   			outputPaths: [],
   			runOnlyForDeploymentPostprocessing: 0,
   			shellPath: '/bin/sh',
   			shellScript: '"cp -rf \\"$PROJECT_DIR/ArchiveStaging\\"/ \\"$TARGET_BUILD_DIR/$PRODUCT_NAME.app/\\""',
   			showEnvVarsInLog: 0
   		};
   }
   // to
   xobjs.PBXShellScriptBuildPhase[buildPhaseUuid] = {
   			isa: 'PBXShellScriptBuildPhase',
   			buildActionMask: 2147483647,
   			files: [],
   			inputPaths: [],
   			name: '"' + name + '"',
   			outputPaths: [],
   			runOnlyForDeploymentPostprocessing: 0,
   			shellPath: '/bin/sh',
   			shellScript: '"/bin/cp -rf \\"$PROJECT_DIR/ArchiveStaging\\"/ \\"$TARGET_BUILD_DIR/$PRODUCT_NAME.app/\\""',
   			showEnvVarsInLog: 0
   		};
   </pre></code></li>
<li>Sharif AbuDarda 2017-11-29

   Hello, Please create a PR and assign in here. Our engineers will look into it. Thanks.</li>
<li>Richard Lustemberg 2017-11-30

   Here is the PR,
   [<a href="https://github.com/appcelerator/titanium_mobile/pull/9639" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9639</a>](<a href="https://github.com/appcelerator/titanium_mobile/pull/9639)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9639)</a></li>
<li>Hans Knöchel 2017-12-07

   Backport for 7_0_X: <a href="https://github.com/appcelerator/titanium_mobile/pull/9663" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9663</a></li>
<li>Abir Mukherjee 2017-12-14

   [~jvennemann] Can you please provide guidance on how to validate the fix?</li>
<li>Abir Mukherjee 2017-12-15

   FR passed.</li>
</ol>


<p><a href="/TIMOB/TIMOB-25576.json">JSON Source</a></p>