---
title: "[TIMOB-25663] Android. HttpClient.cache. ImageView.cache"
---
<table>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Won't Do</td></tr>
<tr><th>Resolution Date</th><td>2020-06-30T14:42:06.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>Android, HttpClient, ImageView, parity</td></tr>
<tr><th>Reporter</th><td>Sergey Volkov</td></tr>
<tr><th>Assignee</th><td>Vijay Singh</td></tr>
<tr><th>Created</th><td>2018-01-11T12:55:06.000+0000</td></tr>
<tr><th>Updated</th><td>2020-06-30T14:42:06.000+0000</td></tr>
</table>

<h3>Description</h3>

In iOS Titanium.Network.HttpClient has _cache_ property, which allow to store http responses in locally on device, Ti SDK for Android lack this property. But remote images loaded by ImageView are stored in cache and there is no way to disable it.

I have implemented HttpResponseCache module for Android (simple binding to 	[android.net.http.HttpResponseCache](<a href="https://developer.android.com/reference/android/net/http/HttpResponseCache.html))" rel="nofollow" target="_blank">https://developer.android.com/reference/android/net/http/HttpResponseCache.html))</a>, also I've added _cache_ properties to HttpClient and ImageView.
So attached pathes intoduces this features:
- conditional caching for HttpClient responses and for remote images loaded by ImageView
- configurable http-response cache storage with some statistics

In patches _Ti.Android.HttpResponseCache_ is not installed (enabled) on application start and should be installed manually by calling "install" method. Without enabled _Ti.Android.HttpResponseCache_ "HttpClient.cache = true" will work with _TiResponseCache_, but "ImageView.cache = false" will not work, because images cached by _TiResponseCache_ anyway.

I think, if you'll find this changes usefull, _TiResponseCache_ class could be totally removed because, as I understand correctly, _TiResponseCache_ was created when _HttpResponseCache_ wasn't exists and stays for now as legacy.

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-25663_63952/0001-Android.-Add-HttpResponseCache-module.patch">0001-Android.-Add-HttpResponseCache-module.patch</td></td><td>2018-01-11T12:53:02.000+0000</td><td>9302</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-25663_63951/0002-Android.-Add-HttpClient.cache-property.patch">0002-Android.-Add-HttpClient.cache-property.patch</td></td><td>2018-01-11T12:53:02.000+0000</td><td>3337</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-25663_63950/0003-Android.-Add-ImageView.cache-property.patch">0003-Android.-Add-ImageView.cache-property.patch</td></td><td>2018-01-11T12:53:02.000+0000</td><td>8137</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2018-01-11

   Hey [~s.volkov], the patches look interesting! You can submit a pull-request to the [titanium_mobile](<a href="https://github.com/appcelerator/titanium_mobile)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile)</a> repository to include this in the SDK. We will then review your pull request and guide you to the right direction if something is missing. Let us know if you can do that! Moving to TIMOB.</li>
<li>Sergey Volkov 2018-01-11

   <a href="https://github.com/appcelerator/titanium_mobile/pull/9719" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9719</a></li>
<li>Hans Knöchel 2018-01-12

   Assigning to version 7.1.0 for now, but it depends on the team resources for new features. Some general thoughts on the PR:
   * The PR is Android only, which is against the parity-first approach. So we might want to think about an iOS solution as well
   * Right now it seems like you are the only person requesting this feature, so we will need to investigate how critical it is for the general SDK
   * The PR misses [unit-tests](<a href="https://github.com/appcelerator/titanium_mobile/#unit-tests)." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/#unit-tests).</a> You can see some examples [here](<a href="https://github.com/appcelerator/titanium-mobile-mocha-suite/tree/master/Resources)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium-mobile-mocha-suite/tree/master/Resources)</a></li>
<li>Sergey Volkov 2018-01-15

   [~hknoechel], this case is mostly about restoring parity, because iOS already has _cache_ property on httpClient.
   
   I've added tests for HttpResponseCache module and HttpClient.cache. It is currently impossible to create tests for ImageView.cache, because images are cached in memory by TiImageLruCache which is not exposed to js.</li>
<li>Hans Knöchel 2018-01-16

   Hey [~s.volkov], thanks for your reply. -I am mostly concerned about the fact that iOS and Windows use the <code>cache</code> property as a boolean, where by the Android platform will use an own proxy.- EDIT: I saw it incorrectly! It's actually a boolean as well and the <code>HttpResponseCache</code> is for global configuration! Cool!
   
   But - I also agree caching should become more configurable, so we'd rather look for a <code>Ti.Network.HttpResponseCache</code> cache that will be exposed on all platforms. Properties like <code>httpCacheSize</code> should be easy to expose, methods like <code>flush</code>, <code>install</code> and <code>close</code> seem quite Android-specific. 
   
   I would also like to consult [~jquick] for additional feedback, but due to the fact that we currently focus on bug-fixing across the SDK, this PR might need to wait for a later release than 7.1.0. We'll keep you posted in either way!</li>
<li>Gary Mathews 2018-02-13

   Bumping out of 7.1.0 so we can work out a solution that's compatible with all platforms.</li>
<li>Joshua Quick 2018-10-31

   I do agree that we should support the "cache" property in <code>HTTPClient</code> on Android.
   
   I don't like the idea of replacing our <code>TiResponseCache</code> with Google's <code>HttpResponseCache</code>. We definitely don't want to lose the custom features we've added to our class such as our relatively new "redirect" methods. Any new caching features we want to add should be added to our class.
   
   I don't think we should add any more network related APIs to our <code>ImageView</code>. I'd rather we keep <code>ImageView</code> simple. If an app developer wants more control over the HTTP request/response handling, then it should be done via <code>HTTPClient</code> and the downloaded image should then be applied to the <code>ImageView</code> via a file path. Case-in-point, [~topener] has created a "ti.imageview" module that wraps an <code>ImageView</code> and allows you to specify the HTTP request headers. Internally, it uses <code>HTTPClient</code> to do so. This is all done in pure JavaScript by dog-fooding our Titanium APIs, which means all platforms Titanium supports (Android, iOS, Windows) get this feature for free.
   <a href="https://github.com/appcelerator-modules/ti.imageview" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.imageview</a>
   </li>
<li>Sergey Volkov 2018-10-31

   Everything below IMHO, I mean no offence.
   
   It's been almost two years since I wrote this patch for 6.0.0 SDK, but anyway:
   
   I understand why TiResponseCache was written in 2010, but don't see any reason to keep it now (even for your newly written methods, because HttpResponseCache should also handle redirects). It seems obvious that  _less code == less bugs_ ([this](<a href="https://github.com/NetrisTV/ti.exoplayer/issues/3)" rel="nofollow" target="_blank">https://github.com/NetrisTV/ti.exoplayer/issues/3)</a>, for example, caused by bug in TiResponseCache: it tries to get response for POST request from cache; just have no time to properly file the issue and PR).
   
   I've seen "ti.imageview" (and [Topener/To.ImageCache](<a href="https://github.com/Topener/To.ImageCache)" rel="nofollow" target="_blank">https://github.com/Topener/To.ImageCache)</a> by Rene). It's seems ok, except possible overhead with copying blob from java to js and back to java; also I'm not sure how it will work with TiImageLruCache.
   
   About "Android-specific API": <code>HttpResponseCache</code> is in Ti.Android namespace and mirroring native module API why wouldn't it be Android specific? It's not like you already have any other incompatible API for cache control by now.
   
   I'm fine if you'll close this ticket and PR, but I'm going to keep using this patch-set for local SDK builds because currently there is no other way for my use case.</li>
<li>Joshua Quick 2018-10-31

   Your code loses an optimization we've made in <code>ImageView</code> where we directly check the HTTP response cache if the image has already been downloaded before proceeding with a threaded-out HTTP request. If the cached response is a redirect, then it'll keep following it in the cache until it reaches the end-point for the image. This is especially important for our image loading APIs such as <code>backgroundImage</code> and {{defaultImage} which still do a "blocking" download.
   
   Regarding <code>TiImageLruCache</code>, our plan is to remove it. It's not our job to decide which images/photos should be cached and it increases the likelihood of out-of-memory exceptions. Its biggest issue is that it keeps hard reference to images. It's up to app developers to decide which images should be cached in memory and that is best done via blobs. There is no additional overhead with blob usage since an image needs to be decoded into memory before being displayed anyways. In fact, it improves image loading performance since Google's Android APIs do not cache images outside of the APK "res" folder. (We may implement a weak-reference cache instead; we'll see.)</li>
<li>Sergey Volkov 2019-01-11

    I've closed the PR. Feel free to close this ticket.</li>
</ol>


<p><a href="/TIMOB/TIMOB-25663.json">JSON Source</a></p>