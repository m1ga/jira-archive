---
title: "[TIMOB-25676] iOS: HTTPClient unit-test sometimes fails because of incorrect states"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Cannot Reproduce</td></tr>
<tr><th>Resolution Date</th><td>2018-02-15T13:44:57.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Hans Knöchel</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2018-01-16T08:41:15.000+0000</td></tr>
<tr><th>Updated</th><td>2018-02-15T13:45:10.000+0000</td></tr>
</table>

<h3>Description</h3>

The following test-case sometimes fails because the <code>onreadystate</code> event fires before the <code>ondatastream</code> one. There are also cases where the <code>orreadystate</code> fires one state twice because the states are lost as a result of a race condition when sending out the events.

The proposed fix (working 20/20 times so far) is to ensure we are firing events to the client serial (blocking) on the main-thread. This ensures all state events get queued correctly and fixes the above issues.

Before:
<code><pre>
2018-01-16 09:40:35.286 Titanium[4965:119750] [INFO] 1
2018-01-16 09:40:35.288 Titanium[4965:119750] [INFO] 3
2018-01-16 09:40:35.288 Titanium[4965:119750] [INFO] 3
2018-01-16 09:40:35.289 Titanium[4965:119750] [INFO] 4
2018-01-16 09:40:35.289 Titanium[4965:119750] [INFO] DONE
</pre></code>
After:
<code><pre>
2018-01-16 09:40:35.286 Titanium[4965:119750] [INFO] 1
2018-01-16 09:40:35.288 Titanium[4965:119750] [INFO] 2
2018-01-16 09:40:35.288 Titanium[4965:119750] [INFO] 3
2018-01-16 09:40:35.289 Titanium[4965:119750] [INFO] 4
2018-01-16 09:40:35.289 Titanium[4965:119750] [INFO] DONE
</pre></code>

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2018-01-16

   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/9737" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9737</a>
   PR (7_0_X): <a href="https://github.com/appcelerator/titanium_mobile/pull/9738" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9738</a>
   
   <code><pre>
   
   function textXHR() {
     var xhr = Ti.Network.createHTTPClient(),
       attempts = 3,
       dataStreamFinished = false;
     xhr.setTimeout(3e4);
   
     xhr.onreadystatechange = function () {
       Ti.API.info(this.readyState);
       if (this.readyState === this.DONE) {
         if (dataStreamFinished === true) {
           Ti.API.info('DONE');
         } else {
           alert('ERROR: onreadystatechange done fired before 100% progress');
         }
       }
     };
   
     xhr.ondatastream = function (e) {
       if(e.progress == null) {
         alert('Error: Progress null!')
       };
       if (e.progress &gt;= 1.0) {
         dataStreamFinished = true;
       }
     };
   
     xhr.onerror = function (e) {
       if (attempts-- &gt; 0) {
         Ti.API.warn('failed, attempting to retry request...');
         xhr.send();
       } else {
         Ti.API.debug(JSON.stringify(e, null , 2));
         Ti.API.error(e.error || this.responseText);
       }
     };
   
     xhr.open('GET', '<a href="http://www.appcelerator.com/assets/The_iPad_App_Wave.pdf" rel="nofollow" target="_blank">http://www.appcelerator.com/assets/The_iPad_App_Wave.pdf</a>');
     xhr.send();
   }
   
   var win = Ti.UI.createWindow({
     backgroundColor: '#fff'
   });
   
   var btn = Ti.UI.createButton({
     title: 'Trigger'
   });
   
   btn.addEventListener('click', textXHR);
   
   win.add(btn);
   win.open();
   </pre></code></li>
<li>Hans Knöchel 2018-02-15

   Not an issue anymore</li>
</ol>


<p><a href="/TIMOB/TIMOB-25676.json">JSON Source</a></p>