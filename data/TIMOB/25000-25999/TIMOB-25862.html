---
title: "[TIMOB-25862] Parity: Support async Ti.UI.Webview.evalJS call on Android & iOS"
---
<table>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>None</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2018-09-25T19:47:31.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 7.0.2</td></tr>
<tr><th>Fix Version/s</th><td>Release 7.5.0</td></tr>
<tr><th>Components</th><td>Android, iOS</td></tr>
<tr><th>Labels</th><td>parity</td></tr>
<tr><th>Reporter</th><td>Christopher Williams</td></tr>
<tr><th>Assignee</th><td>Christopher Williams</td></tr>
<tr><th>Created</th><td>2018-03-13T14:46:56.000+0000</td></tr>
<tr><th>Updated</th><td>2018-10-17T14:07:30.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Issue</h4>
Evaluating Javascript within a Webview is inherently a (possibly) long-running task. On Windows we evalJS accepts a second argument which is a callback function to receive the result (when it's ready). We should support this async variant of the Ti.UI.WebView.evalJS method on Android and iOS (especially now that there's an async method to do exactly this natively in Android as of apilevel-19).

<code><pre>
// Existing sync call example
// Result is returned sync
var result = webview.evalJS('1 + 3');

// Async variant
// this variant doesn't return a a value (basically it returns null or undefined but callers shouldn't use the result)
// It fires off a thread/whatever to eval the JS and call the callback async.
webview.evalJS('1 + 3', function (result) {
  // do something with result
});
</pre></code>


<h3>Comments</h3>

<ol>
<li>Hans Kn√∂chel 2018-03-13

   The big issue on iOS is that the UIWebView currently used in Ti.UI.WebView does not offer an API to both do the evalJS call async AND receive back a value. It can either be blocked on the main thread (sync) and return a value or do it async but do not return a value. Different to that, the "more modern" WKWebView that slowly replaces Ti.UI.WebView does it different and offers the API asynchronous by default. I've made [a module](<a href="https://github.com/appcelerator-modules/Ti.WKWebView)" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/Ti.WKWebView)</a> for that one a while ago, so devs can use it already. [~cwilliams] Let me know your thoughts!</li>
<li>Joshua Quick 2018-03-13

   Here's an idea...
   
   How about we create an async evalJS() equivalent which does *+not+* support returning a value. It merely executes the given script within the WebView. Developers already have a means to communicate back within the HTML via <code>Ti.App.fireEvent()</code>. They can use that to async communicate with the Titanium JavaScript.
   Sometimes keeping it simple is better.</li>
<li>Christopher Williams 2018-03-14

   I think because I didn't add the example API we may be getting confused here.
   
   An async variant of the method would not return a valid result. It should return null/undefined. Instead it schedules the eval to be run in the Webview and invokes the callback with the result when it's done.
   
   Right now the Android version I set up calls the callback function with the result, but doesn't really have a way to handle errors. We could consider a better version which would be more node-like so the first arg is an optional error object, the second argument is the result.
   <code><pre>
   webview.evalJS('1 + 3', function (err, result) {
     // err may be an Error object or string if there was an issue evaluating the JS.
     // if not, result should be a string
   });
   </pre></code>
   
   I don't see why iOS wouldn't be able to do this. This is not some magical time-traveling variant that runs async but also returns a value sync.</li>
<li>Joshua Quick 2018-03-14

   Hold on. We can already do async eval on all platforms today.
   
   We support <code>Ti.App.addEventListener()</code> and <code>Ti.App.fireEvent()</code> on the HTML side. So, developera already have the ability to do async event driven communication between the WebView's JavaScript and Titanium's JavaScript. And they can do an evalJS() equivalent by passing the JavaScript string via an event to the WebView like the below...
   
   <code><pre>
   var htmlText =
   		'<!DOCTYPE html>' +
   		'<html>' +
   		'	<body>' +
   		'		<p>HTML Fire Event Test</p>' +
   		'		<p id="label"></p>' +
   		'	</body>' +
   		'	<script>' +
   		'		Ti.App.addEventListener("app:webViewEval", function(e) {' +
   		'			eval(e.javaScriptString)' +
   		'		});' +
   		'	</script>' +
   		'</html>';
   
   var window = Ti.UI.createWindow();
   var webView = Ti.UI.createWebView({
   	html: htmlText,
   });
   window.add(webView);
   window.open();
   
   var count = 1;
   setInterval(function(e) {
   	Ti.App.fireEvent('app:webViewEval', {
   		javaScriptString: 'document.getElementById("label").innerHTML = "Counter: ' + count + '"',
   	});
   	count++;
   }, 1000);
   </pre></code>
   
   The above works on both Android and iOS.
   
   _*Edit:* The above mentioned solution will only work for HTML under the developer's control. It won't work with random webpages loaded from the Internet since they won't have any Titanium event listeners coded into the HTML's JavaScript. So, Chris' async evalJS() still has merit._</li>
<li>Christopher Williams 2018-09-20

   <a href="https://github.com/appcelerator/titanium_mobile/pull/9889" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9889</a>
   
   Also needs a thumb-up from either [~gmathews] or [~jquick]</li>
<li>Samir Mohammed 2018-10-17

   *Closing ticket* Verified improvement in SDK Version <code>7.5.0.v20181016071050</code> using elements from the example in the description. 
   
   *Test environment*
   <code><pre>
   APPC Studio: 5.1.0.201808080937
   iPhone 6 Sim (iOS 12)
   APPC CLI: 7.0.6
   Operating System Name: Mac OS Mojave
   Operating System Version: 10.14
   Node.js Version: 8.9.1
   Xcode 10.0
   </pre></code>
   </li>
</ol>


<p><a href="/TIMOB/TIMOB-25862.json">JSON Source</a></p>