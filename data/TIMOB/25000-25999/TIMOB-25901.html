---
title: "[TIMOB-25901] iOS: App crashes when background services expire and queue tries to flush"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2018-06-22T10:41:00.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 6.3.0, Release 7.1.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 7.5.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>ios</td></tr>
<tr><th>Reporter</th><td>Igor Stojanovic</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2018-03-23T20:02:05.000+0000</td></tr>
<tr><th>Updated</th><td>2018-10-18T10:51:41.000+0000</td></tr>
</table>

<h3>Description</h3>

File TiApp.m

App crashes on line 632 

/* for (id key in pendingCompletionHandlers) {
            [self completionHandler:key withResult:2]; //UIBackgroundFetchResultFailed
        } */

// elements of array are removed while array is enumerated
// YOU SHOULD TRY LIKE THIS:
        
        for (id key in [pendingCompletionHandlers allKeys]) {
            [self completionHandler:key withResult:2]; //UIBackgroundFetchResultFailed
        }

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2018-03-24

   Hey [~office@smartbit.rs], thanks for your report! What a stupid typo, sorry for that. We'll fix it right away and release it with the next patch.
   
   *EDIT*: Actually, I would like to propose a different change: Instead of looping through a mutable dictionary and remove keys during the iteration, I would rather mark the keys that should be called in a separate dictionary, call them and remove them from the original dictionary later. Does that make sense? I still wonder why this didn't surface before - maybe only in some cases where it's causing a race condition?</li>
<li>Igor Stojanovic 2018-03-24

   Hey Hans,
   AllKeys will create separated (new)  Array with keys. 
   And iteration in this case goes trough that array instead mutableDict.
   
   Your propose also could be good but it depend of object inside dict. Probably you can also remove original dictionary later but in that case for some time you will have objects inside array which can have maybe undefined state (I don't know full code...)
   E.g.
   loop
           completionHandler = [pendingCompletionHandlers objectForKey:key];
           completionHandler(result); // this is called for each object but object is still alive when loop is ended
   end loop
   // in this point we still have objects in Dict. but we called completionHandler(result); IS THAT DANGEROUS ?
   [pendingCompletionHandlers removeAllObjects];
   </li>
<li>Hans Knöchel 2018-03-24

   PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/9957" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9957</a>
   
   Test-Case: Follow [this guide](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/guide/iOS_Background_Services) and let the background-service expire.
   
   [~office@smartbit.rs] If you don't mind, I'd like to ask you to test this change as well. I decided to refactor a bit more and change the handler removal to an own guard ("removeAfterExecution") that is not called anymore, since the whole dictionary is cleared after the enumeration anyway. Thanks again for bringing this up!</li>
<li>Hans Knöchel 2018-04-09

   [~office@smartbit.rs] Have you been able to verify the changes on your end? Thanks!</li>
<li>Igor Stojanovic 2018-04-09

   Hi Hans,
   It looks good to me...
   We will schedule some time for test in to the  company in next few weeks.
   Thanks</li>
<li>Hans Knöchel 2018-06-22

   [~office@smartbit.rs] The PR was just merged. Let me know how your internal tests went for another opinion!</li>
<li>Samir Mohammed 2018-10-18

   *Closing ticket.* Verified fix in SDK Version <code>7.5.0.v20181016071050</code> using the examples from <a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/guide/iOS_Background_Services
   
   *Test environment*
   <code><pre>
   APPC Studio: 5.1.0.201808080937
   iPhone 6 Sim (iOS 12)
   APPC CLI: 7.0.6
   Operating System Name: Mac OS Mojave
   Operating System Version: 10.14
   Node.js Version: 8.9.1
   Xcode 10.0
   </pre></code>
   </li>
</ol>


<p><a href="/TIMOB/TIMOB-25901.json">JSON Source</a></p>