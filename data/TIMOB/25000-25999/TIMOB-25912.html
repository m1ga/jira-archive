---
title: "[TIMOB-25912] iOS: Ti.UI.iOS.createDocumentViewer doesn't work when using SDK-fix"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2018-04-03T16:44:34.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 7.1.0, Release 7.0.2</td></tr>
<tr><th>Fix Version/s</th><td>Release 7.1.1</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>createHttpClient, documentViewer, filesystem</td></tr>
<tr><th>Reporter</th><td>josh.mocek</td></tr>
<tr><th>Assignee</th><td>Hans Knöchel</td></tr>
<tr><th>Created</th><td>2018-03-27T22:04:07.000+0000</td></tr>
<tr><th>Updated</th><td>2018-04-05T20:36:04.000+0000</td></tr>
</table>

<h3>Description</h3>

Ti.UI.iOS.createDocumentViewer does not work correctly in 7.1.0
Build the sample project and copy the files below.
If you build the project w/ 7.1.0 on iOS >=11.2 and click on PDF or PNG it works, but DOCX, PPT, video, and XLS do not work and just show 'Loading...' forever. This is also after moving the files to the 'tmp' directory as stated in the docs to account for iOS 11.2.
If you build the project w/ 6.2.2 on iOS >=11.2 all the files open correctly. 

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-25912_64999/index.js">index.js</td></td><td>2018-03-27T21:56:26.000+0000</td><td>4296</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-25912_64998/index.tss">index.tss</td></td><td>2018-03-27T21:56:26.000+0000</td><td>144</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-25912_64997/index.xml">index.xml</td></td><td>2018-03-27T21:56:26.000+0000</td><td>438</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Mike Stancliffe 2018-03-28

   This is holding up a release of ours, we have tested in 6.2.2 and everything works as expected, but we are needing to be on 7.1 for other fixes.  Would love it if it were possible to get this regression fix into 7.1.1</li>
<li>Hans Knöchel 2018-03-28

   Hey there! I've checked it and it looks like Apple also has some issues with the applicationCache directory. A simple fix is to change the <code>Ti.Filesystem.tempDirectory</code> references to <code>Ti.Filesystem.applicationDataDirectory</code>. Here is a working (classic) test-case based on your input (thanks for that!):
   <code><pre>
   function doClick(e) {
   	downloadFile(e);
   }
   
   function createButton(title, option) {
     var button = Ti.UI.createButton({
       top: 100 + (option * 2),
       title: title,
       option: option
     });
     
     button.addEventListener('click', doClick);
     
     return button;
   }
   
   var newFile2 = Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory, "New");
   if (!newFile2.exists()) {
   	newFile2.createDirectory();
   }
   
   var index = Ti.UI.createWindow({backgroundColor: '#fff', layout: 'vertical'});
   index.add(createButton('View PDF', 1));
   index.add(createButton('View XLS', 2));
   index.add(createButton('View PPT', 3));
   index.add(createButton('View PNG', 4));
   index.add(createButton('View DOCX', 5));
   
   index.open();
   
   function isiOS11_2() {
   	var version = Ti.Platform.version.split(".");
   	return (parseInt(version[0]) >= 11 && parseInt(version[1]) >= 2);
   }
   
   function fileInTemporaryDirectory(fileName) {
   
   	var newFile2 = Titanium.Filesystem.getFile(fileName);
   	newFile2.createFile();
   	if (!newFile2.exists()) {
   		alert('New file could not be created in applicationDataDirectory directory!');
   		return;
   	}
   
   	var splitFile = String(fileName);
   	splitFile = splitFile.split('/');
   	splitFile = splitFile[splitFile.length - 1];
   	var newFile = Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory, splitFile);
   	newFile.createFile();
   
   	if (!newFile.exists()) {
   		alert('New file could not be created in temporary directory!');
   		return;
   	}
   
   	newFile.write(newFile2);
   	var pathSep = Ti.Filesystem.applicationDataDirectory + splitFile;
   	console.info('pathSeperate\n ' + pathSep);
   	docViewer = Ti.UI.iOS.createDocumentViewer({
   		url: pathSep
   	});
   	docViewer.show();
   
   }
   
   var doneWithFile = function(file) {
   	if (file.error == null) {
   		var path = file.path + file.file;
   			if (isiOS11_2()) {
   				fileInTemporaryDirectory(path);
   			}
   	} else {
   		alert(file.error);
   	}
   }
   
   function downloadFile(e) {
   	// var path = "<a href="http://opendatakit.org/wp-content/uploads/static/sample.xls" rel="nofollow" target="_blank">http://opendatakit.org/wp-content/uploads/static/sample.xls</a>";
   	Ti.API.info(JSON.stringify(e));
   	if (e != undefined && e.source != undefined && e.source.option != undefined) {
   		switch (e.source.option) {
   			case 1:
   				var path = '<a href="http://www.pdf995.com/samples/pdf.pdf" rel="nofollow" target="_blank">http://www.pdf995.com/samples/pdf.pdf</a>';
   				break;
   			case 2:
   				var path = "<a href="http://opendatakit.org/wp-content/uploads/static/sample.xls" rel="nofollow" target="_blank">http://opendatakit.org/wp-content/uploads/static/sample.xls</a>";
   				break;
   			case 3:
   				var path = "<a href="http://www.unm.edu/~unmvclib/powerpoint/pptexamples.ppt" rel="nofollow" target="_blank">http://www.unm.edu/~unmvclib/powerpoint/pptexamples.ppt</a>";
   				break;
   			case 4:
   				var path = "<a href="https://upload.wikimedia.org/wikipedia/en/e/e5/ShereFASTticket-Example.png" rel="nofollow" target="_blank">https://upload.wikimedia.org/wikipedia/en/e/e5/ShereFASTticket-Example.png</a>";
   				break;
   			case 5:
   				var path = "<a href="https://calibre-ebook.com/downloads/demos/demo.docx" rel="nofollow" target="_blank">https://calibre-ebook.com/downloads/demos/demo.docx</a>";
   				break;
   			default:
   				var path = "<a href="http://opendatakit.org/wp-content/uploads/static/sample.xls" rel="nofollow" target="_blank">http://opendatakit.org/wp-content/uploads/static/sample.xls</a>";
   				break;
   		}
   	} else {
   		var path = "<a href="http://opendatakit.org/wp-content/uploads/static/sample.xls" rel="nofollow" target="_blank">http://opendatakit.org/wp-content/uploads/static/sample.xls</a>";
   	}
   
   	var file_obj = {};
   	var url = path;
   
   	var splitFile = String(path);
   	splitFile = splitFile.split('/');
   	splitFile = splitFile[splitFile.length - 1];
   	var filename = "New/" + splitFile;
   
   	//Replace Spaces with %20 so IOS will not crash
   	if (url != null) {
   		url = url.replace(/\s/g, '%20');
   		file_obj = {
   			file: filename,
   			url: url,
   			path: null
   		};
   
   		var file = Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory, filename);
   	
   		if (file.exists()) {
   			file_obj.nativePath = file.nativePath;
   			file_obj.path = Ti.Filesystem.applicationDataDirectory;
   			doneWithFile(file_obj);
   		} else {
   			console.info('Ti.Network.online: ' + Ti.Network.online);
   			if (Ti.Network.online) {
   				var c = Ti.Network.createHTTPClient({
   					timeout: 10000,
   					onload: function() {
   						file_obj.status = this.status;
   						if (this.status == 200) {
   							var f = Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory, filename);
   							file_obj.path = Ti.Filesystem.applicationDataDirectory;
   							f.write(this.responseData);
   							file_obj.nativePath = f.nativePath;
   						} else {
   							file_obj.error = 'File not found.'; // to set some errors codes
   						}
   						doneWithFile(file_obj);
   						c = null;
   					}
   				});
   				c.onerror = function(e) {
   					file_obj.status = e.code;
   					file_obj.error = e.error;
   					doneWithFile(file_obj);
   					c = null;
   				};
   				c.open('GET', url);
   				c.send();
   			} else {
   				file_obj.error = 'No internet connection.';
   				doneWithFile(file_obj);
   			}
   		}
   	} else {
   		file_obj.error = 'No URL';
   		doneWithFile(file_obj);
   	}
   }
   </pre></code>
   Interesting enough: It works fine with PDF's - even with an untouched test-case, so it seems like PDF files are okay but others may not? Of course I've only tested with PDF files during the initial change for 7.1.0 so it probably went through. Still a buggy behavior on the native side, sorry for the trouble caused by that!</li>
<li>josh.mocek 2018-03-28

   That does work. I tried putting it in a subdirectory in applicationDataDirectory, but I still couldn't access them there. PDF's still work fine</li>
<li>Hans Knöchel 2018-03-28

   Thanks for testing! I am preparing a fix that moves all files to the application-data (root) directory to be picked up properly AND be removed if manually copied there. That also prevents possible storage leaks for larger amount of data as the file will be removed after finishing to present it. Does that make sense for your case as well?</li>
<li>Hans Knöchel 2018-03-28

   PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/9968" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9968</a>
   Backport: <a href="https://github.com/appcelerator/titanium_mobile/pull/9977" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/9977</a>
   
   Test-Case:
   <code><pre>
   function doClick(e) {
   	downloadFile(e);
   }
   
   function createButton(title, option) {
     var button = Ti.UI.createButton({
       top: 100 + (option * 2),
       title: title,
       option: option
     });
     
     button.addEventListener('click', doClick);
     
     return button;
   }
   
   var newFile2 = Titanium.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory, "New");
   if (!newFile2.exists()) {
   	newFile2.createDirectory();
   }
   
   var index = Ti.UI.createWindow({backgroundColor: '#fff', layout: 'vertical'});
   index.add(createButton('View PDF', 1));
   index.add(createButton('View XLS', 2));
   index.add(createButton('View PPT', 3));
   index.add(createButton('View PNG', 4));
   index.add(createButton('View DOCX', 5));
   
   index.open();
   
   function isiOS11_2() {
   	var version = Ti.Platform.version.split(".");
   	return (parseInt(version[0]) >= 11 && parseInt(version[1]) >= 2);
   }
   
   var doneWithFile = function(file) {
   	if (file.error == null) {
   		var path = file.path + file.file;
   		var docViewer = Ti.UI.iOS.createDocumentViewer({
   			url: path
   		});
   		docViewer.show();
   	} else {
   		alert(file.error);
   	}
   }
   
   function downloadFile(e) {
   	// var path = "<a href="http://opendatakit.org/wp-content/uploads/static/sample.xls" rel="nofollow" target="_blank">http://opendatakit.org/wp-content/uploads/static/sample.xls</a>";
   	Ti.API.info(JSON.stringify(e));
   	if (e != undefined && e.source != undefined && e.source.option != undefined) {
   		switch (e.source.option) {
   			case 1:
   				var path = '<a href="http://www.pdf995.com/samples/pdf.pdf" rel="nofollow" target="_blank">http://www.pdf995.com/samples/pdf.pdf</a>';
   				break;
   			case 2:
   				var path = "<a href="http://opendatakit.org/wp-content/uploads/static/sample.xls" rel="nofollow" target="_blank">http://opendatakit.org/wp-content/uploads/static/sample.xls</a>";
   				break;
   			case 3:
   				var path = "<a href="http://www.unm.edu/~unmvclib/powerpoint/pptexamples.ppt" rel="nofollow" target="_blank">http://www.unm.edu/~unmvclib/powerpoint/pptexamples.ppt</a>";
   				break;
   			case 4:
   				var path = "<a href="https://upload.wikimedia.org/wikipedia/en/e/e5/ShereFASTticket-Example.png" rel="nofollow" target="_blank">https://upload.wikimedia.org/wikipedia/en/e/e5/ShereFASTticket-Example.png</a>";
   				break;
   			case 5:
   				var path = "<a href="https://calibre-ebook.com/downloads/demos/demo.docx" rel="nofollow" target="_blank">https://calibre-ebook.com/downloads/demos/demo.docx</a>";
   				break;
   			default:
   				var path = "<a href="http://opendatakit.org/wp-content/uploads/static/sample.xls" rel="nofollow" target="_blank">http://opendatakit.org/wp-content/uploads/static/sample.xls</a>";
   				break;
   		}
   	} else {
   		var path = "<a href="http://opendatakit.org/wp-content/uploads/static/sample.xls" rel="nofollow" target="_blank">http://opendatakit.org/wp-content/uploads/static/sample.xls</a>";
   	}
   
   	var file_obj = {};
   	var url = path;
   
   	var splitFile = String(path);
   	splitFile = splitFile.split('/');
   	splitFile = splitFile[splitFile.length - 1];
   	var filename = "New/" + splitFile;
   
   	//Replace Spaces with %20 so IOS will not crash
   	if (url != null) {
   		url = url.replace(/\s/g, '%20');
   		file_obj = {
   			file: filename,
   			url: url,
   			path: null
   		};
   
   		var file = Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory, filename);
   	
   		if (file.exists()) {
   			file_obj.nativePath = file.nativePath;
   			file_obj.path = Ti.Filesystem.applicationDataDirectory;
   			doneWithFile(file_obj);
   		} else {
   			console.info('Ti.Network.online: ' + Ti.Network.online);
   			if (Ti.Network.online) {
   				var c = Ti.Network.createHTTPClient({
   					timeout: 10000,
   					onload: function() {
   						file_obj.status = this.status;
   						if (this.status == 200) {
   							var f = Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory, filename);
   							file_obj.path = Ti.Filesystem.applicationDataDirectory;
   							f.write(this.responseData);
   							file_obj.nativePath = f.nativePath;
   						} else {
   							file_obj.error = 'File not found.'; // to set some errors codes
   						}
   						doneWithFile(file_obj);
   						c = null;
   					}
   				});
   				c.onerror = function(e) {
   					file_obj.status = e.code;
   					file_obj.error = e.error;
   					doneWithFile(file_obj);
   					c = null;
   				};
   				c.open('GET', url);
   				c.send();
   			} else {
   				file_obj.error = 'No internet connection.';
   				doneWithFile(file_obj);
   			}
   		}
   	} else {
   		file_obj.error = 'No URL';
   		doneWithFile(file_obj);
   	}
   }
   </pre></code>
   Expected behavior: All files should load in iOS < 11.2 and iOS >= 11.2.</li>
<li>Eric Wieber 2018-04-03

   FR Passed. Able to load PDF, XLS, PPT, MP4, PNG, and DOCX files without issue. Tested using provided sample code as well as modified versions to accept other file types and the document viewer suite.</li>
<li>Eric Wieber 2018-04-05

   Verified changes are in SDK builds 7.1.1.v20180405080421 & 7.2.0.v20180404233630</li>
</ol>


<p><a href="/TIMOB/TIMOB-25912.json">JSON Source</a></p>