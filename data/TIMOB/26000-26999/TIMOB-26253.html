---
title: "[TIMOB-26253] Android: NotificationManager.notify() will crash while screen is off and if app is missing WAKE_LOCK permission"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2018-09-12T00:52:46.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 6.2.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 7.5.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, notification, permissions</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2018-08-03T00:45:55.000+0000</td></tr>
<tr><th>Updated</th><td>2018-09-21T21:19:02.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
As of Titanium 6.2.0, posting a local notification while the screen is off will cause the app to crash if the app does not have the <code>WAKE_LOCK</code> permission.

Titanium should not require the <code>WAKE_LOCK</code> permission.

*Steps to reproduce:*
<h4>Connect an Android device to your machine.</h4>
<h4>Turn the Android device's screen off.</h4>
<h4>Build and run the below code on that Android device.</h4>
<h4>View the log and notice an exception was printed on startup.</h4>
<h4>Turn on the device's screen and view the app. Notice an exception dialog was displayed.</h4>

<code><pre>
Ti.Android.NotificationManager.notify(123, Ti.Android.createNotification({
	contentTitle: "Titanium Notification",
	contentText: "Content Text",
	contentIntent: Ti.Android.createPendingIntent({
		intent: Ti.App.Android.launchIntent,
	}),
}));
</pre></code>

*Result:*
The following exception gets logged...
<code><pre>
[ERROR] :  TiExceptionHandler: Error: Neither user 10256 nor current process has android.permission.WAKE_LOCK.
[ERROR] :  TiExceptionHandler:     at /ActivitySingleTaskTest.js:29:32
[ERROR] :  TiExceptionHandler:     at Module._runScript (ti:/module.js:613:9)
[ERROR] :  TiExceptionHandler:     at Module.load (ti:/module.js:105:7)
[ERROR] :  TiExceptionHandler:     at Module.loadJavascriptText (ti:/module.js:457:9)
[ERROR] :  TiExceptionHandler:     at Module.loadAsFile (ti:/module.js:512:15)
[ERROR] :  TiExceptionHandler:     at Module.loadAsFileOrDirectory (ti:/module.js:429:20)
[ERROR] :  TiExceptionHandler:     at Module.require (ti:/module.js:296:17)
[ERROR] :  TiExceptionHandler:     at require (ti:/module.js:570:15)
[ERROR] :  TiExceptionHandler:     at /app.js:7:1
[ERROR] :  TiExceptionHandler:     at Module._runScript (ti:/module.js:596:17)
[ERROR] :  TiExceptionHandler:
[ERROR] :  TiExceptionHandler:     android.os.Parcel.readException(Parcel.java:1942)
[ERROR] :  TiExceptionHandler:     android.os.Parcel.readException(Parcel.java:1888)
[ERROR] :  TiExceptionHandler:     android.os.IPowerManager$Stub$Proxy.acquireWakeLock(IPowerManager.java:405)
[ERROR] :  TiExceptionHandler:     android.os.PowerManager$WakeLock.acquireLocked(PowerManager.java:1342)
[ERROR] :  TiExceptionHandler:     android.os.PowerManager$WakeLock.acquire(PowerManager.java:1326)
[ERROR] :  TiExceptionHandler:     ti.modules.titanium.android.notificationmanager.NotificationManagerModule.notify(NotificationManagerModule.java:159)
[ERROR] :  TiExceptionHandler:     org.appcelerator.kroll.runtime.v8.V8Runtime.nativeRunModule(Native Method)
[ERROR] :  TiExceptionHandler:     org.appcelerator.kroll.runtime.v8.V8Runtime.doRunModule(V8Runtime.java:184)
[ERROR] :  TiExceptionHandler:     org.appcelerator.kroll.KrollRuntime.runModule(KrollRuntime.java:247)
[ERROR] :  TiExceptionHandler:     org.appcelerator.titanium.TiLaunchActivity.loadActivityScript(TiLaunchActivity.java:135)
[</pre></code>

*Expected Result:*
App should not require the <code>WAKE_LOCK</code> permission. Java code should check if app has <code>WAKE_LOCK</code> before attempting to use it. If the permission is missing, then avoid it and do not turn on the screen.

Note that many Android users tend to avoid apps that use the <code>WAKE_LOCK</code> permission since they're considered to waste battery life. This permission is a dirty word in the Android world and is best avoided if possible.

*Cause:*
This is an issue in Titanium's Java <code>NotificationManagerModule.notify()</code> method...
[NotificationManagerModule.java#L137](<a href="https://github.com/appcelerator/titanium_mobile/blob/master/android/modules/android/src/java/ti/modules/titanium/android/notificationmanager/NotificationManagerModule.java#L137)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/android/modules/android/src/java/ti/modules/titanium/android/notificationmanager/NotificationManagerModule.java#L137)</a>

The solution is to do the following:
* Check if <code>WAKE_LOCK</code> permission is defined in "AndroidManifest.xml" via the <code>Context</code> class before creating a wake lock.
* <code>catch</code> block should catch the <code>Exception</code> type to catch all exception.


<h3>Comments</h3>

<ol>
<li>Joshua Quick 2018-09-07

   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/10311" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10311</a></li>
<li>Lokesh Choudhary 2018-09-12

   FR Passed.
   Waiting for merge to be enabled.</li>
<li>Lokesh Choudhary 2018-09-12

   PR Merged.</li>
<li>Keerthi Mahalingam 2018-09-21

   Verified the fix on Sdk 7.5.0.v20180921103412. Works fine. Closing.
   <code><pre>
   Operating System
     Name                        = Mac OS X
     Version                     = 10.13.6
     Architecture                = 64bit
   Node.js
     Node.js Version             = 8.9.1
     npm Version                 = 5.5.1
   Titanium CLI
     CLI Version                 = 5.1.1
   Titanium SDK
     SDK Version                 = 7.5.0.v20180921103412
   Device                            =Samsung s5 android 6, Pixel android 8
   </pre></code></li>
</ol>


<p><a href="/TIMOB/TIMOB-26253.json">JSON Source</a></p>