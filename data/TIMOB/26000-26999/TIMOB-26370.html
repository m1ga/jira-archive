---
title: "[TIMOB-26370] Android: \"Failed to create external storage directory\" when download image and save to camera roll"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2018-11-19T23:17:29.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 8.0.0</td></tr>
<tr><th>Components</th><td>n/a</td></tr>
<tr><th>Labels</th><td>android, api, camera, roll, save</td></tr>
<tr><th>Reporter</th><td>Ken Rucker</td></tr>
<tr><th>Assignee</th><td>Yordan Banev</td></tr>
<tr><th>Created</th><td>2018-09-05T20:22:16.000+0000</td></tr>
<tr><th>Updated</th><td>2018-11-26T20:10:27.000+0000</td></tr>
</table>

<h3>Description</h3>

When downloading any image, saving to temp folder and then attempting to save the image to the Android Camera Roll, results in error (saving to Camera Roll) "TiMedia: (main) [526999,526999] Failed to create external storage directory". Works as expected on Android API levels 25 and below. Fails on API levels 26, 27, 28. Tested on emulators API 25-28 and devices API 21 and API 28.

*Sample Test Code:*

<code><pre>
var checkCameraPermissions = function(callback) {
    if (Ti.Media.hasCameraPermissions()) {
        Ti.UI.createAlertDialog({ cancel: 0, buttonNames: ['OK'], title:'Permissions', message:'Already had permissions. Good to go.'}).show();
        callback(true);
    } else { 
        Ti.Media.requestCameraPermissions(function(e) {
             if (e.success === true) {
                 Ti.UI.createAlertDialog({ cancel: 0, buttonNames: ['OK'], title:'Permissions', message:'User granted permissions. Good to go.'}).show();
                 callback(true);
             } else {
                 Ti.UI.createAlertDialog({ cancel: 0, buttonNames: ['OK'], title:'Permissions', message:'User did not granted permissions. Bad day.'}).show();
                 callback(false);
             }
        });
    }
};
  
var win = Ti.UI.createWindow({
    exitOnClose: true,
    fullscreen: false,
    title: 'Test'
});

var button = Titanium.UI.createButton({
    title: 'Test DL Img & Save to Camera Roll'
});   
button.addEventListener('click', function(e) {
    checkCameraPermissions(function(returnedData) {            
        if (returnedData == true) {
            var xhrImageGet = Ti.Network.createHTTPClient({
                onerror : function(xhrErr) {
                    Ti.UI.createAlertDialog({ cancel: 0, buttonNames: ['OK'], title:'Error', message:'Unable to download the remote image. ' + xhrErr.error}).show();
                },
                onload : function() {
                    try {
                        var image_to_save = this.responseData;                    
                        var picture = Titanium.Filesystem.getFile(Titanium.Filesystem.tempDirectory, 'icon-arrowFeature.png');
                        picture.write(image_to_save);                                                        
                        Ti.Media.saveToPhotoGallery(picture.read(), {
                            success:function(){
                                Ti.UI.createAlertDialog({ cancel: 0, buttonNames: ['OK'], title:'Image Saved', message:'icon-arrowFeature.png has been saved to your photo gallery.'}).show();
                            },
                            error:function(err){
                                Ti.UI.createAlertDialog({ cancel: 0, buttonNames: ['OK'], title:'Error Saving to Gallery', message:err.error}).show();
// FAILS RIGHT HERE WITH NO ERROR MESSAGE RETURNED. HOWEVER CONSOLE SHOWS THE ERROR TiMedia: (main) [526999,526999] Failed to create external storage directory.
                            }
                        });                        
                        image_to_save = null;
                    }
                    catch(saveErr) {
                        Ti.UI.createAlertDialog({ cancel: 0, buttonNames: ['OK'], title:'Error', message:'Unable to save the file to your device. ' + saveErr.error}).show();
                    }
                }
            });                                        
            xhrImageGet.open("GET", '<a href="https://s3.amazonaws.com/www.appcelerator.com.images/icon-arrowFeature.png" rel="nofollow" target="_blank">https://s3.amazonaws.com/www.appcelerator.com.images/icon-arrowFeature.png</a>');
            xhrImageGet.send();                                            
        } else {
            Ti.UI.createAlertDialog({ cancel: 0, buttonNames: ['OK'], title:'Permission Not Granted', message:'You have not granted the app the needed permissions to access your camera and/or device storage.'}).show();
        }        
    });                                            
});

win.add(button);        
win.open();
</pre></code>

*Test App tiapp.xml:*
<code><pre>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ti:app xmlns:ti="<a href="http://ti.appcelerator.org" rel="nofollow" target="_blank">http://ti.appcelerator.org</a>"&gt;
    &lt;id&gt;com.walkthelot.testsavetogallery&lt;/id&gt;
    &lt;name&gt;TestSaveToGallery&lt;/name&gt;
    &lt;version&gt;1.0&lt;/version&gt;
    &lt;publisher&gt;Ken&lt;/publisher&gt;
    &lt;url/&gt;
    &lt;description&gt;undefined&lt;/description&gt;
    &lt;copyright&gt;2018 by Ken&lt;/copyright&gt;
    &lt;icon&gt;appicon.png&lt;/icon&gt;
    &lt;fullscreen&gt;false&lt;/fullscreen&gt;
    &lt;navbar-hidden&gt;false&lt;/navbar-hidden&gt;
    &lt;analytics&gt;true&lt;/analytics&gt;
    &lt;guid&gt;a17321c0-c4e2-4542-9222-e3f5731f8fb5&lt;/guid&gt;
    &lt;property name="ti.ui.defaultunit" type="string"&gt;dp&lt;/property&gt;
    &lt;property name="run-on-main-thread" type="bool"&gt;true&lt;/property&gt;
    &lt;android xmlns:android="<a href="http://schemas.android.com/apk/res/android" rel="nofollow" target="_blank">http://schemas.android.com/apk/res/android</a>"&gt;
        &lt;manifest android:installLocation="auto"&gt;
            &lt;uses-permission android:name="android.permission.WAKE_LOCK"/&gt;
            &lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/&gt;
            &lt;uses-permission android:name="android.permission.ACCESS_WIFI_STATE"/&gt;
            &lt;uses-permission android:name="android.permission.INTERNET"/&gt;
            &lt;uses-permission android:name="android.permission.VIBRATE"/&gt;
            &lt;uses-permission android:name="android.permission.WRITE_MEDIA_STORAGE"/&gt;
            &lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/&gt;
            &lt;uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/&gt;
            &lt;uses-permission android:name="android.permission.CAMERA"/&gt;
            &lt;uses-sdk android:minSdkVersion="16" android:targetSdkVersion="26"/&gt;
        &lt;/manifest&gt;
    &lt;/android&gt;
    &lt;modules/&gt;
    &lt;deployment-targets&gt;
        &lt;target device="android"&gt;true&lt;/target&gt;
        &lt;target device="ipad"&gt;false&lt;/target&gt;
        &lt;target device="iphone"&gt;false&lt;/target&gt;
    &lt;/deployment-targets&gt;
    &lt;sdk-version&gt;7.3.1.GA&lt;/sdk-version&gt;
&lt;/ti:app&gt;
</pre></code>
I've dug and dug and can not find anything that I may be missing.

<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-26370_65498/Screenshot_20180906-165427.jpg">Screenshot_20180906-165427.jpg</td></td><td>2018-09-06T10:55:12.000+0000</td><td>79182</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Rakhi Mitro 2018-09-06

   Hello,
   
   Tested this issue and able to reproduce on SDK 7.3.0.GA, android 8(Huawei y9 2018) device.
   
   *Test Environemnt:*
   <code><pre>
   
   Appcelerator Command-Line Interface, version 7.0.5
   Operating System
     Name                        = Mac OS X
     Version                     = 10.13.6
     Architecture                = 64bit
     # CPUs                      = 4
     Memory                      = 8589934592
   Node.js
     Node.js Version             = 8.9.1
     npm Version                 = 5.5.1
   Titanium CLI
     CLI Version                 = 5.1.1
   Titanium SDK
     SDK Version                 = 7.3.0.GA
   
   Device: Android 8(Huawei y9 2018) device, Android 5 device
     </pre></code>
   
   *Test code:* Sample code provided above
   
   *Test Steps:*
   1. Create a classic project .
   2. Paste the sample code and run. 
   3. Click on *Test DL Img & Save to Camera Roll* button. Checking the permissions. And receive error â€œ*Error Saving to Gallery*" by the app. Attached the screenshot.
   
   
   *Console logs:*
   
   <code><pre>
   [WARN] :   libEGL: EGLNativeWindowType 0x7330b73010 disconnect failed
   [ERROR] :  TiMedia: (main) [14437,14437] Failed to create external storage directory.
   [INFO] :   zygote64: Do partial code cache collection, code=30KB, data=29KB
   [INFO] :   zygote64: After code cache collection, code=30KB, data=29KB
   [INFO] :   zygote64: Increasing code cache capacity to 128KB
   [INFO] :   PressGestureDetector: HiTouch restricted: AboardArea.
   [INFO] :   APSAnalyticsRunnable: Analytics Started
   [INFO] :   APSAnalyticsRunnable: Stopping Service
   </pre></code></li>
<li>Pietro Granati 2018-10-04

   Same problem here! 
   Tested on LG and Huawei with android 8 and not working, on LG with android 6 no problem</li>
<li>Pietro Granati 2018-10-05

   Any news? This bug is HUGE!</li>
<li>Yordan Banev 2018-10-05

   I think this may be due to not providing WRITE_EXTERNAL_STORAGE permission at runtime. I will give the code a go and get back here when I have some results.</li>
<li>Michael Gangolf 2018-10-05

   [~ybanev]
   you are right. Requesting the runtime permission:
   <code><pre>
   var permissions = ['android.permission.WRITE_EXTERNAL_STORAGE'...];
   Ti.Android.requestPermissions(permissions, function(e) {...})
   </pre></code>
   
   works on Android 8. Without that I'll get the error described above</li>
<li>Pietro Granati 2018-10-05

   Yeah while searching I was trying and seems to work</li>
<li>Yordan Banev 2018-10-05

   Here is the reason why this problem occurred:
   <a href="https://developer.android.com/about/versions/oreo/android-8.0-changes#rmp" rel="nofollow" target="_blank">https://developer.android.com/about/versions/oreo/android-8.0-changes#rmp</a>
   What happens is that on Android API levels below 26 the WRITE_EXTERNAL_STORAGE was automatically granted if the user grants the READ_EXTERNAL_STORAGE permission since they are in the same permission group. The latter is requested by calling the <code>Ti.Media.requestCameraPermissions</code> method. They fixed that behavior in Android Oreo (see the link above).
   The workaround provided by [~michael] is the best way to go for now. </li>
<li>Michael Gangolf 2018-10-11

   I can't update the Wiki (permission denied), but the examples there should be updated to the latest permissions too:
   <a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/guide/Camera_and_Photo_Gallery_APIs
   </li>
<li>John Dalsgaard 2018-10-11

   Agree with Michael
   
   The documentation should mention that for iOS you need to add these permissions in tiapp.xml:
   
   <code><pre>
                   &lt;key&gt;NSCameraUsageDescription&lt;/key&gt;
                   &lt;string&gt;We need access to take a photo&lt;/string&gt;
                   &lt;key&gt;NSPhotoLibraryUsageDescription&lt;/key&gt;
                   &lt;string&gt;We need access to save a photo&lt;/string&gt;
                   &lt;key&gt;NSPhotoLibraryAddUsageDescription&lt;/key&gt;
                   &lt;string&gt;We need access to save a photo&lt;/string&gt;
   </pre></code>
   
   and the showCamera() method could be adapted to something like this:
   
   <code><pre>
       // check if we already have permissions to capture media
       var permissionsToRequest = ["android.permission.CAMERA","android.permission.WRITE_EXTERNAL_STORAGE"];
       if ((OS_ANDROID && !Ti.Android.hasPermission(permissionsToRequest)) || (OS_IOS && !Ti.Media.hasCameraPermissions())) {
           // request permissions to capture media
           if(OS_ANDROID) {
   	        Ti.Android.requestPermissions(permissionsToRequest,function (e) {
   	            // success! display the camera
   	            if (e.success) {
   	                camera();
   	            } else {
   	                callback(new Error('could not obtain camera permissions!'), null);
   	            }
   	        });
           } else {
   	        Ti.Media.requestCameraPermissions(function (e) {
   	            // success! display the camera
   	            if (e.success) {
   	                camera();
   	            } else {
   	                callback(new Error('could not obtain camera permissions!'), null);
   	            }
   	        });
           }
       } else {
           camera();
       }
   </pre></code>
   
   ... or some cleaner code ;-) </li>
<li>Yordan Banev 2018-10-17

    [~michael], [~jda] Thank you for the contribution! Scheduling to have the proposed changes/improvements included in 8.0.0.</li>
<li>Yordan Banev 2018-11-08

    PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/10443" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10443</a></li>
<li>Keerthi Mahalingam 2018-11-19

    FR Passed. PR merged</li>
<li>Keerthi Mahalingam 2018-11-26

    Verified the fix on SDK 8.0.0.v20181126083929 .Image get saved.Closing
    Test Environment:
      Name                        = Mac OS X
      Version                     = 10.13.6
      Architecture                = 64bit
      Memory                      = 17179869184
    Node.js
      Node.js Version             = 8.12.0
      npm Version                 = 6.4.1
    Titanium CLI
      CLI Version                 = 5.1.1
    Titanium SDK
      SDK Version                 = 8.0.0.v20181120090229
    Device                            =Pixel android 9,samsung s5 android 6
    Emulator                        =nexsus 6p android 8
    </li>
</ol>


<p><a href="/TIMOB/TIMOB-26370.json">JSON Source</a></p>