---
title: "[TIMOB-26673] iOS: Race conditions in async APIs (e.g. timers)"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2019-01-11T19:46:43.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 8.0.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 8.0.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Jan Vennemann</td></tr>
<tr><th>Assignee</th><td>Jan Vennemann</td></tr>
<tr><th>Created</th><td>2018-12-20T17:45:08.000+0000</td></tr>
<tr><th>Updated</th><td>2019-01-15T15:13:15.000+0000</td></tr>
</table>

<h3>Description</h3>

Async functions can trigger a race conditions which leads to an internal dead lock inside JavaScriptCore. This happens because we often reschedule block execution using [TiThreadPerformOnMainThread](<a href="https://github.com/appcelerator/titanium_mobile/blob/33498aeaddac7409a3f411a60455bfc5ddaeabf6/iphone/TitaniumKit/TitaniumKit/Sources/API/TiBase.m#L166)." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/33498aeaddac7409a3f411a60455bfc5ddaeabf6/iphone/TitaniumKit/TitaniumKit/Sources/API/TiBase.m#L166).</a>

Note that these race conditions only happen if a lot of async stuff happens at the same time. This example uses a timer with a 5ms interval to force the deadlock to happen. It is very unlikely to happen under normal conditions.

*Steps to reproduce the behavior*
Run the following code in a classic app on an iOS device:
<code><pre>
let counter = 0;
const win = Ti.UI.createWindow({ layout: 'vertical' });
const statusLabel = Ti.UI.createLabel({ top: 100, text: 'Running ...' });
win.add(statusLabel);
const counterLabel = Ti.UI.createLabel({ top: 5 });
win.add(counterLabel);
const testButton = Ti.UI.createButton({ top: 6, title: 'Click me!' });
testButton.addEventListener('click', () => Ti.API.info('expected'));
win.add(testButton);

function triggerRaceCondition() {
  counterLabel.text = counter++;
  console.log(<code>[${counter}] requestUserNotificationSettings</code>);
  Ti.App.iOS.UserNotificationCenter.requestUserNotificationSettings(e => {
    console.log(<code>[${counter}] requestUserNotificationSettings callback</code>);
  });
}
const triggerInterval = setInterval(() => triggerRaceCondition(), 5);
setTimeout(() => {
  clearInterval(triggerInterval);
  statusLabel.text = 'Finished!';
}, 1000);

win.open();
</pre></code>

*Actual behavior*
The whole app will freeze after a few iterations. The counter will not increase anymore and the button will not accept clicks.

*Expected behavior*
The counter should increase for about one second and then stop. The status should switch from "Running" to "Finished". The button should accept click events and print "expected" to the console.

*Additional information*
This is caused by [TiThreadPerformOnMainThread](<a href="https://github.com/appcelerator/titanium_mobile/blob/33498aeaddac7409a3f411a60455bfc5ddaeabf6/iphone/TitaniumKit/TitaniumKit/Sources/API/TiBase.m#L166)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/33498aeaddac7409a3f411a60455bfc5ddaeabf6/iphone/TitaniumKit/TitaniumKit/Sources/API/TiBase.m#L166)</a> which reschedules a block on the main queue when not running on main thread.

In this particular test case various things happen which ultimately lead to the deadlock inside JSCore:
<h4>The timer fires and calls out to its callback function (1)</h4>
<h4>Now, this function contains an async function, namely <code>Ti.App.iOS.UserNotificationCenter.requestUserNotificationSettings</code>. Under the hood this will call [getNotificationSettingsWithCompletionHandler:](<a href="https://developer.apple.com/documentation/usernotifications/unusernotificationcenter/1649524-getnotificationsettingswithcompl)" rel="nofollow" target="_blank">https://developer.apple.com/documentation/usernotifications/unusernotificationcenter/1649524-getnotificationsettingswithcompl)</a> of <code>UNUserNotificationCenter</code>. The completion handler for this method will be called on a separate thread. This is important for the race condition to happen.</h4>
<h4>Eventually the completion handler is called and it will call the JS callback (2) [here](<a href="https://github.com/appcelerator/titanium_mobile/blob/33498aeaddac7409a3f411a60455bfc5ddaeabf6/iphone/Classes/TiAppiOSUserNotificationCenterProxy.m#L199)." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/33498aeaddac7409a3f411a60455bfc5ddaeabf6/iphone/Classes/TiAppiOSUserNotificationCenterProxy.m#L199).</a></h4>
<h4>The timer fires again and it will be added to the dispatch queue to be processed.</h4>
<h4>Inside the callback (2) we make use of <code>console.log</code>. Since the callback was called from a different thread, KrollMethod will reschedule the <code>console.log</code> call to the main thread [here](<a href="https://github.com/appcelerator/titanium_mobile/blob/33498aeaddac7409a3f411a60455bfc5ddaeabf6/iphone/TitaniumKit/TitaniumKit/Sources/Kroll/KrollMethod.m#L42)." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/33498aeaddac7409a3f411a60455bfc5ddaeabf6/iphone/TitaniumKit/TitaniumKit/Sources/Kroll/KrollMethod.m#L42).</a> This will schedule the method call behind the previously scheduled timer.</h4>
<h4>The timer callback (1) is now called which also want's to use <code>console.log</code>. However, the pending call from callback (2) still has a lock on that. Boom, deadlock!</h4>

<h3>Comments</h3>

<ol>
<li>Jan Vennemann 2018-12-20

   A simple workaround for this specific test case using <code>UNNotificationCenter</code> is to wrap calling the callback in <code>TiThreadPerformOnMainThread</code>. This will schedule the complete callback execution on the main thread and not every single JS statement made in the callback. This should also be a lot more performant since we do not need to constantly switch threads.</li>
<li>Jan Vennemann 2018-12-20

   PR: <a href="https://github.com/appcelerator/titanium_mobile/pull/10556" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10556</a>
   
   This fixes the issues with <code>UNNotificationCenter</code>.
   
   We may need to scan our SDK for similar issues.</li>
<li>Jan Vennemann 2019-01-08

   8_0_X backport done in <a href="https://github.com/appcelerator/titanium_mobile/pull/10584" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10584</a></li>
<li>Keerthi Mahalingam 2019-01-10

   FR Passed. Waiting for  merge conflicts to be resolved for merge</li>
<li>Lokesh Choudhary 2019-01-11

   PR's Merged.</li>
<li>Samir Mohammed 2019-01-15

   Closing ticket, Verified fix in SDK Version 8.1.0.v20190115054502 and SDK version 8.0.0.v20190114160512.
   
   Test and other information can be found at: 
   Master: <a href="https://github.com/appcelerator/titanium_mobile/pull/10556" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10556</a>
   8_0_X: <a href="https://github.com/appcelerator/titanium_mobile/pull/10584" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10584</a></li>
</ol>


<p><a href="/TIMOB/TIMOB-26673.json">JSON Source</a></p>