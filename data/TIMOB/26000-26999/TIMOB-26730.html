---
title: "[TIMOB-26730] Android: Cannot use Socket.io module, closes connection after first message"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Not Our Bug</td></tr>
<tr><th>Resolution Date</th><td>2019-02-15T18:00:37.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>n/a</td></tr>
<tr><th>Reporter</th><td>Hans Knöchel</td></tr>
<tr><th>Assignee</th><td>Jan Vennemann</td></tr>
<tr><th>Created</th><td>2019-01-15T17:54:39.000+0000</td></tr>
<tr><th>Updated</th><td>2019-02-15T18:00:37.000+0000</td></tr>
</table>

<h3>Description</h3>

While working with Socket.io on iOS works fine, we are running into critical issues when using the module on Android. The first message works, after that the following error occurs and the communication is broken.

<code><pre>
[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}
[ERROR] Error in socket connection

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[WARN]  W/com.appc.app: No such thread id for suspend: 29
[WARN]  System: A resource failed to call response.body().close().
[INFO]  chatty: uid=10108(com.appc.app) OkHttp Connecti identical 1 line
[WARN]  System: A resource failed to call response.body().close().
[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}

[ERROR] Error in socket connection
[ERROR] {"message":"xhr poll error"}
</pre></code>

Maybe the OKHTTP library used in the core clashes with this one?


<h3>Comments</h3>

<ol>
<li>Joshua Quick 2019-01-18

   Google's Android OS uses the okhttp library internally, which is what the Android <code>HttpUrlConnection</code> Java class uses under the hood. So, this is most likely an okhttp library version conflict. Unfortunately, the only 100% ensured way of avoiding this issue is to either:
   <h4>Recompile the entire okhttp library under a different namespace.</h4>
   <h4>Remove the module's okhttp library usage and use some other API.</h4>
   
   I'm curious. What do you need from "ti.socket" that our core <code>Ti.Network.Socket</code> doesn't offer?</li>
<li>Hans Knöchel 2019-01-18

   Thanks for the suggestion Josh! We didn't try Ti.Network.Socket so far, because the official socket.io library seemed to be the best match here and is pretty performant on iOS. Regarding the conflict: The module uses okhttp-3.11.0.jar and okio-1.14.1.jar, so maybe it's something there. We will also give the ti.network socket a shot!</li>
<li>Jan Vennemann 2019-01-18

   [~jquick] that module is for [socket.io](<a href="https://socket.io/)" rel="nofollow" target="_blank">https://socket.io/)</a>, not just a simple socket ;) To use <code>Ti.Network.Socket</code> one would have to write a WebSocket implementation first and then use that to implement a socket.io client.</li>
<li>Joshua Quick 2019-01-18

   Oh gotcha. You're after the WebSocket protocol.
   
   So, we could try updating the okhttp library to the newest version. Assuming that it's backward compatible with older Android OS versions and it doesn't conflict with what Google is using. It's worth a try. Although their newest version's min Android version supported is 5.0, which doesn't line-up with Titanium's min version of 4.4.
   <a href="http://square.github.io/okhttp" rel="nofollow" target="_blank">http://square.github.io/okhttp</a>
   </li>
<li>Jan Vennemann 2019-02-07

   This is most likely due to a nginx reverse proxy setup. This prevents socket.io from successfully upgrading the http connection to a websocket connection. The iOS client handles this transparently by remaining in http polling mode. The Android client however seems to have issues with an upgrade error.
   
   Please see the following link and see if your server setup is properly configured: <a href="https://www.nginx.com/blog/websocket-nginx/" rel="nofollow" target="_blank">https://www.nginx.com/blog/websocket-nginx/</a>
   </li>
<li>Jan Vennemann 2019-02-15

   This was indeed caused by a missing configuration in the nginx reverse proxy. Closing since it was fixed on the server side.</li>
</ol>


<p><a href="/TIMOB/TIMOB-26730.json">JSON Source</a></p>