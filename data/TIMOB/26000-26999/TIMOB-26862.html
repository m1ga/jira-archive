---
title: "[TIMOB-26862] Android: TextField/TextArea within a TableView can have performance issues with some keyboards"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2019-07-15T19:14:24.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 8.1.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>TableView, TextArea, TextField, android, en, engSchedule</td></tr>
<tr><th>Reporter</th><td>Hans Kn√∂chel</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2019-02-26T15:07:28.000+0000</td></tr>
<tr><th>Updated</th><td>2019-07-15T19:14:24.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
Entering text into a <code>TextField</code>/<code>TextArea</code> embedded within a <code>TableView</code> can cause performance issues if the virtual keyboard shows/hides its top suggestion bar dynamically. It can also cause the cursor to suddenly move to the end of field and cause the field to flicker.

*Reason:*
By default, the "windowSoftInputMode" is set to <code>Ti.UI.Android.SOFT_INPUT_ADJUST_PAN</code> (aka: "adjustPan"), which means that showing/hiding the virtual keyboards will cause the window to resize. The resizing of a <code>TableView</code> triggers its row recycling/update behavior which can cause the "contents" of each row (such as the <code>TextField</code>) to be re-parented to a new row container view, which causes havoc with the virtual keyboard.

For virtual keyboards that have a fixed height and do not pop-in/out a suggestion bar as you type, this isn't really an issue since the above mentioned resize behavior happens once. For example, this is not an issue on a Pixel phone.

But some device pop-in/out a suggestion bar as you type which causes the <code>TableView</code> to resize every time you type in a character. This will cause massive performance issues.

*Steps to reproduce:*
<h4>Build and run [^TableOfTextFieldsTest.js] on Android.</h4>
<h4>Tap on row 1's <code>TextArea</code>.</h4>
<h4>Notice that the cursor is moved to end of the field. (The code is supposed to highlight the whole text instead.)</h4>
<h4>Notice the below warnings get logged.</h4>

<code><pre>
[WARN]  IInputConnectionWrapper: getTextBeforeCursor on inactive InputConnection
[WARN]  IInputConnectionWrapper: getSelectedText on inactive InputConnection
[WARN]  IInputConnectionWrapper: getTextAfterCursor on inactive InputConnection
</pre></code>

*Work-Around 1:*
Set up the window to "adjustPan". This works-around the issue because it causes the virtual keyboard to be overlaid on top of the window instead of resizing it, which avoids the issue.
<code><pre>
var window = Ti.UI.createWindow({
	windowSoftInputMode: Ti.UI.Android ? Ti.UI.Android.SOFT_INPUT_ADJUST_PAN : null,
});
</pre></code>

*Work-Around 2:*
Use a <code>ScrollView</code> instead of a <code>TableView</code>.


<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-26862_66229/TableOfTextFieldsTest.js">TableOfTextFieldsTest.js</td></td><td>2019-03-09T00:24:43.000+0000</td><td>1117</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-26862_66227/TableViewCustomRowTest.js">TableViewCustomRowTest.js</td></td><td>2019-03-09T00:23:19.000+0000</td><td>1554</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-26862_66228/TableViewDefaultRowTest.js">TableViewDefaultRowTest.js</td></td><td>2019-03-09T00:23:19.000+0000</td><td>1326</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Srinivasan Pulipakkam 2019-02-26

   [~amukherjee] [~jquick] : can you check this.</li>
<li>Joshua Quick 2019-03-05

   Calling the Java <code>EditText.setText()</code> method will cause these warnings because it will replace the internal <code>Editable</code> Java object. It is better to call the <code>EditText.getText().replace()</code> method instead, which re-uses the existing <code>Editable</code> object just like how the keyboard does it. This gets rid of the logged warnings and should be an optimization.
   
   I've also noticed that these warnings will be logged when showing/dismissing the virtual keyboard with a <code>TextField</code> and <code>TextArea</code> *+embedded+* within a Titanium <code>TableView</code> or <code>ListView</code>. The issue [~hknoechel] is seeing might be related to [TIMOB-18903]. On an Android phone (not a tablet), these warnings only happen when in portrait orientation too, not landscape since a fullscreen edit screen is displayed. (Embedding them within a <code>ScrollView</code> works fine; no warnings.)
   </li>
<li>Joshua Quick 2019-03-06

   Regarding the warnings caused by showing/dismissing a <code>TextField</code>'s virtual keyboard while it is embedded within a <code>TableView</code>, this is only an issue when the "windowSoftInputMode" is set to <code>SOFT_INPUT_ADJUST_SIZE</code>, which is the Android OS' default setting (ie: "adjustSize" in the "AndroidManifest.xml"). This issue won't happen if the window is set up to use "adjustPan" as shown below.
   <code><pre>
   var window = Ti.UI.createWindow({
   	windowSoftInputMode: Ti.UI.Android.SOFT_INPUT_ADJUST_PAN,
   });
   </pre></code>
   
   Titanium's <code>Ti.UI.TableView</code> and <code>Ti.UI.ListView</code> currently use Google's Java <code>ListView</code> class internally. From looking at Google's code, its <code>onLayout()</code> method will flag all of its children/rows as dirty and forcefully reload them. This is triggering the row view recycling behavior and I believe the text field is being quickly detached and re-attached to its row container view. Since "adjustSize" is the default setting on Android, the virtual keyboard will force a resize of the app's window and <code>ListView</code>, which will in turn call its <code>onLayout()</code> method. I believe this is what's causing the issue. This would also explain why switching to "adjustPan" (as shown above) works-around the issue.
   [AbsListView.onLayout()](<a href="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/AbsListView.java#L2188)" rel="nofollow" target="_blank">https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/widget/AbsListView.java#L2188)</a>
   
   [~hknoechel] has shown me a video of his issue. The reason why he's seeing a performance issue is because his device's virtual keyboard pops-up a suggestion bar when typing in the field, which increases the keyboard height. And since "adjustSize" is the default, this causing the <code>ListView</code> to shrink in size and trigger another relayout. The relayout resets the text field's cursor state to the end of the field, which removes the suggestion bar above the keyboard, causing the keyboard height to shrink... which again resizes the app window and <code>ListView</code> triggering another relayout. This explains the performance issues.
   
   I'm not able to reproduce the performance issue on a Google Pixel device's virtual keyboard since its top suggestion bar never appears/disappears, meaning the keyboard height doesn't fluctuate. I only see a the logged warnings once when showing the keyboard and again when dismissing the keyboard. I don't see the warnings while typing as [~hknoechel] is seeing since his keyboard suggestion bar is added/removed dynamically.
   
   I'm not sure how to solve this issue at the moment.
   
   But we do know how to work-around it by doing one of the following:
   * Use a <code>ScrollView</code> instead of a <code>TableView</code>/<code>ListView</code> when showing text fields
   * Set <code>TI.UI.Window</code> "windowSoftInputMode" to <code>Ti.UI.Android.SOFT_INPUT_ADJUST_PAN</code>.
   </li>
<li>Joshua Quick 2019-03-06

   I've noticed that this <code>TableView</code> issue happens on Android 7.0 and above.
   
   When the native Java <code>ListView.onLayout()</code> method is called, it triggers the recycling behavior. This calls Titanium's <code>Adapter.getView()</code> method to see if the given row view container can be re-used or if a new row view container needs to be created. Our current adapter code will always create a new row container for Android 7.0 (aka: API Level 24) and above as can be seen in the link below.
   [TiTableView.java#L218](<a href="https://github.com/appcelerator/titanium_mobile/blob/master/android/modules/ui/src/java/ti/modules/titanium/ui/widget/tableview/TiTableView.java#L218)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/android/modules/ui/src/java/ti/modules/titanium/ui/widget/tableview/TiTableView.java#L218)</a>
   
   Quick code snippet...
   <code><pre>
   // TIMOB-24560: prevent duplicate TableViewRowProxyItem on Android N
   if (Build.VERSION.SDK_INT &gt; 23) {
   	ArrayList&lt;Item&gt; models = viewModel.getViewModel();
   	if (models != null && v instanceof TiTableViewRowProxyItem && models.contains(v.getRowData())) {
   		v = null;
   		sameView = true;
   	}
   }
   </pre></code>
   
   
   If I comment out that code, the logged warnings go away... but only if the row was already above the virtual keyboard. The reason this works is that the row container is being re-used and the text field is not being detached and re-attached to another row container. Note that I say it only solves this issue if the row is above the virtual keyboard. If the keyboard overlaps the row, then the old row container is offscreen, which causes it to be recycled, and then a new row container needs to be set up anyways... which is the correct behavior in this case and there is no getting around the logged warnings.
   
   Now we can't simply comment out that code since it's needed for a reason. Android 7.0 is much more aggressive about recycling rows as can be seen in ticket [TIMOB-24560].
   </li>
<li>Joshua Quick 2019-03-09

   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/10745" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10745</a></li>
<li>Joshua Quick 2019-06-05

   PR (8.1.x): <a href="https://github.com/appcelerator/titanium_mobile/pull/10936" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10936</a></li>
<li>Lokesh Choudhary 2019-07-12

   FR's Passed.
   Waiting for jenkins to merge.</li>
<li>Christopher Williams 2019-07-15

   merged to 8_1_X (had already been merged to master)</li>
<li>Lokesh Choudhary 2019-07-15

   Verified the fix in sdk 8.1.0.v20190715100642 & 8.2.0.v20190715083607.
   
   Closing.</li>
</ol>


<p><a href="/TIMOB/TIMOB-26862.json">JSON Source</a></p>