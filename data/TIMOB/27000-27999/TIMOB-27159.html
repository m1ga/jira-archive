---
title: "[TIMOB-27159] iOS: Ti.UI.WebView cannot load html files from cache"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2020-01-30T21:11:45.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 8.0.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 9.0.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>8.0.0, engSchedule, ios, webview</td></tr>
<tr><th>Reporter</th><td>Nikos Poulios</td></tr>
<tr><th>Assignee</th><td>Vijay Singh</td></tr>
<tr><th>Created</th><td>2019-05-09T09:18:49.000+0000</td></tr>
<tr><th>Updated</th><td>2020-01-30T21:11:45.000+0000</td></tr>
</table>

<h3>Description</h3>

*Note: Issue can be reproduced only on device, webview works as expected on simulator*
New WebView fails to load html files stored in the app with the error:

<code><pre>
default	11:34:49.407006 +0300	com.apple.WebKit.Networking	0x1075e8000 - NetworkResourceLoader::startNetworkLoad: (pageID = 5, frameID = 1, resourceID = 1, isMainResource = 1, isSynchronous = 0)
default	11:34:49.407054 +0300	com.apple.WebKit.Networking	Task &lt;0AF948FB-871A-4EDD-A632-D67CBB10B3BC&gt;.&lt;1&gt; resuming, QOS(0x19)
default	11:34:49.407103 +0300	com.apple.WebKit.Networking	[Telemetry]: Activity &lt;nw_activity 16:2 [3A7E50A1-6DED-43AC-8750-A3865F7FCB48] (reporting strategy default)&gt; on Task &lt;0AF948FB-871A-4EDD-A632-D67CBB10B3BC&gt;.&lt;1&gt; was not selected for reporting
error	11:34:49.407332 +0300	kernel	Sandbox: com.apple.WebKit(10340) deny(1) file-read-data /private/var/mobile/Containers/Data/Application/B7D5C2EF-634E-4F7E-A7EC-BAB4DDF48868/Library/Caches/307/platform_article_1112110663/article.html
default	11:34:49.407402 +0300	com.apple.WebKit.Networking	0x1075e8000 - NetworkResourceLoader::startNetworkLoad: (pageID = 5, frameID = 1, resourceID = 1, description = LocalDataTask &lt;0AF948FB-871A-4EDD-A632-D67CBB10B3BC&gt;.&lt;1&gt;)
error	11:34:49.407557 +0300	com.apple.WebKit.Networking	Task &lt;0AF948FB-871A-4EDD-A632-D67CBB10B3BC&gt;.&lt;1&gt; finished with error - code: 1
error	11:34:49.407608 +0300	com.apple.WebKit.Networking	Task &lt;0AF948FB-871A-4EDD-A632-D67CBB10B3BC&gt;.&lt;1&gt; load failed with error Error Domain=kCFErrorDomainCFNetwork Code=1 UserInfo={_NSURLErrorRelatedURLSessionTaskErrorKey=&lt;private&gt;, _NSURLErrorFailingURLSessionTaskErrorKey=&lt;private&gt;} [1]
default	11:34:49.408142 +0300	com.apple.WebKit.Networking	0x1075e8000 - NetworkResourceLoader::didFailLoading: (pageID = 5, frameID = 1, resourceID = 1, isTimeout = 0, isCancellation = 0, isAccessControl = 0, errCode = 1)
</pre></code>

Reading iOS documentation I noticed that local files should be loaded using *loadFileURL* method as in <a href="https://github.com/appcelerator-modules/Ti.WKWebView/blob/master/ios/Classes/TiWkwebviewWebView.m#L198" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/Ti.WKWebView/blob/master/ios/Classes/TiWkwebviewWebView.m#L198</a> but I don't see that in <a href="https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUIWebView.m#L664" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/iphone/Classes/TiUIWebView.m#L664</a>


<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-27159_66679/Resources.zip">Resources.zip</td></td><td>2019-06-10T13:03:35.000+0000</td><td>2259</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Vijay Singh 2019-05-31

   [~nipoul] Can you give a test case for mentioned issue? Thanks!</li>
<li>Nikos Poulios 2019-06-10

   Hi,
   
   Sorry for the delay, I uploaded a test case. It turns out issue exists when trying to access a file stored in app's Cache directory. As you can see I have 3 cases:
   
   
   <code><pre>
   //All OK
   //webView.url = fileInResources.nativePath;
   
   //Does not work at all on device
   webView.url = fileInCache.nativePath;
   
   //works but no css on device
   // webView.setHtml(htmlInCache.read(), {
   // 	baseURL: cacheDir.nativePath
   // });
   </pre></code>
   
   When html and css file are on resources everything is ok, setting url to a path under Cache fails, and setHtml using file.read from cache works but again css fails to load. Again the only workaround working is using setHtml and referring to css by absolute path in resources.
   
   Is this an iOS restriction? Is there any workaround to have html in cache and use relative paths for css files?
   I tried using the code below in the SDK and it works but again  allowingReadAccessToURL is fixed so it's not proper solution, ideally it would be set similarly to baseURL param in setHtml
   
   <code><pre>
       [[self webView] loadFileURL:[NSURL fileURLWithPath:path]
           allowingReadAccessToURL:[NSURL fileURLWithPath:[[[path stringByDeletingLastPathComponent] stringByDeletingLastPathComponent]];
   </pre></code>
   
   Thank you in advance
   </li>
<li>Vijay Singh 2019-06-18

   Thanks for test case [~nipoul]. Webkit  has restricted more on local file loading via WKWebView. Apple has given new API in WKWebView as mentioned in above comment [- (WKNavigation *)loadFileURL:(NSURL *)URL  allowingReadAccessToURL:(NSURL *)readAccessURL](<a href="https://developer.apple.com/documentation/webkit/wkwebview/1414973-loadfileurl?language=objc)." rel="nofollow" target="_blank">https://developer.apple.com/documentation/webkit/wkwebview/1414973-loadfileurl?language=objc).</a> 
   I think we should  expose new API for local file Urls-
   
   setFileUrl({
   url: "local file url",
   readAccessUrl: "read access file url"
   })
   
   [~jquick] What you think? 
   Thanks!</li>
<li>Joshua Quick 2019-06-18

   [~vijaysingh], this sounds like a security feature on Apple's end. Particularly for MacOS where they don't want some rogue local HTML file having full filesystem access via a file:// scheme... and iOS inherited it.
   
   Android's <code>WebView</code> doesn't have an equivalent to the <code>allowingReadAccessToURL</code> API.
   
   Do we need to add a new API? What if we were to automatically assign the <code>allowingReadAccessToURL</code> to the given HTML file's directory path?</li>
<li>Nikos Poulios 2019-06-18

   If possible It would be nice to be able to set allowingReadAccessToURL actually, so that assets like css files can be shared between files in cache using relative paths</li>
<li>Vijay Singh 2019-06-18

   <a href="https://github.com/appcelerator/titanium_mobile/pull/10976" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/10976</a>
   
   Test Case - 
   
   <code><pre>
   (function() {
       var window = Ti.UI.createWindow();
           
       var createDirectory = function(f) {
           if(f && !f.exists()) {
            f.createDirectory();
           }
           
           return f;   
       };
       
       //Copy from Resources to cache folder
       var cacheDir = createDirectory(Ti.Filesystem.getFile(Ti.Filesystem.applicationCacheDirectory));
       var htmlDir = createDirectory(Ti.Filesystem.getFile(cacheDir.nativePath, 'html'));
       var cssDir = createDirectory(Ti.Filesystem.getFile(cacheDir.nativePath, 'css'));
       var resourceDir = Ti.Filesystem.getFile(Ti.Filesystem.resourcesDirectory);
   
       var htmlFile = Ti.Filesystem.getFile(Ti.Filesystem.resourcesDirectory, 'html', 'example.html');
       var cssFile = Ti.Filesystem.getFile(Ti.Filesystem.resourcesDirectory, 'css', 'test.css');
       
       var htmlInCache = Ti.Filesystem.getFile(cacheDir.nativePath, 'html', 'example.html');   
       var cssInCache = Ti.Filesystem.getFile(cacheDir.nativePath, 'css', 'test.css');
           
       htmlFile.copy(htmlInCache.nativePath);
       cssFile.copy(cssInCache.nativePath);
       
       var fileInResources = Ti.Filesystem.getFile(Ti.Filesystem.resourcesDirectory, 'html', 'example.html');
           
       var webView = Ti.UI.createWebView({
           width: Ti.UI.FILL,
           height: Ti.UI.FILL,
           url: htmlInCache.nativePath,
           assetsDirectory: cacheDir.nativePath
       });
       
   
       window.add(webView);
       window.open();
   })();
   </pre></code>
   </li>
<li>Keerthi Mahalingam 2019-08-05

   FR passed.please provide PR for 8_3_X</li>
<li>Christopher Williams 2019-08-29

   While the FR may have passed, the unit tests for WebView are repeatedly failing for this PR. As such, I've bumped that back to failed QE/review. 4 WebView tests are timing out on this PR, and have been after several builds on Jenkins.</li>
<li>Vijay Singh 2019-08-30

   It looks like iOS 13 broken WKWebView's API - (nullable WKNavigation *)loadFileURL:(NSURL *)URL allowingReadAccessToURL:(NSURL *)readAccessURL.  See discussion <a href="https://forums.developer.apple.com/thread/120566" rel="nofollow" target="_blank">https://forums.developer.apple.com/thread/120566</a>
   In iOS 12 it is working fine.</li>
<li>Vijay Singh 2020-01-14

    PR - <a href="https://github.com/appcelerator/titanium_mobile/pull/11431" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11431</a></li>
<li>Samir Mohammed 2020-01-23

    FR Passed, Waiting on Jenkins build</li>
<li>Christopher Williams 2020-01-23

    merged to master for 9.0.0</li>
<li>Lokesh Choudhary 2020-01-30

    Verified the fix with SDK 9.0.0.v20200130075800.
    Closing.</li>
</ol>


<p><a href="/TIMOB/TIMOB-27159.json">JSON Source</a></p>