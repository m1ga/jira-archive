---
title: "[TIMOB-27206] LiveView: unable to require files under node_modules"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>None</td></tr>
<tr><th>Status</th><td>Open</td></tr>
<tr><th>Resolution</th><td>Unresolved</td></tr>

<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>LiveView</td></tr>
<tr><th>Labels</th><td>alloy, engSchedule, liveview</td></tr>
<tr><th>Reporter</th><td>Brenton House</td></tr>
<tr><th>Assignee</th><td>Ewan Harris</td></tr>
<tr><th>Created</th><td>2019-07-02T19:52:43.000+0000</td></tr>
<tr><th>Updated</th><td>2021-02-22T20:01:37.000+0000</td></tr>
</table>

<h3>Description</h3>

SDK:  8.0.2.GA
Titanium: 5.2.1
Alloy:  1.14.0-1
--------------------------------

UPDATE:  Upon further investigation, I've found that it is more than just Alloy.Globals that is being affected by this.  Every time alloy is required using <code>require()</code> it is getting a fresh version so any changes that were made to the same module in a different class are lost.  

require('/alloy') on index.js gets a clean version and thus all changes made in alloy.js are gone.   Even if I move all the logic of assigning things to Alloy.Globals to index.js, everything added is gone when the next controller is loaded.

I have a stand-alone project that I can share to duplicate this issue.

--------------------------------
When defining an event handler function in alloy.js:


<code><pre>
Alloy.Globals.eventHandler = e =&gt; {
	console.error('you are here â†’ Alloy.Globals.eventHandler1');
	alert('button clicked 1');
}

</pre></code>

and then using it in index.xml:


<code><pre>
&lt;Label id="label1" onClick="Alloy.Globals.eventHandler" text="Hello, World" /&gt;
</pre></code>


When this auto-generated controller code is executed:


<code><pre>
$.addListener($.__views.label1, 'click', Alloy.Globals.eventHandler);
</pre></code>


It gets to this code in the BaseController:


<code><pre>
proxy.addEventListener(type, callback);
</pre></code>


and then throws an error because callback is undefined.  


<code><pre>
[INFO]  [LiveView] Error Evaluating app.js @ Line: 430
[ERROR] Error: Invalid type passed to function
[ERROR] File: app.js
[ERROR] Line: 430
[ERROR] SourceId: &lt;null&gt;
[ERROR] Backtrace:
[ERROR]  undefined

</pre></code>

The file is actually BaseController.js Line: 430 but it just reports app.js when using LiveView.

NOTE:  This does not happen in every app.  I am not sure how LiveView is handling alloy.js code so I might need to get more familiar with that before I can say what or why Alloy.Globals.eventHandler would be undefined even though it is defined in alloy.js.

<h3>Comments</h3>

<ol>
<li>Ewan Harris 2019-07-03

   So this looks down to be reproducible sample vendoring the node_modules. Here's my observations
   
   * The <code>require('alloyxl')</code> call at the top of the file seems to be the root cause of the problems here
   * This is because liveview has no real support for loading from node_modules, it has some code that was used to support loading the polyfilling libs that looks into the Resources dir as well as the build dir, so when requiring <code>alloyxl</code> the liveview server cant find the module and responds with a 404, causing the liveview app code to fallback to the "native require", which does know about node_modules, so requires it successfully, I believe this fallback is intended for native modules and not js files. 
   * I suspect that because of the differences in how the require mechanisms work, this is then causing problems which is breaking Alloy.Globals. Commenting out that require, or putting an alloyxl.js file under lib fixes the issue.
   
   I guess technically this is a bug in liveview, but it's due to a use case that liveview has never stated to support (but it should).</li>
<li>Brenton House 2019-07-03

   I added another test to the app where I am doing a new require from node_modules:   require('test1')
   
   When I do this in alloy.js and assign a property a value, that value is still there when I require it again in index.js.
   
   This would seem to contradict the theory from above...</li>
<li>Brenton House 2019-12-18

   The flip-side also seems to be an issue.  If I am requiring a file (like alloy.js) from a JavaScript file under node_modules, it seems to give me a new context and any properties that were set on it at runtime are absent.</li>
</ol>


<p><a href="/TIMOB/TIMOB-27206.json">JSON Source</a></p>