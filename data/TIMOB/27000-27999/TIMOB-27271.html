---
title: "[TIMOB-27271] Android: Resuming with intent using "FLAG_ACTIVITY_MULTIPLE_TASK" can hang the app"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2019-08-22T14:57:46.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 8.1.1</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, engSchedule, intent, intent-filter, resume</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2019-07-23T01:40:33.000+0000</td></tr>
<tr><th>Updated</th><td>2019-08-22T14:57:46.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
Resuming an app with an intent having <code>FLAG_ACTIVITY_MULTIPLE_TASK</code> set causes it to hang in Titanium 8.0.0 if the app does not immediately open a window via its "newintent" event.

Titanium 7.x.x and older isn't much better. It won't hang on startup, but will instead create a new splash screen activity instance and do nothing.

*Note:*
The Android OS will automatically add the <code>FLAG_ACTIVITY_MULTIPLE_TASK</code> to intents assigned the <code>ACTION_SEND</code> action. So, apps whose intent-filter do not handle "intent-filter" <code>ACTION_SEND</code> typically don't have to worry about this issue.

*Steps to reproduce:*
<h4>Create a classic Titanium app.</h4>
<h4>Set project name to "IntentTest". _(This is <code><name/></code> in "tiapp.xml".)_</h4>
<h4>Set project's "Application Id" to "com.appc.intent.test". _(This is <code><id/></code> in "tiapp.xml".)_</h4>
<h4>Set up the "app.js" with the below code.</h4>
<h4>Build and run on Android.</h4>
<h4>Open the Mac "Terminal".</h4>
<h4>CD (change directory) to: <code>~/Library/Android/sdk/platform-tools</code></h4>
<h4>In the terminal, enter the following...</h4>

<code><pre>
./adb shell am start -n com.appc.intent.test/.IntenttestActivity -a android.intent.action.VIEW -d <a href="https://www.appcelerator.com" rel="nofollow" target="_blank">https://www.appcelerator.com</a> -f 0x08000000
</pre></code>

app.js
<code><pre>
Ti.Android.rootActivity.addEventListener("newintent", function(e) {
	label.text = "New Intent:\n" + JSON.stringify(e.intent, null, 4);
	Ti.API.info("@@@ newintent: " + JSON.stringify(e.intent));
});

var window = Ti.UI.createWindow();
var scrollView = Ti.UI.createScrollView({
	scrollType: "vertical",
	width: Ti.UI.FILL,
	height: Ti.UI.FILL,
});
var label = Ti.UI.createLabel({
	text: "Launch Intent:\n" + JSON.stringify(Ti.Android.rootActivity.intent, null, 4),
	width: Ti.UI.FILL,
	height: Ti.UI.SIZE,
});
scrollView.add(label);
window.add(scrollView);
window.open();
</pre></code>

*Result:*
In Titanium 8.0.0 and higher, the app hangs. Also notice in the log that the "newintent" is being logged non-stop, meaning the "newintent" event is being fired repeatedly when it should only be fired once.

In Titanium versions older than 8.0.0, a new splash screen activity window is displayed, but nothing happens. Note that the app is not hung and you can back-out of the splash window, but this is still not good behavior.

*Expected Result:*
The "newintent" event should only be fired once and not hang the app.

*Work-around:*
Immediately open a window when a "newintent" is received set with this flag.

If you don't want to open a window immediately, then you can instead quickly open/close a temporary window when this flag is set. Note that closing a window immediately as shown below prevents it from ever being shown, because Titanium destroys it via the activity's <code>onCreate()</code> method.
<code><pre>
Ti.Android.rootActivity.addEventListener("newintent", function(e) {
	// This works-around the issue.
	if (e.intent.flags & Ti.Android.FLAG_ACTIVITY_MULTIPLE_TASK) {
		var window = Ti.UI.createWindow();
		window.open();
		window.close();
	}
});
</pre></code>

_(I've tested the below on Android Q while target API Level 29. It works fine.)_


<h3>Comments</h3>

<ol>
<li>Joshua Quick 2019-07-23

   My initial thought was to set the activity's "android:documentLaunchMode" attribute to "never", which according to Google's docs would make it ignore the <code>FLAG_ACTIVITY_MULTIPLE_TASK</code> intent flag.
   <a href="https://developer.android.com/guide/topics/manifest/activity-element#dlmode" rel="nofollow" target="_blank">https://developer.android.com/guide/topics/manifest/activity-element#dlmode</a>
   
   While this does work and makes it re-use the existing activity (instead of creating a duplicate activity instance), the negative consequence is that the activity is put into a "singleTask" like mode where the Android OS will automatically destroy all child activities when it is started via an intent. This is not a viable option for us. Most app devs don't want "singleTask" like behavior (and they can already opt-in to this behavior if they want anyways).</li>
<li>Joshua Quick 2019-07-26

   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/11080" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11080</a>
   PR (8.1.x): <a href="https://github.com/appcelerator/titanium_mobile/pull/11081" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11081</a>
   </li>
<li>Keerthi Mahalingam 2019-07-29

   FR Passed. NO hanging when resuming app with an intent having FLAG_ACTIVITY_MULTIPLE_TASK. Works as Expected. Waiting for the 8.1.0 GA release  to merge this PR
   </li>
<li>Joshua Quick 2019-08-14

   PR (8.3.x): <a href="https://github.com/appcelerator/titanium_mobile/pull/11145" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11145</a></li>
<li>Christopher Williams 2019-08-20

   Merged to master, 8_3_X and 8_1_X</li>
<li>Samir Mohammed 2019-08-22

   *Closing ticket* fix verified in SDK version <code>8.2.0.v20190820104021</code>, <code>8.1.1.v20190820143437</code> and <code>8.3.0.v20190820103430</code>.
   
   Test and other information can be found at:
   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/11080" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11080</a>
   PR (8.1.x): <a href="https://github.com/appcelerator/titanium_mobile/pull/11081" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11081</a>
   PR (8.3.x): <a href="https://github.com/appcelerator/titanium_mobile/pull/11145" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11145</a></li>
</ol>


<p><a href="/TIMOB/TIMOB-27271.json">JSON Source</a></p>