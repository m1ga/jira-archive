---
title: "[TIMOB-27872] Android: Blob imageAsX() methods ignore EXIF orientation if not wrapping a file"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2020-08-11T13:13:50.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 9.1.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, blob, exif, jpeg, orientation</td></tr>
<tr><th>Reporter</th><td>Samir Mohammed</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2020-04-29T16:21:18.000+0000</td></tr>
<tr><th>Updated</th><td>2020-08-11T13:13:50.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
When a Titanium blob references a non-file type, such as a byte buffer or "content://" URL, then the blob's <code>imageAs*()</code> methods will ignore a JPEG's EXIF orientation setting.

This affects the following methods:
* <code>Blob.imageAsCropped()</code>
* <code>Blob.imageAsResized()</code>
* <code>Blob.imageAsThumbnail()</code>
* <code>Blob.imageWithAlpha()</code>
* <code>Blob.imageWithRoundedCorner()</code>
* <code>Blob.imageWithTransparentBorder()</code>

*Steps to reproduce:*
<h4>Build the attached  [^DownloadImageBlobTest.js] on Android.</h4>
<h4>Tap on the "Download" button. (Requires Internet access.)</h4>
<h4>Tap on "JPEG - EXIF Rotate 90" in option dialog.</h4>
<h4>Notice that the displayed resized image is not upright. (This is the bug.</h4>
<h4>Do the same with all of the other "EXIF" options in the dialog. They all have this issue.</h4>


<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-27872_67353/DownloadImageBlobTest.js">DownloadImageBlobTest.js</td></td><td>2020-05-02T01:07:16.000+0000</td><td>2688</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Joshua Quick 2020-04-29

   It's an issue with blobs that do *not* wrap a file system path. That is, blobs which wrap a "content://" URL (like in above test case) or when the blobs wraps an in-memory image.
   
   *Solution:*
   In our <code>TiBlob.java</code> code, we have method calls to <code>TiImageHelper.getOrientation()</code> which fetch the EXIF orientation from a JPEG. Instead of passing a file path to it, we should pass an <code>InputStream</code> to it instead.
   <a href="https://github.com/jquick-axway/titanium_mobile/blob/master/android/titanium/src/java/org/appcelerator/titanium/TiBlob.java" rel="nofollow" target="_blank">https://github.com/jquick-axway/titanium_mobile/blob/master/android/titanium/src/java/org/appcelerator/titanium/TiBlob.java</a>
   </li>
<li>Joshua Quick 2020-05-02

   Below is [~smohammed]'s original ticket summary. Th below can reproduce this issue when taking a camera shot on a Pixel XL device and then calling <code>imageAsResized()</code>. Not all devices can reproduce it this way though since some camera will always save the photo in the upright position... and some won't and will write the orientation to the JPEG's EXIF data instead.
   
   *+Test Case:+*
   *index.js*
   <code><pre>
   _.delay(function() {
   	Titanium.Media.showCamera({
   		success: function(e) {
   			var start = new Date().getTime();
   			var blob = e.media;
   			var w = e.media.width;
   			var h = e.media.height;
   			var r = h / w;
   			w = 350;
   			h = 300;
   			blob = blob.imageAsResized(w, h);
   			$.img.image = blob;
   			var end = new Date().getTime();
   			console.log(end - start);
    
   			console.log(e.media.width, e.media.height);
   			console.log(blob.width, blob.height);
   		},
   		cancel: function() {},
   		error: function(error) {},
   		mediaTypes: [Ti.Media.MEDIA_TYPE_PHOTO]
   	});
   }, 4000);
    
   $.index.open();
   </pre></code>
   
   *index.xml*
   <code><pre>
   &lt;Alloy&gt;
   	&lt;Window class="container"&gt;
   		&lt;ImageView id="img"&gt;&lt;/ImageView&gt;
   	&lt;/Window&gt;
   &lt;/Alloy&gt;
   </pre></code>
   
   *Test Steps*
   <h4>Download SDK version 9.0.2.GA</h4>
   <h4>Create an alloy application</h4>
   <h4>Copy the test case above </h4>
   <h4>Make sure camera permissions are enabled</h4>
   <h4>Run the application on a Pixel XL</h4>
   <h4>Take a picture in portrait mode </h4>
   <h4>Check log for the orientation (width, height) </h4>
   
   *Expected result*
   Console should log the correct orientation (350, 300) in this case
   
   *Actual result*
   The orientation is flipped and displayed as (300, 350)</li>
<li>Joshua Quick 2020-05-02

   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/11679" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11679</a></li>
<li>Satyam Sekhri 2020-05-20

   FR Passed.
   Waiting for Jenkins build</li>
<li>Christopher Williams 2020-05-21

   merged to master for 9.1.0 target</li>
<li>Samir Mohammed 2020-08-11

   *Closing ticket*. Improvement verified in SDK version <code>9.1.0.v20200810120239</code>.
   
   *Test and other information can be found at:*
   <a href="https://github.com/appcelerator/titanium_mobile/pull/11679" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11679</a></li>
</ol>


<p><a href="/TIMOB/TIMOB-27872.json">JSON Source</a></p>