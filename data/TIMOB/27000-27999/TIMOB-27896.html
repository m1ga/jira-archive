---
title: "[TIMOB-27896] TiAPI: Add ability to run in the background without UI"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>New Feature</td></tr>
<tr><th>Priority</th><td>Low</td></tr>
<tr><th>Status</th><td>Open</td></tr>
<tr><th>Resolution</th><td>Unresolved</td></tr>

<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Android, iOS</td></tr>
<tr><th>Labels</th><td>android, background, ios</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2020-05-16T00:09:37.000+0000</td></tr>
<tr><th>Updated</th><td>2021-02-22T18:51:07.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
The Titanium JS (JavaScript) runtime is currently tightly bound to the UI. The JS runtime is created when the native UI is created and the 1st script executed (the "app.js" or "alloy.js") is expected to immediately create a window. On Android, the JS runtime is terminated once all windows have been destroyed and a new JS runtime will be created when the app's UI has been re-launched.

We should add a new feature which will create the Titanium JS runtime on app startup before it can natively host UI (if applicable) and keep the JS runtime running for the lifetime of the application process. On Android, this means destroying all UI will no longer terminate the JS runtime and a re-launch will re-use the existing JS runtime.

This should be an opt-in feature since this may require the app developers to re-architect their app launch behavior.

*Use-Cases:*
* On iOS, allow app to run tasks in the background via [BGTaskScheduler](<a href="https://developer.apple.com/documentation/backgroundtasks/bgtaskscheduler?language=objc)." rel="nofollow" target="_blank">https://developer.apple.com/documentation/backgroundtasks/bgtaskscheduler?language=objc).</a>
* On Android, prevent JS runtime from being terminated after end-user backs out of all windows or OS forcibly destroys all windows but keeps app process alive.
* On Android, allow developer to set up a <code>BOOT_COMPLETED</code> broadcast receiver to run backgrounding tasks after device boot-up.

*New "tiapp.xml" property:*
Setting this to <code>true</code> will enable this feature. The default is <code>false</code>.
<code><pre>
&lt;ti:app&gt;
	&lt;property name="run-in-background" type="bool"&gt;true&lt;/property&gt;
&lt;/ti:app&gt;
</pre></code>

*New <code>Ti.UI</code> property:*
* <code>Ti.UI.hasSession</code>: A read-only boolean property which returns <code>true</code> if the app can currently host UI. Will returns <code>false</code> if unable to host UI and creating windows is impossible.

*New <code>Ti.UI</code> event:*
(This event will only be fired if "tiapp.xml" property "run-in-background" is set <code>true</code>.)
* <code>"sessionbegin"</code>: Fired when it's time for the app to create its windows. Will only be fired if <code>Ti.UI.hasSession</code> property was previously <code>false</code>.

*Bootstrap JS Changes:*
Files ending with <code>*.bootstrap.js</code> should no longer display UI via their async <code>execute()</code> function anymore. We will add the following optional function that will be called just before the <code>Ti.UI</code> "sessionbegin" event gets fired so that bootstrap can inject their UI before the app can show its first window.
* <code>showUI(callback)</code>: Invoked on app startup after <code>execute()</code> only if <code>Ti.UI.hasSession</code> is <code>true</code>. From then on, this method will be invoked just before the <code>Ti.UI</code> "sessionbegin" event is fired.

Known bootstrap that show UI are...
[ti.playservices.bootstrap.js](<a href="https://github.com/appcelerator-modules/ti.playservices/blob/master/android/Resources/ti.playservices/ti.playservices.bootstrap.js)" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.playservices/blob/master/android/Resources/ti.playservices/ti.playservices.bootstrap.js)</a>
[mocha - ui.bootstrap.js](<a href="https://github.com/appcelerator/titanium-mobile-mocha-suite/blob/master/Resources/bootstraps/ui.bootstrap.js)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium-mobile-mocha-suite/blob/master/Resources/bootstraps/ui.bootstrap.js)</a>

*Classic App Usage:*
For a Classic app, the "app.js" should look like the below. Note that the "app.js" can be executed in the background while the app is incapable of hosting UI.
<code><pre>
// Listen for an event indicating when it's time to create/re-create app UI.
// On Android, this will be fired every time you back out and re-launch.
Ti.UI.addEventListener('sessionbegin', () =&gt; {
	openRootWindow();
});

// On startup, only create window if app is currently capable of hosting UI.
if (Ti.UI.hasSession) {
	openRootWindow();
}
</pre></code>

*Alloy App Usage:*
Alloy users do not have to worry about window creation at launch. It is Alloy's responsibility to open/re-open the root window when needed.

On our end, we will have to change Alloy's "app.js" code generation to do something similar to the Classic code example above.

*Backgrounding Pro-Tips:*
* On iOS, you must use [URLSession](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Modules.URLSession) to do networking in the background.
* On Android, you must set up a [Foreground Service](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Android.Service) to perform networking, geolocation, and other tasks in the background. It also signals the OS to not forcibly terminate the backgrounded app.


<h3>Comments</h3>

<ol>
<li>Michael Gangolf 2020-05-22

   Does this mean even if we kill the app from the app-switcher (while the fg service is running) the service continues to run? If so: awesome news! </li>
<li>Joshua Quick 2020-05-22

   [~michael], yes, the runtime continues to run when you swipe off the app from the app switcher. I tested it. :)</li>
<li>Joshua Quick 2020-05-22

   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/11728" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11728</a>
   PR (ti.playservices): <a href="https://github.com/appcelerator-modules/ti.playservices/pull/39" rel="nofollow" target="_blank">https://github.com/appcelerator-modules/ti.playservices/pull/39</a></li>
</ol>


<p><a href="/TIMOB/TIMOB-27896.json">JSON Source</a></p>