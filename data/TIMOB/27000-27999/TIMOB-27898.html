---
title: "[TIMOB-27898] iOS: Race condition in setTimeout/clearTimeout (regression)"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2020-06-08T13:58:47.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 8.3.1, Release 9.1.0</td></tr>
<tr><th>Fix Version/s</th><td>Release 9.0.3</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>clearInterval, ios, race_condition, regression, setinterval</td></tr>
<tr><th>Reporter</th><td>Hans Knöchel</td></tr>
<tr><th>Assignee</th><td>Jan Vennemann</td></tr>
<tr><th>Created</th><td>2020-05-18T09:15:44.000+0000</td></tr>
<tr><th>Updated</th><td>2020-09-01T08:27:25.000+0000</td></tr>
</table>

<h3>Description</h3>

There seem to be a critical regression regarding intervals in SDK 8 and 9 (so maybe caused between SDK 7 and 8?). See the following vanilla Node.js test case for reference (using a classic throttling mechanism):
<code><pre>
let searchTimeout;

function search(value) {
	if (searchTimeout) {
		console.warn('Abort request');
		clearTimeout(searchTimeout);
	}

	searchTimeout = setTimeout(() =&gt; {
        console.warn('Start search: ' + value);
	}, 500);
}

function sleep(ms) {
    return new Promise(resolve =&gt; setTimeout(resolve, ms));
}

(async function () {
    search('m');
    search('me');
    search('mep');
}());
</pre></code>
The expected console output is:
<code><pre>
Abort request
Abort request
Start search: mep
</pre></code>

But on iOS, the kroll timer manager has different plans with us:
<code><pre>
Abort request
Start search: m
Start search: mep
</pre></code>

Here is the app test case (wrapped into a quick i/o UI):
<code><pre>
let searchTimeout;

function search(value) {
	if (searchTimeout) {
		console.warn('Abort request');
		clearTimeout(searchTimeout);
	}

	searchTimeout = setTimeout(() =&gt; {
        console.warn('Start search: ' + value);
	}, 500);
}

var win = Ti.UI.createWindow({
    backgroundColor: '#fff'
});

var btn = Ti.UI.createButton({
    title: 'Test'
});

btn.addEventListener('click', function onClick() {
    search('m')
    search('me')
    search('mep')
});

win.add(btn);
win.open();
</pre></code>

Notably, iOS does something wrong here. And Android works just fine (like Node.js).

<h3>Comments</h3>

<ol>
<li>Hans Knöchel 2020-05-19

   Can this please be validated on the team side? It's an absolute blocker as it caused multiple parts of our app to behave randomly incorrectly.</li>
<li>Rene Pot 2020-05-19

   I can reproduce with the following
   
   <code><pre>
   SDK 9.0.1.GA
   appc CLI 8.0.0
   Ti CLI 5.2.2
   iOS 13.4 Simulator (iPhone 11)
   xcode 11.4.1
   </pre></code></li>
<li>Jan Vennemann 2020-05-26

   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/11734" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11734</a>
   PR (9_0_X): <a href="https://github.com/appcelerator/titanium_mobile/pull/11735" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/11735</a></li>
<li>Christopher Williams 2020-06-04

   merged to master for 9.1.0 target, 9_0_X for 9.0.3 target.</li>
<li>Ewan Harris 2020-06-08

   Verified changes in 9.0.3.v20200608051820 and 9.1.0.v20200604104832.
   
   Closing ticket.</li>
</ol>


<p><a href="/TIMOB/TIMOB-27898.json">JSON Source</a></p>