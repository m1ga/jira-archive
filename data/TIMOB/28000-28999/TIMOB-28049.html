---
title: "[TIMOB-28049] Android: Investigate "ACCESS_BACKGROUND_LOCATION" handling on Android 11"
---
<table>
<tr><th>Type</th><td>Story</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Done</td></tr>
<tr><th>Resolution Date</th><td>2020-09-19T06:09:32.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 9.3.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, location, permission</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2020-07-25T01:20:26.000+0000</td></tr>
<tr><th>Updated</th><td>2020-11-03T15:22:08.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
Supposedly, Android 11 will no longer show a permission request dialog for the <code>ACCESS_BACKGROUND_LOCATION</code> permission. We need to confirm this.
<a href="https://developer.android.com/preview/privacy/location#background-location-permission-dialog-changes" rel="nofollow" target="_blank">https://developer.android.com/preview/privacy/location#background-location-permission-dialog-changes</a>

If true, then the only way to enable permission is to go to the app's "Location Permissions" activity under system settings. This very well maybe true because according to Google's developer blog below, they will be removing apps using this permission from Google Play unless they provide a valid reason and pass Google's review process.
<a href="https://android-developers.googleblog.com/2020/02/safer-location-access.html" rel="nofollow" target="_blank">https://android-developers.googleblog.com/2020/02/safer-location-access.html</a>

*Note 1:*
We might be able to reach the app's "Location Permission" activity under system settings via the following intent action.
<code>ACTION_LOCATION_SOURCE_SETTINGS</code>

*Note 2:*
We may need to expose Android's [shouldShowRequestPermissionRationale ()](<a href="https://developer.android.com/reference/android/app/Activity.html#shouldShowRequestPermissionRationale(java.lang.String))" rel="nofollow" target="_blank">https://developer.android.com/reference/android/app/Activity.html#shouldShowRequestPermissionRationale(java.lang.String))</a> API. Normally, this method would return <code>true</code> if the end-user tapped on "Disallow" in the permission request dialog. On Android 11, this might always return <code>true</code> for the <code>ACCESS_BACKGROUND_LOCATION</code> where you would have to tell the end-user how to enable it under system settings.


<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-28049_67527/Android11-AllLocationPermissions.png">Android11-AllLocationPermissions.png</td></td><td>2020-09-05T03:35:01.000+0000</td><td>171003</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-28049_67526/Android11-BackgroundLocationPermission.png">Android11-BackgroundLocationPermission.png</td></td><td>2020-09-05T03:35:01.000+0000</td><td>166667</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-28049_67534/GeolocationGpsService.js">GeolocationGpsService.js</td></td><td>2020-09-11T00:32:13.000+0000</td><td>419</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-28049_67535/GeolocationGpsTest.js">GeolocationGpsTest.js</td></td><td>2020-09-11T00:32:14.000+0000</td><td>5482</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-28049_67536/tiapp.xml">tiapp.xml</td></td><td>2020-09-11T00:32:14.000+0000</td><td>1083</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Joshua Quick 2020-09-05

   Here are my test results...
   
   If you call <code>requestPermission()</code> for <code>ACCESS_BACKGROUND_LOCATION</code> and the app has *+NOT+* been granted <code>ACCESS_COARSE_LOCATION</code> or <code>ACCESS_FINE_LOCATION</code> permission, then a dialog will *+NOT+* appear and the method will report the permission as denied. This behavior exists on Android 10 as well. So, this is not an Android 11 breaking-change.
   
   If the app was granted the <code>ACCESS_COARSE_LOCATION</code> or <code>ACCESS_FINE_LOCATION</code> permission first and then you call <code>requestPermission()</code> for <code>ACCESS_BACKGROUND_LOCATION</code>, then a dialog will appear as shown below. What's different in Android 11 is the end-user must tap on the "*Allow in setting*" link to enable location access in the background. This is the major Android 11 change, but it doesn't require anyone to change their native or JS code to support this. Google merely added more steps to the UI to enable it on their end.
    !Android11-BackgroundLocationPermission.png|thumbnail! 
   
   *Side Note:*
   A better solution for Android 10 and 11 would be to request for all 3 location permissions at once like the below. If you do, then a dialog will always appear... unless the end-user denied it several times already.
   <code><pre>
   var permissions = [
   	"android.permission.ACCESS_COARSE_LOCATION",
   	"android.permission.ACCESS_FINE_LOCATION",
   ];
   if (Ti.Platform.Android.API_LEVEL >= 29) {
   	permissions.push("android.permission.ACCESS_BACKGROUND_LOCATION");
   }
   Ti.Android.requestPermissions(permissions, function(e) {
   	alert("Has Location Permissions: " + e.success);
   });
   </pre></code>
    !Android11-AllLocationPermissions.png|thumbnail! 
   
   We should update our "Background Location Service Example" in our docs (link below) to request <code>ACCESS_BACKGROUND_LOCATION</code> as shown above.
   <a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Android.Service
   
   *Final Notes:*
   We do not need to use a <code>ACTION_LOCATION_SOURCE_SETTINGS</code> intent to enable <code>ACCESS_BACKGROUND_LOCATION</code>. The "Allow in settings" link in the permission request dialog will take the end-user to that screen for us.
   
   We don't need to add a <code>shouldShowRequestPermissionRationale()</code> method. It's actually not helpful in this case.
   </li>
<li>Joshua Quick 2020-09-10

   The current plan is to improve the Ti.Geolocation parity between Android and iOS, while also improving our APIs to make it easier to access the GPS in the background on both platform. This will be handled by the epic [TIMOB-28114].
   
   \\
   For now, the attached files below is an example of how to access GPS data in the background on both Android and iOS. This correctly works on Android 11 and older OS versions as well as iOS 14 and older iOS versions.
   *  [^tiapp.xml] 
   *  [^GeolocationGpsTest.js] 
   *  [^GeolocationGpsService.js] </li>
<li>Joshua Quick 2020-09-19

   The release version of Android 11 has completely changed behavior. It no longer displays a "Show in settings" link option as shown in the dialog screenshots above.
   
   More importantly, you can no longer ask for <code>"ACCESS_BACKGROUND_LOCATION"</code> and <code>"ACCESS_FINE_LOCATION"</code> in the same request anymore or else it will fail if you don't have any location permission at all. This is a breaking-change in the release version of Android 11. You now must request <code>"ACCESS_FINE_LOCATION"</code> first and then <code>"ACCESS_BACKGROUND_LOCATION"</code> second.
   
   Note that our docs currently suggest devs to do this already.
   <a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Android.Service
   </li>
<li>Samir Mohammed 2020-11-03

   Closing ticket as investigation is complete. If this is a mistake feel free to reopen. </li>
</ol>


<p><a href="/TIMOB/TIMOB-28049.json">JSON Source</a></p>