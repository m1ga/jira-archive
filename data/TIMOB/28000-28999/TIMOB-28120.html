---
title: "[TIMOB-28120] Android: Add Ti.Geolocation.allowsBackgroundLocationUpdates support"
---
<table>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>Low</td></tr>
<tr><th>Status</th><td>Open</td></tr>
<tr><th>Resolution</th><td>Unresolved</td></tr>

<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>n/a</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, background, geolocation, parity, permission</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2020-09-10T05:28:12.000+0000</td></tr>
<tr><th>Updated</th><td>2021-02-22T19:01:03.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
We currently already support location data collection in the background, but you have to request the end-user for <code>"android.permission.ACCESS_BACKGROUND_LOCATION"</code> on Android 10 and above or else it'll stop reporting data. This can only be done via the [Ti.Android.hasPermission()](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Android-method-hasPermission) and [Ti.Android.requestPermissions()](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Android-method-requestPermissions) methods, which makes it more difficult to write cross-platform code between Android and iOS.

*Current Solution:*
This is how you would request background permission today on Android 10 and above.
<code><pre>
const ACCESS_COARSE_LOCATION = 'android.permission.ACCESS_COARSE_LOCATION';
const ACCESS_FINE_LOCATION = 'android.permission.ACCESS_FINE_LOCATION';
const ACCESS_BACKGROUND_LOCATION = 'android.permission.ACCESS_BACKGROUND_LOCATION';
const permissionArray = [ACCESS_COARSE_LOCATION, ACCESS_FINE_LOCATION];
if (Ti.Platform.Android.API_LEVEL &gt;= 29) {
	permissionArray.push('android.permission.ACCESS_BACKGROUND_LOCATION');
}
if (!Ti.Android.hasPermission(permissionArray)) {
	Ti.Android.requestPermissions(permissionArray, (e) =&gt; {
		// Android 11 allows you to deny background permission and grant other location permissions separately.
		// Event object's "success" property will be false in this case. So, we must check individual permissions.
		if (!Ti.Android.hasPermission([ACCESS_COARSE_LOCATION, ACCESS_FINE_LOCATION])) {
			alert('Location permission denied.');
		} else if ((Ti.Platform.Android.API_LEVEL &gt;= 29) && !Ti.Android.hasPermission(ACCESS_BACKGROUND_LOCATION)) {
			alert('Background location access denied.');
		} else {
			Ti.Geolocation.addEventListener('location', onLocationDataReceived);
		}
	});
} else {
	Ti.Geolocation.addEventListener('location', onLocationDataReceived);
}
</pre></code>

*Better Solution:*
Add support for the [Ti.Geolocation.allowsBackgroundLocationUpdates](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Geolocation-property-allowsBackgroundLocationUpdates) property. When set <code>true</code>, then the next time you call the [Ti.Geolocation.hasLocationPermissions()](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Geolocation-method-hasLocationPermissions) and [Ti.Geolocation.requestLocationPermissions()](<a href="https://docs.appcelerator.com/platform/latest/#" rel="nofollow" target="_blank">https://docs.appcelerator.com/platform/latest/#</a>!/api/Titanium.Geolocation-method-requestLocationPermissions) methods, they will automatically add the <code>"android.permission.ACCESS_BACKGROUND_LOCATION"</code> permission to the check/request for you, making the code much more portable.
<code><pre>
Ti.Geolocation.allowsBackgroundLocationUpdates = true;
if (!Ti.Geolocation.hasLocationPermissions(Ti.Geolocation.AUTHORIZATION_WHEN_IN_USE)) {
	Ti.Geolocation.requestLocationPermissions(Ti.Geolocation.AUTHORIZATION_WHEN_IN_USE, () =&gt; {
		if (e.success) {
			Ti.Geolocation.addEventListener('location', onLocationDataReceived);
		}
	});
} else {
	Ti.Geolocation.addEventListener('location', onLocationDataReceived);
}
</pre></code>

*Notes:*
<h4>You will still need to start an Android foreground service set up for <code>FOREGROUND_SERVICE_TYPE_LOCATION</code> to make this work. There is no way to make this cross-platform since it involves posting a notification to the status bar.</h4>
<h4>On iOS, the "allowsBackgroundLocationUpdates" property only applies the first time you add your "location" event... versus on Android it only applies when doing the location permission checks.</h4>


<h3>Comments</h3>

<p>No comments</p>

<p><a href="/TIMOB/TIMOB-28120.json">JSON Source</a></p>