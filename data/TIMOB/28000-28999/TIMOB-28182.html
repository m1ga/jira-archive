---
title: "[TIMOB-28182] Android: Only add WRITE_EXTERNAL_STORAGE permission when needed"
---
<table>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2020-11-16T21:39:44.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 9.3.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, externalstorage, manifest, permission, storage</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2020-10-09T01:06:23.000+0000</td></tr>
<tr><th>Updated</th><td>2020-11-16T21:39:44.000+0000</td></tr>
</table>

<h3>Description</h3>

*Synopsis:*
The "AndroidManifest.xml" permission <code>WRITE_EXTERNAL_STORAGE</code> is ignored when targeting Android 10+ and running on those Android OS versions. This is because of scoped-storage and Google only allows an app to write to very particular folders on external storage. The app's sandboxed folders on external storage no longer require permission as of Android 4.4.
<a href="https://developer.android.com/training/data-storage/shared/media#request-permissions" rel="nofollow" target="_blank">https://developer.android.com/training/data-storage/shared/media#request-permissions</a>

*To-Do:*
The Titanium build system should be changed to only inject this permission when needed based on JavaScript APIs used.

If the <code>Ti.Filesystem.requestStoragePermissions()</code> method is used, then the permission should be added as before like this. This is the only method that requires this permission on Android 10 and above.
<code><pre>
&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/&gt;
</pre></code>

If <code>Ti.Media.showCamera()</code> or <code>Ti.Media.saveToPhotoGallery()</code> methods are used, then we should add a <code>maxSdkVersion</code> attribute set to Android 9 since external storage access is not required on Android 10 and higher.
<code><pre>
&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="28"/&gt;
</pre></code>

If none of the above JavaScript methods are detected, then we should *NOT* add this permission.

*Note:*
If the "tiapp.xml" adds the <code>WRITE_EXTERNAL_STORAGE</code> permission, then it should take priority and the above should be ignored.


<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-28182_67640/CameraPhotoExternalTest.js">CameraPhotoExternalTest.js</td></td><td>2020-11-09T22:24:20.000+0000</td><td>982</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-28182_67639/ImageToGalleryTest.js">ImageToGalleryTest.js</td></td><td>2020-11-09T22:23:56.000+0000</td><td>870</td></tr>
<tr><td><a href="https://jira-attachments.titaniumsdk.com/TIMOB/TIMOB-28182_67641/RequestStoragePermissionsTest.js">RequestStoragePermissionsTest.js</td></td><td>2020-11-09T23:01:26.000+0000</td><td>526</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Joshua Quick 2020-11-06

   I'm thinking we should *NOT* implement this because it would be a breaking-change that would cause a lot of tech-support issues. It should be the Titanium app developer's responsibility to do this instead.
   
   The reason is because a lot of customer code that looks like the below will always fail to request for external storage permission on Android 10 and above if we set <code>maxSdkVersion</code> to <code>29</code>. Note that the <code>requestStoragePermission()</code> method call is no longer required anymore as of 9.3.0 and can be removed.
   <code><pre>
   // You no longer need to request storage permission to access externalStorageDirectory anymore.
   Ti.Filesystem.requestStoragePermissions((e) =&gt; {
   	if (!e.success) {
   		alert("External storage permission not granted.")
   	} else if (!Ti.Filesystem.isExternalStoragePresent()) {
   		alert("External storage is not available on this device.");
   	} else {
   		const dataFile = Ti.Filesystem.getFile(Ti.Filesystem.externalStorageDirectory, 'MyFile.txt');
   		dataFile.write("Hello World");
   	}
   });
   </pre></code>
   
   *Note1 :*
   As of Titanium 9.3.0, our <code>Ti.Media.showCamera()</code> and <code>Ti.Media.saveToPhotoGallery()</code> method no longer require this permission on Android 10 and above. And our <code>Ti.Filesystem.externalStorageDirectory</code> does not require this permission on Android 4.4 and above.
   
   This means the <code>Ti.Filesystem.requestStoragePermission()</code> is only needed for:
   * Android 6 - Android 9 when using <code>showCamera()</code> and <code>saveToPhotoGallery()</code> APIs.
   * Sometimes by 3rd party modules or hyperloop code which writes outside of scoped storage.
   
   *Note 2:*
   As of 9.3.0, the <code>Ti.Media.requestCameraPermissions()</code> method is smart enough to only request external storage permission for Android 6 to Android 9. It won't request this permission on Android 10 and above. This method should be used before calling <code>showCamera()</code>.
   
   *Note 3:*
   As of 9.3.0, we've added <code>Ti.Media.requestPhotoGalleryPermissions()</code> support on Android. This method should be used before calling <code>saveToPhotoGallery()</code> like iOS. The Android implementation is smart enough to only request external storage permission for Android 6 to Android 9. This method will always return return true on Android 10 and above.
   </li>
<li>Joshua Quick 2020-11-07

   Okay. I've changed my mind.
   
   Instead of always adding the <code>WRITE_EXTERNAL_STORAGE</code> permission with a <code>maxSdkVersion</code> set to Android 9, we should instead scan the JS code for APIs that need this permission and inject it intelligently like how we handle the camera and location permissions.</li>
<li>Joshua Quick 2020-11-07

   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/12253" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/12253</a></li>
<li>Lokesh Choudhary 2020-11-16

   FR Passed.
   PR Merged.</li>
</ol>


<p><a href="/TIMOB/TIMOB-28182.json">JSON Source</a></p>