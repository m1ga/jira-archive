---
title: "[TIMOB-28412] iOS: Optimize JS Promise creation on iOS 12"
---
<table>
<tr><th>Type</th><td>Improvement</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2021-06-17T11:53:30.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 10.0.1</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>async, iOS, performance, promise</td></tr>
<tr><th>Reporter</th><td>Joshua Quick</td></tr>
<tr><th>Assignee</th><td>Joshua Quick</td></tr>
<tr><th>Created</th><td>2021-04-02T01:43:38.000+0000</td></tr>
<tr><th>Updated</th><td>2021-06-17T11:53:30.000+0000</td></tr>
</table>

<h3>Description</h3>

*Summary:*
On iOS 12 and older versions, there is no native API to create a JavaScript <code>Promise</code>. So, we create promises via a JS <code>eval()</code> as shown below...
<a href="https://github.com/appcelerator/titanium_mobile/blob/master/iphone/TitaniumKit/TitaniumKit/Sources/Kroll/KrollPromise.m#L35-L49" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/iphone/TitaniumKit/TitaniumKit/Sources/Kroll/KrollPromise.m#L35-L49</a>

*To-Do:*
We should optimize this so that we don't do an <code>eval()</code> every time a promise needs to be created. Simplest solution is to only create the JS promise handling function once and re-use it.

*Note:*
Apple documents that <code>evaluateScript()</code> will add function/variable definitions permanently to the global context.
<a href="https://developer.apple.com/documentation/javascriptcore/jscontext/1451350-evaluatescript" rel="nofollow" target="_blank">https://developer.apple.com/documentation/javascriptcore/jscontext/1451350-evaluatescript</a>

This means we should use a unique prefixing convention to avoid collision.

Also, every time we define our JS <code>executor()</code> and <code>createPromise()</code> functions, theoretically we're slowly bloating the JS global context with these re-definitions. This may be a slow memory leak.

<h3>Comments</h3>

<ol>
<li>Joshua Quick 2021-04-02

   PR (master): <a href="https://github.com/appcelerator/titanium_mobile/pull/12684" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/12684</a></li>
<li>Ewan Harris 2021-06-17

   master and backport merged</li>
</ol>


<p><a href="/TIMOB/TIMOB-28412.json">JSON Source</a></p>