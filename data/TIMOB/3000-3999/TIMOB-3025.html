---
title: "[TIMOB-3025] Android: Facebook.logout called from activity destroy event doesn't (always) succeed in clearing saved session info"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Trivial</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-04-17T02:00:42.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Release 1.6.0 M08</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, defect, facebook, release-1.6.0, reported-1.6.0</td></tr>
<tr><th>Reporter</th><td>Bill Dawson</td></tr>
<tr><th>Assignee</th><td>Bill Dawson</td></tr>
<tr><th>Created</th><td>2011-04-15T03:35:01.000+0000</td></tr>
<tr><th>Updated</th><td>2011-04-17T02:00:42.000+0000</td></tr>
</table>

<h3>Description</h3>

<div><p>Some app developers want to clear the saved Facebook session
information when a user backs out of an app, so that the session
info doesn't automatically get remembered the next time the app is
started. I want to recommend to them that they should use the
<code>destroy</code> event of the root activity, such as in this
example app.js:</p>
<pre>
<code class="javascript">Titanium.UI.setBackgroundColor('#000');
Ti.Facebook.appid = "PUT A FACEBOOK APP ID HERE";
var win = Titanium.UI.createWindow({  
    title:'Test',
    backgroundColor:'#fff',
    exitOnClose: true
});

Ti.Android.currentActivity.addEventListener('destroy',function(){
    Ti.API.info('Root activity destroying');
    Ti.Facebook.logout();
});
win.add( Ti.Facebook.createLoginButton({style: 'wide'}) );
win.open();</code>
</pre>
<p>Run that example and login to Facebook. Then completely back out
of the application. Then go back in to the application --
unfortunately you'll probably see the facebook button still says
"logout", so it thinks it is logged in even though we called
<code>logout()</code> when the user backed out of the app, which is
when <code>destroy</code> occurs (you can see that
<code>logout()</code> really does get called if you watch
logcat.</p>
<p>So what has happened is that the user really is logged out of
that Facebook session (the OAuth 2.0 token is no longer valid), but
Titanium doesn't know about it, so the login button is screwed up
and showing "Logout" instead of "Connect with Facebook".</p>
<p>I think what's happening here is that the relevant Titanium code
to clear the saved session info (saved as a private entry in the
Android Shared Preferences store) does not run until an
Asynchronous call to Facebook's logout API has returned. By the
time that Async call is finished, there are no listeners available
any more (the user has backed out of the app, the root activity has
been destroyed, etc.)</p>
<p>What we need to do is destroy the session info right when
<code>Ti.Facebook.logout()</code> is called, rather than wait for a
return from FB's logout API call. After all, if an app developer
has called <code>.logout()</code>, he wants that session destroyed,
so why wait? This way the destruction of the session occurs
synchronously within the <code>destroy</code> thread.</p></div>

<h3>Comments</h3>

<ol>
<li>Bill Dawson 2011-04-15

   <div><p>Commit: <a href=
   "<a href="https://github.com/appcelerator/titanium_mobile/commit/74e40cd99a92efa3d7e81fcee452b06347a1fad4" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/74e40cd99a92efa3d7e81fcee452b06347a1fad4</a>">
   <a href="https://github.com/appcelerator/titanium_mobile/commit/74e40cd99a92..." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/74e40cd99a92...</a></a></p>
   <p>With this change, if you run an app with the above app.js and
   follow the same steps as described above, when you back out of the
   app now it'll both logout the FB session "officially" (i.e, via the
   FB API call) <strong>and</strong> destroy the session info stored
   by Titanium. When you go back in, the button will say "Connect with
   Facebook" (i.e., you'll show as being logged out, which is
   correct.)</p></div></li>
<li>Opie Cyrus 2011-04-15

   <div><p>Verified emulator 2.2</p></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>(from <a href=
   "/projects/32238/changesets/74e40cd99a92efa3d7e81fcee452b06347a1fad4"
   title=
   "Changeset [74e40cd99a92efa3d7e81fcee452b06347a1fad4]">[74e40cd99a92efa3d7e81fcee452b06347a1fad4]</a>)
   [<a href="/projects/32238/tickets/3025" title=
   "Ticket #3025">#3025</a> state:fixed-in-qa] destroy fb session info
   immediately when logout called <a href=
   "<a href="https://github.com/appcelerator/titanium_mobile/commit/74e40cd99a92efa3d7e81fcee452b06347a1fad4" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/74e40cd99a92efa3d7e81fcee452b06347a1fad4</a>">
   <a href="https://github.com/appcelerator/titanium_mobile/commit/74e40cd99a92..." rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/74e40cd99a92...</a></a></p></div></li>
<li>Bill Dawson 2011-04-15

   <div><p>That was the agent setting it back to fixed-in-qa. It's still
   resolved.</p></div></li>
</ol>


<p><a href="/TIMOB/TIMOB-3025.json">JSON Source</a></p>