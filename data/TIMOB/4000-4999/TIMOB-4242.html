---
title: "[TIMOB-4242] Calling Ti.API.info from global object reference in sub-context causes event exception"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-06-03T14:36:32.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 1.7.0</td></tr>
<tr><th>Fix Version/s</th><td>Sprint 2011-22</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>ti.api</td></tr>
<tr><th>Reporter</th><td>Jeffrey Clark</td></tr>
<tr><th>Assignee</th><td>Blain Hamon</td></tr>
<tr><th>Created</th><td>2011-05-18T11:11:44.000+0000</td></tr>
<tr><th>Updated</th><td>2011-06-06T14:04:56.000+0000</td></tr>
</table>

<h3>Description</h3>

The following code produces error (below) as summarized on iOS only.  The error can be circumvented by placing a call to everywhere.test() or Ti.API.info before it is called by the event in win.js (sub-context reference).

<code><pre>
var everywhere = {
    test: function() {
        Ti.API.info('this is a test');
    }
};

var win = Titanium.UI.createWindow({  
    url: 'win.js'
});

win.everywhere = everywhere;
win.open();
</pre></code>

<code><pre>
({
    win: Ti.UI.currentWindow,
    everywhere: Ti.UI.currentWindow.everywhere,
    init: function() {
        var self = this;
        var button = Ti.UI.createButton({
            title: "click me"
        });
        button.addEventListener('click', function(e) {
            self.clicked();
        });
        this.win.add(button);
    },
    clicked: function() {
        this.everywhere.test();
    }
}).init();
</pre></code>

{noformat}
[WARN] [object TopTiModule] tried to note the callback for API in the wrong thead.
[WARN] Exception in event callback. {
line = 6;
message = "-[__NSCFDictionary setObject:forKey:]: attempt to insert nil value (key: API)";
sourceId = 116344464;
sourceURL = "file://<snipped>/scopebug/Resources/app.js";
}
{noformat}

<h3>Comments</h3>

<ol>
<li>Jeffrey Clark 2011-05-18

   Other users are reporting what appears to be the same issue in [a community support question](<a href="https://developer.appcelerator.com/question/119751/errors-with-latest-builds-17x-r3bed52c7-and-18x-r5a5f4522#header)." rel="nofollow" target="_blank">https://developer.appcelerator.com/question/119751/errors-with-latest-builds-17x-r3bed52c7-and-18x-r5a5f4522#header).</a>  I entered another ticket (TC-10) which, although the example code is different, it may fall under the same problem.</li>
<li>Jeffrey Clark 2011-05-19

   [Comment on github from development team](<a href="https://github.com/appcelerator/titanium_mobile/commit/7bef2bd0bcb7abbded1b9cccbbd187ee056788d7#commitcomment-390814)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/commit/7bef2bd0bcb7abbded1b9cccbbd187ee056788d7#commitcomment-390814)</a></li>
<li>Paul Dowsett 2011-05-30

   Tested and works on Android 2.2, Titanium SDK 1.7.0 (05/27/11 17:53 8be59d3...)</li>
<li>Dawson Toth 2011-05-31

   A client is watching this now as well.
   
   <h4>Associated Helpdesk Ticket</h4>
   <a href="http://appc.me/c/APP-367438" rel="nofollow" target="_blank">http://appc.me/c/APP-367438</a></li>
<li>Blain Hamon 2011-06-03

   The fix won't make it into 1.7.0, but there's a workaround. The workaround is to put, in app.js, put as line 1:
   
   Ti.API;
   
   Cross-context function calls are dangerous things (It's better to use event handlers, because of threading issues. (JS objects in JSCore are not threadsafe, and cross-context function calls mean you could be modifying the same JS object at the same time.)
   
   When you first refer to a module, that's when it's generated and attached to the Titanium namespace. However, when you're doing a cross-context call, the Titanium namespace the function is accessing is NOT the Titanium of the context calling the function. Because it's the wrong namespace, the context that owns it refuses to register the module because it's the wrong thread (safety reasons). However, if the module was already registered in the right context, things are fine.
   
   We pre-register UI module since it will be used. Since API module is also common, it will now be pre-registered. However, other modules won't be pre-registered.</li>
<li>Blain Hamon 2011-06-03

   It's still not good to call cross-context, but pre-loading API is innocuous enough.</li>
<li>Eric Merriman  2011-06-06

   Verified fixed with Verizon iPhone 4 (4.2.8) , Titanium Studio, build: 1.0.0.201106021621, Titanium SDK version: 1.8.0 r477c7b27. No exception, simply a warning: 
   [WARN] (null)->(null) [0]->[object APIModule] is being made in a thread not owned by <KrollContext: 0xb434870></li>
</ol>


<p><a href="/TIMOB/TIMOB-4242.json">JSON Source</a></p>