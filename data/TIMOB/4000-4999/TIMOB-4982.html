---
title: "[TIMOB-4982] Geolocation not working consistently on Android WebView (with suggested patch)"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2012-10-12T22:08:20.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 2.0.2</td></tr>
<tr><th>Fix Version/s</th><td>Release 3.0.2, Release 3.1.0, 2012 Sprint 21 API, 2012 Sprint 21</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>android, api, geolocation, mobile, qe-port, webview</td></tr>
<tr><th>Reporter</th><td>Allan Kim</td></tr>
<tr><th>Assignee</th><td>Karl Rowley</td></tr>
<tr><th>Created</th><td>2011-08-03T18:33:39.000+0000</td></tr>
<tr><th>Updated</th><td>2014-06-24T18:17:12.000+0000</td></tr>
</table>

<h3>Description</h3>

My experience shows that geolocation doesn't work consistently in an Android WebView, even when <code>android.permission.ACCESS_FINE_LOCATION</code> is added to <code>tiapp.xml</code>. 

To replicate:

* Create simple app that loads a web page that uses geolocation APIs. In this case I used the KitchenSink app and changed the external URL in [web_views.js](<a href="https://github.com/appcelerator/titanium_mobile/blob/master/demos/KitchenSink/Resources/examples/web_views.js)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/blob/master/demos/KitchenSink/Resources/examples/web_views.js)</a> to a test page for W3C browser geolocation, <a href="http://code.google.com/apis/maps/documentation/javascript/examples/map-geolocation.html." rel="nofollow" target="_blank">http://code.google.com/apis/maps/documentation/javascript/examples/map-geolocation.html.</a>
* Add to tiapp.xml:
** <code><pre>&lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" /&gt;</pre></code>
* Save and build as usual. Install to Android device and to iOS device for comparison.
* Verify that the permission privilege was added to <code>build/android/AndroidManifest.xml</code>.
* Open KitchenSink on Android device and go to Base UI > Views > Web Views > External URL. Geolocation test fails.
* Open KitchenSink in iOS device and repeat process. App requests location permission and test completes.

Here is my suggested resolution to the problem:

* Add the following to source code for <code>TiWebChromeClient.java</code>:
** <code><pre>
public void onGeolocationPermissionsShowPrompt(String origin, android.webkit.GeolocationPermissions.Callback callback) {
     callback.invoke(origin, true, false);
}</pre></code>
* Build and update <code>titanium-ui.jar</code>.
* Clean and build project and install new build to Android device. 
* Open KitchenSink on Android device and go to Base UI > Views > Web Views > External URL. Geolocation test succeeds!


<h3>Comments</h3>

<ol>
<li>Paul Dowsett 2011-08-04

   Allan
   
   Thank you for raising this ticket. In order to progress it, please add the missing information in the format and places requested in the guidelines at [Jira Ticket Checklist](<a href="http://wiki.appcelerator.org/display/guides/Contributing+to+Titanium#ContributingtoTitanium-Summary%3AJiraTicketChecklist)." rel="nofollow" target="_blank">http://wiki.appcelerator.org/display/guides/Contributing+to+Titanium#ContributingtoTitanium-Summary%3AJiraTicketChecklist).</a>
   
   Many thanks in advance</li>
<li>Allan Kim 2011-08-04

   I've updated the ticket and description to follow the guidelines in the checklist. I've also added more details to replicate both the problem and the fix. Thank you!</li>
<li>Paul Dowsett 2011-08-05

   Allan
   
   Many thanks for your contribution so far.
   
   Unfortunately this ticket still requires a few changes to be progressed. Would you add the code that you have actually tested, so that we can with some certainty replicate the issue? The simpler the code, the better, as explained in [Creating Good Use-cases](<a href="http://wiki.appcelerator.org/display/guides/Contributing+to+Titanium#ContributingtoTitanium-CreatingGoodUsecases)." rel="nofollow" target="_blank">http://wiki.appcelerator.org/display/guides/Contributing+to+Titanium#ContributingtoTitanium-CreatingGoodUsecases).</a>
   
   The environment field looks good. Just bear in mind that there are bugs in the Android 2.2.X emulator relating to webviews, so it is likely that they will only work correctly on a physical device.
   
   I have edited your ticket to use jira markup. Try to use markup in your future tickets.
   
   Thank you again</li>
<li>Allan Kim 2011-08-10

   Pull request sent: branch TC-186-geolocationWebViewAndroid</li>
<li>Paul Dowsett 2011-08-10

   Allan
   
   Thank you for the code. I will move this across to the correct project, but regrettably no action can be taken on your Pull Request until you have signed a CLA. Please see [Signing the Contributors License Agreement (CLA)](<a href="http://wiki.appcelerator.org/display/guides/Contributing+to+Titanium#ContributingtoTitanium-SigningtheContributorsLicenseAgreement%28CLA%29)" rel="nofollow" target="_blank">http://wiki.appcelerator.org/display/guides/Contributing+to+Titanium#ContributingtoTitanium-SigningtheContributorsLicenseAgreement%28CLA%29)</a> for details.
   
   Please bear in mind the information I gave you in previous comments, about how to create a proper usecase.
   
   Thanks</li>
<li>Paul Dowsett 2011-08-10

   By the way, I am very sorry, but I made a mistake previously. I meant to say that the Android 2.3.X emulator has webview issues, rather than 2.2.X. See [Android SDK / Target Android Platform](<a href="http://wiki.appcelerator.org/display/guides/Titanium+Compatibility+Matrix#TitaniumCompatibilityMatrix-AndroidSDK%2FTargetAndroidPlatform)" rel="nofollow" target="_blank">http://wiki.appcelerator.org/display/guides/Titanium+Compatibility+Matrix#TitaniumCompatibilityMatrix-AndroidSDK%2FTargetAndroidPlatform)</a>, which explains this.</li>
<li>Paul Dowsett 2011-10-21

   Reassigning tickets, as per Tony Guntharp's request</li>
<li>Karl Rowley 2012-10-10

   Pull request <a href="https://github.com/appcelerator/titanium_mobile/pull/3157" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/3157</a></li>
<li>Vishal Duggal 2013-01-16

   Backport task TIMOB-12300
   backport PR <a href="https://github.com/appcelerator/titanium_mobile/pull/3719" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/3719</a></li>
<li>Paras Mishra 2013-01-24

    GeoLocation works fine.
    
    Verified on:
     LG device Android 2.2.2
    SDK version:  3.1.0.v20130123144204,3.0.2.v20130122172624
    CLI version : 3.0.23
    OS : MAC OSX 10.7.5
    XCode : 4.5.1</li>
</ol>


<p><a href="/TIMOB/TIMOB-4982.json">JSON Source</a></p>