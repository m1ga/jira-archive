---
title: "[TIMOB-6573] iOS: Some modules designed for CommonJS not exporting, even with the \"export\" variable set"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>High</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2011-12-13T14:05:49.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 1.8.0.1</td></tr>
<tr><th>Fix Version/s</th><td>Sprint 2011-50, Release 1.8.0.1, Release 2.0.0</td></tr>
<tr><th>Components</th><td>iOS</td></tr>
<tr><th>Labels</th><td>parity</td></tr>
<tr><th>Reporter</th><td>Stephen Tramer</td></tr>
<tr><th>Assignee</th><td>Blain Hamon</td></tr>
<tr><th>Created</th><td>2011-12-12T10:53:40.000+0000</td></tr>
<tr><th>Updated</th><td>2012-03-04T22:08:00.000+0000</td></tr>
</table>

<h3>Description</h3>

From the Titans mailing list:

Using the CommonJS module "underscore" (available at <a href="http://documentcloud.github.com/underscore/)" rel="nofollow" target="_blank">http://documentcloud.github.com/underscore/)</a> does not properly export when using <code>require()</code>. The relevant snippet from the code seems to be:

<code><pre>
  if (typeof exports !== 'undefined') {
    if (typeof module !== 'undefined' && module.exports) {
      exports = module.exports = _;
    }
    exports._ = _;
  } else if (typeof define === 'function' && define.amd) {
    // Register as a named module with AMD.
    define('underscore', function() {
      return _;
    });
  } else {
    // Exported as a string, for Closure Compiler "advanced" mode.
    root['_'] = _;
  }
</pre></code>

And the developer is trying the following:

<code><pre>
var _ = require('underscore')._;
</pre></code>

This is leading to the following error:

<code><pre>
[ERROR] Script Error = -[KrollCallback countByEnumeratingWithState:objects:count:]: unrecognized selector sent to instance 0x8c27fb0.
</pre></code>

<h3>Comments</h3>

<ol>
<li>Stephen Tramer 2011-12-12

   This issue may be related to TIMOB-6458, TIMOB-6457, and our other require processing mechanisms. While performing work on require() these other issues should be examined (but maybe not resolved yet).</li>
<li>Blain Hamon 2011-12-12

   Note to self: This is because, for some reason, evaluating the module is returning a KrollCallback, not an NSDictionary.</li>
<li>Stephen Tramer 2011-12-12

   Android is compliant with 1.1 CommonJS spec, which might give some clues as to the nature of this bug:
   
   <a href="http://wiki.commonjs.org/wiki/Modules/1.1" rel="nofollow" target="_blank">http://wiki.commonjs.org/wiki/Modules/1.1</a></li>
<li>Blain Hamon 2011-12-12

   Adding test code, just to test not only the module is generated, but it's usable as well. Note that this sample test defines _ to be the module/function itself, so we can inspect the read-only URI and id properties.
   <code><pre>
   
   var _ = require('underscore');
   var stooges = [{name : 'curly', age : 25}, {name : 'moe', age : 21}, {name : 'larry', age : 23}];
   var youngest = _(stooges).chain()
     .sortBy(function(stooge){ return stooge.age; })
     .map(function(stooge){ return stooge.name + ' is ' + stooge.age; })
     .first()
     .value();
   
   Ti.API.debug(youngest);
   Ti.API.debug(_.uri);
   
   </pre></code>
   
   Turns out these are unrelated to linked issues, but the link is still useful.</li>
<li>Natalie Huynh 2011-12-14

   Tested with 1.8.0.1.v20111214093905 on 
   Simulator 5.0
   iPhone 4 (5.0.1)
   iPod 3g (4.0.2)
   iPad 1 (4.3.5)
   Returns:
   <Notice>: [INFO] moe is 21
   <Notice>: [INFO] app://underscore.js</li>
</ol>


<p><a href="/TIMOB/TIMOB-6573.json">JSON Source</a></p>