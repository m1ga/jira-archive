---
title: "[TIMOB-8906] Android: createHttpClient cannot determine the charset encoding by html meta tag"
---
<table>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Medium</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2012-06-29T17:26:22.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>n/a</td></tr>
<tr><th>Fix Version/s</th><td>Sprint 2012-13 API, Release 3.0.0</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>api, httpclient, parity, qe-port</td></tr>
<tr><th>Reporter</th><td>Satoshi Tanaka</td></tr>
<tr><th>Assignee</th><td>Josh Roesslein</td></tr>
<tr><th>Created</th><td>2012-04-26T00:06:53.000+0000</td></tr>
<tr><th>Updated</th><td>2013-01-15T16:54:03.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Problem</h4>

To determine the character encoding, determining sequence is as follows:

* HTTP Header (Content-type: text/html; charset=utf-8)
* HTML meta tag (meta http-equiv="Content-Type" content="text/html; charset=utf-8")

iOS handring is correct, but Android ignores HTML meta tag encoding name.

<h4>Test Case</h4>

I make a sample code which accesses each charset sample webpage and display their results.
<code><pre>
var win1 = Ti.UI.createWindow({
	backgroundColor: 'white',
});
var text = Ti.UI.createLabel({
	text: '',
});
win1.add(text);
win1.open();
charsetTest("<a href="http://kangaechu.com/utf8.html" rel="nofollow" target="_blank">http://kangaechu.com/utf8.html</a>");
charsetTest("<a href="http://kangaechu.com/shiftjis.html" rel="nofollow" target="_blank">http://kangaechu.com/shiftjis.html</a>");
charsetTest("<a href="http://kangaechu.com/eucjp.html" rel="nofollow" target="_blank">http://kangaechu.com/eucjp.html</a>");
charsetTest("<a href="http://kangaechu.com/iso2022jp.html" rel="nofollow" target="_blank">http://kangaechu.com/iso2022jp.html</a>");

function charsetTest(url){
	var xhr = Ti.Network.createHTTPClient();
	
	xhr.onload = function() {
		if(this.status == 200) {
			var html = this.responseText;
			if(html == null){
				text.text = text.text + url + ' is null.\n\n';
			}
			else if(html.match(/&lt;body&gt;([\s\S]*)&lt;\/body&gt;/)){
				var body = RegExp.$1;
				text.text = text.text + url + body;
			}else{
				text.text = text.text + url + ' is 200, but no body element.\n\n';
			}
		}else{
			text.text = text.text + url + ' status code is ' + this.status + '\n\n';
		}
	};
	xhr.onerror = function() {
		text.text = text.text + url + ' status code is ' + this.status + '\n\n';

	};
	xhr.open("GET", url, false);
	xhr.send();
	
}
</pre></code> 
Result and screenshot is below:
||OS||UTF-8||Shift_JIS||EUC-JP||ISO-2022-JP||
|Android|OK|NG|NG|NG|

<h4>Suggested Fix</h4>

To fix this bug, set charset in getResponseText()

See <a href="https://github.com/appcelerator/titanium_mobile/pull/590" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/590</a>




<h3>Attachments</h3>

<table>
<thead>
<tr><th>File</th><th>Date</th><th>Size</th></tr><thead>
<tbody>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-8906_27406/120426-0001.png">120426-0001.png</td></td><td>2012-04-26T00:06:53.000+0000</td><td>63205</td></tr>
<tr><td><a href="https://jira-attachments.tisdk.com/TIMOB/TIMOB-8906_28785/httpclient_xmlencoding_tests.js">httpclient_xmlencoding_tests.js</td></td><td>2012-06-28T12:42:13.000+0000</td><td>1647</td></tr>
</tbody>
<table>

<h3>Comments</h3>

<ol>
<li>Josh Roesslein 2012-05-01

   iOS can also detect [encoding](<a href="http://www.w3schools.com/xml/xml_encoding.asp)" rel="nofollow" target="_blank">http://www.w3schools.com/xml/xml_encoding.asp)</a> for text/xml content.
   We should also support this in Android for parity.</li>
<li>Satoshi Tanaka 2012-05-17

   The link for github is not correct.
   The correct link for github is:
   <a href="https://github.com/appcelerator/titanium_mobile/pull/2143" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/2143</a></li>
<li>Josh Roesslein 2012-06-07

   <h4>Behavior for responseText property</h4>
   
   This is the correct behavior for getting the response text
   from the raw data and is currently implemented this way in iOS.
   
   1. Attempt to convert the data using the encoding specified in the Content-Type header.
      If no encoding is specified, default to UTF-8. If successful, return the generated string.
   2. If the data looks like a XML document (maybe use content-type MIME or scan for root xml tag), search for the encoding attribute.
      If found use this encoding to convert the data and return.
   3. If the data looks like a HTML document, try scanning for the charset attribute.
      If found use this encoding to convert the data and return.
   4. Return null if we fail to parse the data. (Maybe log an error?)
   </li>
<li>Josh Roesslein 2012-06-28

   Attached a test case for detecting the encoding with XML document responses.
   
   To test just run the application and select various tests from the picker. You should see the correctly decoded text.</li>
<li>Josh Roesslein 2012-06-28

   Created [PR #2490](<a href="https://github.com/appcelerator/titanium_mobile/pull/2490)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/2490)</a> to resolve issue.</li>
<li>Satoshi Tanaka 2012-07-01

   This patch is great, but attribute value delimiter can use only double quotation.
   From W3C, attribute delimiter can use double quotation and single quotation.
   
   {quote}
   By default, SGML requires that all attribute values be delimited using either double quotation marks (ASCII decimal 34) or single quotation marks (ASCII decimal 39). 
   {quote}
   <a href="http://www.w3.org/TR/REC-html40/intro/sgmltut.html#h-3.2.2" rel="nofollow" target="_blank">http://www.w3.org/TR/REC-html40/intro/sgmltut.html#h-3.2.2</a>
   
   Created PR.
   <a href="https://github.com/appcelerator/titanium_mobile/pull/2495" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/2495</a>
   </li>
<li>Satoshi Tanaka 2012-07-25

   New PR is below:
   <a href="https://github.com/appcelerator/titanium_mobile/pull/2644" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/2644</a>
   
   Test case code: 
   <code><pre>
   var win1 = Ti.UI.createWindow({
       backgroundColor: 'white',
   });
   var text = Ti.UI.createLabel({
       text: '',
   });
   win1.add(text);
   win1.open();
   charsetTest("<a href="http://kangaechu.com/timob-8906/singleQuotation.html" rel="nofollow" target="_blank">http://kangaechu.com/timob-8906/singleQuotation.html</a>");
   charsetTest("<a href="http://kangaechu.com/timob-8906/singleQuotation.xml" rel="nofollow" target="_blank">http://kangaechu.com/timob-8906/singleQuotation.xml</a>");
   charsetTest("<a href="http://kangaechu.com/timob-8906/doubleQuotation.html" rel="nofollow" target="_blank">http://kangaechu.com/timob-8906/doubleQuotation.html</a>");
   charsetTest("<a href="http://kangaechu.com/timob-8906/doubleQuotation.xml" rel="nofollow" target="_blank">http://kangaechu.com/timob-8906/doubleQuotation.xml</a>");
    
   function charsetTest(url){
       var xhr = Ti.Network.createHTTPClient();
        
       xhr.onload = function() {
           if(this.status == 200) {
               var html = this.responseText;
               if(html == null){
                   text.text = text.text + url + ' is null.\n\n';
               }
               else if(html.match(/&lt;body&gt;([\s\S]*)&lt;\/body&gt;/)){
                   var body = RegExp.$1;
                   text.text = text.text + url + body;
               }else{
                   text.text = text.text + url + ' is 200, but no body element.\n\n';
               }
           }else{
               text.text = text.text + url + ' status code is ' + this.status + '\n\n';
           }
       };
       xhr.onerror = function() {
           text.text = text.text + url + ' status code is ' + this.status + '\n\n';
    
       };
       xhr.open("GET", url, false);
       xhr.send();
        
   }
   </pre></code> 
   
   screenshot
   
   before: 
   
   !<a href="http://kangaechu.com/timob-8906/before.png" rel="nofollow" target="_blank">http://kangaechu.com/timob-8906/before.png</a>! 
   
   after:
   
   !<a href="http://kangaechu.com/timob-8906/after.png" rel="nofollow" target="_blank">http://kangaechu.com/timob-8906/after.png</a>! </li>
<li>Olga Romero 2013-01-15

   Closing as fixed.
   Tested and verified with:
   Titanium Studio, build: 3.0.1.201212181159
   Titanium SDK, build: 3.0.0.GA
   Mountain Lion 10.8.2
   Nexus4 Android version 4.2
   Nexus7 Android version 4.1.2
   Chrome 23.0
   </li>
</ol>


<p><a href="/TIMOB/TIMOB-8906.json">JSON Source</a></p>