---
title: "[TIMOB-8953] Android: XML: Erratic Namespace Definition and Redefinition"
---
<table>
<tr><th>GitHub Issue</th><td>n/a</td></tr>
<tr><th>Type</th><td>Bug</td></tr>
<tr><th>Priority</th><td>Critical</td></tr>
<tr><th>Status</th><td>Closed</td></tr>
<tr><th>Resolution</th><td>Fixed</td></tr>
<tr><th>Resolution Date</th><td>2012-05-18T21:12:40.000+0000</td></tr>
<tr><th>Affected Version/s</th><td>Release 2.0.1</td></tr>
<tr><th>Fix Version/s</th><td>Release 2.0.2, Release 2.1.0, Sprint 2012-10 API</td></tr>
<tr><th>Components</th><td>Android</td></tr>
<tr><th>Labels</th><td>api, module_xml, qe-testadded</td></tr>
<tr><th>Reporter</th><td>Dawson Toth</td></tr>
<tr><th>Assignee</th><td>Josh Roesslein</td></tr>
<tr><th>Created</th><td>2012-05-02T12:09:21.000+0000</td></tr>
<tr><th>Updated</th><td>2012-07-05T15:02:57.000+0000</td></tr>
</table>

<h3>Description</h3>

<h4>Problem</h4>
There are a couple bugs preventing proper XML generation in Titanium. These are demonstrated in the reproduction below.

1. Defining a namespace attribute for a document element ends up redefining "xmlns", which kills most XML interpreters because it's an illegal redefinition. (For example, I want to add an xmlns:m attribute to my doc, but it ends up redefining xmlns:n0="<a href="http://www.w3.org/2000/xmlns/" rel="nofollow" target="_blank">http://www.w3.org/2000/xmlns/</a>" and adding n0:m="myurl".)
2. Prefix names are ignored. In the example, "atom:" is renamed to "n0:", "xmlns:" to "n1:", "d:" to "n2:", and "m:" to "n3".
3. Existing namespace definitions are ignored, in favor of defining the namespace on every child that specifies it. This shows up in the example for the properties and message elements receiving the new prefix "n2" and "n3", respectively.

<h4>Reproduction</h4>
<code><pre>
(function (document, Ti) {
    document = document || Ti && Ti.XML.parseString('&lt;a/&gt;');
    var feed = document.implementation.createDocument('<a href="http://www.w3.org/2005/Atom" rel="nofollow" target="_blank">http://www.w3.org/2005/Atom</a>', 'atom:feed', null);
    feed.documentElement.setAttributeNS('<a href="http://www.w3.org/2000/xmlns/" rel="nofollow" target="_blank">http://www.w3.org/2000/xmlns/</a>', 'xmlns:atom', '<a href="http://www.w3.org/2005/Atom" rel="nofollow" target="_blank">http://www.w3.org/2005/Atom</a>');
    feed.documentElement.setAttributeNS('<a href="http://www.w3.org/2000/xmlns/" rel="nofollow" target="_blank">http://www.w3.org/2000/xmlns/</a>', 'xmlns:m', '<a href="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices/metadata</a>');
    feed.documentElement.setAttributeNS('<a href="http://www.w3.org/2000/xmlns/" rel="nofollow" target="_blank">http://www.w3.org/2000/xmlns/</a>', 'xmlns:d', '<a href="http://schemas.microsoft.com/ado/2007/08/dataservices" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices</a>');

    var id = feed.documentElement.ownerDocument.createElementNS('<a href="http://www.w3.org/2005/Atom" rel="nofollow" target="_blank">http://www.w3.org/2005/Atom</a>', 'atom:id');
    id.appendChild(feed.documentElement.ownerDocument.createTextNode('<a href="http://appc.me/odata/flocker/4f9f037df04d4613dc0607d7" rel="nofollow" target="_blank">http://appc.me/odata/flocker/4f9f037df04d4613dc0607d7</a>'));
    feed.documentElement.appendChild(id);

    var title = feed.documentElement.ownerDocument.createElementNS('<a href="http://www.w3.org/2005/Atom" rel="nofollow" target="_blank">http://www.w3.org/2005/Atom</a>', 'atom:title');
    title.appendChild(feed.documentElement.ownerDocument.createTextNode('4f9f037df04d4613dc0607d7'));
    feed.documentElement.appendChild(title);

    var entry = feed.documentElement.ownerDocument.createElementNS('<a href="http://www.w3.org/2005/Atom" rel="nofollow" target="_blank">http://www.w3.org/2005/Atom</a>', 'atom:entry');
    var content = feed.documentElement.ownerDocument.createElementNS('<a href="http://www.w3.org/2005/Atom" rel="nofollow" target="_blank">http://www.w3.org/2005/Atom</a>', 'atom:content');
    content.setAttribute('type', 'application/xml');
    var properties = feed.documentElement.ownerDocument.createElementNS('<a href="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices/metadata</a>', 'm:properties');

    var message = feed.documentElement.ownerDocument.createElementNS('<a href="http://schemas.microsoft.com/ado/2007/08/dataservices" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices</a>', 'd:message');
    message.appendChild(feed.documentElement.ownerDocument.createTextNode('This is a flock!'));
    properties.appendChild(message);

    content.appendChild(properties);
    entry.appendChild(content);
    feed.documentElement.appendChild(entry);

    var expected = '&lt;?xml version="1.0" encoding="UTF-8"?&gt;\
            &lt;atom:feed xmlns:atom="<a href="http://www.w3.org/2005/Atom" rel="nofollow" target="_blank">http://www.w3.org/2005/Atom</a>"\
            xmlns:m="<a href="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices/metadata</a>"\
            xmlns:d="<a href="http://schemas.microsoft.com/ado/2007/08/dataservices" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices</a>"&gt;\
                &lt;atom:id&gt;<a href="http://appc.me/odata/flocker/4f9f037df04d4613dc0607d7&lt" rel="nofollow" target="_blank">http://appc.me/odata/flocker/4f9f037df04d4613dc0607d7&lt</a>;/atom:id&gt;\
                &lt;atom:title&gt;4f9f037df04d4613dc0607d7&lt;/atom:title&gt;\
                &lt;atom:entry&gt;\
                    &lt;atom:content type="application/xml"&gt;\
                        &lt;m:properties&gt;\
                            &lt;d:message&gt;This is a flock!&lt;/d:message&gt;\
                        &lt;/m:properties&gt;\
                    &lt;/atom:content&gt;\
                &lt;/atom:entry&gt;\
            &lt;/atom:feed&gt;'.replace(/\s{1,}/ig, ' ').replace(/&gt; &lt;/ig, '&gt;&lt;');

    var actual = '&lt;?xml version="1.0" encoding="UTF-8"?&gt;' + ((Ti && Ti.XML) || new XMLSerializer()).serializeToString(feed);

    if (Ti) {
        Ti.API.info('Expected:\n' + expected);
        Ti.API.info('Actual:\n' + actual);
    }
    else {
        console.log('Expected:\n' + expected);
        console.log('Actual:\n' + actual);
    }

    if (expected != actual) {
        alert('FAIL! Check logs for more information.');
    }
    else {
        alert('PASS!');
    }
})(this['document'], this['Ti']);
</pre></code>

<h4>Test Results</h4>

<h4>Chrome</h4>
**PASS**
The expected and actual are equal.

<h4>Android Galaxy Tab 7.0+ (3.2)</h4>
**FAIL**
The actual results are as follows (once problem #1 is resolved):
<code><pre>
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;n0:feed n1:atom="<a href="http://www.w3.org/2005/Atom" rel="nofollow" target="_blank">http://www.w3.org/2005/Atom</a>" n1:m="<a href="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices/metadata</a>"
         n1:d="<a href="http://schemas.microsoft.com/ado/2007/08/dataservices" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices</a>" xmlns:n0="<a href="http://www.w3.org/2005/Atom" rel="nofollow" target="_blank">http://www.w3.org/2005/Atom</a>"
         xmlns:n1="<a href="http://www.w3.org/2000/xmlns/" rel="nofollow" target="_blank">http://www.w3.org/2000/xmlns/</a>"&gt;
    &lt;n0:id&gt;<a href="http://appc.me/odata/flocker/4f9f037df04d4613dc0607d7&lt" rel="nofollow" target="_blank">http://appc.me/odata/flocker/4f9f037df04d4613dc0607d7&lt</a>;/n0:id&gt;
    &lt;n0:title&gt;4f9f037df04d4613dc0607d7&lt;/n0:title&gt;
    &lt;n0:entry&gt;
        &lt;n0:content type="application/xml"&gt;
            &lt;n2:properties xmlns:n2="<a href="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices/metadata</a>"&gt;
                &lt;n3:message xmlns:n3="<a href="http://schemas.microsoft.com/ado/2007/08/dataservices" rel="nofollow" target="_blank">http://schemas.microsoft.com/ado/2007/08/dataservices</a>"&gt;This is a flock!
                &lt;/n3:message&gt;
            &lt;/n2:properties&gt;
        &lt;/n0:content&gt;
    &lt;/n0:entry&gt;
&lt;/n0:feed&gt;
</pre></code>
Note these discrepancies:
1. "xmlns" prefix renamed to "n1".
2. "atom" prefix renamed to "n0".
3. Explicit definition of "xmlns" as "xmlns:n1".
4. With explicit "n1" definition, "d" and "m" namespaces are placed under "n1:" instead of "xmlns:".
5. Disregarding "d:" and "m:" in favor of redefining the new namespaces "n2" and "n3" for "n2:properties" and "n3:message". Should be "m:properties" and "d:properties".

<h3>Comments</h3>

<ol>
<li>Dawson Toth 2012-05-02

   Not ready to create this ticket.</li>
<li>Dawson Toth 2012-05-07

   Ready to make this ticket now. Will take a bit to update it, hold tight...</li>
<li>Dawson Toth 2012-05-07

   Updated. Ready for escalation.</li>
<li>Josh Roesslein 2012-05-18

   With the new fix change line 44 to:
   <code><pre>
   var actual = ((Ti && Ti.XML) || new XMLSerializer()).serializeToString(feed);
   </pre></code>
   
   We now properly output the XML declaration so no need to append this onto the result.</li>
<li>Josh Roesslein 2012-05-18

   Pull request [#2225](<a href="https://github.com/appcelerator/titanium_mobile/pull/2225)" rel="nofollow" target="_blank">https://github.com/appcelerator/titanium_mobile/pull/2225)</a> is up.</li>
<li>Natalie Huynh 2012-05-23

   Tested with 2.0.2.v20120522180515 on Samsung Galaxy 4.0.4</li>
</ol>


<p><a href="/TIMOB/TIMOB-8953.json">JSON Source</a></p>